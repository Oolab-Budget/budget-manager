<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Manager - Mexico Operations</title>
    <!-- Excel export library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF generation library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Fix MutationObserver error from Supabase - MUST run BEFORE Supabase library loads -->
    <script>
        // Patch MutationObserver BEFORE Supabase loads to prevent errors
        // This must run immediately, before any other scripts
        (function() {
            'use strict';
            
            // Store original observe function
            let originalObserve = null;
            
            // Function to patch MutationObserver
            function patchMutationObserver() {
                if (typeof MutationObserver === 'undefined' || !MutationObserver.prototype) {
                    return;
                }
                
                // Get original if not stored yet
                if (!originalObserve) {
                    originalObserve = MutationObserver.prototype.observe;
                }
                
                // Only patch if not already patched
                if (originalObserve && MutationObserver.prototype.observe === originalObserve) {
                    MutationObserver.prototype.observe = function(target, options) {
                        // Validate target is a valid Node - if not, silently return
                        if (!target || typeof target !== 'object' || typeof target.nodeType !== 'number') {
                            return; // Silently ignore invalid targets
                        }
                        
                        // Only valid Node types: 1=Element, 9=Document, 11=DocumentFragment
                        if (target.nodeType === 1 || target.nodeType === 9 || target.nodeType === 11) {
                            try {
                                return originalObserve.call(this, target, options);
                            } catch (e) {
                                // Silently ignore all errors - don't break Supabase
                                return;
                            }
                        }
                        // Invalid nodeType - silently ignore
                        return;
                    };
                }
            }
            
            // Patch immediately
            patchMutationObserver();
            
            // Patch multiple times to ensure it's applied
            setTimeout(patchMutationObserver, 0);
            setTimeout(patchMutationObserver, 10);
            setTimeout(patchMutationObserver, 50);
            setTimeout(patchMutationObserver, 100);
            setTimeout(patchMutationObserver, 200);
            
            // Patch when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', patchMutationObserver);
            } else {
                patchMutationObserver();
            }
            
            // Patch after window loads
            window.addEventListener('load', patchMutationObserver);
        })();
    </script>
    <!-- EmailJS library for sending emails -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Additional MutationObserver patch after Supabase loads (backup) -->
    <script>
        // Backup patch in case Supabase library modifies MutationObserver after loading
        (function() {
            function patchMutationObserver() {
                if (typeof MutationObserver !== 'undefined' && MutationObserver.prototype) {
                    const originalObserve = MutationObserver.prototype.observe;
                    if (originalObserve && !MutationObserver.prototype.observe._patched) {
                        MutationObserver.prototype.observe = function(target, options) {
                            if (!target || typeof target !== 'object' || typeof target.nodeType !== 'number') {
                                return;
                            }
                            if (target.nodeType === 1 || target.nodeType === 9 || target.nodeType === 11) {
                                try {
                                    return originalObserve.call(this, target, options);
                                } catch (e) {
                                    return;
                                }
                            }
                            return;
                        };
                        MutationObserver.prototype.observe._patched = true;
                    }
                }
            }
            // Apply backup patch after Supabase loads
            setTimeout(patchMutationObserver, 0);
            setTimeout(patchMutationObserver, 50);
            setTimeout(patchMutationObserver, 100);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header-logos {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 20px;
        }

        .header-logo {
            height: 60px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .header-logo:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header-logos {
                gap: 10px;
                margin-right: 10px;
            }
            .header-logo {
                height: 40px;
                max-width: 120px;
            }
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .language-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .translation-note {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            color: #0c5460;
        }

        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e1e8ed;
            padding: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #5d6d7e;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e1e8ed;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #2c3e50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #bdc3c7;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
            transform: translateY(-2px);
        }

        .tab-button.active:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.5);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e8ed;
        }

        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .form-section h3 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .item-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: move;
            position: relative;
        }

        .item-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            cursor: grabbing;
        }

        .item-card.drag-over {
            border-top: 3px solid #3498db;
            margin-top: 8px;
        }

        .item-card.drag-over-bottom {
            border-bottom: 3px solid #3498db;
            margin-bottom: 8px;
        }

        .drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 1.2rem;
            cursor: grab;
            padding: 5px;
            user-select: none;
            pointer-events: none;
        }

        .item-card:hover .drag-handle {
            color: #7f8c8d;
        }

        .item-card.dragging .drag-handle {
            cursor: grabbing;
        }

        .item-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .item-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .item-description {
            color: #7f8c8d;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 6px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .supplier-info {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 6px 8px;
            margin-top: 4px;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .supplier-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .supplier-detail {
            font-size: 0.9rem;
        }

        .supplier-detail strong {
            color: #2c3e50;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-move {
            background: #6c757d;
            color: white;
            padding: 6px 10px;
            font-size: 0.85rem;
            min-width: 35px;
        }

        .btn-move:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-move:disabled {
            background: #ced4da;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .quantity-priority {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        .quantity-priority input,
        .quantity-priority select {
            width: 80px;
            padding: 4px 6px;
            font-size: 0.85rem;
        }
        
        .quantity-priority label {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .budget-summary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
        }

        .budget-summary h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .budget-summary p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .total-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .total-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .total-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .budget-items {
            background: white;
            border-radius: 10px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        .budget-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e1e8ed;
        }

        .budget-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e8ed;
            vertical-align: middle;
        }

        .photo-upload {
            position: relative;
            display: inline-block;
        }

        .photo-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .photo-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s ease;
        }

        .photo-btn:hover {
            background: #2980b9;
        }

        .photo-btn.has-photo {
            background: #27ae60;
        }

        .photo-btn.has-photo:hover {
            background: #229954;
        }

        .photo-preview {
            max-width: 60px;
            max-height: 60px;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
        }

        .photo-preview.show {
            display: block;
        }

        .camera-icon {
            font-size: 14px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #7f8c8d;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .alert {
            border-radius: 4px;
            padding: 10px 15px;
            margin: 10px 0;
            border: 1px solid transparent;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .approval-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .approval-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .approval-denied {
            background-color: #f8d7da;
            color: #721c24;
        }

        .approval-needs_edit {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .budget-table tr:hover {
            background: #f8f9fa;
        }

        .priority-high {
            color: #e74c3c;
            font-weight: 600;
        }

        .priority-medium {
            color: #f39c12;
            font-weight: 600;
        }

        .priority-low {
            color: #27ae60;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        /* Persistent Duties Alert */
        .duties-alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .duties-alert-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .duties-alert-message {
            flex: 1;
            min-width: 300px;
        }

        .duties-alert-message h3 {
            margin: 0 0 8px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duties-alert-message p {
            margin: 0;
            font-size: 1rem;
            opacity: 0.95;
        }

        .duties-alert-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .duties-alert-btn {
            padding: 12px 24px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .duties-alert-btn:hover {
            background: white;
            color: #f39c12;
            transform: translateY(-2px);
        }

        .duties-alert-btn.accept {
            background: white;
            color: #f39c12;
        }

        .duties-alert-btn.accept:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        body.has-duties-alert {
            padding-top: 120px;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .item-details {
                grid-template-columns: 1fr;
            }
            
            .supplier-details {
                grid-template-columns: 1fr;
            }
            
            .quantity-priority {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quantity-priority input,
            .quantity-priority select {
                width: 100%;
            }
            
            .budget-table {
                font-size: 14px;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 10px 8px;
            }
        }

        /* Print Styles for 8.5 x 11 page */
        @media print {
            @page {
                size: 8.5in 11in;
                margin: 0.5in;
            }
            
            body {
                margin: 0;
                padding: 0;
                font-size: 10pt;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .header {
                background: white !important;
                color: black !important;
                padding: 10px 0 !important;
                border-bottom: 2px solid #000 !important;
            }
            
            .tab-navigation,
            .language-toggle,
            .btn,
            .item-actions,
            .photo-upload,
            input,
            select,
            textarea,
            button {
                display: none !important;
            }
            
            .tab-content {
                display: block !important;
                padding: 0 !important;
            }
            
            .form-section {
                background: white !important;
                border: none !important;
                padding: 10px 0 !important;
                margin: 0 0 15px 0 !important;
                page-break-inside: avoid;
            }
            
            .budget-summary {
                background: white !important;
                color: black !important;
                padding: 15px !important;
                border: 2px solid #000 !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }
            
            .budget-items {
                box-shadow: none !important;
                border: 1px solid #000 !important;
            }
            
            .budget-table {
                width: 100% !important;
                min-width: auto !important;
                font-size: 9pt !important;
                border-collapse: collapse !important;
            }
            
            .budget-table th {
                background: #f0f0f0 !important;
                color: black !important;
                padding: 6px 4px !important;
                border: 1px solid #000 !important;
                text-align: left !important;
                font-weight: bold !important;
                font-size: 8pt !important;
            }
            
            .budget-table td {
                padding: 5px 4px !important;
                border: 1px solid #ccc !important;
                font-size: 8pt !important;
                text-align: left !important;
                word-wrap: break-word !important;
                vertical-align: top !important;
            }
            
            .budget-table tr {
                page-break-inside: avoid;
            }
            
            /* Text justification - right align for numeric columns */
            .budget-table td,
            .budget-table th {
                text-align: left !important;
            }
            
            /* Right align for Unit Price (5), Quantity (6), and Total (9) columns */
            .budget-table td:nth-child(5),
            .budget-table th:nth-child(5),
            .budget-table td:nth-child(6),
            .budget-table th:nth-child(6),
            .budget-table td:nth-child(9),
            .budget-table th:nth-child(9) {
                text-align: right !important;
            }
            
            /* Center align for Priority (7) and Status (10) columns */
            .budget-table td:nth-child(7),
            .budget-table th:nth-child(7),
            .budget-table td:nth-child(10),
            .budget-table th:nth-child(10) {
                text-align: center !important;
            }
            
            /* Ensure table fits on page */
            table {
                width: 100% !important;
                max-width: 100% !important;
                table-layout: fixed !important;
            }
            
            /* Column widths optimized for 8.5" page with 0.5" margins = 7.5" usable width */
            .budget-table th:nth-child(1),
            .budget-table td:nth-child(1) {
                width: 15% !important; /* Item */
            }
            
            .budget-table th:nth-child(2),
            .budget-table td:nth-child(2) {
                width: 12% !important; /* Description */
            }
            
            .budget-table th:nth-child(3),
            .budget-table td:nth-child(3) {
                width: 10% !important; /* Notes */
            }
            
            .budget-table th:nth-child(4),
            .budget-table td:nth-child(4) {
                width: 10% !important; /* Category */
            }
            
            .budget-table th:nth-child(5),
            .budget-table td:nth-child(5) {
                width: 9% !important; /* Unit Price */
            }
            
            .budget-table th:nth-child(6),
            .budget-table td:nth-child(6) {
                width: 7% !important; /* Quantity */
            }
            
            .budget-table th:nth-child(7),
            .budget-table td:nth-child(7) {
                width: 7% !important; /* Priority */
            }
            
            .budget-table th:nth-child(8),
            .budget-table td:nth-child(8) {
                width: 8% !important; /* Invoice Photo */
            }
            
            .budget-table th:nth-child(9),
            .budget-table td:nth-child(9) {
                width: 9% !important; /* Total */
            }
            
            .budget-table th:nth-child(10),
            .budget-table td:nth-child(10) {
                width: 8% !important; /* Status */
            }
            
            .budget-table th:nth-child(11),
            .budget-table td:nth-child(11) {
                width: 5% !important; /* Actions - hidden in print */
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen (hidden by default, shown when not logged in) -->
    <div id="loginScreen" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; padding: 40px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Budget Manager</h2>
            <div id="loginForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;">Email</label>
                    <input type="email" id="loginEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;" placeholder="your@email.com">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;">Password</label>
                    <input type="password" id="loginPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button onclick="if(typeof handleLogin === 'function') { handleLogin(); } else { alert('Login function not loaded. Please refresh the page.'); console.error('handleLogin is not defined'); }" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px;">Login</button>
                <button onclick="showSignupForm()" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px;">Create Account</button>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <label style="display: block; margin-bottom: 10px; color: #2c3e50; font-weight: 600; font-size: 15px;">ðŸ”§ Restore Backup (No Login Required)</label>
                    <input type="file" id="restoreBackupFile" accept=".json" onchange="restoreBackupWithoutLogin(event)" style="padding: 10px; width: 100%; border: 2px solid #3498db; border-radius: 5px; font-size: 14px; box-sizing: border-box; background: #f8f9fa; cursor: pointer;">
                    <small style="display: block; margin-top: 8px; color: #7f8c8d; font-size: 12px; line-height: 1.4;">Select your backup JSON file (e.g., budget-full-backup-with-supabase-2025-11-30.json) to restore all your data without logging in.</small>
                </div>
                
                <div id="loginError" style="color: #e74c3c; margin-top: 15px; text-align: center; display: none;"></div>
                <div id="restoreStatus" style="color: #27ae60; margin-top: 15px; text-align: center; display: none; padding: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; font-size: 14px;"></div>
            </div>
            <div id="signupForm" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;">Email</label>
                    <input type="email" id="signupEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;" placeholder="your@email.com">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;">Password</label>
                    <input type="password" id="signupPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 5px; padding: 10px; margin-bottom: 15px; font-size: 0.85rem; color: #0c5460;">
                    <strong>Note:</strong> New accounts are created with limited access (Budget, Reports, Can/Mex, and Mex/Can tabs only). Contact an administrator to request admin access.
                </div>
                <button onclick="handleSignup()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px;">Create Account</button>
                <button onclick="showLoginForm()" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 16px;">Back to Login</button>
                <div id="signupError" style="color: #e74c3c; margin-top: 15px; text-align: center; display: none;"></div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: block;">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="language-toggle" id="langToggle" onclick="toggleLanguage()">ES / EN</button>
                    <div>
                        <h1 data-en="Budget Manager" data-es="Gestor de Presupuesto">Budget Manager</h1>
                        <p data-en="Mexico Operations - Bilingual Budget Management System" data-es="Operaciones MÃ©xico - Sistema de GestiÃ³n de Presupuesto BilingÃ¼e">Mexico Operations - Bilingual Budget Management System</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- Company Logos -->
                    <div class="header-logos">
                        <img src="images/logo1.png" alt="Company Logo 1" class="header-logo" id="headerLogo1">
                        <img src="images/logo2.png" alt="Company Logo 2" class="header-logo" id="headerLogo2">
                        <img src="images/logo3.png" alt="Company Logo 3" class="header-logo" id="headerLogo3">
                    </div>
                    <button onclick="if(typeof handleLogout === 'function') { handleLogout(); } else { alert('Logout function not loaded. Please refresh the page.'); console.error('handleLogout is not defined'); }" id="logoutBtn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; display: none;" data-en="Logout" data-es="Cerrar SesiÃ³n">Logout</button>
                </div>
            </div>
        </div>

        <div class="translation-note">
            <strong data-en="Translation Note:" data-es="Nota de TraducciÃ³n:">Translation Note:</strong>
            <span data-en="Items will be automatically translated between English and Spanish. You can switch languages using the toggle button." data-es="Los artÃ­culos se traducirÃ¡n automÃ¡ticamente entre inglÃ©s y espaÃ±ol. Puedes cambiar idiomas usando el botÃ³n de alternancia.">Items will be automatically translated between English and Spanish. You can switch languages using the toggle button.</span>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('budget')" data-en="Budget" data-es="Presupuesto">Budget</button>
            <button class="tab-button" onclick="switchTab('addItems')" data-en="Add Items" data-es="Agregar ArtÃ­culos">Add Items</button>
            <button class="tab-button" onclick="switchTab('manageItems')" data-en="Manage Items" data-es="Gestionar ArtÃ­culos">Manage Items</button>
            <button class="tab-button" onclick="switchTab('categories')" data-en="Categories" data-es="CategorÃ­as">Categories</button>
            <button class="tab-button" onclick="switchTab('reports')" data-en="Reports" data-es="Reportes">Reports</button>
            <button class="tab-button" onclick="switchTab('monitor')" data-en="Monitor" data-es="Monitor">Monitor</button>
            <button class="tab-button" onclick="switchTab('alerts')" data-en="Alerts" data-es="Alertas">Alerts</button>
            <button class="tab-button" onclick="switchTab('canada')" data-en="Can/Mex" data-es="Can/Mex">Can/Mex</button>
            <button class="tab-button" onclick="switchTab('mexcan')" data-en="Mex/Can" data-es="Mex/Can">Mex/Can</button>
            <button class="tab-button" onclick="switchTab('settings')" data-en="Settings" data-es="ConfiguraciÃ³n">Settings</button>
        </div>

        <!-- Budget Tab -->
        <div id="budgetTab" class="tab-content active">
            <div class="form-section">
                <h2 data-en="Add Items from Category" data-es="Agregar ArtÃ­culos por CategorÃ­a">Add Items from Category</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Select Category" data-es="Seleccionar CategorÃ­a">Select Category</label>
                        <select id="categorySelect" onchange="loadCategoryItems()">
                            <option value="" data-en="Choose a category..." data-es="Elige una categorÃ­a...">Choose a category...</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; margin-top: 25px;">
                            <input type="checkbox" id="enableNotesForCategoryItems" onchange="toggleNotesForCategoryItems()">
                            <span data-en="Add Notes" data-es="Agregar Notas">Add Notes</span>
                        </label>
                    </div>
                </div>

                <div id="categoryItems" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0;" data-en="Available Items" data-es="ArtÃ­culos Disponibles">Available Items</h3>
                        <div style="flex: 1; max-width: 300px; min-width: 200px;">
                            <input type="text" id="itemSearchFilter" placeholder="Search items..." 
                                   oninput="filterCategoryItems()" 
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;"
                                   data-en="Search items..." data-es="Buscar artÃ­culos...">
                        </div>
                    </div>
                    <div id="itemsList">
                        <!-- Items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="budget-summary">
                <h2 data-en="Current Budget" data-es="Presupuesto Actual">Current Budget</h2>
                <div class="budget-totals" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="total-item">
                        <div class="total-label" data-en="Total Amount" data-es="Monto Total">Total Amount</div>
                        <div class="total-value" id="totalAmount">$0.00 MXN</div>
                        <div class="total-subtitle" id="totalSubtitle" style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;" data-en="(Approved + Pending Items)" data-es="(ArtÃ­culos Aprobados + Pendientes)">(Approved + Pending Items)</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-en="Total Items" data-es="Total de ArtÃ­culos">Total Items</div>
                        <div class="total-value" id="totalItems">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-en="Approved Items" data-es="ArtÃ­culos Aprobados">Approved Items</div>
                        <div class="total-value" id="approvedItems" style="color: #28a745;">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-en="Pending Items" data-es="ArtÃ­culos Pendientes">Pending Items</div>
                        <div class="total-value" id="pendingItems" style="color: #ffc107;">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-en="Denied Items" data-es="ArtÃ­culos Rechazados">Denied Items</div>
                        <div class="total-value" id="deniedItems" style="color: #dc3545;">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-en="Needs Edit" data-es="Necesita EdiciÃ³n">Needs Edit</div>
                        <div class="total-value" id="needsEditItems" style="color: #17a2b8;">0</div>
                    </div>
                </div>
            </div>

            <!-- Budget Approval Section -->
            <div class="budget-approval" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Budget Approval" data-es="AprobaciÃ³n de Presupuesto">Budget Approval</h3>
                <div class="approval-actions" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="approveAllItems()" data-en="Approve All Items" data-es="Aprobar Todos los ArtÃ­culos">Approve All Items</button>
                    <button class="btn btn-primary" onclick="showPartialPaymentModal()" data-en="Partial Budget Payment" data-es="Pago Parcial del Presupuesto">Partial Budget Payment</button>
                    <button class="btn btn-warning" onclick="resetAllApprovals()" data-en="Reset All Approvals" data-es="Restablecer Todas las Aprobaciones">Reset All Approvals</button>
                </div>
                <div id="approvalStatus" style="display: none; padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
            </div>

            <div class="budget-items">
                <table class="budget-table">
                    <thead>
                        <tr>
                            <th data-en="Item" data-es="ArtÃ­culo">Item</th>
                            <th data-en="Description" data-es="DescripciÃ³n">Description</th>
                            <th data-en="Notes" data-es="Notas">Notes</th>
                            <th data-en="Category" data-es="CategorÃ­a">Category</th>
                            <th data-en="Unit Price" data-es="Precio Unitario">Unit Price</th>
                            <th data-en="Quantity" data-es="Cantidad">Quantity</th>
                            <th data-en="Priority" data-es="Prioridad">Priority</th>
                            <th data-en="Invoice Photo" data-es="Foto de Factura">Invoice Photo</th>
                            <th data-en="Total" data-es="Total">Total</th>
                            <th data-en="Status" data-es="Estado">Status</th>
                            <th data-en="Actions" data-es="Acciones">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budgetItemsList">
                        <!-- Budget items will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="form-section">
                <button class="btn btn-info" onclick="requestReview()" style="background: #17a2b8; border-color: #17a2b8;" data-en="Request Review" data-es="Solicitar RevisiÃ³n">Request Review</button>
                <button class="btn btn-primary" onclick="saveAndContinueBudget()" style="background: #6c757d; border-color: #6c757d;" data-en="Save and Continue" data-es="Guardar y Continuar">Save and Continue</button>
                <button class="btn btn-success" onclick="saveAndClearBudget()" data-en="Save & Clear for Next Week" data-es="Guardar y Limpiar para la PrÃ³xima Semana">Save & Clear for Next Week</button>
                <button class="btn btn-warning" onclick="printBudget()" data-en="Print Budget" data-es="Imprimir Presupuesto">Print Budget</button>
                <button class="btn btn-danger" onclick="clearBudget().catch(err => console.error('Error clearing budget:', err))" data-en="Clear All Items" data-es="Limpiar Todos los ArtÃ­culos">Clear All Items</button>
            </div>
        </div>

        <!-- Add Items Tab -->
        <div id="addItemsTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Add Custom Item" data-es="Agregar ArtÃ­culo Personalizado">Add Custom Item</h2>
                <p data-en="Add a new item to your budget. Items will be automatically translated when you switch languages." data-es="Agrega un nuevo artÃ­culo a tu presupuesto. Los artÃ­culos se traducirÃ¡n automÃ¡ticamente cuando cambies de idioma.">Add a new item to your budget. Items will be automatically translated when you switch languages.</p>
                
                <form id="itemForm" novalidate onsubmit="event.preventDefault(); validateItemForm(event); return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Item Name" data-es="Nombre del ArtÃ­culo">Item Name</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label data-en="Description" data-es="DescripciÃ³n">Description</label>
                            <textarea id="description" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Category" data-es="CategorÃ­a">Category</label>
                            <select id="category" required onchange="updateUnitPriceField()">
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-en="Pricing Type" data-es="Tipo de Precio">Pricing Type</label>
                            <select id="itemPricingType">
                                <option value="fixed" data-en="Fixed Cost" data-es="Costo Fijo">Fixed Cost</option>
                                <option value="flexible" data-en="Flexible Cost" data-es="Costo Flexible">Flexible Cost</option>
                            </select>
                            <small style="color: #6c757d; font-size: 0.875rem; display: block; margin-top: 5px;" data-en="Fixed: Price cannot be changed when adding to budget. Flexible: Price can be modified when adding to budget." data-es="Fijo: El precio no se puede cambiar al agregar al presupuesto. Flexible: El precio se puede modificar al agregar al presupuesto.">Fixed: Price cannot be changed when adding to budget. Flexible: Price can be modified when adding to budget.</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Supplier" data-es="Proveedor">Supplier</label>
                            <input type="text" id="supplier" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" id="unitPriceGroup">
                            <label data-en="Unit Price (MXN)" data-es="Precio Unitario (MXN)">Unit Price (MXN)</label>
                            <input type="number" id="unitPrice" step="0.01" min="0" value="0">
                            <small id="unitPriceHelp" style="display: none; color: #6c757d; font-size: 0.875rem;" data-en="Optional for flexible cost categories" data-es="Opcional para categorÃ­as de costo flexible">Optional for flexible cost categories</small>
                        </div>
                        <div class="form-group">
                            <label data-en="Quantity" data-es="Cantidad">Quantity</label>
                            <input type="number" id="quantity" min="1" value="1" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Supplier Phone" data-es="TelÃ©fono del Proveedor">Supplier Phone</label>
                            <input type="tel" id="supplierPhone" placeholder="+52 55 1234 5678">
                        </div>
                        <div class="form-group">
                            <label data-en="Supplier Email" data-es="Correo del Proveedor">Supplier Email</label>
                            <input type="email" id="supplierEmail" placeholder="supplier@example.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Supplier Address" data-es="DirecciÃ³n del Proveedor">Supplier Address</label>
                            <textarea id="supplierAddress" rows="2" placeholder="Complete address"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Receipt/Invoice (Image, PDF, or Excel)" data-es="Recibo/Factura (Imagen, PDF o Excel)">Receipt/Invoice (Image, PDF, or Excel)</label>
                            <div class="photo-upload">
                                <input type="file" id="invoicePhoto" accept="image/*,.pdf,.xlsx,.xls" onchange="uploadAddItemPhoto(this)">
                                <button class="photo-btn" type="button">
                                    <span class="camera-icon">ðŸ“·</span>
                                    <span data-en="Add Photo" data-es="Agregar Foto">Add Photo</span>
                                </button>
                                <img id="addPhotoPreview" class="photo-preview" alt="Invoice photo" style="max-width: 100px; max-height: 100px; margin-top: 10px;">
                            </div>
                            <div id="receiptAmountRow" style="display: none; margin-top: 10px;">
                                <label data-en="Receipt Amount (MXN)" data-es="Monto del Recibo (MXN)">Receipt Amount (MXN)</label>
                                <input type="number" id="receiptAmount" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <small data-en="Enter the exact amount shown on the receipt" data-es="Ingresa el monto exacto que aparece en el recibo">Enter the exact amount shown on the receipt</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="addNotes" onchange="toggleNotesField()">
                                <span data-en="Add Notes" data-es="Agregar Notas">Add Notes</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-row" id="notesRow" style="display: none;">
                        <div class="form-group" style="width: 100%;">
                            <label data-en="Notes" data-es="Notas">Notes</label>
                            <textarea id="itemNotes" rows="3" placeholder="Add any additional notes or details about this item..."></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="saveToCategory" checked>
                                <span data-en="Save to Category Database" data-es="Guardar en Base de Datos de CategorÃ­a">Save to Category Database</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="itemForCanada" onchange="toggleItemForCanada()">
                                <span data-en="Available for Canada Requests" data-es="Disponible para Solicitudes de CanadÃ¡">Available for Canada Requests</span>
                            </label>
                            <small data-en="This item will appear in the Can/Mex tab (Canada requesting from Mexico)" data-es="Este artÃ­culo aparecerÃ¡ en la pestaÃ±a Can/Mex (CanadÃ¡ solicitando de MÃ©xico)">This item will appear in the Can/Mex tab (Canada requesting from Mexico)</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="itemForMexico" onchange="toggleItemForMexico()">
                                <span data-en="Available for Mexico Requests" data-es="Disponible para Solicitudes de MÃ©xico">Available for Mexico Requests</span>
                            </label>
                            <small data-en="This item will appear in the Mex/Can tab (Mexico requesting from Canada)" data-es="Este artÃ­culo aparecerÃ¡ en la pestaÃ±a Mex/Can (MÃ©xico solicitando de CanadÃ¡)">This item will appear in the Mex/Can tab (Mexico requesting from Canada)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="itemRecurringWeekly" onchange="toggleItemRecurringWeekly()">
                                <span data-en="Recurring Weekly" data-es="Recurrente Semanal">Recurring Weekly</span>
                            </label>
                            <small data-en="Item will automatically be added to budget every week" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto cada semana">Item will automatically be added to budget every week</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="itemRecurringMonthly" onchange="toggleItemRecurringMonthly()">
                                <span data-en="Recurring Monthly" data-es="Recurrente Mensual">Recurring Monthly</span>
                            </label>
                            <small data-en="Item will automatically be added to budget on a specific day each month" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto en un dÃ­a especÃ­fico cada mes">Item will automatically be added to budget on a specific day each month</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="itemHasDueDate" onchange="toggleItemDueDate()">
                                <span data-en="Set Due Date for Auto-Add" data-es="Establecer Fecha de Vencimiento para Auto-Agregar">Set Due Date for Auto-Add</span>
                            </label>
                            <small data-en="Item will automatically be added to budget one week before due date" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto una semana antes de la fecha de vencimiento">Item will automatically be added to budget one week before due date</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="itemMonthlyDayRow" style="display: none;">
                            <label data-en="Day of Month" data-es="DÃ­a del Mes">Day of Month</label>
                            <select id="itemMonthlyDay" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Select day...</option>
                            </select>
                            <small data-en="Item will be auto-added on this day of each month" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente en este dÃ­a de cada mes">Item will be auto-added on this day of each month</small>
                        </div>
                        <div class="form-group" id="itemDueDateRow" style="display: none;">
                            <label data-en="Due Date" data-es="Fecha de Vencimiento">Due Date</label>
                            <input type="date" id="itemDueDate">
                            <small data-en="Item will be auto-added one week before this date" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente una semana antes de esta fecha">Item will be auto-added one week before this date</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn btn-success" data-en="Add to Budget" data-es="Agregar al Presupuesto">Add to Budget</button>
                        <button type="button" class="btn btn-primary" onclick="addToCategoryOnly()" data-en="Add to Category Only" data-es="Agregar Solo a CategorÃ­a">Add to Category Only</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Manage Items Tab -->
        <div id="manageItemsTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Manage Category Items" data-es="Gestionar ArtÃ­culos de CategorÃ­a">Manage Category Items</h2>
                <p data-en="View and manage items in each category. Items you add will appear here and in the category selection above." data-es="Ver y gestionar artÃ­culos en cada categorÃ­a. Los artÃ­culos que agregues aparecerÃ¡n aquÃ­ y en la selecciÃ³n de categorÃ­a de arriba.">View and manage items in each category. Items you add will appear here and in the category selection above.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Select Category to Manage" data-es="Seleccionar CategorÃ­a para Gestionar">Select Category to Manage</label>
                        <select id="manageCategorySelect" onchange="loadManageCategoryItems()">
                            <option value="" data-en="Choose a category..." data-es="Elige una categorÃ­a...">Choose a category...</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                </div>

                <div id="manageCategoryItems" style="display: none;">
                    <h3 data-en="Category Items" data-es="ArtÃ­culos de CategorÃ­a">Category Items</h3>
                    <div id="manageItemsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <!-- Items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categoriesTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Manage Categories" data-es="Gestionar CategorÃ­as">Manage Categories</h2>
                <p data-en="Add, edit, or remove categories for organizing your items." data-es="Agrega, edita o elimina categorÃ­as para organizar tus artÃ­culos.">Add, edit, or remove categories for organizing your items.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Category Name (English)" data-es="Nombre de CategorÃ­a (InglÃ©s)">Category Name (English)</label>
                        <input type="text" id="newCategoryNameEn" placeholder="e.g., Electronics">
                    </div>
                    <div class="form-group">
                        <label data-en="Category Name (Spanish)" data-es="Nombre de CategorÃ­a (EspaÃ±ol)">Category Name (Spanish)</label>
                        <input type="text" id="newCategoryNameEs" placeholder="e.g., ElectrÃ³nicos">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Category Description" data-es="DescripciÃ³n de CategorÃ­a">Category Description</label>
                        <textarea id="newCategoryDescription" rows="2" placeholder="Brief description of this category"></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Pricing Type" data-es="Tipo de Precio">Pricing Type</label>
                        <select id="newCategoryPricingType">
                            <option value="fixed" data-en="Fixed Cost" data-es="Costo Fijo">Fixed Cost</option>
                            <option value="flexible" data-en="Flexible Cost" data-es="Costo Flexible">Flexible Cost</option>
                        </select>
                        <small data-en="Fixed: Price cannot be changed when adding to budget. Flexible: Price can be modified when adding to budget." data-es="Fijo: El precio no se puede cambiar al agregar al presupuesto. Flexible: El precio se puede modificar al agregar al presupuesto.">Fixed: Price cannot be changed when adding to budget. Flexible: Price can be modified when adding to budget.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="newCategoryRecurringWeekly" onchange="toggleRecurringWeekly()">
                            <span data-en="Recurring Weekly" data-es="Recurrente Semanal">Recurring Weekly</span>
                        </label>
                        <small data-en="Items in this category will automatically be added to budget every week" data-es="Los artÃ­culos de esta categorÃ­a se agregarÃ¡n automÃ¡ticamente al presupuesto cada semana">Items in this category will automatically be added to budget every week</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="newCategoryHasDueDate" onchange="toggleDueDate()">
                            <span data-en="Has Due Date" data-es="Tiene Fecha de Vencimiento">Has Due Date</span>
                        </label>
                        <small data-en="Items will automatically be added one week before the due date" data-es="Los artÃ­culos se agregarÃ¡n automÃ¡ticamente una semana antes de la fecha de vencimiento">Items will automatically be added one week before the due date</small>
                    </div>
                </div>

                <div class="form-row" id="dueDateRow" style="display: none;">
                    <div class="form-group">
                        <label data-en="Due Date" data-es="Fecha de Vencimiento">Due Date</label>
                        <input type="date" id="newCategoryDueDate">
                        <small data-en="Items will be automatically added to budget one week before this date" data-es="Los artÃ­culos se agregarÃ¡n automÃ¡ticamente al presupuesto una semana antes de esta fecha">Items will be automatically added to budget one week before this date</small>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addNewCategory()" data-en="Add Category" data-es="Agregar CategorÃ­a">Add Category</button>
                <button class="btn btn-warning" onclick="cancelEditCategory()" data-en="Cancel" data-es="Cancelar" style="display: none;" id="cancelEditBtn">Cancel</button>
                <button class="btn btn-primary" onclick="populateCategoryDropdowns()" data-en="Refresh Categories" data-es="Actualizar CategorÃ­as">Refresh Categories</button>
            </div>

            <div class="form-section">
                <h3 data-en="Existing Categories" data-es="CategorÃ­as Existentes">Existing Categories</h3>
                <div id="categoriesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Budget Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Reports & Analytics" data-es="Reportes y AnÃ¡lisis">Reports & Analytics</h2>
                
                <!-- Report Type Selector -->
                <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;" data-en="Select Report Type:" data-es="Seleccionar Tipo de Reporte:">Select Report Type:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="budgetReportsBtn" class="btn btn-primary" onclick="switchReportType('budget')" style="flex: 1; min-width: 150px;" data-en="Budget Reports" data-es="Reportes de Presupuesto">Budget Reports</button>
                        <button id="canadaReportsBtn" class="btn" onclick="switchReportType('canada')" style="flex: 1; min-width: 150px; background: #6c757d; color: white;" data-en="Canada Reports" data-es="Reportes de CanadÃ¡">Canada Reports</button>
                    </div>
                </div>
                
                <!-- Budget Reports Section -->
                <div id="budgetReportsSection">
                    <h3 data-en="Budget Reports & Analytics" data-es="Reportes y AnÃ¡lisis de Presupuesto">Budget Reports & Analytics</h3>
                    <p data-en="View historical data, spending patterns, and detailed analytics for your budgets." data-es="Ve datos histÃ³ricos, patrones de gasto y anÃ¡lisis detallados de tus presupuestos.">View historical data, spending patterns, and detailed analytics for your budgets.</p>
                
                <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #0c5460;" data-en="Export All Items" data-es="Exportar Todos los ArtÃ­culos">Export All Items</h3>
                    <p style="color: #0c5460; margin-bottom: 10px;" data-en="Export all items from all categories (including Canada items) to Excel for re-entry. This will include items from your budget and all category databases." data-es="Exporta todos los artÃ­culos de todas las categorÃ­as (incluyendo artÃ­culos de CanadÃ¡) a Excel para reingresarlos. Esto incluirÃ¡ artÃ­culos de tu presupuesto y todas las bases de datos de categorÃ­as.">Export all items from all categories (including Canada items) to Excel for re-entry. This will include items from your budget and all category databases.</p>
                    <button class="btn btn-success" onclick="exportAllItemsToExcel()" data-en="Export All Items to Excel" data-es="Exportar Todos los ArtÃ­culos a Excel">Export All Items to Excel</button>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #856404;" data-en="Clear All Data" data-es="Limpiar Todos los Datos">Clear All Data</h3>
                    <p style="color: #856404; margin-bottom: 10px;" data-en="âš ï¸ WARNING: This will permanently delete ALL items, categories, and related data. This action cannot be undone. Make sure you have exported your data first if you need it later." data-es="âš ï¸ ADVERTENCIA: Esto eliminarÃ¡ permanentemente TODOS los artÃ­culos, categorÃ­as y datos relacionados. Esta acciÃ³n no se puede deshacer. AsegÃºrate de haber exportado tus datos primero si los necesitas mÃ¡s tarde.">âš ï¸ WARNING: This will permanently delete ALL items, categories, and related data. This action cannot be undone. Make sure you have exported your data first if you need it later.</p>
                    <button class="btn btn-danger" onclick="clearAllData()" data-en="Clear All Items and Categories" data-es="Limpiar Todos los ArtÃ­culos y CategorÃ­as">Clear All Items and Categories</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Report Type" data-es="Tipo de Reporte">Report Type</label>
                        <select id="reportType" onchange="loadReport()">
                            <option value="summary" data-en="Budget Summary" data-es="Resumen de Presupuesto">Budget Summary</option>
                            <option value="savedBudgets" data-en="Saved Budgets" data-es="Presupuestos Guardados">Saved Budgets</option>
                            <option value="byCategory" data-en="Spending by Category" data-es="Gastos por CategorÃ­a">Spending by Category</option>
                            <option value="bySupplier" data-en="Spending by Supplier" data-es="Gastos por Proveedor">Spending by Supplier</option>
                            <option value="byPriority" data-en="Spending by Priority" data-es="Gastos por Prioridad">Spending by Priority</option>
                            <option value="historical" data-en="Historical Trends" data-es="Tendencias HistÃ³ricas">Historical Trends</option>
                            <option value="itemAnalysis" data-en="Item Analysis" data-es="AnÃ¡lisis de ArtÃ­culos">Item Analysis</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-en="Date Range" data-es="Rango de Fechas">Date Range</label>
                        <select id="dateRange" onchange="loadReport()">
                            <option value="all" data-en="All Time" data-es="Todo el Tiempo">All Time</option>
                            <option value="last30" data-en="Last 30 Days" data-es="Ãšltimos 30 DÃ­as">Last 30 Days</option>
                            <option value="last90" data-en="Last 90 Days" data-es="Ãšltimos 90 DÃ­as">Last 90 Days</option>
                            <option value="lastYear" data-en="Last Year" data-es="Ãšltimo AÃ±o">Last Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-en="Filter by Item" data-es="Filtrar por ArtÃ­culo">Filter by Item</label>
                        <select id="reportItemFilter" onchange="loadReport()">
                            <option value="all" data-en="All Items" data-es="Todos los ArtÃ­culos">All Items</option>
                            <!-- Items will be populated dynamically -->
                        </select>
                    </div>
                </div>
                
                    <div id="reportContent" style="margin-top: 20px;">
                        <!-- Report content will be loaded here -->
                    </div>
                </div>
                
                <!-- Canada Reports Section -->
                <div id="canadaReportsSection" style="display: none;">
                    <h3 data-en="Canada Reports & Analytics" data-es="Reportes y AnÃ¡lisis de CanadÃ¡">Canada Reports & Analytics</h3>
                    <p data-en="View reports and analytics for Canada material requests, shipping status, and backorders." data-es="Ve reportes y anÃ¡lisis para solicitudes de materiales de CanadÃ¡, estado de envÃ­o y pedidos pendientes.">View reports and analytics for Canada material requests, shipping status, and backorders.</p>
                
                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Report Type" data-es="Tipo de Reporte">Report Type</label>
                            <select id="canadaReportType" onchange="loadCanadaReport()">
                                <option value="requestHistory" data-en="Request History Summary" data-es="Resumen del Historial de Solicitudes">Request History Summary</option>
                                <option value="shippingStatus" data-en="Shipping Status Report" data-es="Reporte de Estado de EnvÃ­o">Shipping Status Report</option>
                                <option value="backorders" data-en="Backorders Report" data-es="Reporte de Pedidos Pendientes">Backorders Report</option>
                                <option value="dutiesTaxes" data-en="Duties & Taxes Report" data-es="Reporte de Impuestos y Aranceles">Duties & Taxes Report</option>
                                <option value="deliveryTimeline" data-en="Delivery Timeline" data-es="LÃ­nea de Tiempo de Entrega">Delivery Timeline</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-en="Date Range" data-es="Rango de Fechas">Date Range</label>
                            <select id="canadaDateRange" onchange="loadCanadaReport()">
                                <option value="all" data-en="All Time" data-es="Todo el Tiempo">All Time</option>
                                <option value="last30" data-en="Last 30 Days" data-es="Ãšltimos 30 DÃ­as">Last 30 Days</option>
                                <option value="last90" data-en="Last 90 Days" data-es="Ãšltimos 90 DÃ­as">Last 90 Days</option>
                                <option value="lastYear" data-en="Last Year" data-es="Ãšltimo AÃ±o">Last Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-en="Filter by Item" data-es="Filtrar por ArtÃ­culo">Filter by Item</label>
                            <select id="canadaReportItemFilter" onchange="loadCanadaReport()">
                                <option value="all" data-en="All Items" data-es="Todos los ArtÃ­culos">All Items</option>
                                <!-- Items will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div id="canadaReportContent" style="margin-top: 20px;">
                        <!-- Canada report content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div id="monitorTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Budget Monitor & Alerts" data-es="Monitor de Presupuesto y Alertas">Budget Monitor & Alerts</h2>
                <p data-en="Track budget changes, set alerts, and monitor activity in real-time." data-es="Rastrea cambios en el presupuesto, configura alertas y monitorea la actividad en tiempo real.">Track budget changes, set alerts, and monitor activity in real-time.</p>
            </div>

            <!-- Budget Threshold Alerts -->
            <div class="form-section">
                <h3 data-en="Budget Threshold Alerts" data-es="Alertas de Umbral de Presupuesto">Budget Threshold Alerts</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Budget Limit (MXN)" data-es="LÃ­mite de Presupuesto (MXN)">Budget Limit (MXN)</label>
                        <input type="number" id="budgetLimit" step="0.01" min="0" placeholder="100000" onchange="saveBudgetSettings()">
                        <small data-en="Set a maximum budget limit to receive alerts" data-es="Establece un lÃ­mite mÃ¡ximo de presupuesto para recibir alertas">Set a maximum budget limit to receive alerts</small>
                    </div>
                    <div class="form-group">
                        <label data-en="Alert Threshold (%)" data-es="Umbral de Alerta (%)">Alert Threshold (%)</label>
                        <input type="number" id="alertThreshold" step="1" min="0" max="100" placeholder="80" onchange="saveBudgetSettings()">
                        <small data-en="Alert when budget reaches this percentage" data-es="Alerta cuando el presupuesto alcance este porcentaje">Alert when budget reaches this percentage</small>
                    </div>
                </div>
                <div id="budgetAlertStatus" style="margin-top: 15px;"></div>
            </div>

            <!-- Real-time Dashboard -->
            <div class="form-section">
                <h3 data-en="Real-time Dashboard" data-es="Panel en Tiempo Real">Real-time Dashboard</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="total-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="total-label" data-en="Current Budget" data-es="Presupuesto Actual">Current Budget</div>
                        <div class="total-value" id="monitorCurrentBudget" style="color: white;">$0.00 MXN</div>
                        <div class="total-subtitle" id="monitorBudgetPercentage" style="color: rgba(255,255,255,0.8);">0%</div>
                    </div>
                    <div class="total-item" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="total-label" data-en="Items Today" data-es="ArtÃ­culos Hoy">Items Today</div>
                        <div class="total-value" id="monitorItemsToday" style="color: white;">0</div>
                    </div>
                    <div class="total-item" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="total-label" data-en="Changes Today" data-es="Cambios Hoy">Changes Today</div>
                        <div class="total-value" id="monitorChangesToday" style="color: white;">0</div>
                    </div>
                    <div class="total-item" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="total-label" data-en="Pending Approval" data-es="Pendiente AprobaciÃ³n">Pending Approval</div>
                        <div class="total-value" id="monitorPendingApproval" style="color: white;">0</div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="form-section">
                <h3 data-en="Activity Log" data-es="Registro de Actividad">Activity Log</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="refreshActivityLog()" data-en="Refresh" data-es="Actualizar">Refresh</button>
                    <button class="btn btn-warning" onclick="clearActivityLog()" data-en="Clear Log" data-es="Limpiar Registro">Clear Log</button>
                    <button class="btn btn-success" onclick="exportActivityLog()" data-en="Export Log" data-es="Exportar Registro">Export Log</button>
                </div>
                <div id="activityLog" style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <!-- Activity log entries will be loaded here -->
                </div>
            </div>

            <!-- Change History -->
            <div class="form-section">
                <h3 data-en="Change History" data-es="Historial de Cambios">Change History</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label data-en="Filter by Item" data-es="Filtrar por ArtÃ­culo">Filter by Item</label>
                        <select id="historyItemFilter" onchange="loadChangeHistory()">
                            <option value="" data-en="All Items" data-es="Todos los ArtÃ­culos">All Items</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-en="Filter by Type" data-es="Filtrar por Tipo">Filter by Type</label>
                        <select id="historyTypeFilter" onchange="loadChangeHistory()">
                            <option value="" data-en="All Changes" data-es="Todos los Cambios">All Changes</option>
                            <option value="added" data-en="Added" data-es="Agregado">Added</option>
                            <option value="updated" data-en="Updated" data-es="Actualizado">Updated</option>
                            <option value="deleted" data-en="Deleted" data-es="Eliminado">Deleted</option>
                            <option value="approved" data-en="Approved" data-es="Aprobado">Approved</option>
                            <option value="denied" data-en="Denied" data-es="Rechazado">Denied</option>
                        </select>
                    </div>
                </div>
                <div id="changeHistory" style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <!-- Change history will be loaded here -->
                </div>
            </div>

            <!-- Notifications Settings -->
            <div class="form-section">
                <h3 data-en="Notification Settings" data-es="ConfiguraciÃ³n de Notificaciones">Notification Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNotifications" onchange="saveNotificationSettings()">
                            <span data-en="Enable Browser Notifications" data-es="Habilitar Notificaciones del Navegador">Enable Browser Notifications</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="alertOnThreshold" onchange="saveNotificationSettings()">
                            <span data-en="Alert on Budget Threshold" data-es="Alerta en Umbral de Presupuesto">Alert on Budget Threshold</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="alertOnChanges" onchange="saveNotificationSettings()">
                            <span data-en="Alert on Budget Changes" data-es="Alerta en Cambios de Presupuesto">Alert on Budget Changes</span>
                        </label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="requestNotificationPermission()" data-en="Request Notification Permission" data-es="Solicitar Permiso de Notificaciones">Request Notification Permission</button>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alertsTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Alerts & Receipt Tracking" data-es="Alertas y Seguimiento de Recibos">Alerts & Receipt Tracking</h2>
                <p data-en="Track items missing receipts and monitor budget vs actual spending differences." data-es="Rastrea artÃ­culos sin recibos y monitorea las diferencias entre presupuesto y gasto real.">Track items missing receipts and monitor budget vs actual spending differences.</p>
            </div>

            <!-- Items Missing Receipts -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Items Missing Receipts" data-es="ArtÃ­culos Sin Recibos">Items Missing Receipts</h3>
                <p data-en="Items that were added to the budget but don't have a receipt photo attached." data-es="ArtÃ­culos que se agregaron al presupuesto pero no tienen una foto de recibo adjunta.">Items that were added to the budget but don't have a receipt photo attached.</p>
                <div id="missingReceiptsList" style="margin-top: 15px;">
                    <!-- Missing receipts will be loaded here -->
                </div>
            </div>

            <!-- Weekly Budgets vs Actual -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Weekly Budgets vs Actual Spending" data-es="Presupuestos Semanales vs Gasto Real">Weekly Budgets vs Actual Spending</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;" data-en="View budget vs actual spending for each saved weekly budget, organized by date and week of the year." data-es="Ve el presupuesto vs gasto real para cada presupuesto semanal guardado, organizado por fecha y semana del aÃ±o.">View budget vs actual spending for each saved weekly budget, organized by date and week of the year.</p>
                <div id="weeklyBudgetsVsActual" style="margin-top: 15px;">
                    <!-- Weekly budgets will be loaded here -->
                </div>
            </div>

            <!-- Current Budget vs Actual Balance -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Current Budget vs Actual Spending" data-es="Presupuesto Actual vs Gasto Real">Current Budget vs Actual Spending</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="total-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="total-label" data-en="Total Budgeted" data-es="Total Presupuestado">Total Budgeted</div>
                        <div class="total-value" id="totalBudgeted" style="color: white;">$0.00 MXN</div>
                    </div>
                    <div class="total-item" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="total-label" data-en="Total Actual (Receipts)" data-es="Total Real (Recibos)">Total Actual (Receipts)</div>
                        <div class="total-value" id="totalActual" style="color: white;">$0.00 MXN</div>
                    </div>
                    <div class="total-item" id="balanceCard" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="total-label" data-en="Running Balance" data-es="Balance Acumulado">Running Balance</div>
                        <div class="total-value" id="runningBalance" style="color: white;">$0.00 MXN</div>
                        <div class="total-subtitle" id="balanceStatus" style="color: rgba(255,255,255,0.8);"></div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h4 data-en="Item-by-Item Comparison" data-es="ComparaciÃ³n ArtÃ­culo por ArtÃ­culo">Item-by-Item Comparison</h4>
                    <div id="itemComparisonList" style="margin-top: 15px;">
                        <!-- Item comparisons will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Canada Tab -->
        <div id="canadaTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Can/Mex Material Requests" data-es="Solicitudes de Materiales Can/Mex">Can/Mex Material Requests</h2>
                <p data-en="Canada requesting materials from Mexico. Items marked as 'Available for Canada Requests' will appear here." data-es="CanadÃ¡ solicitando materiales de MÃ©xico. Los artÃ­culos marcados como 'Disponible para Solicitudes de CanadÃ¡' aparecerÃ¡n aquÃ­.">Canada requesting materials from Mexico. Items marked as 'Available for Canada Requests' will appear here.</p>
            </div>

            <!-- Current Request -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Select Materials" data-es="Seleccionar Materiales">Select Materials</h3>
                <div id="canadaItemsList" style="margin-top: 15px;">
                    <!-- Canada items will be loaded here -->
                </div>
            </div>

            <!-- Request Summary -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Request Summary" data-es="Resumen de Solicitud">Request Summary</h3>
                <div id="canadaRequestSummary" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p style="color: #7f8c8d; text-align: center;" data-en="No items selected yet" data-es="AÃºn no se han seleccionado artÃ­culos">No items selected yet</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="generateCanadaRequest()" data-en="Generate Request" data-es="Generar Solicitud">Generate Request</button>
                    <button class="btn btn-primary" onclick="exportCanadaRequest()" data-en="Export Request List" data-es="Exportar Lista de Solicitud">Export Request List</button>
                    <button class="btn btn-warning" onclick="clearCanadaSelection()" data-en="Clear Selection" data-es="Limpiar SelecciÃ³n">Clear Selection</button>
                </div>
            </div>

            <!-- Canada EmailJS Configuration -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 data-en="Email Configuration for Canada Requests" data-es="ConfiguraciÃ³n de Correo para Solicitudes de CanadÃ¡">Email Configuration for Canada Requests</h3>
                    <button class="btn btn-sm" onclick="toggleCanadaEmailConfig()" id="canadaEmailConfigToggle" style="background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;" data-en="Show Configuration" data-es="Mostrar ConfiguraciÃ³n">Show Configuration</button>
                </div>
                <div id="canadaEmailConfigDetails" style="display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <small style="color: #666; display: block; margin-bottom: 10px;" data-en="Configure EmailJS to automatically email Canada requests. Uses the same EmailJS account but can use a different template." data-es="Configura EmailJS para enviar automÃ¡ticamente solicitudes de CanadÃ¡. Usa la misma cuenta de EmailJS pero puede usar una plantilla diferente.">Configure EmailJS to automatically email Canada requests. Uses the same EmailJS account but can use a different template.</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Service ID (for Canada requests)" data-es="ID de Servicio de EmailJS (para solicitudes de CanadÃ¡)">EmailJS Service ID (for Canada requests)</label>
                        <input type="text" id="canadaEmailjsServiceId" placeholder="service_xxxxx"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                                onchange="saveCanadaEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Leave empty to use main EmailJS service ID" data-es="Deja vacÃ­o para usar el ID de servicio principal de EmailJS">Leave empty to use main EmailJS service ID</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Template ID (for Canada requests)" data-es="ID de Plantilla de EmailJS (para solicitudes de CanadÃ¡)">EmailJS Template ID (for Canada requests)</label>
                        <input type="text" id="canadaEmailjsTemplateId" placeholder="template_xxxxx"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                                onchange="saveCanadaEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Template should include {{pdf_attachment}} and {{pdf_filename}} variables for PDF attachment" data-es="La plantilla debe incluir las variables {{pdf_attachment}} y {{pdf_filename}} para el adjunto PDF">Template should include <code>{{pdf_attachment}}</code> and <code>{{pdf_filename}}</code> variables for PDF attachment</small>
                    </div>
                    <div class="form-group">
                        <label data-en="Recipient Emails (comma-separated)" data-es="Correos Destinatarios (separados por comas)">Recipient Emails (comma-separated)</label>
                        <input type="text" id="canadaRecipientEmails" 
                                placeholder="shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com"
                                value="shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                                onchange="saveCanadaEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Emails that will receive Canada material requests" data-es="Correos que recibirÃ¡n solicitudes de materiales de CanadÃ¡">Emails that will receive Canada material requests</small>
                    </div>
                    <button class="btn btn-success" onclick="testCanadaEmailJS()" style="margin-top: 10px;" data-en="Test Canada Request Email" data-es="Probar Correo de Solicitud de CanadÃ¡">Test Canada Request Email</button>
                </div>
            </div>

            <!-- Backorders Summary -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">
                <h3 style="color: #d68910; margin-bottom: 15px;" data-en="Backorders Summary" data-es="Resumen de Pedidos Pendientes">Backorders Summary</h3>
                <div id="backordersSummary" style="min-height: 50px;">
                    <!-- Backorders will be loaded here -->
                </div>
            </div>

            <!-- Request History -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;" data-en="Request History" data-es="Historial de Solicitudes">Request History</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="migrateCanadaRequestsBtn" class="btn btn-warning" onclick="migrateCanadaRequestsFromLocalStorage()" style="padding: 8px 15px; font-size: 0.9rem; display: none;" data-en="Migrate to Supabase" data-es="Migrar a Supabase" title="Migrate requests from localStorage to Supabase">Migrate to Supabase</button>
                        <button class="btn btn-primary" onclick="checkAllTrackingNumbers()" style="padding: 8px 15px; font-size: 0.9rem;" data-en="Refresh Tracking Status" data-es="Actualizar Estado de Seguimiento">Refresh Tracking Status</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <select id="canadaHistoryFilter" onchange="loadCanadaHistory().catch(err => console.error('Error:', err))" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; max-width: 300px;">
                        <option value="all" data-en="All Requests" data-es="Todas las Solicitudes" selected>All Requests</option>
                        <option value="pending" data-en="Pending" data-es="Pendientes">Pending</option>
                        <option value="sent" data-en="Sent" data-es="Enviadas">Sent</option>
                        <option value="received" data-en="Received" data-es="Recibidas">Received</option>
                        <option value="backorders" data-en="With Backorders" data-es="Con Pedidos Pendientes">With Backorders</option>
                        <option value="duties" data-en="Duties/Taxes Due" data-es="Impuestos/Aranceles Pendientes">Duties/Taxes Due</option>
                        <option value="delays" data-en="With Delays/Exceptions" data-es="Con Retrasos/Excepciones">With Delays/Exceptions</option>
                        <option value="in_transit" data-en="In Transit" data-es="En TrÃ¡nsito">In Transit</option>
                        <option value="delivered" data-en="Delivered" data-es="Entregado">Delivered</option>
                    </select>
                </div>
                <div id="canadaRequestHistory" style="margin-top: 15px;">
                    <!-- Request history will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Mex/Can Tab (Mexico requesting from Canada) -->
        <div id="mexcanTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Mex/Can Material Requests" data-es="Solicitudes de Materiales Mex/Can">Mex/Can Material Requests</h2>
                <p data-en="Mexico requesting materials from Canada. Items marked as 'Available for Mexico Requests' will appear here." data-es="MÃ©xico solicitando materiales de CanadÃ¡. Los artÃ­culos marcados como 'Disponible para Solicitudes de MÃ©xico' aparecerÃ¡n aquÃ­.">Mexico requesting materials from Canada. Items marked as 'Available for Mexico Requests' will appear here.</p>
            </div>

            <!-- Current Request -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Select Materials" data-es="Seleccionar Materiales">Select Materials</h3>
                <div id="mexcanItemsList" style="margin-top: 15px;">
                    <!-- Mexico items will be loaded here -->
                </div>
            </div>

            <!-- Request Summary -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 data-en="Request Summary" data-es="Resumen de Solicitud">Request Summary</h3>
                <div id="mexcanRequestSummary" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p style="color: #7f8c8d; text-align: center;" data-en="No items selected yet" data-es="AÃºn no se han seleccionado artÃ­culos">No items selected yet</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="generateMexcanRequest()" data-en="Generate Request" data-es="Generar Solicitud">Generate Request</button>
                    <button class="btn btn-primary" onclick="exportMexcanRequest()" data-en="Export Request List" data-es="Exportar Lista de Solicitud">Export Request List</button>
                    <button class="btn btn-warning" onclick="clearMexcanSelection()" data-en="Clear Selection" data-es="Limpiar SelecciÃ³n">Clear Selection</button>
                </div>
            </div>

            <!-- Mex/Can EmailJS Configuration -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 data-en="Email Configuration for Mex/Can Requests" data-es="ConfiguraciÃ³n de Correo para Solicitudes Mex/Can">Email Configuration for Mex/Can Requests</h3>
                    <button class="btn btn-sm" onclick="toggleMexcanEmailConfig()" id="mexcanEmailConfigToggle" style="background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;" data-en="Show Configuration" data-es="Mostrar ConfiguraciÃ³n">Show Configuration</button>
                </div>
                <div id="mexcanEmailConfigDetails" style="display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <small style="color: #666; display: block; margin-bottom: 10px;" data-en="Configure EmailJS to automatically email Mex/Can requests. Uses the same EmailJS account but can use a different template." data-es="Configura EmailJS para enviar automÃ¡ticamente solicitudes Mex/Can. Usa la misma cuenta de EmailJS pero puede usar una plantilla diferente.">Configure EmailJS to automatically email Mex/Can requests. Uses the same EmailJS account but can use a different template.</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Service ID (for Mex/Can requests)" data-es="ID de Servicio de EmailJS (para solicitudes Mex/Can)">EmailJS Service ID (for Mex/Can requests)</label>
                        <input type="text" id="mexcanEmailjsServiceId" placeholder="service_xxxxx"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                                onchange="saveMexcanEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Leave empty to use main EmailJS service ID" data-es="Deja vacÃ­o para usar el ID de servicio principal de EmailJS">Leave empty to use main EmailJS service ID</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Template ID (for Mex/Can requests)" data-es="ID de Plantilla de EmailJS (para solicitudes Mex/Can)">EmailJS Template ID (for Mex/Can requests)</label>
                        <input type="text" id="mexcanEmailjsTemplateId" placeholder="template_xxxxx"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                                onchange="saveMexcanEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Template should include {{pdf_attachment}} and {{pdf_filename}} variables for PDF attachment" data-es="La plantilla debe incluir las variables {{pdf_attachment}} y {{pdf_filename}} para el adjunto PDF">Template should include <code>{{pdf_attachment}}</code> and <code>{{pdf_filename}}</code> variables for PDF attachment</small>
                    </div>
                    <div class="form-group">
                        <label data-en="Recipient Emails (comma-separated)" data-es="Correos Destinatarios (separados por comas)">Recipient Emails (comma-separated)</label>
                        <input type="text" id="mexcanRecipientEmails" 
                                placeholder="mexico@oolab.com, shipping@oolab.com"
                                value=""
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                                onchange="saveMexcanEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Emails that will receive Mex/Can material requests" data-es="Correos que recibirÃ¡n solicitudes de materiales Mex/Can">Emails that will receive Mex/Can material requests</small>
                    </div>
                    <button class="btn btn-success" onclick="testMexcanEmailJS()" style="margin-top: 10px;" data-en="Test Mex/Can Request Email" data-es="Probar Correo de Solicitud Mex/Can">Test Mex/Can Request Email</button>
                </div>
            </div>

            <!-- Backorders Summary -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #f39c12;">
                <h3 style="color: #d68910; margin-bottom: 15px;" data-en="Backorders Summary" data-es="Resumen de Pedidos Pendientes">Backorders Summary</h3>
                <div id="mexcanBackordersSummary" style="min-height: 50px;">
                    <!-- Backorders will be loaded here -->
                </div>
            </div>

            <!-- Request History -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;" data-en="Request History" data-es="Historial de Solicitudes">Request History</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="migrateMexcanRequestsBtn" class="btn btn-warning" onclick="migrateMexcanRequestsFromLocalStorage()" style="padding: 8px 15px; font-size: 0.9rem; display: none;" data-en="Migrate to Supabase" data-es="Migrar a Supabase" title="Migrate requests from localStorage to Supabase">Migrate to Supabase</button>
                        <button class="btn btn-primary" onclick="checkAllMexcanTrackingNumbers()" style="padding: 8px 15px; font-size: 0.9rem;" data-en="Refresh Tracking Status" data-es="Actualizar Estado de Seguimiento">Refresh Tracking Status</button>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <select id="mexcanHistoryFilter" onchange="loadMexcanHistory().catch(err => console.error('Error:', err))" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; max-width: 300px;">
                        <option value="all" data-en="All Requests" data-es="Todas las Solicitudes" selected>All Requests</option>
                        <option value="pending" data-en="Pending" data-es="Pendientes">Pending</option>
                        <option value="sent" data-en="Sent" data-es="Enviadas">Sent</option>
                        <option value="received" data-en="Received" data-es="Recibidas">Received</option>
                        <option value="backorders" data-en="With Backorders" data-es="Con Pedidos Pendientes">With Backorders</option>
                        <option value="duties" data-en="Duties/Taxes Due" data-es="Impuestos/Aranceles Pendientes">Duties/Taxes Due</option>
                        <option value="delays" data-en="With Delays/Exceptions" data-es="Con Retrasos/Excepciones">With Delays/Exceptions</option>
                        <option value="in_transit" data-en="In Transit" data-es="En TrÃ¡nsito">In Transit</option>
                        <option value="delivered" data-en="Delivered" data-es="Entregado">Delivered</option>
                    </select>
                </div>
                <div id="mexcanRequestHistory" style="margin-top: 15px;">
                    <!-- Request history will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="form-section">
                <h2 data-en="Settings" data-es="ConfiguraciÃ³n">Settings</h2>
                <p data-en="Configure email notifications and translation services." data-es="Configura las notificaciones por correo y los servicios de traducciÃ³n.">Configure email notifications and translation services.</p>
            </div>

            <!-- Email Settings Section -->
            <div class="email-settings" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;" data-en="Email Notifications" data-es="Notificaciones por Correo">Email Notifications</h3>
                    <button class="btn btn-sm" onclick="toggleEmailConfig()" id="emailConfigToggle" style="background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;" data-en="Show Configuration" data-es="Mostrar ConfiguraciÃ³n">Show Configuration</button>
                </div>
                <div class="form-group">
                    <label data-en="Email List for Save & Clear (comma-separated)" data-es="Lista de Correos para Guardar y Limpiar (separados por comas)">Email List for Save & Clear (comma-separated)</label>
                    <input type="text" id="saveClearEmailList" placeholder="mike@oolab.com, manager@company.com" 
                           value="mike@oolab.com, accounting@oolab.com, graeme@oolab.com, consufis@gmail.com, josejuanpalafoxrodriguez@gmail.com" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onchange="saveEmailList()">
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="Emails will receive PDF and Excel attachments when 'Save & Clear' is clicked" data-es="Los correos recibirÃ¡n archivos PDF y Excel cuando se haga clic en 'Guardar y Limpiar'">Emails will receive PDF and Excel attachments when 'Save & Clear' is clicked</small>
                </div>
                
                <!-- EmailJS Configuration (Collapsible) -->
                <div id="emailConfigDetails" style="display: none; border-top: 2px solid #e1e8ed; margin-top: 20px; padding-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;" data-en="EmailJS Configuration (for automatic attachments)" data-es="ConfiguraciÃ³n de EmailJS (para adjuntos automÃ¡ticos)">EmailJS Configuration (for automatic attachments)</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <small style="color: #666; display: block; margin-bottom: 10px;" data-en="To enable automatic email attachments, sign up at https://www.emailjs.com/ and create a service and template. Then enter your credentials below." data-es="Para habilitar adjuntos automÃ¡ticos de correo, regÃ­strate en https://www.emailjs.com/ y crea un servicio y plantilla. Luego ingresa tus credenciales a continuaciÃ³n.">To enable automatic email attachments, sign up at <a href="https://www.emailjs.com/" target="_blank">https://www.emailjs.com/</a> and create a service and template. Then enter your credentials below.</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Public Key" data-es="Clave PÃºblica de EmailJS">EmailJS Public Key</label>
                        <input type="text" id="emailjsPublicKey" placeholder="user_xxxxxxxxxxxxx" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                               onchange="saveEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in EmailJS Dashboard â†’ Account â†’ API Keys" data-es="Se encuentra en EmailJS Dashboard â†’ Account â†’ API Keys">Found in EmailJS Dashboard â†’ Account â†’ API Keys</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Service ID" data-es="ID de Servicio de EmailJS">EmailJS Service ID</label>
                        <input type="text" id="emailjsServiceId" placeholder="service_xxxxx" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                               onchange="saveEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in EmailJS Dashboard â†’ Email Services" data-es="Se encuentra en EmailJS Dashboard â†’ Email Services">Found in EmailJS Dashboard â†’ Email Services</small>
                    </div>
                    <div class="form-group">
                        <label data-en="EmailJS Template ID" data-es="ID de Plantilla de EmailJS">EmailJS Template ID</label>
                        <input type="text" id="emailjsTemplateId" placeholder="template_xxxxx" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                               onchange="saveEmailJSSettings()">
                        <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in EmailJS Dashboard â†’ Email Templates. Make sure to configure attachments in your template using {{pdf_attachment}}, {{excel_attachment}}, {{pdf_filename}}, and {{excel_filename}} variables." data-es="Se encuentra en EmailJS Dashboard â†’ Email Templates. AsegÃºrate de configurar adjuntos en tu plantilla usando las variables {{pdf_attachment}}, {{excel_attachment}}, {{pdf_filename}} y {{excel_filename}}.">Found in EmailJS Dashboard â†’ Email Templates. Make sure to configure attachments in your template using <code>{{pdf_attachment}}</code>, <code>{{excel_attachment}}</code>, <code>{{pdf_filename}}</code>, and <code>{{excel_filename}}</code> variables.</small>
                    </div>
                    <button class="btn btn-success" onclick="testEmailJSConnection()" style="margin-top: 10px;" data-en="Test EmailJS Connection" data-es="Probar ConexiÃ³n de EmailJS">Test EmailJS Connection</button>
                </div>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label data-en="Recipient Email" data-es="Correo del Destinatario">Recipient Email</label>
                        <input type="email" id="recipientEmail" placeholder="manager@company.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label data-en="Subject" data-es="Asunto">Subject</label>
                        <input type="text" id="emailSubject" placeholder="Budget Approval Notification" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div class="form-group">
                    <label data-en="Message" data-es="Mensaje">Message</label>
                    <textarea id="emailMessage" rows="3" placeholder="The budget has been approved and is ready for review." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-info" onclick="testEmail()" data-en="Test Email" data-es="Probar Correo">Test Email</button>
            </div>

            <!-- DeepL Translation API Configuration -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #2c3e50;" data-en="Translation API (DeepL)" data-es="API de TraducciÃ³n (DeepL)">Translation API (DeepL)</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <small style="color: #666; display: block; margin-bottom: 10px;" data-en="To enable automatic translation of item names, descriptions, notes, and category names, sign up for a free DeepL API key at https://www.deepl.com/pro-api. The free tier includes 500,000 characters per month." data-es="Para habilitar la traducciÃ³n automÃ¡tica de nombres de artÃ­culos, descripciones, notas y nombres de categorÃ­as, regÃ­strate para una clave API gratuita de DeepL en https://www.deepl.com/pro-api. El nivel gratuito incluye 500,000 caracteres por mes.">To enable automatic translation of item names, descriptions, notes, and category names, sign up for a free DeepL API key at <a href="https://www.deepl.com/pro-api" target="_blank">https://www.deepl.com/pro-api</a>. The free tier includes 500,000 characters per month.</small>
                </div>
                <div class="form-group">
                    <label data-en="DeepL API Key" data-es="Clave API de DeepL">DeepL API Key</label>
                    <input type="password" id="deeplApiKey" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:fx" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                           onchange="saveDeepLSettings()">
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in DeepL Account â†’ Account â†’ API Keys. Free tier keys end with ':fx'" data-es="Se encuentra en DeepL Account â†’ Account â†’ API Keys. Las claves del nivel gratuito terminan con ':fx'">Found in DeepL Account â†’ Account â†’ API Keys. Free tier keys end with <code>:fx</code></small>
                </div>
                <button class="btn btn-info" onclick="testDeepLConnection()" style="margin-top: 10px;" data-en="Test DeepL Connection" data-es="Probar ConexiÃ³n de DeepL">Test DeepL Connection</button>
                <button class="btn btn-success" onclick="translateAllItemsAndCategories()" style="margin-top: 10px; margin-left: 10px;" data-en="Translate All Items & Categories" data-es="Traducir Todos los ArtÃ­culos y CategorÃ­as">Translate All Items & Categories</button>
                <small style="color: #666; display: block; margin-top: 10px;" data-en="Click 'Translate All Items & Categories' to translate all items in all categories and update missing translations." data-es="Haz clic en 'Traducir Todos los ArtÃ­culos y CategorÃ­as' para traducir todos los artÃ­culos en todas las categorÃ­as y actualizar las traducciones faltantes.">Click 'Translate All Items & Categories' to translate all items in all categories and update missing translations.</small>
            </div>

            <!-- UPS Tracking API Configuration -->
            <div class="form-section" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #2c3e50;" data-en="UPS Tracking API" data-es="API de Seguimiento de UPS">UPS Tracking API</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <small style="color: #666; display: block; margin-bottom: 10px;" data-en="To enable automatic status updates when packages are delivered, sign up for a UPS Developer account at https://developer.ups.com/. The system will automatically check tracking numbers and update status to 'Received' when delivered." data-es="Para habilitar actualizaciones automÃ¡ticas de estado cuando los paquetes sean entregados, regÃ­strate para una cuenta de desarrollador de UPS en https://developer.ups.com/. El sistema verificarÃ¡ automÃ¡ticamente los nÃºmeros de seguimiento y actualizarÃ¡ el estado a 'Recibido' cuando se entregue.">To enable automatic status updates when packages are delivered, sign up for a UPS Developer account at <a href="https://developer.ups.com/" target="_blank">https://developer.ups.com/</a>. The system will automatically check tracking numbers and update status to 'Received' when delivered.</small>
                </div>
                <div class="form-group">
                    <label data-en="UPS Client ID (Access Key)" data-es="ID de Cliente de UPS (Clave de Acceso)">UPS Client ID (Access Key)</label>
                    <input type="text" id="upsClientId" placeholder="Your UPS Client ID" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                           onchange="saveUPSSettings()">
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in UPS Developer Portal â†’ Apps â†’ Your App â†’ Client ID" data-es="Se encuentra en UPS Developer Portal â†’ Apps â†’ Your App â†’ Client ID">Found in UPS Developer Portal â†’ Apps â†’ Your App â†’ Client ID</small>
                </div>
                <div class="form-group">
                    <label data-en="UPS Client Secret" data-es="Secreto de Cliente de UPS">UPS Client Secret</label>
                    <input type="password" id="upsClientSecret" placeholder="Your UPS Client Secret" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                           onchange="saveUPSSettings()">
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="Found in UPS Developer Portal â†’ Apps â†’ Your App â†’ Client Secret" data-es="Se encuentra en UPS Developer Portal â†’ Apps â†’ Your App â†’ Client Secret">Found in UPS Developer Portal â†’ Apps â†’ Your App â†’ Client Secret</small>
                </div>
                <div class="form-group">
                    <label data-en="Proxy Server URL (Required)" data-es="URL del Servidor Proxy (Requerido)">Proxy Server URL (Required)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="upsProxyUrl" placeholder="https://your-app.railway.app" 
                               value="${localStorage.getItem('upsProxyUrl') || ''}"
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"
                               onchange="saveUPSSettings()">
                        <button type="button" onclick="clearProxyUrl()" class="btn btn-secondary" style="white-space: nowrap;" data-en="Clear" data-es="Limpiar">Clear</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="âš ï¸ REQUIRED: The UPS API requires a proxy server due to CORS restrictions. Enter your deployed proxy server URL (e.g., Railway, Render, Heroku). If your proxy returns 404, check that it's deployed and the endpoints are correct. See DEPLOYMENT_GUIDE.md for setup instructions." data-es="âš ï¸ REQUERIDO: La API de UPS requiere un servidor proxy debido a restricciones CORS. Ingresa la URL de tu servidor proxy desplegado (ej: Railway, Render, Heroku). Si tu proxy devuelve 404, verifica que estÃ© desplegado y que los endpoints sean correctos. Ver DEPLOYMENT_GUIDE.md para instrucciones.">âš ï¸ <strong>REQUIRED:</strong> The UPS API requires a proxy server due to CORS restrictions. Enter your deployed proxy server URL (e.g., Railway, Render, Heroku). If your proxy returns 404, check that it's deployed and the endpoints are correct. See DEPLOYMENT_GUIDE.md for setup instructions.</small>
                </div>
                <div class="form-group">
                    <label data-en="Check Tracking Interval (hours)" data-es="Intervalo de VerificaciÃ³n de Seguimiento (horas)">Check Tracking Interval (hours)</label>
                    <input type="number" id="upsCheckInterval" placeholder="6" min="1" max="24" value="6"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onchange="saveUPSSettings()">
                    <small style="color: #666; display: block; margin-top: 5px;" data-en="How often to check tracking status (1-24 hours). Default is 6 hours." data-es="Con quÃ© frecuencia verificar el estado de seguimiento (1-24 horas). El valor predeterminado es 6 horas.">How often to check tracking status (1-24 hours). Default is 6 hours.</small>
                </div>
                <button class="btn btn-info" onclick="testUPSTracking()" style="margin-top: 10px;" data-en="Test UPS Tracking" data-es="Probar Seguimiento de UPS">Test UPS Tracking</button>
                <button class="btn btn-primary" onclick="checkAllTrackingNumbers()" style="margin-top: 10px; margin-left: 10px;" data-en="Check All Tracking Now" data-es="Verificar Todos los Seguimientos Ahora">Check All Tracking Now</button>
            </div>

            <!-- Backup & Restore Section -->
            <div class="form-section" style="background: #fff3cd; border: 2px solid #ffc107; margin-top: 25px;">
                <h2 style="color: #856404;" data-en="âš ï¸ Backup & Restore" data-es="âš ï¸ Respaldo y Restaurar">âš ï¸ Backup & Restore</h2>
                <p style="color: #856404;" data-en="Export your complete data to a backup file, or import from a previous backup." data-es="Exporta tus datos completos a un archivo de respaldo, o importa desde un respaldo anterior.">Export your complete data to a backup file, or import from a previous backup.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <button class="btn btn-warning" onclick="exportCategoriesAndItems()" style="font-size: 1rem; padding: 12px 20px;" data-en="Export Complete Backup" data-es="Exportar Respaldo Completo">Export Complete Backup</button>
                        <small style="display: block; margin-top: 5px;" data-en="Download a complete backup file including: categories, items, Canada requests, saved budgets, activity logs, and all settings" data-es="Descargar un archivo de respaldo completo que incluye: categorÃ­as, artÃ­culos, solicitudes de CanadÃ¡, presupuestos guardados, registros de actividad y todas las configuraciones">Download a complete backup file including: categories, items, Canada requests, saved budgets, activity logs, and all settings</small>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" onclick="exportCompleteBackupWithSupabase()" style="font-size: 1rem; padding: 12px 20px;" data-en="Export Full Backup (with Supabase)" data-es="Exportar Respaldo Completo (con Supabase)">Export Full Backup (with Supabase)</button>
                        <small style="display: block; margin-top: 5px;" data-en="Export ALL data including Supabase: requests, tracking shipments, items, budgets, and settings. You can choose to save to Desktop/Budget manager folder." data-es="Exporta TODOS los datos incluyendo Supabase: solicitudes, envÃ­os de seguimiento, artÃ­culos, presupuestos y configuraciones. Puedes elegir guardar en la carpeta Escritorio/Budget manager.">Export ALL data including Supabase: requests, tracking shipments, items, budgets, and settings. You can choose to save to Desktop/Budget manager folder.</small>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;" data-en="Import Backup" data-es="Importar Respaldo">Import Backup</label>
                        <input type="file" id="importCategoriesFile" accept=".json" onchange="importCategoriesAndItems(event)" style="padding: 8px; width: 100%;">
                        <small style="display: block; margin-top: 5px;" data-en="Select a previously exported JSON file to restore" data-es="Selecciona un archivo JSON exportado previamente para restaurar">Select a previously exported JSON file to restore</small>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196F3;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;" data-en="Enable Automatic Backup" data-es="Habilitar Respaldo AutomÃ¡tico">Enable Automatic Backup</span>
                    </label>
                    <div style="margin-top: 10px; margin-left: 28px;">
                        <label style="display: block; margin-bottom: 5px;" data-en="Backup Frequency:" data-es="Frecuencia de Respaldo:">Backup Frequency:</label>
                        <select id="backupFrequency" onchange="updateAutoBackupSchedule()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="daily" data-en="Daily" data-es="Diario">Daily</option>
                            <option value="weekly" data-en="Weekly" data-es="Semanal">Weekly</option>
                            <option value="monthly" data-en="Monthly" data-es="Mensual">Monthly</option>
                        </select>
                        <small style="display: block; margin-top: 5px; color: #666;" data-en="Automatic backups will download to your default download folder. You can move them to Desktop/Budget manager folder." data-es="Los respaldos automÃ¡ticos se descargarÃ¡n en tu carpeta de descargas predeterminada. Puedes moverlos a la carpeta Escritorio/Budget manager.">Automatic backups will download to your default download folder. You can move them to Desktop/Budget manager folder.</small>
                    </div>
                </div>
                
                <div id="backupStatus" style="margin-top: 15px; padding: 15px; border-radius: 5px; display: none; font-size: 1rem;"></div>
            </div>
        </div>

    </div>

    <!-- Tracking Number Modal -->
    <!-- Persistent Duties/Taxes Alert Banner -->
    <div id="dutiesAlertBanner" class="duties-alert-banner">
        <div class="duties-alert-content">
            <div class="duties-alert-message">
                <h3>ðŸ’° <span data-en="Duties/Taxes Payment Required" data-es="Pago de Impuestos/Aranceles Requerido">Duties/Taxes Payment Required</span></h3>
                <p id="dutiesAlertDetails" data-en="One or more shipments require payment of duties/taxes. Click 'Accept & View' to see details." data-es="Uno o mÃ¡s envÃ­os requieren pago de impuestos/aranceles. Haz clic en 'Aceptar y Ver' para ver los detalles.">One or more shipments require payment of duties/taxes. Click 'Accept & View' to see details.</p>
            </div>
            <div class="duties-alert-actions">
                <button class="duties-alert-btn accept" onclick="acceptDutiesAlert()" data-en="Accept & View" data-es="Aceptar y Ver">Accept & View</button>
                <button class="duties-alert-btn" onclick="dismissDutiesAlert()" data-en="Dismiss" data-es="Descartar">Dismiss</button>
            </div>
        </div>
    </div>

    <div id="trackingModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="trackingModalTitle" data-en="Mark Request as Sent" data-es="Marcar Solicitud como Enviada">Mark Request as Sent</h2>
                <button class="close" onclick="closeTrackingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="trackingModalContent">
                    <!-- Content will be dynamically generated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-en="Edit Item" data-es="Editar ArtÃ­culo">Edit Item</h2>
                <button class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Item Name (English)" data-es="Nombre del ArtÃ­culo (InglÃ©s)">Item Name (English)</label>
                            <input type="text" id="editNameEn" required>
                        </div>
                        <div class="form-group">
                            <label data-en="Item Name (Spanish)" data-es="Nombre del ArtÃ­culo (EspaÃ±ol)">Item Name (Spanish)</label>
                            <input type="text" id="editNameEs" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Description (English)" data-es="DescripciÃ³n (InglÃ©s)">Description (English)</label>
                            <textarea id="editDescriptionEn" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label data-en="Description (Spanish)" data-es="DescripciÃ³n (EspaÃ±ol)">Description (Spanish)</label>
                            <textarea id="editDescriptionEs" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Category" data-es="CategorÃ­a">Category</label>
                            <select id="editCategory" required>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-en="Unit Price (MXN)" data-es="Precio Unitario (MXN)">Unit Price (MXN)</label>
                            <input type="number" id="editUnitPrice" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Priority" data-es="Prioridad">Priority</label>
                            <select id="editPriority">
                                <option value="high" data-en="High" data-es="Alta">High</option>
                                <option value="medium" data-en="Medium" data-es="Media">Medium</option>
                                <option value="low" data-en="Low" data-es="Baja">Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Supplier Name" data-es="Nombre del Proveedor">Supplier Name</label>
                            <input type="text" id="editSupplierName" required>
                        </div>
                        <div class="form-group">
                            <label data-en="Supplier Phone" data-es="TelÃ©fono del Proveedor">Supplier Phone</label>
                            <input type="tel" id="editSupplierPhone">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Supplier Email" data-es="Correo del Proveedor">Supplier Email</label>
                            <input type="email" id="editSupplierEmail">
                        </div>
                        <div class="form-group">
                            <label data-en="Supplier Address" data-es="DirecciÃ³n del Proveedor">Supplier Address</label>
                            <textarea id="editSupplierAddress" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-en="Receipt/Invoice (Image, PDF, or Excel)" data-es="Recibo/Factura (Imagen, PDF o Excel)">Receipt/Invoice (Image, PDF, or Excel)</label>
                            <div class="photo-upload">
                                <input type="file" id="editInvoicePhoto" accept="image/*,.pdf,.xlsx,.xls" onchange="uploadEditInvoicePhoto(this)">
                                <button class="photo-btn" type="button">
                                    <span class="camera-icon">ðŸ“·</span>
                                    <span data-en="Add/Change Photo" data-es="Agregar/Cambiar Foto">Add/Change Photo</span>
                                </button>
                                <img id="editPhotoPreview" class="photo-preview" alt="Invoice photo" style="max-width: 100px; max-height: 100px; margin-top: 10px;">
                            </div>
                            <div id="editReceiptAmountRow" style="display: none; margin-top: 10px;">
                                <label data-en="Receipt Amount (MXN)" data-es="Monto del Recibo (MXN)">Receipt Amount (MXN)</label>
                                <input type="number" id="editReceiptAmount" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <small data-en="Enter the exact amount shown on the receipt" data-es="Ingresa el monto exacto que aparece en el recibo">Enter the exact amount shown on the receipt</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editRecurringWeekly" onchange="toggleEditItemRecurringWeekly()">
                                <span data-en="Recurring Weekly" data-es="Recurrente Semanal">Recurring Weekly</span>
                            </label>
                            <small data-en="Item will automatically be added to budget every week" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto cada semana">Item will automatically be added to budget every week</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editRecurringMonthly" onchange="toggleEditItemRecurringMonthly()">
                                <span data-en="Recurring Monthly" data-es="Recurrente Mensual">Recurring Monthly</span>
                            </label>
                            <small data-en="Item will automatically be added to budget on a specific day each month" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto en un dÃ­a especÃ­fico cada mes">Item will automatically be added to budget on a specific day each month</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editHasDueDate" onchange="toggleEditItemDueDate()">
                                <span data-en="Set Due Date for Auto-Add" data-es="Establecer Fecha de Vencimiento para Auto-Agregar">Set Due Date for Auto-Add</span>
                            </label>
                            <small data-en="Item will automatically be added to budget one week before due date" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente al presupuesto una semana antes de la fecha de vencimiento">Item will automatically be added to budget one week before due date</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="editMonthlyDayRow" style="display: none;">
                            <label data-en="Day of Month" data-es="DÃ­a del Mes">Day of Month</label>
                            <select id="editMonthlyDay" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Select day...</option>
                            </select>
                            <small data-en="Item will be auto-added on this day of each month" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente en este dÃ­a de cada mes">Item will be auto-added on this day of each month</small>
                        </div>
                        <div class="form-group" id="editDueDateRow" style="display: none;">
                            <label data-en="Due Date" data-es="Fecha de Vencimiento">Due Date</label>
                            <input type="date" id="editDueDate">
                            <small data-en="Item will be auto-added one week before this date" data-es="El artÃ­culo se agregarÃ¡ automÃ¡ticamente una semana antes de esta fecha">Item will be auto-added one week before this date</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editItemForCanada">
                                <span data-en="Available for Canada Requests" data-es="Disponible para Solicitudes de CanadÃ¡">Available for Canada Requests</span>
                            </label>
                            <small data-en="This item will appear in the Can/Mex tab (Canada requesting from Mexico)" data-es="Este artÃ­culo aparecerÃ¡ en la pestaÃ±a Can/Mex (CanadÃ¡ solicitando de MÃ©xico)">This item will appear in the Can/Mex tab (Canada requesting from Mexico)</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editItemForMexico">
                                <span data-en="Available for Mexico Requests" data-es="Disponible para Solicitudes de MÃ©xico">Available for Mexico Requests</span>
                            </label>
                            <small data-en="This item will appear in the Mex/Can tab (Mexico requesting from Canada)" data-es="Este artÃ­culo aparecerÃ¡ en la pestaÃ±a Mex/Can (MÃ©xico solicitando de CanadÃ¡)">This item will appear in the Mex/Can tab (Mexico requesting from Canada)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <button type="submit" class="btn btn-success" data-en="Save Changes" data-es="Guardar Cambios">Save Changes</button>
                        <button type="button" class="btn btn-danger" onclick="closeEditModal()" data-en="Cancel" data-es="Cancelar">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global error handler to catch unhandled promise rejections that might break Supabase
        window.addEventListener('unhandledrejection', function(event) {
            // If it's a MutationObserver error, prevent it from breaking the app
            if (event.reason && (
                (event.reason.message && event.reason.message.includes('MutationObserver')) ||
                (event.reason.toString && event.reason.toString().includes('MutationObserver')) ||
                (event.reason.name === 'TypeError' && event.reason.message && event.reason.message.includes('observe'))
            )) {
                console.warn('Suppressed MutationObserver error in promise:', event.reason);
                event.preventDefault(); // Prevent the error from breaking the app
                return;
            }
            // Log other unhandled rejections but don't break
            console.warn('Unhandled promise rejection:', event.reason);
        });
        
        // Also catch errors globally
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message && event.error.message.includes('MutationObserver')) {
                console.warn('Suppressed MutationObserver error:', event.error);
                event.preventDefault();
                return false;
            }
        }, true);
        
        // Fix for MutationObserver error from Supabase library
        // This suppresses the error when Supabase tries to observe DOM elements before they're ready
        (function() {
            const originalObserve = MutationObserver.prototype.observe;
            MutationObserver.prototype.observe = function(target, options) {
                // Only observe if target is a valid DOM Node
                if (target && target.nodeType === 1) {
                    try {
                        return originalObserve.call(this, target, options);
                    } catch (e) {
                        // Silently ignore observation errors
                        if (e.message && e.message.includes('observe')) {
                            return;
                        }
                        throw e;
                    }
                }
                // Silently ignore invalid targets
                return;
            };
        })();
        
        // Supabase initialization
        const SUPABASE_URL = 'https://oxsbyeelxxekqebqcrbs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94c2J5ZWVseHhla3FlYnFjcmJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NjkzMTgsImV4cCI6MjA3OTI0NTMxOH0.hOeT9NOD9O9cnKbI1bqOh1VP_sIlYqbZtroqGxoOMVI';
        
        // Initialize Supabase client - wait for DOM and library to load
        let supabase;
        
        // Function to initialize Supabase client
        function initializeSupabaseClient() {
            if (typeof window.supabase !== 'undefined') {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    });
                    // Initialize auth check after client is ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initializeAuth);
                    } else {
                        initializeAuth();
                    }
                } catch (e) {
                    console.error('Error initializing Supabase client:', e);
                }
            }
        }
        
        // Wait for both DOM and Supabase library to be ready
        if (document.readyState === 'loading') {
            // DOM is still loading
            if (typeof window.supabase !== 'undefined') {
                // Supabase is already loaded, wait for DOM
                document.addEventListener('DOMContentLoaded', initializeSupabaseClient);
            } else {
                // Wait for both
                window.addEventListener('load', function() {
                    initializeSupabaseClient();
                });
            }
        } else {
            // DOM is ready
            if (typeof window.supabase !== 'undefined') {
                // Supabase is already loaded
                initializeSupabaseClient();
            } else {
                // Wait for Supabase library
                window.addEventListener('load', function() {
                    initializeSupabaseClient();
                });
            }
        }
        
        // Check authentication status
        let currentUser = null;
        let useSupabase = false;
        let userRole = 'user'; // 'admin' or 'user' - default to 'user' for limited access // Flag to toggle between localStorage and Supabase
        let isLoggingIn = false; // Prevent multiple simultaneous login attempts
        
        // Function to initialize auth (can be called after library loads)
        function initializeAuth() {
            if (!supabase) {
                console.log('Supabase client not initialized - continuing without Supabase');
                // Continue anyway - use localStorage only
                useSupabase = false;
                userRole = 'admin';
                hideLoginScreen();
                updateTabVisibility();
                loadFromLocalStorage();
                return;
            }
            
            // Skip login - go straight to app with localStorage
            console.log('Skipping login - loading app directly');
            useSupabase = false;
            userRole = 'admin'; // Set to admin so all tabs are visible
            hideLoginScreen();
            updateTabVisibility();
            loadFromLocalStorage();
            
            // Optional: Check for session in background (but don't block)
            if (supabase && supabase.auth) {
                supabase.auth.getSession().then(async ({ data: { session } }) => {
                    if (session?.user) {
                        console.log('User session found in background:', session.user.email);
                        currentUser = session.user;
                        useSupabase = true;
                        userRole = session.user.user_metadata?.role || 'admin';
                        updateTabVisibility();
                        // Optionally load from Supabase if user wants
                        // await loadUserData();
                    }
                }).catch(error => {
                    console.log('No active session (using localStorage only):', error);
                });
            }
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                currentUser = session?.user || null;
                if (event === 'SIGNED_IN' && currentUser) {
                    useSupabase = true;
                    // Refresh user session to get latest metadata (including role)
                    const { data: { user: refreshedUser } } = await supabase.auth.getUser();
                    if (refreshedUser) {
                        currentUser = refreshedUser;
                        // Get user role from metadata (default to 'user' if not set)
                        userRole = refreshedUser.user_metadata?.role || 'user';
                        console.log('User role loaded (auth state change):', userRole);
                    } else {
                        // Fallback to session user
                        userRole = currentUser.user_metadata?.role || 'user';
                        console.log('User role (fallback):', userRole);
                    }
                    hideLoginScreen();
                    updateTabVisibility(); // Hide/show tabs based on role
                    loadUserData();
                    
                    // Start UPS tracking polling if credentials are set (don't let this break login)
                    try {
                        const clientId = localStorage.getItem('upsClientId');
                        const clientSecret = localStorage.getItem('upsClientSecret');
                        if (clientId && clientSecret && typeof startUPSTrackingPolling === 'function') {
                            startUPSTrackingPolling();
                        }
                    } catch (e) {
                        console.warn('Error starting UPS tracking polling:', e);
                    }
                } else if (event === 'SIGNED_OUT') {
                    useSupabase = false;
                    userRole = 'user'; // Reset role
                    showLoginScreen();
                    updateTabVisibility(); // Reset tab visibility
                    loadFromLocalStorage();
                }
            });
        }
        
        // Call initializeAuth if supabase is ready, otherwise wait for load event
        if (supabase) {
            initializeAuth();
        } else {
            window.addEventListener('load', function() {
                if (supabase) {
                    initializeAuth();
                }
            });
        }
        
        let currentLanguage = 'en';
        let items = JSON.parse(localStorage.getItem('budgetItems')) || [];
        let editingItem = null;
        let activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
        let changeHistory = JSON.parse(localStorage.getItem('changeHistory')) || [];
        let currentCategoryItems = []; // For search filtering

        // Helper function to load from localStorage (for backward compatibility)
        function loadFromLocalStorage() {
            // Load budget items
            items = JSON.parse(localStorage.getItem('budgetItems')) || [];
            
            // Load categories
            const savedCategories = localStorage.getItem('customCategories');
            if (savedCategories) {
                try {
                    const parsed = JSON.parse(savedCategories);
                    Object.assign(categories, parsed);
                } catch (e) {
                    console.error('Error loading categories:', e);
                }
            }
            
            // Load category items
            const savedItems = localStorage.getItem('categoryItems');
            if (savedItems) {
                try {
                    const parsed = JSON.parse(savedItems);
                    Object.assign(itemDatabase, parsed);
                } catch (e) {
                    console.error('Error loading category items:', e);
                }
            }
            
            // Load activity log and change history
            activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
            changeHistory = JSON.parse(localStorage.getItem('changeHistory')) || [];
            
            // Load saved budgets (for Reports tab)
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
            console.log('Loaded saved budgets from localStorage:', savedBudgets.length);
            
            // Load Canada request history (for Can/Mex tab)
            const canadaHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
            console.log('Loaded Canada request history from localStorage:', canadaHistory.length);
            
            // Refresh UI
            if (typeof populateCategoryDropdowns === 'function') populateCategoryDropdowns();
            if (typeof loadCategoriesList === 'function') loadCategoriesList();
            renderBudgetItems();
            updateTotal();
            updateApprovalSummary();
            
            // Load Canada history if we're on that tab or if tab is available
            if (typeof loadCanadaHistory === 'function') {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    loadCanadaHistory().catch(err => console.error('Error loading Canada history:', err));
                }, 500);
            }
            
            // Check and add recurring items AFTER loading from localStorage
            // Only add if items were actually added (to prevent duplicates on every load)
            if (typeof checkAndAddDueItems === 'function') {
                const itemsBefore = items.length;
                console.log('Checking for recurring items... Current items:', itemsBefore);
                checkAndAddDueItems();
                const itemsAfter = items.length;
                console.log('After checking recurring items:', itemsAfter, 'Added:', itemsAfter - itemsBefore);
                // Only save if items were actually added
                if (items.length > itemsBefore) {
                    saveItems();
                    renderBudgetItems();
                    updateTotal();
                }
            }
        }
        
        // Authentication Functions
        function showLoginScreen() {
            // Login is disabled - always show app instead
            hideLoginScreen();
        }
        
        function hideLoginScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            // Hide logout button since login is disabled
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
            // Show/hide migration button based on Supabase login
            updateMigrationButtonVisibility();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            // Hide resend button when showing login form
            const resendDiv = document.getElementById('resendConfirmationDiv');
            if (resendDiv) {
                resendDiv.style.display = 'none';
            }
        }
        
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
        }
        
        async function handleLogin() {
            console.log('handleLogin called');
            if (isLoggingIn) {
                console.log('Login already in progress');
                return;
            }
            isLoggingIn = true;
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.querySelector('button[onclick*="handleLogin"]');
            
            console.log('Login attempt:', { email: email ? 'provided' : 'missing', hasPassword: !!password });
            
            // Disable button
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.textContent = 'Logging in...';
            }
            
            try {
                // Validate input
                if (!email || !password) {
                    errorDiv.textContent = 'Please enter email and password';
                    errorDiv.style.display = 'block';
                    isLoggingIn = false;
                    if (loginButton) {
                        loginButton.disabled = false;
                        loginButton.textContent = 'Login';
                    }
                    return;
                }
                
                // Check Supabase is ready
                if (!supabase || !supabase.auth) {
                    errorDiv.textContent = 'Error: Application not ready. Please refresh the page.';
                    errorDiv.style.display = 'block';
                    isLoggingIn = false;
                    if (loginButton) {
                        loginButton.disabled = false;
                        loginButton.textContent = 'Login';
                    }
                    return;
                }
                
                // Login with timeout protection
                console.log('Calling Supabase signInWithPassword...');
                
                // First, try a quick connectivity check
                try {
                    const { data: { session: testSession } } = await Promise.race([
                        supabase.auth.getSession(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Connection test timeout')), 5000))
                    ]);
                    console.log('Supabase connection test passed');
                } catch (connError) {
                    console.warn('Supabase connection test failed, but continuing with login:', connError);
                    // Continue anyway - might be a false negative
                }
                
                let loginPromise = supabase.auth.signInWithPassword({ email, password });
                
                // Add a timeout to prevent infinite hanging (reduced to 15 seconds)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Login request timed out. Please check your internet connection and try again.')), 15000)
                );
                
                let loginResult;
                try {
                    loginResult = await Promise.race([loginPromise, timeoutPromise]);
                    console.log('Supabase response received:', { hasData: !!loginResult.data, hasError: !!loginResult.error });
                } catch (raceError) {
                    console.error('Login promise race error:', raceError);
                    // Check if login actually succeeded despite timeout
                    if (raceError.message && raceError.message.includes('timed out')) {
                        console.log('Timeout occurred, checking if login succeeded...');
                        try {
                            const sessionCheck = await Promise.race([
                                supabase.auth.getSession(),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Session check timeout')), 3000))
                            ]);
                            if (sessionCheck && sessionCheck.data && sessionCheck.data.session && sessionCheck.data.session.user) {
                                console.log('Session found after timeout - login succeeded!');
                                loginResult = { data: { user: sessionCheck.data.session.user }, error: null };
                            } else {
                                throw raceError;
                            }
                        } catch (checkError) {
                            console.error('Session check failed:', checkError);
                            throw raceError;
                        }
                    } else {
                        throw raceError;
                    }
                }
                
                const { data, error } = loginResult;
                
                if (error) {
                    console.error('Login error from Supabase:', error);
                    throw error;
                }
                
                console.log('Login successful!');
                
                // Set user and role
                currentUser = data.user;
                useSupabase = true;
                userRole = data.user.user_metadata?.role || 'user';
                
                // Get fresh user data for role
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        currentUser = user;
                        userRole = user.user_metadata?.role || 'user';
                    }
                } catch (e) {
                    // Ignore - use data from login
                }
                
                // Show app
                hideLoginScreen();
                updateTabVisibility();
                await loadUserData();
                
                // Start UPS tracking polling if credentials are set (don't let this break login)
                try {
                    const clientId = localStorage.getItem('upsClientId');
                    const clientSecret = localStorage.getItem('upsClientSecret');
                    if (clientId && clientSecret && typeof startUPSTrackingPolling === 'function') {
                        startUPSTrackingPolling();
                    }
                } catch (e) {
                    console.warn('Error starting UPS tracking polling:', e);
                }
                
            } catch (error) {
                console.error('Login catch block:', error);
                const errorMessage = error.message || 'Login failed';
                if (errorDiv) {
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = 'block';
                } else {
                    alert('Login error: ' + errorMessage);
                }
                
                // Show resend button if email not confirmed
                const resendDiv = document.getElementById('resendConfirmationDiv');
                if (resendDiv) {
                    const errorLower = errorMessage.toLowerCase();
                    resendDiv.style.display = (
                        errorLower.includes('email not confirmed') || 
                        errorLower.includes('email_not_confirmed') ||
                        errorLower.includes('email not verified') ||
                        errorLower.includes('email_not_verified')
                    ) ? 'block' : 'none';
                }
            } finally {
                isLoggingIn = false;
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Login';
                }
            }
        }
        
        async function resendConfirmationEmail() {
            const email = document.getElementById('loginEmail').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email) {
                errorDiv.textContent = 'Please enter your email address first';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Use production URL for email confirmation redirect
                const productionUrl = 'https://oolab-budget.github.io/budget-manager/';
                const redirectUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? productionUrl 
                    : window.location.origin + window.location.pathname;
                
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: email,
                    options: {
                        emailRedirectTo: redirectUrl
                    }
                });
                
                if (error) throw error;
                
                errorDiv.style.color = '#27ae60';
                errorDiv.textContent = 'Confirmation email sent! Please check your inbox (and spam folder).';
                errorDiv.style.display = 'block';
                document.getElementById('resendConfirmationDiv').style.display = 'none';
            } catch (error) {
                errorDiv.style.color = '#e74c3c';
                errorDiv.textContent = 'Error sending confirmation email: ' + (error.message || 'Unknown error');
                errorDiv.style.display = 'block';
            }
        }
        
        async function handleSignup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const errorDiv = document.getElementById('signupError');
            
            if (!email || !password || !passwordConfirm) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== passwordConfirm) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // New users default to 'user' role (limited access)
                // Admins can be set manually in Supabase dashboard by updating user metadata
                // Use production URL for email confirmation redirect (works for both local and production signups)
                const productionUrl = 'https://oolab-budget.github.io/budget-manager/';
                const redirectUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? productionUrl 
                    : window.location.origin + window.location.pathname;
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            role: 'user' // Default role - admin can be set manually in Supabase
                        },
                        emailRedirectTo: redirectUrl // For email confirmation - always use production URL
                    }
                });
                
                if (error) throw error;
                
                // Initialize request counter for new user
                if (data.user) {
                    await supabase.from('canada_request_counters').insert({
                        user_id: data.user.id,
                        counter: 0
                    });
                }
                
                errorDiv.style.color = '#27ae60';
                errorDiv.textContent = 'Account created! Please check your email to verify your account. If you don\'t receive it, check your spam folder or use the "Resend Confirmation Email" button on the login screen.';
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
            } catch (error) {
                errorDiv.textContent = error.message || 'Signup failed';
                errorDiv.style.display = 'block';
            }
        }
        
        async function handleLogout() {
            console.log('handleLogout called');
            await supabase.auth.signOut();
            currentUser = null;
            useSupabase = false;
            userRole = 'user'; // Reset role
            items = [];
            saveItems(); // Clear local state
            document.getElementById('logoutBtn').style.display = 'none';
            updateTabVisibility(); // Reset tab visibility
            showLoginScreen();
        }
        
        // Function to update tab visibility based on user role
        function updateTabVisibility() {
            try {
                // Default to showing all tabs if role is not set
                if (!userRole) {
                    console.warn('userRole not set, showing all tabs');
                    userRole = 'admin'; // Safe default - show everything
                }
                
                const tabsToHideForUsers = ['addItems', 'manageItems', 'categories', 'monitor', 'alerts', 'settings'];
                const tabButtons = document.querySelectorAll('.tab-button');
                
                if (!tabButtons || tabButtons.length === 0) {
                    console.warn('No tab buttons found, skipping visibility update');
                    return;
                }
                
                tabButtons.forEach(button => {
                    try {
                        const onclick = button.getAttribute('onclick');
                        if (onclick) {
                            // Extract tab name from onclick attribute
                            const match = onclick.match(/switchTab\('([^']+)'\)/);
                            if (match) {
                                const tabName = match[1];
                                
                                if (userRole === 'admin') {
                                    // Admin sees all tabs
                                    button.style.display = '';
                                } else {
                                    // Limited users only see: budget, reports, canada (Can/Mex), mexcan (Mex/Can)
                                    if (tabsToHideForUsers.includes(tabName)) {
                                        button.style.display = 'none';
                                    } else {
                                        button.style.display = '';
                                    }
                                }
                            }
                        }
                    } catch (buttonError) {
                        console.warn('Error updating button visibility:', buttonError);
                    }
                });
            } catch (error) {
                console.error('Error in updateTabVisibility:', error);
                // On error, show all tabs (safe default)
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.style.display = '';
                });
            }
        }
        
        // Function to load user data from Supabase
        async function loadUserData() {
            if (!currentUser || !useSupabase) {
                loadFromLocalStorage();
                return;
            }
            
            try {
                // Load budget items - MUST filter by user_id
                const { data: budgetItems, error: itemsError } = await supabase
                    .from('budget_items')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date_added', { ascending: false });
                
                if (itemsError) throw itemsError;
                items = (budgetItems || []).map(convertDbItemToAppItem);
                
                // Load categories - MUST filter by user_id
                const { data: categoriesData, error: categoriesError } = await supabase
                    .from('custom_categories')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (categoriesError) throw categoriesError;
                
                // Convert categories to app format
                categories = {};
                if (categoriesData && categoriesData.length > 0) {
                    categoriesData.forEach(cat => {
                        categories[cat.category_key] = {
                            nameEn: cat.name_en,
                            nameEs: cat.name_es,
                            descriptionEn: cat.description_en,
                            descriptionEs: cat.description_es,
                            pricingType: cat.pricing_type || 'fixed',
                            recurringWeekly: cat.recurring_weekly || false,
                            recurringMonthly: cat.recurring_monthly || false,
                            monthlyDay: cat.monthly_day,
                            hasDueDate: cat.has_due_date || false,
                            dueDate: cat.due_date,
                            items: cat.items || []
                        };
                    });
                }
                
                // Load item database from categories
                itemDatabase = {};
                if (categoriesData && categoriesData.length > 0) {
                    categoriesData.forEach(cat => {
                        if (cat.items && Array.isArray(cat.items)) {
                            itemDatabase[cat.category_key] = cat.items;
                        }
                    });
                }
                
                // Check for saved budgets - MUST filter by user_id
                const { data: savedBudgetsData } = await supabase
                    .from('saved_budgets')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // If Supabase is empty, check localStorage and migrate data
                if ((!categoriesData || categoriesData.length === 0) && (!budgetItems || budgetItems.length === 0) && (!savedBudgetsData || savedBudgetsData.length === 0)) {
                    const localCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
                    const localItems = JSON.parse(localStorage.getItem('categoryItems')) || {};
                    const localBudgetItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
                    const localSavedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
                    
                    // If we have local data, migrate it to Supabase
                    if (Object.keys(localCategories).length > 0 || Object.keys(localItems).length > 0 || localBudgetItems.length > 0 || localSavedBudgets.length > 0) {
                        console.log('Migrating localStorage data to Supabase...');
                        await migrateLocalStorageToSupabase(localCategories, localItems, localBudgetItems, localSavedBudgets);
                        // Reload after migration
                        return loadUserData();
                    }
                }
                
                // If saved budgets exist in localStorage but not in Supabase, migrate them
                if ((!savedBudgetsData || savedBudgetsData.length === 0)) {
                    const localSavedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
                    if (localSavedBudgets.length > 0) {
                        console.log('Migrating saved budgets to Supabase...');
                        await migrateSavedBudgets(localSavedBudgets);
                    }
                }
                
                // Check and migrate Canada requests
                const { data: canadaRequestsData } = await supabase
                    .from('canada_requests')
                    .select('id')
                    .eq('user_id', currentUser.id);
                
                if ((!canadaRequestsData || canadaRequestsData.length === 0)) {
                    const localCanadaHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                    if (localCanadaHistory.length > 0) {
                        console.log('Migrating Canada requests to Supabase...');
                        await migrateCanadaRequests(localCanadaHistory);
                    }
                }
                
                // If no data in Supabase and no local data, load from localStorage as fallback
                if ((!categoriesData || categoriesData.length === 0) && Object.keys(categories).length === 0) {
                    const localCategories = JSON.parse(localStorage.getItem('customCategories') || '{}');
                    const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
                    if (Object.keys(localCategories).length > 0 || Object.keys(localItems).length > 0) {
                        categories = localCategories;
                        itemDatabase = localItems;
                    }
                }
                
                // Also check if items exist in localStorage even if categories were loaded from Supabase
                // This handles the case where categories migrated but items didn't
                const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
                if (Object.keys(localItems).length > 0) {
                    // Count items in Supabase vs localStorage
                    let supabaseItemCount = 0;
                    Object.keys(itemDatabase).forEach(cat => {
                        if (Array.isArray(itemDatabase[cat])) {
                            supabaseItemCount += itemDatabase[cat].length;
                        }
                    });
                    
                    let localItemCount = 0;
                    Object.keys(localItems).forEach(cat => {
                        if (Array.isArray(localItems[cat])) {
                            localItemCount += localItems[cat].length;
                        }
                    });
                    
                    // If localStorage has more items, use it and migrate
                    if (localItemCount > supabaseItemCount) {
                        console.log(`Found more items in localStorage (${localItemCount}) than in Supabase (${supabaseItemCount}). Restoring from localStorage...`);
                        itemDatabase = localItems;
                        // Save to Supabase
                        await saveCategoryItems();
                    }
                }
                
                // Check if budget items in localStorage are missing from Supabase and migrate them
                const localBudgetItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
                if (localBudgetItems.length > 0 && items.length === 0) {
                    console.log(`Found ${localBudgetItems.length} items in localStorage but 0 in Supabase. Migrating...`);
                    // Migrate items from localStorage to Supabase
                    for (const item of localBudgetItems) {
                        try {
                            const dbItem = convertAppItemToDbItem(item);
                            dbItem.user_id = currentUser.id;
                            // Try to insert, ignore if it already exists
                            const { error: insertError } = await supabase
                                .from('budget_items')
                                .insert([dbItem]);
                            
                            if (insertError) {
                                // If error is not a duplicate key error, log it
                                if (insertError.code !== '23505') {
                                    console.error('Error migrating item to Supabase:', insertError);
                                }
                            }
                        } catch (err) {
                            console.error('Error converting/migrating item:', err, item);
                        }
                    }
                    // Reload items from Supabase after migration
                    const { data: migratedItems, error: reloadError } = await supabase
                        .from('budget_items')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('date_added', { ascending: false });
                    
                    if (!reloadError && migratedItems) {
                        items = migratedItems.map(convertDbItemToAppItem);
                    }
                } else if (localBudgetItems.length > items.length) {
                    // If localStorage has more items than Supabase, check which ones are missing
                    console.log(`Found ${localBudgetItems.length} items in localStorage but only ${items.length} in Supabase. Checking for missing items...`);
                    const supabaseItemIds = new Set(items.map(item => String(item.id)));
                    const itemsToMigrate = localBudgetItems.filter(item => {
                        const itemId = String(item.id);
                        // Check if item exists in Supabase by ID
                        if (supabaseItemIds.has(itemId)) {
                            return false;
                        }
                        // Also check by name and date to avoid duplicates
                        const exists = items.some(existing => 
                            existing.nameEn === item.nameEn && 
                            existing.dateAdded === item.dateAdded
                        );
                        return !exists;
                    });
                    
                    if (itemsToMigrate.length > 0) {
                        console.log(`Migrating ${itemsToMigrate.length} missing items to Supabase...`);
                        for (const item of itemsToMigrate) {
                            try {
                                const dbItem = convertAppItemToDbItem(item);
                                dbItem.user_id = currentUser.id;
                                // Remove the ID so Supabase generates a new one
                                delete dbItem.id;
                                const { error: insertError } = await supabase
                                    .from('budget_items')
                                    .insert([dbItem]);
                                
                                if (insertError) {
                                    if (insertError.code !== '23505') {
                                        console.error('Error migrating item to Supabase:', insertError);
                                    }
                                }
                            } catch (err) {
                                console.error('Error converting/migrating item:', err, item);
                            }
                        }
                        // Reload items from Supabase after migration
                        const { data: migratedItems, error: reloadError } = await supabase
                            .from('budget_items')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('date_added', { ascending: false });
                        
                        if (!reloadError && migratedItems) {
                            items = migratedItems.map(convertDbItemToAppItem);
                        }
                    }
                }
                
                // Load activity log - MUST filter by user_id
                const { data: activityData, error: activityError } = await supabase
                    .from('activity_log')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (!activityError && activityData && activityData.length > 0) {
                    // Use Supabase data if it exists
                    activityLog = activityData.map(convertDbActivityToApp);
                    // Also save to localStorage as backup
                    localStorage.setItem('activityLog', JSON.stringify(activityLog));
                } else {
                    // Fallback to localStorage - preserve existing data
                    const localActivityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
                    if (localActivityLog.length > 0) {
                        activityLog = localActivityLog;
                        // Optionally migrate to Supabase if we have local data but no Supabase data
                        if ((!activityData || activityData.length === 0) && localActivityLog.length > 0) {
                            console.log(`Migrating ${localActivityLog.length} activity log entries to Supabase...`);
                            for (const activity of localActivityLog.slice(0, 100)) {
                                try {
                                    await supabase.from('activity_log').insert([{
                                        user_id: currentUser.id,
                                        type: activity.type,
                                        description: activity.description,
                                        item_id: activity.itemId,
                                        created_at: activity.timestamp || new Date().toISOString()
                                    }]);
                                } catch (err) {
                                    // Ignore duplicate errors
                                    if (err.code !== '23505') {
                                        console.error('Error migrating activity log:', err);
                                    }
                                }
                            }
                        }
                    } else {
                        activityLog = [];
                    }
                }
                
                // Load change history - MUST filter by user_id
                const { data: historyData, error: historyError } = await supabase
                    .from('change_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (!historyError && historyData && historyData.length > 0) {
                    // Use Supabase data if it exists
                    changeHistory = historyData.map(convertDbHistoryToApp);
                    // Also save to localStorage as backup
                    localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
                } else {
                    // Fallback to localStorage - preserve existing data
                    const localChangeHistory = JSON.parse(localStorage.getItem('changeHistory')) || [];
                    if (localChangeHistory.length > 0) {
                        changeHistory = localChangeHistory;
                        // Optionally migrate to Supabase if we have local data but no Supabase data
                        if ((!historyData || historyData.length === 0) && localChangeHistory.length > 0) {
                            console.log(`Migrating ${localChangeHistory.length} change history entries to Supabase...`);
                            for (const change of localChangeHistory.slice(0, 100)) {
                                try {
                                    await supabase.from('change_history').insert([{
                                        user_id: currentUser.id,
                                        type: change.type,
                                        item_id: change.itemId,
                                        item_name: change.itemName,
                                        old_value: change.oldValue,
                                        new_value: change.newValue,
                                        field: change.field,
                                        created_at: change.timestamp || new Date().toISOString()
                                    }]);
                                } catch (err) {
                                    // Ignore duplicate errors
                                    if (err.code !== '23505') {
                                        console.error('Error migrating change history:', err);
                                    }
                                }
                            }
                        }
                    } else {
                        changeHistory = [];
                    }
                }
                
                // Render UI
                renderBudgetItems();
                updateTotal();
                if (typeof loadCategoriesList === 'function') loadCategoriesList();
                if (typeof populateCategoryDropdowns === 'function') populateCategoryDropdowns();
                if (typeof updateApprovalSummary === 'function') updateApprovalSummary();
                if (typeof updateMonitorDashboard === 'function') updateMonitorDashboard();
                if (typeof refreshActivityLog === 'function') refreshActivityLog();
                if (typeof loadChangeHistory === 'function') loadChangeHistory();
                if (typeof loadCanadaHistory === 'function') {
                    loadCanadaHistory().catch(err => console.error('Error loading Canada history:', err));
                }
                if (typeof updateCanadaRequestSummary === 'function') updateCanadaRequestSummary();
                updateMigrationButtonVisibility();
                
                // Check and add recurring items AFTER data is loaded
                // Only add recurring items if items array is not empty (to avoid re-adding after clear)
                // This prevents items from reappearing immediately after clearing
                if (typeof checkAndAddDueItems === 'function' && items.length > 0) {
                    checkAndAddDueItems();
                    // Save items after adding recurring items
                    saveItems();
                    renderBudgetItems();
                    updateTotal();
                } else if (items.length === 0) {
                    // If items array is empty, just render to show empty state
                    renderBudgetItems();
                    updateTotal();
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showApprovalStatus('error', 'Failed to load data: ' + error.message);
                // Fallback to localStorage
                loadFromLocalStorage();
                updateMigrationButtonVisibility();
            }
        }
        
        // Function to update migration button visibility
        function updateMigrationButtonVisibility() {
            const migrateBtn = document.getElementById('migrateCanadaRequestsBtn');
            if (migrateBtn) {
                if (useSupabase && currentUser) {
                    migrateBtn.style.display = 'inline-block';
                } else {
                    migrateBtn.style.display = 'none';
                }
            }
        }
        
        // Function to force migration of budget items from localStorage to Supabase
        // This can be called from the browser console: forceMigrateBudgetItems()
        async function forceMigrateBudgetItems() {
            if (!currentUser || !useSupabase) {
                console.error('Please log in first to migrate items to Supabase');
                alert('Please log in first to migrate items to Supabase');
                return;
            }
            
            const localBudgetItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
            if (localBudgetItems.length === 0) {
                console.log('No items found in localStorage to migrate');
                alert('No items found in localStorage to migrate');
                return;
            }
            
            console.log(`Found ${localBudgetItems.length} items in localStorage. Starting migration...`);
            
            try {
                // Get current items from Supabase
                const { data: existingItems, error: fetchError } = await supabase
                    .from('budget_items')
                    .select('id, name_en, date_added, unit_price, quantity')
                    .eq('user_id', currentUser.id);
                
                if (fetchError) {
                    console.error('Error fetching existing items:', fetchError);
                    alert('Error fetching existing items: ' + fetchError.message);
                    return;
                }
                
                console.log(`Found ${existingItems?.length || 0} existing items in Supabase`);
                
                // Create a more robust duplicate check using multiple fields
                const existingItemKeys = new Set();
                if (existingItems) {
                    existingItems.forEach(item => {
                        // Normalize date for comparison (handle different date formats)
                        const dateStr = item.date_added ? new Date(item.date_added).toISOString().split('T')[0] : '';
                        // Create multiple keys for better duplicate detection
                        const key1 = `${item.name_en || ''}_${dateStr}_${item.unit_price || 0}_${item.quantity || 1}`;
                        const key2 = `${item.name_en || ''}_${dateStr}`;
                        existingItemKeys.add(key1);
                        existingItemKeys.add(key2);
                    });
                }
                
                let migratedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Migrate items that don't exist in Supabase
                for (let i = 0; i < localBudgetItems.length; i++) {
                    const item = localBudgetItems[i];
                    try {
                        // Normalize date for comparison
                        const itemDate = item.dateAdded ? new Date(item.dateAdded).toISOString().split('T')[0] : '';
                        const itemName = item.nameEn || item.name || '';
                        const itemPrice = item.unitPrice || 0;
                        const itemQty = item.quantity || 1;
                        
                        // Check multiple keys for duplicates
                        const key1 = `${itemName}_${itemDate}_${itemPrice}_${itemQty}`;
                        const key2 = `${itemName}_${itemDate}`;
                        
                        // Only skip if we have a very close match (same name, date, price, and quantity)
                        if (existingItemKeys.has(key1)) {
                            skippedCount++;
                            continue;
                        }
                        
                        const dbItem = convertAppItemToDbItem(item);
                        dbItem.user_id = currentUser.id;
                        // Remove ID so Supabase generates a new one
                        delete dbItem.id;
                        
                        // Ensure date_added is properly formatted
                        if (!dbItem.date_added) {
                            dbItem.date_added = new Date().toISOString();
                        }
                        
                        const { error: insertError } = await supabase
                            .from('budget_items')
                            .insert([dbItem]);
                        
                        if (insertError) {
                            if (insertError.code === '23505') {
                                // Duplicate key, skip
                                skippedCount++;
                            } else {
                                console.error(`Error migrating item ${i + 1}/${localBudgetItems.length}:`, insertError.message, item);
                                errors.push({ item: itemName, error: insertError.message });
                                errorCount++;
                            }
                        } else {
                            migratedCount++;
                            // Add to set to avoid duplicates in this batch
                            existingItemKeys.add(key1);
                            existingItemKeys.add(key2);
                            
                            // Log progress every 50 items
                            if (migratedCount % 50 === 0) {
                                console.log(`Progress: ${migratedCount} migrated, ${skippedCount} skipped, ${errorCount} errors...`);
                            }
                        }
                    } catch (err) {
                        console.error(`Error processing item ${i + 1}/${localBudgetItems.length}:`, err, item);
                        errors.push({ item: item.nameEn || item.name || 'Unknown', error: err.message });
                        errorCount++;
                    }
                }
                
                console.log(`Migration complete! Migrated: ${migratedCount}, Skipped: ${skippedCount}, Errors: ${errorCount}`);
                if (errors.length > 0) {
                    console.log('Errors encountered:', errors.slice(0, 10)); // Log first 10 errors
                }
                
                alert(`Migration complete!\nMigrated: ${migratedCount} items\nSkipped: ${skippedCount} items (already exist)\nErrors: ${errorCount} items${errors.length > 0 ? '\n\nCheck console for error details' : ''}`);
                
                // Reload items from Supabase
                const { data: allItems, error: reloadError } = await supabase
                    .from('budget_items')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date_added', { ascending: false });
                
                if (!reloadError && allItems) {
                    items = allItems.map(convertDbItemToAppItem);
                    renderBudgetItems();
                    updateTotal();
                    console.log(`Loaded ${items.length} items from Supabase (should match migrated + existing)`);
                    alert(`Successfully loaded ${items.length} items from Supabase!`);
                } else {
                    console.error('Error reloading items:', reloadError);
                    alert('Migration completed but failed to reload items. Please refresh the page.');
                }
            } catch (error) {
                console.error('Migration error:', error);
                alert('Migration failed: ' + error.message);
            }
        }
        
        // Make function available globally for console access
        window.forceMigrateBudgetItems = forceMigrateBudgetItems;
        
        // Diagnostic function to check item counts - call from console: checkItemCounts()
        async function checkItemCounts() {
            if (!currentUser || !useSupabase) {
                console.log('Not logged in or Supabase not enabled');
                return;
            }
            
            const localItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
            console.log(`LocalStorage items: ${localItems.length}`);
            
            const { data: supabaseItems, error } = await supabase
                .from('budget_items')
                .select('id')
                .eq('user_id', currentUser.id);
            
            if (error) {
                console.error('Error fetching Supabase items:', error);
            } else {
                console.log(`Supabase items: ${supabaseItems?.length || 0}`);
            }
            
            console.log(`Currently loaded items: ${items.length}`);
            console.log(`Difference: ${localItems.length - (supabaseItems?.length || 0)} items not in Supabase`);
            
            return {
                localStorage: localItems.length,
                supabase: supabaseItems?.length || 0,
                loaded: items.length,
                missing: localItems.length - (supabaseItems?.length || 0)
            };
        }
        window.checkItemCounts = checkItemCounts;
        
        // Force reload all items from Supabase - call from console: forceReloadItems()
        async function forceReloadItems() {
            if (!currentUser || !useSupabase) {
                console.error('Please log in first');
                // If not logged in, reload from localStorage
                items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                renderBudgetItems();
                updateTotal();
                alert(`Reloaded ${items.length} items from localStorage`);
                return;
            }
            
            console.log('Force reloading items from Supabase...');
            const { data: allItems, error } = await supabase
                .from('budget_items')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date_added', { ascending: false });
            
            if (error) {
                console.error('Error reloading items:', error);
                // Fallback to localStorage
                items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                renderBudgetItems();
                updateTotal();
                alert('Error reloading from Supabase. Loaded ' + items.length + ' items from localStorage instead.');
                return;
            }
            
            if (allItems && allItems.length > 0) {
                items = allItems.map(convertDbItemToAppItem);
                // Also update localStorage
                localStorage.setItem('budgetItems', JSON.stringify(items));
                renderBudgetItems();
                updateTotal();
                console.log(`Successfully reloaded ${items.length} items from Supabase`);
                alert(`Successfully reloaded ${items.length} items from Supabase!`);
            } else {
                // Check localStorage as fallback
                const localItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
                if (localItems.length > 0) {
                    items = localItems;
                    renderBudgetItems();
                    updateTotal();
                    alert(`No items in Supabase. Loaded ${items.length} items from localStorage.`);
                } else {
                    console.log('No items found in Supabase or localStorage');
                    alert('No items found in Supabase or localStorage');
                }
            }
        }
        window.forceReloadItems = forceReloadItems;
        
        // Recover missing items from localStorage to Supabase
        async function recoverMissingItems() {
            if (!currentUser || !useSupabase) {
                alert('Please log in first to recover items to Supabase');
                return;
            }
            
            const localItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
            if (localItems.length === 0) {
                alert('No items found in localStorage to recover');
                return;
            }
            
            // Get items from Supabase
            const { data: supabaseItems } = await supabase
                .from('budget_items')
                .select('id')
                .eq('user_id', currentUser.id);
            
            const supabaseIds = new Set((supabaseItems || []).map(item => String(item.id)));
            
            // Find items in localStorage that aren't in Supabase
            const itemsToRecover = localItems.filter(item => {
                const itemId = String(item.id);
                return !supabaseIds.has(itemId);
            });
            
            if (itemsToRecover.length === 0) {
                alert('All items are already in Supabase');
                return;
            }
            
            if (!confirm(`Found ${itemsToRecover.length} items in localStorage that are not in Supabase. Recover them?`)) {
                return;
            }
            
            let recovered = 0;
            for (const item of itemsToRecover) {
                try {
                    const dbItem = convertAppItemToDbItem(item);
                    dbItem.user_id = currentUser.id;
                    const { error } = await supabase
                        .from('budget_items')
                        .insert([dbItem]);
                    
                    if (!error) {
                        recovered++;
                    }
                } catch (err) {
                    console.error('Error recovering item:', err, item);
                }
            }
            
            alert(`Recovered ${recovered} of ${itemsToRecover.length} items to Supabase`);
            
            // Reload items
            await forceReloadItems();
        }
        window.recoverMissingItems = recoverMissingItems;
        
        // Diagnostic function to check category item counts - call from console: checkCategoryItemCounts()
        async function checkCategoryItemCounts() {
            if (!currentUser || !useSupabase) {
                console.log('Not logged in or Supabase not enabled');
                return;
            }
            
            const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            let localItemCount = 0;
            Object.keys(localItems).forEach(cat => {
                if (Array.isArray(localItems[cat])) {
                    localItemCount += localItems[cat].length;
                }
            });
            console.log(`LocalStorage category items: ${localItemCount} items across ${Object.keys(localItems).length} categories`);
            
            const { data: supabaseCategories, error } = await supabase
                .from('custom_categories')
                .select('category_key, items')
                .eq('user_id', currentUser.id);
            
            let supabaseItemCount = 0;
            if (error) {
                console.error('Error fetching Supabase categories:', error);
            } else {
                if (supabaseCategories) {
                    supabaseCategories.forEach(cat => {
                        if (cat.items && Array.isArray(cat.items)) {
                            supabaseItemCount += cat.items.length;
                        }
                    });
                }
                console.log(`Supabase category items: ${supabaseItemCount} items across ${supabaseCategories?.length || 0} categories`);
            }
            
            let loadedItemCount = 0;
            Object.keys(itemDatabase).forEach(cat => {
                if (Array.isArray(itemDatabase[cat])) {
                    loadedItemCount += itemDatabase[cat].length;
                }
            });
            console.log(`Currently loaded category items: ${loadedItemCount} items across ${Object.keys(itemDatabase).length} categories`);
            
            return {
                localStorage: localItemCount,
                supabase: supabaseItemCount,
                loaded: loadedItemCount,
                missing: localItemCount - supabaseItemCount
            };
        }
        window.checkCategoryItemCounts = checkCategoryItemCounts;
        
        // Recover missing category items from Supabase - call from console: recoverMissingCategoryItems()
        async function recoverMissingCategoryItems() {
            if (!currentUser || !useSupabase) {
                alert('Please log in first to recover category items from Supabase');
                return;
            }
            
            console.log('Recovering category items from Supabase...');
            
            try {
                // Fetch all categories from Supabase
                const { data: categoriesData, error } = await supabase
                    .from('custom_categories')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) {
                    console.error('Error fetching categories from Supabase:', error);
                    alert('Error fetching categories: ' + error.message);
                    return;
                }
                
                if (!categoriesData || categoriesData.length === 0) {
                    alert('No categories found in Supabase');
                    return;
                }
                
                // Reload itemDatabase from Supabase
                itemDatabase = {};
                let totalItems = 0;
                let categoryCount = 0;
                
                categoriesData.forEach(cat => {
                    // Always include the category, even if items is null/undefined
                    if (cat.items && Array.isArray(cat.items)) {
                        itemDatabase[cat.category_key] = cat.items;
                        totalItems += cat.items.length;
                    } else {
                        // Initialize with empty array if items is missing
                        itemDatabase[cat.category_key] = [];
                    }
                    categoryCount++;
                });
                
                // Update localStorage
                localStorage.setItem('categoryItems', JSON.stringify(itemDatabase));
                
                // Also update categories object
                categories = {};
                categoriesData.forEach(cat => {
                    categories[cat.category_key] = {
                        nameEn: cat.name_en,
                        nameEs: cat.name_es,
                        descriptionEn: cat.description_en,
                        descriptionEs: cat.description_es,
                        pricingType: cat.pricing_type || 'fixed',
                        recurringWeekly: cat.recurring_weekly || false,
                        recurringMonthly: cat.recurring_monthly || false,
                        monthlyDay: cat.monthly_day,
                        hasDueDate: cat.has_due_date || false,
                        dueDate: cat.due_date,
                        items: cat.items || []
                    };
                });
                localStorage.setItem('customCategories', JSON.stringify(categories));
                
                // Refresh the UI
                loadCategoriesList();
                populateCategoryDropdowns();
                
                // If a category is selected, reload its items
                const categorySelect = document.getElementById('categorySelect');
                if (categorySelect && categorySelect.value) {
                    loadCategoryItems();
                }
                
                console.log(`Successfully recovered ${totalItems} category items across ${categoryCount} categories from Supabase`);
                alert(`Successfully recovered ${totalItems} category items across ${categoryCount} categories from Supabase!`);
                
            } catch (error) {
                console.error('Error recovering category items:', error);
                alert('Error recovering category items: ' + error.message);
            }
        }
        window.recoverMissingCategoryItems = recoverMissingCategoryItems;
        
        // Force migrate category items from localStorage to Supabase - call from console: forceMigrateCategoryItems()
        async function forceMigrateCategoryItems() {
            if (!currentUser || !useSupabase) {
                console.error('Please log in first to migrate category items to Supabase');
                alert('Please log in first to migrate category items to Supabase');
                return;
            }
            
            const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            let localItemCount = 0;
            Object.keys(localItems).forEach(cat => {
                if (Array.isArray(localItems[cat])) {
                    localItemCount += localItems[cat].length;
                }
            });
            
            if (localItemCount === 0) {
                console.log('No category items found in localStorage to migrate');
                alert('No category items found in localStorage to migrate');
                return;
            }
            
            console.log(`Found ${localItemCount} category items in localStorage across ${Object.keys(localItems).length} categories. Starting migration...`);
            
            try {
                // Get current categories from Supabase
                const { data: existingCategories, error: fetchError } = await supabase
                    .from('custom_categories')
                    .select('category_key, items')
                    .eq('user_id', currentUser.id);
                
                if (fetchError) {
                    console.error('Error fetching existing categories:', fetchError);
                    alert('Error fetching existing categories: ' + fetchError.message);
                    return;
                }
                
                let supabaseItemCount = 0;
                if (existingCategories) {
                    existingCategories.forEach(cat => {
                        if (cat.items && Array.isArray(cat.items)) {
                            supabaseItemCount += cat.items.length;
                        }
                    });
                }
                console.log(`Found ${supabaseItemCount} existing category items in Supabase across ${existingCategories?.length || 0} categories`);
                
                // Migrate category items
                let migratedCount = 0;
                let updatedCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const [categoryKey, categoryItems] of Object.entries(localItems)) {
                    if (!Array.isArray(categoryItems) || categoryItems.length === 0) {
                        continue;
                    }
                    
                    try {
                        // Get the category data (we need it to update the category record)
                        const categoryData = categories[categoryKey];
                        if (!categoryData) {
                            console.warn(`Category ${categoryKey} not found in categories object, skipping items`);
                            continue;
                        }
                        
                        // Check if category exists in Supabase
                        const existingCategory = existingCategories?.find(cat => cat.category_key === categoryKey);
                        const existingItems = existingCategory?.items || [];
                        
                        // Use localStorage as source of truth - merge intelligently
                        // Start with existing items from Supabase
                        const mergedItems = existingItems ? [...existingItems] : [];
                        
                        // Add all local items, but check for duplicates more carefully
                        categoryItems.forEach(localItem => {
                            const itemName = localItem.nameEn || localItem.nameEs || localItem.name || '';
                            const itemPrice = localItem.unitPrice || 0;
                            const itemDesc = localItem.descriptionEn || localItem.descriptionEs || localItem.description || '';
                            
                            // Check if item already exists (by name AND price AND description for better matching)
                            const exists = mergedItems.some(existing => {
                                const existingName = existing.nameEn || existing.nameEs || existing.name || '';
                                const existingPrice = existing.unitPrice || 0;
                                const existingDesc = existing.descriptionEn || existing.descriptionEs || existing.description || '';
                                
                                // Match if name, price, and description all match (more strict duplicate check)
                                return existingName === itemName && 
                                       existingPrice === itemPrice && 
                                       existingDesc === itemDesc;
                            });
                            
                            if (!exists) {
                                mergedItems.push(localItem);
                                console.log(`Adding item to ${categoryKey}: ${itemName}`);
                            } else {
                                console.log(`Skipping duplicate item in ${categoryKey}: ${itemName}`);
                            }
                        });
                        
                        console.log(`Category ${categoryKey}: ${existingItems.length} existing + ${categoryItems.length} local = ${mergedItems.length} total items`);
                        
                        // Update category with merged items
                        const categoryRecord = {
                            user_id: currentUser.id,
                            category_key: categoryKey,
                            name_en: categoryData.nameEn,
                            name_es: categoryData.nameEs,
                            description_en: categoryData.descriptionEn,
                            description_es: categoryData.descriptionEs,
                            pricing_type: categoryData.pricingType || 'fixed',
                            recurring_weekly: categoryData.recurringWeekly || false,
                            recurring_monthly: categoryData.recurringMonthly || false,
                            monthly_day: categoryData.monthlyDay,
                            has_due_date: categoryData.hasDueDate || false,
                            due_date: categoryData.dueDate,
                            items: mergedItems
                        };
                        
                        const { error: upsertError } = await supabase
                            .from('custom_categories')
                            .upsert(categoryRecord, {
                                onConflict: 'user_id,category_key'
                            });
                        
                        if (upsertError) {
                            console.error(`Error migrating category ${categoryKey}:`, upsertError);
                            errors.push({ category: categoryKey, error: upsertError.message });
                            errorCount++;
                        } else {
                            if (existingCategory) {
                                updatedCount++;
                                migratedCount += mergedItems.length - existingItems.length;
                            } else {
                                migratedCount += mergedItems.length;
                            }
                        }
                    } catch (err) {
                        console.error(`Error processing category ${categoryKey}:`, err);
                        errors.push({ category: categoryKey, error: err.message });
                        errorCount++;
                    }
                }
                
                console.log(`Migration complete! Migrated: ${migratedCount} items, Updated: ${updatedCount} categories, Errors: ${errorCount}`);
                if (errors.length > 0) {
                    console.log('Errors encountered:', errors.slice(0, 10)); // Log first 10 errors
                }
                
                alert(`Category items migration complete!\\nMigrated: ${migratedCount} items\\nUpdated: ${updatedCount} categories\\nErrors: ${errorCount}${errors.length > 0 ? '\\n\\nCheck console for error details' : ''}`);
                
                // Reload categories and items from Supabase
                await loadUserData();
                console.log(`Loaded ${Object.keys(itemDatabase).length} categories with items from Supabase`);
                alert(`Successfully loaded category items from Supabase!`);
            } catch (error) {
                console.error('Migration error:', error);
                alert('Migration failed: ' + error.message);
            }
        }
        window.forceMigrateCategoryItems = forceMigrateCategoryItems;
        
        // Force replace category items from localStorage (use localStorage as absolute source of truth)
        // Call from console: forceReplaceCategoryItems('other') or forceReplaceCategoryItems() for all
        async function forceReplaceCategoryItems(categoryKey = null) {
            if (!currentUser || !useSupabase) {
                console.error('Please log in first');
                alert('Please log in first');
                return;
            }
            
            const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            
            if (categoryKey) {
                // Replace specific category
                if (!localItems[categoryKey] || !Array.isArray(localItems[categoryKey])) {
                    console.error(`Category ${categoryKey} not found in localStorage or has no items`);
                    alert(`Category ${categoryKey} not found in localStorage or has no items`);
                    return;
                }
                
                const categoryData = categories[categoryKey];
                if (!categoryData) {
                    console.error(`Category ${categoryKey} not found in categories object`);
                    alert(`Category ${categoryKey} not found in categories object`);
                    return;
                }
                
                console.log(`Replacing items for category ${categoryKey} with ${localItems[categoryKey].length} items from localStorage...`);
                
                const categoryRecord = {
                    user_id: currentUser.id,
                    category_key: categoryKey,
                    name_en: categoryData.nameEn,
                    name_es: categoryData.nameEs,
                    description_en: categoryData.descriptionEn,
                    description_es: categoryData.descriptionEs,
                    pricing_type: categoryData.pricingType || 'fixed',
                    recurring_weekly: categoryData.recurringWeekly || false,
                    recurring_monthly: categoryData.recurringMonthly || false,
                    monthly_day: categoryData.monthlyDay,
                    has_due_date: categoryData.hasDueDate || false,
                    due_date: categoryData.dueDate,
                    items: localItems[categoryKey] // Use localStorage items directly
                };
                
                const { error } = await supabase
                    .from('custom_categories')
                    .upsert(categoryRecord, {
                        onConflict: 'user_id,category_key'
                    });
                
                if (error) {
                    console.error(`Error replacing category ${categoryKey}:`, error);
                    alert(`Error: ${error.message}`);
                } else {
                    console.log(`Successfully replaced ${localItems[categoryKey].length} items for category ${categoryKey}`);
                    alert(`Successfully replaced ${localItems[categoryKey].length} items for category ${categoryKey}!`);
                    // Reload data
                    await loadUserData();
                }
            } else {
                // Replace all categories
                console.log('Replacing ALL category items from localStorage...');
                let replacedCount = 0;
                let errorCount = 0;
                
                for (const [catKey, catItems] of Object.entries(localItems)) {
                    if (!Array.isArray(catItems) || catItems.length === 0) {
                        continue;
                    }
                    
                    const catData = categories[catKey];
                    if (!catData) {
                        console.warn(`Category ${catKey} not found in categories object, skipping`);
                        continue;
                    }
                    
                    const categoryRecord = {
                        user_id: currentUser.id,
                        category_key: catKey,
                        name_en: catData.nameEn,
                        name_es: catData.nameEs,
                        description_en: catData.descriptionEn,
                        description_es: catData.descriptionEs,
                        pricing_type: catData.pricingType || 'fixed',
                        recurring_weekly: catData.recurringWeekly || false,
                        recurring_monthly: catData.recurringMonthly || false,
                        monthly_day: catData.monthlyDay,
                        has_due_date: catData.hasDueDate || false,
                        due_date: catData.dueDate,
                        items: catItems // Use localStorage items directly
                    };
                    
                    const { error } = await supabase
                        .from('custom_categories')
                        .upsert(categoryRecord, {
                            onConflict: 'user_id,category_key'
                        });
                    
                    if (error) {
                        console.error(`Error replacing category ${catKey}:`, error);
                        errorCount++;
                    } else {
                        replacedCount++;
                        console.log(`Replaced ${catItems.length} items for category ${catKey}`);
                    }
                }
                
                console.log(`Replacement complete! Replaced: ${replacedCount} categories, Errors: ${errorCount}`);
                alert(`Replacement complete!\\nReplaced: ${replacedCount} categories\\nErrors: ${errorCount}`);
                
                // Reload data
                await loadUserData();
            }
        }
        window.forceReplaceCategoryItems = forceReplaceCategoryItems;
        
        // Function to migrate localStorage data to Supabase
        async function migrateLocalStorageToSupabase(localCategories, localItems, localBudgetItems, localSavedBudgets = []) {
            if (!currentUser || !useSupabase) return;
            
            try {
                // Migrate categories
                for (const [categoryKey, categoryData] of Object.entries(localCategories)) {
                    const categoryItems = localItems[categoryKey] || [];
                    
                    const categoryRecord = {
                        user_id: currentUser.id,
                        category_key: categoryKey,
                        name_en: categoryData.nameEn,
                        name_es: categoryData.nameEs,
                        description_en: categoryData.descriptionEn,
                        description_es: categoryData.descriptionEs,
                        pricing_type: categoryData.pricingType || 'fixed',
                        recurring_weekly: categoryData.recurringWeekly || false,
                        recurring_monthly: categoryData.recurringMonthly || false,
                        monthly_day: categoryData.monthlyDay,
                        has_due_date: categoryData.hasDueDate || false,
                        due_date: categoryData.dueDate,
                        items: categoryItems
                    };
                    
                    await supabase
                        .from('custom_categories')
                        .upsert(categoryRecord, {
                            onConflict: 'user_id,category_key'
                        });
                }
                
                // Migrate budget items
                for (const item of localBudgetItems) {
                    const dbItem = convertAppItemToDbItem(item);
                    dbItem.user_id = currentUser.id;
                    await supabase.from('budget_items').insert([dbItem]);
                }
                
                // Migrate saved budgets
                if (localSavedBudgets.length > 0) {
                    await migrateSavedBudgets(localSavedBudgets);
                }
                
                console.log('Migration completed successfully');
                showApprovalStatus('success', 'Data migrated to cloud successfully!');
            } catch (error) {
                console.error('Error migrating data:', error);
                showApprovalStatus('error', 'Error migrating data: ' + error.message);
            }
        }
        
        // Function to migrate Canada requests to Supabase
        // Function to save a single Canada request to Supabase
        async function saveCanadaRequestToSupabase(request) {
            if (!currentUser || !useSupabase) return;
            
            try {
                // Get the max request_number for this user to avoid duplicates
                const { data: existingRequests, error: maxError } = await supabase
                    .from('canada_requests')
                    .select('request_number')
                    .eq('user_id', currentUser.id)
                    .order('request_number', { ascending: false })
                    .limit(1);
                
                if (maxError && maxError.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw maxError;
                }
                
                // Calculate next request number
                let requestNumber = 0;
                if (existingRequests && existingRequests.length > 0) {
                    requestNumber = (existingRequests[0].request_number || 0) + 1;
                }
                
                // Create request
                let newRequest;
                let reqError;
                
                const { data: requestData, error: insertError } = await supabase
                    .from('canada_requests')
                    .insert([{
                        user_id: currentUser.id,
                        request_number: requestNumber,
                        date: new Date(request.date).toISOString(),
                        status: request.status || 'pending'
                    }])
                    .select()
                    .single();
                
                if (insertError) {
                    reqError = insertError;
                    // If duplicate key error, try with next number
                    if (insertError.code === '23505') {
                        console.warn('Duplicate request_number detected, retrying with next number...');
                        requestNumber += 1;
                        const { data: retryRequest, error: retryError } = await supabase
                            .from('canada_requests')
                            .insert([{
                                user_id: currentUser.id,
                                request_number: requestNumber,
                                date: new Date(request.date).toISOString(),
                                status: request.status || 'pending'
                            }])
                            .select()
                            .single();
                        
                        if (retryError) throw retryError;
                        newRequest = retryRequest;
                    } else {
                        throw insertError;
                    }
                } else {
                    newRequest = requestData;
                }
                
                // Insert request items
                if (request.items && request.items.length > 0) {
                    const items = request.items.map(item => ({
                        request_id: newRequest.id,
                        name_en: item.nameEn,
                        name_es: item.nameEs,
                        category: item.category,
                        quantity: item.quantity,
                        unit: item.unit || 'sheet',
                        unit_price: item.unitPrice || 0,
                        total_price: (item.unitPrice || 0) * (item.quantity || 1)
                    }));
                    
                    await supabase.from('canada_request_items').insert(items);
                }
                
                // Update the request object with the new database ID
                request.id = newRequest.id;
                
                console.log('Canada request saved to Supabase:', newRequest.id, 'request_number:', requestNumber);
            } catch (error) {
                console.error('Error saving Canada request to Supabase:', error);
                throw error;
            }
        }

        async function migrateCanadaRequests(localHistory) {
            if (!currentUser || !useSupabase) return;
            
            try {
                // Get the current max request_number for this user to avoid conflicts
                const { data: existingRequests } = await supabase
                    .from('canada_requests')
                    .select('request_number')
                    .eq('user_id', currentUser.id)
                    .order('request_number', { ascending: false })
                    .limit(1);
                
                let nextRequestNumber = 1;
                if (existingRequests && existingRequests.length > 0) {
                    nextRequestNumber = (existingRequests[0].request_number || 0) + 1;
                }
                
                for (const request of localHistory) {
                    // Skip requests with no date or empty data
                    if (!request.date || request.date === null) {
                        console.warn('Request missing date, skipping:', request);
                        continue;
                    }
                    
                    // Skip requests with no items and no tracking (likely already migrated empty data)
                    if ((!request.items || request.items.length === 0) && 
                        (!request.trackingShipments || request.trackingShipments.length === 0)) {
                        console.warn('Request has no items or tracking data, skipping:', request);
                        continue;
                    }
                    
                    // Normalize date format
                    let requestDate = request.date;
                    // Ensure date is in ISO format
                    if (typeof requestDate === 'string') {
                        requestDate = new Date(requestDate).toISOString();
                    } else if (requestDate instanceof Date) {
                        requestDate = requestDate.toISOString();
                    } else {
                        console.warn('Invalid date format, skipping:', request);
                        continue;
                    }
                    
                    // Check if request already exists by date (to avoid duplicates)
                    const { data: existingRequest } = await supabase
                        .from('canada_requests')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('date', requestDate)
                        .maybeSingle(); // Use maybeSingle() instead of single() to avoid errors if not found
                    
                    let requestId;
                    if (existingRequest) {
                        requestId = existingRequest.id;
                        // Update existing request
                        await supabase
                            .from('canada_requests')
                            .update({
                                status: request.status,
                                sent_date: request.sentDate,
                                received_date: request.receivedDate
                            })
                            .eq('id', requestId);
                    } else {
                        // Create new request with request_number
                        const { data: newRequest, error: reqError } = await supabase
                            .from('canada_requests')
                            .insert([{
                                user_id: currentUser.id,
                                request_number: nextRequestNumber,
                                date: requestDate,
                                status: request.status || 'pending',
                                sent_date: request.sentDate ? new Date(request.sentDate).toISOString() : null,
                                received_date: request.receivedDate ? new Date(request.receivedDate).toISOString() : null
                            }])
                            .select()
                            .single();
                        
                        if (reqError) throw reqError;
                        requestId = newRequest.id;
                        nextRequestNumber++; // Increment for next request
                    }
                    
                    // Migrate request items
                    if (request.items && request.items.length > 0) {
                        // Delete existing items
                        await supabase
                            .from('canada_request_items')
                            .delete()
                            .eq('request_id', requestId);
                        
                        // Insert items
                        const items = request.items.map(item => ({
                            request_id: requestId,
                            name_en: item.nameEn,
                            name_es: item.nameEs,
                            category: item.category,
                            quantity: item.quantity,
                            unit_price: item.unitPrice,
                            total_price: item.totalPrice,
                            notes: item.notes
                        }));
                        
                        await supabase.from('canada_request_items').insert(items);
                    }
                    
                    // Migrate tracking shipments
                    if (request.trackingShipments && request.trackingShipments.length > 0) {
                        // Delete existing tracking
                        await supabase
                            .from('canada_tracking_shipments')
                            .delete()
                            .eq('request_id', requestId);
                        
                        // Insert tracking
                        const tracking = request.trackingShipments.map(shipment => ({
                            request_id: requestId,
                            tracking_number: shipment.trackingNumber,
                            shipment_items: shipment.itemIds || [],
                            ups_status: shipment.upsStatus,
                            ups_last_update: shipment.upsLastUpdate,
                            ups_has_duties_due: shipment.upsHasDutiesDue || false,
                            ups_has_delay: shipment.upsHasDelay || false,
                            ups_exception_description: shipment.upsExceptionDescription,
                            ups_picked_up: shipment.upsPickedUp || false,
                            ups_in_transit: shipment.upsInTransit || false,
                            ups_duties_paid: shipment.upsDutiesPaid || false,
                            ups_duties_amount: shipment.upsDutiesAmount || ''
                        }));
                        
                        await supabase.from('canada_tracking_shipments').insert(tracking);
                    }
                    
                    // Migrate backorders
                    if (request.backorders && request.backorders.length > 0) {
                        // Delete existing backorders
                        await supabase
                            .from('canada_backorders')
                            .delete()
                            .eq('request_id', requestId);
                        
                        // Insert backorders
                        const backorders = request.backorders.map(bo => ({
                            request_id: requestId,
                            name_en: bo.nameEn,
                            name_es: bo.nameEs,
                            category: bo.category,
                            backorder_qty: bo.backorderQty,
                            notes: bo.notes
                        }));
                        
                        await supabase.from('canada_backorders').insert(backorders);
                    }
                }
                
                console.log(`Migrated ${localHistory.length} Canada requests`);
            } catch (error) {
                console.error('Error migrating Canada requests:', error);
                throw error;
            }
        }
        
        // Function to migrate Canada requests from localStorage to Supabase (user-triggered)
        async function migrateCanadaRequestsFromLocalStorage() {
            if (!useSupabase || !currentUser) {
                alert(currentLanguage === 'en' 
                    ? 'Please log in to Supabase first to migrate requests.' 
                    : 'Por favor inicia sesiÃ³n en Supabase primero para migrar solicitudes.');
                return;
            }
            
            const localHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
            
            if (localHistory.length === 0) {
                alert(currentLanguage === 'en' 
                    ? 'No requests found in localStorage to migrate.' 
                    : 'No se encontraron solicitudes en localStorage para migrar.');
                return;
            }
            
            if (!confirm(currentLanguage === 'en' 
                ? `Found ${localHistory.length} request(s) in localStorage.\n\nMigrate these to Supabase? This will not create duplicates if requests already exist.` 
                : `Se encontraron ${localHistory.length} solicitud(es) en localStorage.\n\nÂ¿Migrar estas a Supabase? Esto no crearÃ¡ duplicados si las solicitudes ya existen.`)) {
                return;
            }
            
            try {
                // Show loading message
                const historyDiv = document.getElementById('canadaRequestHistory');
                if (historyDiv) {
                    historyDiv.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #3498db; background: #e3f2fd; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">â³ ${currentLanguage === 'en' ? 'Migrating requests...' : 'Migrando solicitudes...'}</div>
                            <div style="font-size: 0.9rem; color: #666;">${currentLanguage === 'en' ? 'Please wait...' : 'Por favor espera...'}</div>
                        </div>
                    `;
                }
                
                await migrateCanadaRequests(localHistory);
                
                // Reload history to show migrated requests
                await loadCanadaHistory();
                
                // Show success message
                showApprovalStatus('success', currentLanguage === 'en' 
                    ? `Successfully migrated ${localHistory.length} request(s) to Supabase!` 
                    : `Â¡Se migraron exitosamente ${localHistory.length} solicitud(es) a Supabase!`);
            } catch (error) {
                console.error('Error migrating Canada requests:', error);
                showApprovalStatus('error', currentLanguage === 'en' 
                    ? `Error migrating requests: ${error.message}` 
                    : `Error al migrar solicitudes: ${error.message}`);
                
                // Reload history anyway
                await loadCanadaHistory();
            }
        }

        // Function to check UPS and Canada tracking status
        async function checkTrackingStatus() {
            const upsClientId = localStorage.getItem('upsClientId');
            const upsClientSecret = localStorage.getItem('upsClientSecret');
            const canadaHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
            
            let message = '=== TRACKING STATUS CHECK ===\n\n';
            
            // Check UPS keys
            if (upsClientId && upsClientSecret) {
                message += `âœ“ UPS API Keys: SET\n`;
                message += `  Client ID: ${upsClientId.substring(0, 10)}...\n`;
            } else {
                message += `âœ— UPS API Keys: NOT SET\n`;
                message += `  Go to Settings tab and enter your UPS Client ID and Secret\n\n`;
            }
            
            // Check Canada requests in localStorage
            message += `\nCanada Requests (localStorage): ${canadaHistory.length}\n`;
            if (canadaHistory.length > 0) {
                let withTracking = 0;
                let withUPSStatus = 0;
                canadaHistory.forEach(req => {
                    if (req.trackingShipments && req.trackingShipments.length > 0) {
                        withTracking++;
                        req.trackingShipments.forEach(ship => {
                            if (ship.upsStatus) withUPSStatus++;
                        });
                    }
                });
                message += `  - Requests with tracking: ${withTracking}\n`;
                message += `  - Shipments with UPS status: ${withUPSStatus}\n`;
            }
            
            // Check Supabase
            if (useSupabase && currentUser) {
                try {
                    const { data: supabaseRequests, error: reqError } = await supabase
                        .from('canada_requests')
                        .select('id')
                        .eq('user_id', currentUser.id);
                    
                    if (reqError) throw reqError;
                    
                    message += `\nCanada Requests (Supabase): ${supabaseRequests?.length || 0}\n`;
                    
                    if (supabaseRequests && supabaseRequests.length > 0) {
                        const { data: tracking, error: trackError } = await supabase
                            .from('canada_tracking_shipments')
                            .select('*')
                            .in('request_id', supabaseRequests.map(r => r.id));
                        
                        if (!trackError && tracking) {
                            message += `  - Tracking shipments: ${tracking.length}\n`;
                            const withStatus = tracking.filter(t => t.ups_status).length;
                            message += `  - With UPS status: ${withStatus}\n`;
                            if (tracking.length > 0) {
                                message += `  - Sample tracking: ${tracking[0].tracking_number} (${tracking[0].ups_status || 'no status'})\n`;
                            }
                        }
                    }
                } catch (error) {
                    message += `\nâœ— Error checking Supabase: ${error.message}\n`;
                }
            } else {
                message += `\nâœ— Not logged in to Supabase\n`;
            }
            
            alert(message);
            console.log('UPS Client ID:', upsClientId ? 'SET' : 'NOT SET');
            console.log('UPS Client Secret:', upsClientSecret ? 'SET' : 'NOT SET');
            console.log('Canada Requests (localStorage):', canadaHistory.length);
        }
        
        // Function to export Canada requests data (run on local machine)
        function exportCanadaRequests() {
            const localHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
            
            if (localHistory.length === 0) {
                alert('No Canada requests found in localStorage to export.');
                return;
            }
            
            const exportData = JSON.stringify(localHistory, null, 2);
            
            // Copy to clipboard
            navigator.clipboard.writeText(exportData).then(() => {
                alert(`Exported ${localHistory.length} Canada requests!\n\nData copied to clipboard. Paste it into the import function on the live site.`);
                console.log('=== CANADA REQUESTS DATA (copy this) ===');
                console.log(exportData);
            }).catch(() => {
                // Fallback if clipboard doesn't work
                const textarea = document.createElement('textarea');
                textarea.value = exportData;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert(`Exported ${localHistory.length} Canada requests!\n\nData copied to clipboard. Paste it into the import function on the live site.`);
                console.log('=== CANADA REQUESTS DATA (copy this) ===');
                console.log(exportData);
            });
        }
        
        // Function to import Canada requests data (run on live site)
        async function importCanadaRequests(jsonData) {
            if (!currentUser || !useSupabase) {
                alert('Please log in first to import Canada requests to Supabase');
                return;
            }
            
            let data;
            try {
                // If jsonData is a string, parse it; if it's already an object, use it
                data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
            } catch (error) {
                alert('Invalid JSON data. Please check the data and try again.');
                return;
            }
            
            if (!Array.isArray(data) || data.length === 0) {
                alert('No valid Canada requests data found.');
                return;
            }
            
            if (!confirm(`Found ${data.length} Canada requests to import.\n\nImport these to Supabase?`)) {
                return;
            }
            
            try {
                showApprovalStatus('info', 'Importing Canada requests... Please wait.');
                
                // Save to localStorage first
                localStorage.setItem('canadaRequestHistory', JSON.stringify(data));
                
                // Migrate to Supabase
                await migrateCanadaRequests(data);
                
                showApprovalStatus('success', `Successfully imported ${data.length} Canada requests!`);
                
                // Reload the history
                await loadCanadaHistory();
            } catch (error) {
                console.error('Error importing Canada requests:', error);
                showApprovalStatus('error', 'Error importing Canada requests: ' + error.message);
                alert('Error importing Canada requests: ' + error.message);
            }
        }
        
        // Function to manually restore Canada requests from localStorage to Supabase
        async function restoreCanadaRequests() {
            if (!currentUser || !useSupabase) {
                alert('Please log in first to restore Canada requests to Supabase');
                return;
            }
            
            const localHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
            
            if (localHistory.length === 0) {
                alert('No Canada requests found in localStorage to restore.');
                return;
            }
            
            if (!confirm(`Found ${localHistory.length} Canada requests in localStorage.\n\nRestore these to Supabase?`)) {
                return;
            }
            
            try {
                showApprovalStatus('info', 'Restoring Canada requests... Please wait.');
                await migrateCanadaRequests(localHistory);
                showApprovalStatus('success', `Successfully restored ${localHistory.length} Canada requests!`);
                
                // Reload the history
                await loadCanadaHistory();
            } catch (error) {
                console.error('Error restoring Canada requests:', error);
                showApprovalStatus('error', 'Error restoring Canada requests: ' + error.message);
                alert('Error restoring Canada requests: ' + error.message);
            }
        }
        
        // Function to check localStorage data (for debugging)
        function checkLocalStorageData() {
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
            const categories = JSON.parse(localStorage.getItem('customCategories') || '{}');
            const items = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            const budgetItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
            
            console.log('=== LOCALSTORAGE DATA CHECK ===');
            console.log('Saved Budgets:', savedBudgets.length, savedBudgets);
            console.log('Categories:', Object.keys(categories).length, categories);
            console.log('Category Items:', Object.keys(items).length, items);
            console.log('Current Budget Items:', budgetItems.length, budgetItems);
            
            // Count total items across all categories
            let totalItems = 0;
            Object.keys(items).forEach(cat => {
                if (Array.isArray(items[cat])) {
                    totalItems += items[cat].length;
                }
            });
            
            const message = `LocalStorage Check:\n- Saved Budgets: ${savedBudgets.length}\n- Categories: ${Object.keys(categories).length}\n- Category Items: ${totalItems} items in ${Object.keys(items).length} categories\n- Current Budget Items: ${budgetItems.length}\n\nCheck browser console (F12) for details.`;
            alert(message);
            
            return { savedBudgets, categories, items, budgetItems };
        }
        
        // Function to restore category items from localStorage
        async function restoreCategoryItems() {
            const localItems = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            const localCategories = JSON.parse(localStorage.getItem('customCategories') || '{}');
            
            // Count total items
            let totalItems = 0;
            Object.keys(localItems).forEach(cat => {
                if (Array.isArray(localItems[cat])) {
                    totalItems += localItems[cat].length;
                }
            });
            
            if (totalItems === 0) {
                alert('No category items found in localStorage to restore.');
                return;
            }
            
            if (!confirm(`Found ${totalItems} items in ${Object.keys(localItems).length} categories in localStorage.\n\nRestore these items?`)) {
                return;
            }
            
            try {
                // Restore to app memory
                itemDatabase = localItems;
                if (Object.keys(localCategories).length > 0) {
                    categories = localCategories;
                }
                
                // Save to localStorage
                localStorage.setItem('categoryItems', JSON.stringify(itemDatabase));
                if (Object.keys(categories).length > 0) {
                    localStorage.setItem('customCategories', JSON.stringify(categories));
                }
                
                // Save to Supabase if logged in
                if (useSupabase && currentUser) {
                    await saveCategoryItems();
                }
                
                // Refresh UI
                if (typeof loadCategoriesList === 'function') loadCategoriesList();
                if (typeof populateCategoryDropdowns === 'function') populateCategoryDropdowns();
                
                alert(`Successfully restored ${totalItems} items!`);
                showApprovalStatus('success', `Restored ${totalItems} items from ${Object.keys(localItems).length} categories`);
            } catch (error) {
                console.error('Error restoring items:', error);
                alert('Error restoring items: ' + error.message);
            }
        }
        
        // Emergency recovery function - restores data from localStorage to Supabase
        async function emergencyRecoverData() {
            if (!currentUser || !useSupabase) {
                alert('Please log in first to recover data to Supabase');
                return;
            }
            
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
            const categories = JSON.parse(localStorage.getItem('customCategories') || '{}');
            const items = JSON.parse(localStorage.getItem('categoryItems') || '{}');
            const budgetItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
            
            if (savedBudgets.length === 0 && Object.keys(categories).length === 0 && Object.keys(items).length === 0 && budgetItems.length === 0) {
                alert('No data found in localStorage to recover. Your data may have been cleared.');
                return;
            }
            
            if (!confirm(`Found data in localStorage:\n- ${savedBudgets.length} saved budgets\n- ${Object.keys(categories).length} categories\n- ${Object.keys(items).length} category items\n- ${budgetItems.length} current budget items\n\nRecover this data to Supabase?`)) {
                return;
            }
            
            try {
                showApprovalStatus('info', 'Recovering data... Please wait.');
                
                // Recover categories
                if (Object.keys(categories).length > 0) {
                    for (const [categoryKey, categoryData] of Object.entries(categories)) {
                        const categoryItems = items[categoryKey] || [];
                        
                        const categoryRecord = {
                            user_id: currentUser.id,
                            category_key: categoryKey,
                            name_en: categoryData.nameEn,
                            name_es: categoryData.nameEs,
                            description_en: categoryData.descriptionEn,
                            description_es: categoryData.descriptionEs,
                            pricing_type: categoryData.pricingType || 'fixed',
                            recurring_weekly: categoryData.recurringWeekly || false,
                            recurring_monthly: categoryData.recurringMonthly || false,
                            monthly_day: categoryData.monthlyDay,
                            has_due_date: categoryData.hasDueDate || false,
                            due_date: categoryData.dueDate,
                            items: categoryItems
                        };
                        
                        await supabase
                            .from('custom_categories')
                            .upsert(categoryRecord, {
                                onConflict: 'user_id,category_key'
                            });
                    }
                }
                
                // Recover saved budgets
                if (savedBudgets.length > 0) {
                    await migrateSavedBudgets(savedBudgets);
                }
                
                // Recover current budget items
                if (budgetItems.length > 0) {
                    for (const item of budgetItems) {
                        const dbItem = convertAppItemToDbItem(item);
                        dbItem.user_id = currentUser.id;
                        await supabase.from('budget_items').upsert([dbItem], {
                            onConflict: 'id'
                        });
                    }
                }
                
                showApprovalStatus('success', 'Data recovered successfully! Refreshing...');
                setTimeout(() => {
                    loadUserData();
                }, 1000);
                
            } catch (error) {
                console.error('Error recovering data:', error);
                showApprovalStatus('error', 'Error recovering data: ' + error.message);
            }
        }
        
        // Function to migrate saved budgets
        async function migrateSavedBudgets(localSavedBudgets) {
            if (!currentUser || !useSupabase) return;
            
            try {
                for (const budget of localSavedBudgets) {
                    // Create saved budget record
                    const { data: savedBudget, error: budgetError } = await supabase
                        .from('saved_budgets')
                        .insert([{
                            user_id: currentUser.id,
                            saved_date: budget.savedDate,
                            week_start: budget.weekStart,
                            week_label: budget.weekLabel,
                            total: budget.total || 0,
                            item_count: budget.itemCount || 0,
                            approved_count: budget.approvedCount || 0,
                            pending_count: budget.pendingCount || 0,
                            language: budget.language || 'en',
                            is_partial_payment: budget.isPartialPayment || false
                        }])
                        .select()
                        .single();
                    
                    if (budgetError) {
                        // If budget already exists (duplicate), skip it
                        if (budgetError.code !== '23505') { // 23505 is unique violation
                            throw budgetError;
                        }
                        continue;
                    }
                    
                    // Save budget items
                    if (budget.items && budget.items.length > 0) {
                        const budgetItems = budget.items.map(item => ({
                            saved_budget_id: savedBudget.id,
                            item_data: item
                        }));
                        
                        await supabase.from('saved_budget_items').insert(budgetItems);
                    }
                }
                
                console.log(`Migrated ${localSavedBudgets.length} saved budgets`);
            } catch (error) {
                console.error('Error migrating saved budgets:', error);
                throw error;
            }
        }
        
        // Helper function to convert database item to app format
        function convertDbItemToAppItem(dbItem) {
            return {
                id: dbItem.id,
                nameEn: dbItem.name_en,
                nameEs: dbItem.name_es,
                descriptionEn: dbItem.description_en,
                descriptionEs: dbItem.description_es,
                category: dbItem.category,
                pricingType: dbItem.pricing_type,
                unitPrice: parseFloat(dbItem.unit_price || 0),
                quantity: dbItem.quantity || 1,
                totalPrice: parseFloat(dbItem.total_price || 0),
                priority: dbItem.priority,
                approvalStatus: dbItem.approval_status,
                approvalReason: dbItem.approval_reason,
                invoicePhoto: dbItem.invoice_photo,
                invoiceFileName: dbItem.invoice_file_name,
                invoiceFileType: dbItem.invoice_file_type,
                receiptAmount: parseFloat(dbItem.receipt_amount || 0),
                notes: dbItem.notes,
                notesEn: dbItem.notes_en,
                notesEs: dbItem.notes_es,
                dateAdded: dbItem.date_added,
                recurringWeekly: dbItem.recurring_weekly,
                recurringMonthly: dbItem.recurring_monthly,
                monthlyDay: dbItem.monthly_day,
                hasDueDate: dbItem.has_due_date,
                dueDate: dbItem.due_date,
                forCanada: dbItem.for_canada,
                weeklyAddedWeek: dbItem.weekly_added_week,
                monthlyAddedMonth: dbItem.monthly_added_month,
                monthlyAddedYear: dbItem.monthly_added_year,
                priceAdjustmentNote: dbItem.price_adjustment_note,
                hasPriceAdjustment: dbItem.has_price_adjustment || false,
                adjustmentApplied: dbItem.adjustment_applied || false,
                supplier: {
                    name: dbItem.supplier_name || '',
                    phone: dbItem.supplier_phone || '',
                    email: dbItem.supplier_email || '',
                    address: dbItem.supplier_address || ''
                }
            };
        }
        
        // Helper function to convert app item to database format
        function convertAppItemToDbItem(appItem) {
            const dbItem = {
                name_en: appItem.nameEn,
                name_es: appItem.nameEs,
                description_en: appItem.descriptionEn,
                description_es: appItem.descriptionEs,
                category: appItem.category,
                pricing_type: appItem.pricingType,
                unit_price: appItem.unitPrice,
                quantity: appItem.quantity || 1,
                total_price: appItem.totalPrice,
                priority: appItem.priority,
                approval_status: appItem.approvalStatus,
                approval_reason: appItem.approvalReason,
                invoice_photo: appItem.invoicePhoto,
                invoice_file_name: appItem.invoiceFileName,
                invoice_file_type: appItem.invoiceFileType,
                receipt_amount: appItem.receiptAmount,
                notes: appItem.notes,
                notes_en: appItem.notesEn,
                notes_es: appItem.notesEs,
                date_added: appItem.dateAdded || new Date().toISOString(),
                recurring_weekly: appItem.recurringWeekly || false,
                recurring_monthly: appItem.recurringMonthly || false,
                monthly_day: appItem.monthlyDay,
                has_due_date: appItem.hasDueDate || false,
                due_date: appItem.dueDate,
                for_canada: appItem.forCanada || false,
                supplier_name: appItem.supplier?.name || '',
                supplier_phone: appItem.supplier?.phone || '',
                supplier_email: appItem.supplier?.email || '',
                supplier_address: appItem.supplier?.address || '',
                price_adjustment_note: appItem.priceAdjustmentNote,
                has_price_adjustment: appItem.hasPriceAdjustment || false,
                adjustment_applied: appItem.adjustmentApplied || false
            };
            
            // Only include these fields if they exist (to avoid schema cache errors)
            // These columns may not exist in older databases until schema cache refreshes
            if (appItem.weeklyAddedWeek !== undefined && appItem.weeklyAddedWeek !== null) {
                dbItem.weekly_added_week = appItem.weeklyAddedWeek;
            }
            if (appItem.monthlyAddedMonth !== undefined && appItem.monthlyAddedMonth !== null) {
                dbItem.monthly_added_month = appItem.monthlyAddedMonth;
            }
            if (appItem.monthlyAddedYear !== undefined && appItem.monthlyAddedYear !== null) {
                dbItem.monthly_added_year = appItem.monthlyAddedYear;
            }
            
            return dbItem;
        }
        
        function convertDbActivityToApp(dbActivity) {
            return {
                id: dbActivity.id,
                type: dbActivity.type,
                description: dbActivity.description,
                itemId: dbActivity.item_id,
                timestamp: dbActivity.created_at
            };
        }
        
        function convertDbHistoryToApp(dbHistory) {
            return {
                id: dbHistory.id,
                type: dbHistory.type,
                itemId: dbHistory.item_id,
                itemName: dbHistory.item_name,
                oldValue: dbHistory.old_value,
                newValue: dbHistory.new_value,
                field: dbHistory.field,
                timestamp: dbHistory.created_at
            };
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            updateLanguage(); // This is now async but we don't need to await it
        }

        function updateUnitPriceField() {
            const category = document.getElementById('category').value;
            const unitPriceInput = document.getElementById('unitPrice');
            const unitPriceHelp = document.getElementById('unitPriceHelp');
            const canadaCheckbox = document.getElementById('itemForCanada');
            const isCanadaItem = canadaCheckbox && canadaCheckbox.checked;
            
            // Check if category is Canada (case-insensitive)
            const isCanadaCategory = category && (
                category.toLowerCase() === 'canada' ||
                (categories[category] && (
                    (categories[category].nameEn && categories[category].nameEn.toLowerCase() === 'canada') ||
                    (categories[category].nameEs && categories[category].nameEs.toLowerCase() === 'canadÃ¡')
                ))
            );
            
            // Auto-check Canada checkbox if Canada category is selected
            if (isCanadaCategory && canadaCheckbox) {
                canadaCheckbox.checked = true;
                toggleItemForCanada();
            }
            
            // Check item pricing type (user can override category setting)
            const itemPricingType = document.getElementById('itemPricingType');
            let isFlexibleCost = false;
            
            if (itemPricingType) {
                isFlexibleCost = itemPricingType.value === 'flexible';
            } else if (category && categories[category]) {
                // Fallback to category pricing type if item pricing type not available
                isFlexibleCost = categories[category].pricingType === 'flexible';
            }
            
            // Auto-update item pricing type to match category when category is selected
            if (category && categories[category] && itemPricingType) {
                const categoryPricingType = categories[category].pricingType;
                if (categoryPricingType) {
                    itemPricingType.value = categoryPricingType;
                    isFlexibleCost = categoryPricingType === 'flexible';
                }
            }
            
            if (isFlexibleCost || isCanadaItem || isCanadaCategory) {
                unitPriceInput.removeAttribute('required');
                unitPriceInput.required = false;
                if (isFlexibleCost && !isCanadaItem && !isCanadaCategory) {
                    unitPriceHelp.style.display = 'block';
                } else {
                    unitPriceHelp.style.display = 'none';
                }
            } else {
                unitPriceInput.setAttribute('required', 'required');
                unitPriceInput.required = true;
                unitPriceHelp.style.display = 'none';
            }
        }

        // Translation cache to avoid repeated API calls
        const translationCache = {};
        
        // Get DeepL API key from localStorage (user needs to set this)
        function getDeepLAPIKey() {
            return localStorage.getItem('deeplApiKey') || '';
        }
        
        async function translateTextAPI(text, fromLang, toLang) {
            if (!text || text.trim() === '') return text;
            
            // Check cache first
            const cacheKey = `${fromLang}_${toLang}_${text}`;
            if (translationCache[cacheKey]) {
                return translationCache[cacheKey];
            }
            
            // Get DeepL API key
            const apiKey = getDeepLAPIKey();
            if (!apiKey) {
                console.warn('DeepL API key not set. Please add your API key in Settings. Falling back to basic translation.');
                return translateText(text, fromLang, toLang);
            }
            
            // Validate API key format (should contain a colon and end with :fx for free tier)
            if (!apiKey.includes(':') && !apiKey.endsWith(':fx')) {
                console.warn('DeepL API key format may be incorrect. Free tier keys should end with :fx');
            }
            
            // Use DeepL Translation API
            try {
                // DeepL language codes: 'EN' for English, 'ES' for Spanish
                const sourceLang = fromLang.toUpperCase() === 'EN' ? 'EN' : 'ES';
                const targetLang = toLang.toUpperCase() === 'ES' ? 'ES' : 'EN';
                
                // Use free tier endpoint (api-free.deepl.com) or paid tier (api.deepl.com)
                // Free tier has 500,000 characters/month limit
                // Note: When running from file://, we need to use a CORS proxy
                const isLocalFile = window.location.protocol === 'file:';
                let apiUrl = 'https://api-free.deepl.com/v2/translate';
                
                // If running from file://, we'll use a CORS proxy in the fetch call below
                
                const formData = new URLSearchParams();
                formData.append('auth_key', apiKey);
                formData.append('text', text);
                formData.append('source_lang', sourceLang);
                formData.append('target_lang', targetLang);
                
                // For CORS proxy, we need to send the request differently
                let response;
                let data;
                
                if (isLocalFile) {
                    // When running from file://, use CORS proxy
                    // Using corsproxy.io which properly handles POST requests
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api-free.deepl.com/v2/translate');
                    
                    response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`DeepL API error: ${response.status} ${response.statusText}`);
                    }
                    
                    data = await response.json();
                } else {
                    // Direct API call (works when served from a web server)
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`DeepL API error: ${response.status} ${response.statusText}`);
                    }
                    
                    data = await response.json();
                }
                
                if (data.translations && data.translations.length > 0 && data.translations[0].text) {
                    const translated = data.translations[0].text;
                    // Cache the translation
                    translationCache[cacheKey] = translated;
                    return translated;
                } else {
                    throw new Error('No translation returned from DeepL API');
                }
            } catch (error) {
                console.error('DeepL Translation API error:', error);
                console.error('Error details:', {
                    message: error.message,
                    text: text,
                    fromLang: fromLang,
                    toLang: toLang,
                    apiKeyPresent: !!apiKey,
                    apiKeyLength: apiKey ? apiKey.length : 0
                });
                // Fallback to simple translation if API fails
                return translateText(text, fromLang, toLang);
            }
        }
        
        async function updateLanguage() {
            const elements = document.querySelectorAll('[data-en][data-es]');
            elements.forEach(element => {
                const text = element.getAttribute(`data-${currentLanguage}`);
                if (text) {
                    // Update text content for most elements
                    if (element.tagName === 'INPUT' && element.type === 'text' || element.tagName === 'INPUT' && element.type === 'email' || element.tagName === 'INPUT' && element.type === 'tel') {
                        // For input elements, update placeholder if it exists
                        if (element.hasAttribute('placeholder')) {
                            element.placeholder = text;
                        }
                    } else if (element.tagName === 'TEXTAREA') {
                        // For textarea, update placeholder
                        if (element.hasAttribute('placeholder')) {
                            element.placeholder = text;
                        } else {
                            element.textContent = text;
                        }
                    } else if (element.tagName === 'OPTION') {
                        // For option elements, update text
                        element.textContent = text;
                    } else {
                        // For other elements, update text content
                        element.textContent = text;
                    }
                }
            });
            
            // Update title attributes for drag handles
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.setAttribute('title', currentLanguage === 'en' ? 'Drag to reorder' : 'Arrastrar para reordenar');
            });
            
            document.getElementById('langToggle').textContent = currentLanguage === 'en' ? 'ES / EN' : 'EN / ES';
            renderBudgetItems();
            
            // Update category dropdowns when language changes
            populateCategoryDropdowns();
            
            // Refresh the categories list to show updated names in current language
            loadCategoriesList();
            
            // Refresh Manage Items tab if it's currently visible
            const manageCategorySelect = document.getElementById('manageCategorySelect');
            if (manageCategorySelect && manageCategorySelect.value) {
                loadManageCategoryItems();
            }
            
            // Translate notes that don't have translations yet (lazy translation)
            await translateMissingNotes();
            
            // Translate item names, descriptions, and category names
            await translateMissingItemText();
            await translateMissingCategoryNames();
            
            // Refresh categories list again after translations complete
            loadCategoriesList();
            
            // Refresh Manage Items tab again after translations complete
            if (manageCategorySelect && manageCategorySelect.value) {
                loadManageCategoryItems();
            }
        }
        
        async function translateMissingItemText() {
            const itemsToTranslate = JSON.parse(JSON.stringify(items));
            let needsUpdate = false;
            const translationPromises = [];
            
            console.log(`Checking ${itemsToTranslate.length} items for name/description translation (current language: ${currentLanguage})...`);
            
            itemsToTranslate.forEach((item, index) => {
                // Log what we have
                console.log(`  Item ${index}: nameEn="${item.nameEn || '(none)'}", nameEs="${item.nameEs || '(none)'}", name="${item.name || '(none)'}"`);
                
                // Translate item name
                if (currentLanguage === 'en') {
                    // Check if we have nameEs but not nameEn
                    if (item.nameEs && item.nameEs.trim() !== '' && (!item.nameEn || item.nameEn.trim() === '')) {
                        console.log(`    â†’ Translating name from es to en: "${item.nameEs}"`);
                        const promise = translateTextAPI(item.nameEs, 'es', 'en').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated name: "${translated}"`);
                                item.nameEn = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                    // Also check old 'name' field if nameEn/nameEs don't exist
                    else if (item.name && item.name.trim() !== '' && (!item.nameEn || item.nameEn.trim() === '') && (!item.nameEs || item.nameEs.trim() === '')) {
                        console.log(`    â†’ Translating old name field from es to en: "${item.name}"`);
                        const promise = translateTextAPI(item.name, 'es', 'en').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated name: "${translated}"`);
                                item.nameEn = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                    
                    if (item.descriptionEs && item.descriptionEs.trim() !== '' && (!item.descriptionEn || item.descriptionEn.trim() === '')) {
                        console.log(`    â†’ Translating description from es to en: "${item.descriptionEs}"`);
                        const promise = translateTextAPI(item.descriptionEs, 'es', 'en').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated description: "${translated}"`);
                                item.descriptionEn = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                } else {
                    // Check if we have nameEn but not nameEs
                    if (item.nameEn && item.nameEn.trim() !== '' && (!item.nameEs || item.nameEs.trim() === '')) {
                        console.log(`    â†’ Translating name from en to es: "${item.nameEn}"`);
                        const promise = translateTextAPI(item.nameEn, 'en', 'es').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated name: "${translated}"`);
                                item.nameEs = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                    // Also check old 'name' field if nameEn/nameEs don't exist
                    else if (item.name && item.name.trim() !== '' && (!item.nameEn || item.nameEn.trim() === '') && (!item.nameEs || item.nameEs.trim() === '')) {
                        console.log(`    â†’ Translating old name field from en to es: "${item.name}"`);
                        const promise = translateTextAPI(item.name, 'en', 'es').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated name: "${translated}"`);
                                item.nameEs = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                    
                    if (item.descriptionEn && item.descriptionEn.trim() !== '' && (!item.descriptionEs || item.descriptionEs.trim() === '')) {
                        console.log(`    â†’ Translating description from en to es: "${item.descriptionEn}"`);
                        const promise = translateTextAPI(item.descriptionEn, 'en', 'es').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated description: "${translated}"`);
                                item.descriptionEs = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                }
            });
            
            if (translationPromises.length > 0) {
                console.log(`Waiting for ${translationPromises.length} translation(s) to complete...`);
                await Promise.all(translationPromises);
                if (needsUpdate) {
                    console.log('Saving translated items to localStorage and updating display...');
                    // Update the original items array by finding and updating each item
                    itemsToTranslate.forEach(translatedItem => {
                        const originalIndex = items.findIndex(item => item.id === translatedItem.id);
                        if (originalIndex !== -1) {
                            // Update the original item with translated values
                            if (translatedItem.nameEn) items[originalIndex].nameEn = translatedItem.nameEn;
                            if (translatedItem.nameEs) items[originalIndex].nameEs = translatedItem.nameEs;
                            if (translatedItem.descriptionEn) items[originalIndex].descriptionEn = translatedItem.descriptionEn;
                            if (translatedItem.descriptionEs) items[originalIndex].descriptionEs = translatedItem.descriptionEs;
                        }
                    });
                    saveItems(); // Save to localStorage
                    renderBudgetItems(); // Re-render to show translations
                    console.log('Translation complete and items updated!');
                } else {
                    console.log('No items needed translation updates.');
                }
            } else {
                console.log('No items need translation.');
            }
        }
        
        async function translateMissingCategoryNames() {
            const categoriesToTranslate = JSON.parse(JSON.stringify(categories));
            let needsUpdate = false;
            const translationPromises = [];
            const categoryKeys = Object.keys(categoriesToTranslate);
            
            // Helper function to add delay between API calls to avoid rate limiting
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            console.log(`Checking ${categoryKeys.length} categories for name and description translation (current language: ${currentLanguage})...`);
            
            categoryKeys.forEach((categoryKey, index) => {
                const category = categoriesToTranslate[categoryKey];
                console.log(`  Category "${categoryKey}": nameEn="${category.nameEn || '(none)'}", nameEs="${category.nameEs || '(none)'}", descriptionEn="${category.descriptionEn || '(none)'}", descriptionEs="${category.descriptionEs || '(none)'}", description="${category.description || '(none)'}"`);
                
                if (currentLanguage === 'en') {
                    // Translate category name - if nameEn is empty, translate from nameEs
                    // If both are the same, assume nameEn is correct (English) and translate to Spanish
                    if (!category.nameEn || category.nameEn.trim() === '') {
                        if (category.nameEs && category.nameEs.trim() !== '') {
                            console.log(`    â†’ Translating name from es to en: "${category.nameEs}"`);
                            const promise = delay(index * 200).then(() => 
                                translateTextAPI(category.nameEs, 'es', 'en')
                            ).then(translated => {
                                console.log(`    â†’ Translation result for name "${category.nameEs}": "${translated}"`);
                                if (translated && translated.trim() !== '' && translated !== category.nameEn) {
                                    console.log(`    âœ“ Translated category name: "${translated}"`);
                                    category.nameEn = translated;
                                    needsUpdate = true;
                                } else {
                                    console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                                }
                            }).catch(error => {
                                console.error(`    âœ— Translation failed for name "${category.nameEs}":`, error);
                            });
                            translationPromises.push(promise);
                        }
                    } else if (category.nameEn === category.nameEs && category.nameEn.trim() !== '') {
                        // Both are the same - assume the text is in the current language (English) and translate to Spanish
                        console.log(`    â†’ Both name fields are identical ("${category.nameEn}"), assuming English and translating to Spanish`);
                        const promise = delay(index * 200).then(() => 
                            translateTextAPI(category.nameEn, 'en', 'es')
                        ).then(translated => {
                            console.log(`    â†’ Translation result for name "${category.nameEn}": "${translated}"`);
                            if (translated && translated.trim() !== '' && translated !== category.nameEs) {
                                console.log(`    âœ“ Translated category name to Spanish: "${translated}"`);
                                // Only update nameEs, keep nameEn as is
                                category.nameEs = translated;
                                needsUpdate = true;
                            } else {
                                console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                            }
                        }).catch(error => {
                            console.error(`    âœ— Translation failed for name "${category.nameEn}":`, error);
                        });
                        translationPromises.push(promise);
                    }
                    // Translate category description - prioritize descriptionEs as source, fallback to old description field
                    if (category.descriptionEs && category.descriptionEs.trim() !== '') {
                        // Always translate from Spanish to English to ensure descriptionEn is correct
                        if (!category.descriptionEn || category.descriptionEn.trim() === '' || category.descriptionEn === category.descriptionEs) {
                            console.log(`    â†’ Translating description from es to en: "${category.descriptionEs}"`);
                            const promise = translateTextAPI(category.descriptionEs, 'es', 'en').then(translated => {
                                console.log(`    â†’ Translation result for "${category.descriptionEs}": "${translated}"`);
                                if (translated && translated.trim() !== '' && translated !== category.descriptionEn) {
                                    console.log(`    âœ“ Translated category description: "${translated}"`);
                                    category.descriptionEn = translated;
                                    needsUpdate = true;
                                } else {
                                    console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                                }
                            }).catch(error => {
                                console.error(`    âœ— Translation failed for "${category.descriptionEs}":`, error);
                            });
                            translationPromises.push(promise);
                        }
                    }
                    // Also check old description field if new fields don't exist
                    else if (category.description && category.description.trim() !== '' && (!category.descriptionEn || category.descriptionEn.trim() === '') && (!category.descriptionEs || category.descriptionEs.trim() === '')) {
                        console.log(`    â†’ Translating old description field from es to en: "${category.description}"`);
                        const promise = translateTextAPI(category.description, 'es', 'en').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated category description: "${translated}"`);
                                category.descriptionEn = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                } else {
                    // Translate category name - if nameEs is empty, translate from nameEn
                    // If both are the same, assume nameEs is correct (Spanish) and translate to English
                    if (!category.nameEs || category.nameEs.trim() === '') {
                        if (category.nameEn && category.nameEn.trim() !== '') {
                            console.log(`    â†’ Translating name from en to es: "${category.nameEn}"`);
                            const promise = delay(index * 200).then(() => 
                                translateTextAPI(category.nameEn, 'en', 'es')
                            ).then(translated => {
                                console.log(`    â†’ Translation result for name "${category.nameEn}": "${translated}"`);
                                if (translated && translated.trim() !== '' && translated !== category.nameEs) {
                                    console.log(`    âœ“ Translated category name: "${translated}"`);
                                    category.nameEs = translated;
                                    needsUpdate = true;
                                } else {
                                    console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                                }
                            }).catch(error => {
                                console.error(`    âœ— Translation failed for name "${category.nameEn}":`, error);
                            });
                            translationPromises.push(promise);
                        }
                    } else if (category.nameEn === category.nameEs && category.nameEs.trim() !== '') {
                        // Both are the same - assume the text is in the current language (Spanish) and translate to English
                        console.log(`    â†’ Both name fields are identical ("${category.nameEs}"), assuming Spanish and translating to English`);
                        const promise = delay(index * 200).then(() => 
                            translateTextAPI(category.nameEs, 'es', 'en')
                        ).then(translated => {
                            console.log(`    â†’ Translation result for name "${category.nameEs}": "${translated}"`);
                            if (translated && translated.trim() !== '' && translated !== category.nameEn) {
                                console.log(`    âœ“ Translated category name to English: "${translated}"`);
                                // Only update nameEn, keep nameEs as is
                                category.nameEn = translated;
                                needsUpdate = true;
                            } else {
                                console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                            }
                        }).catch(error => {
                            console.error(`    âœ— Translation failed for name "${category.nameEs}":`, error);
                        });
                        translationPromises.push(promise);
                    }
                    // Translate category description - prioritize descriptionEn as source, fallback to old description field
                    if (category.descriptionEn && category.descriptionEn.trim() !== '') {
                        // Always translate from English to Spanish to ensure descriptionEs is correct
                        if (!category.descriptionEs || category.descriptionEs.trim() === '' || category.descriptionEs === category.descriptionEn) {
                            console.log(`    â†’ Translating description from en to es: "${category.descriptionEn}"`);
                            const promise = translateTextAPI(category.descriptionEn, 'en', 'es').then(translated => {
                                console.log(`    â†’ Translation result for "${category.descriptionEn}": "${translated}"`);
                                if (translated && translated.trim() !== '' && translated !== category.descriptionEs) {
                                    console.log(`    âœ“ Translated category description: "${translated}"`);
                                    category.descriptionEs = translated;
                                    needsUpdate = true;
                                } else {
                                    console.log(`    âœ— Translation skipped: result is empty or same as existing`);
                                }
                            }).catch(error => {
                                console.error(`    âœ— Translation failed for "${category.descriptionEn}":`, error);
                            });
                            translationPromises.push(promise);
                        }
                    }
                    // Also check old description field if new fields don't exist
                    else if (category.description && category.description.trim() !== '' && (!category.descriptionEn || category.descriptionEn.trim() === '') && (!category.descriptionEs || category.descriptionEs.trim() === '')) {
                        console.log(`    â†’ Translating old description field from en to es: "${category.description}"`);
                        const promise = translateTextAPI(category.description, 'en', 'es').then(translated => {
                            if (translated && translated.trim() !== '') {
                                console.log(`    âœ“ Translated category description: "${translated}"`);
                                category.descriptionEs = translated;
                                needsUpdate = true;
                            }
                        });
                        translationPromises.push(promise);
                    }
                }
            });
            
            if (translationPromises.length > 0) {
                await Promise.all(translationPromises);
                if (needsUpdate) {
                    console.log('Saving translated categories to localStorage and updating display...');
                    // Update the original categories object by finding and updating each category
                    categoryKeys.forEach(categoryKey => {
                        const translatedCategory = categoriesToTranslate[categoryKey];
                        if (translatedCategory && categories[categoryKey]) {
                            // Update the original category with translated values
                            if (translatedCategory.nameEn) categories[categoryKey].nameEn = translatedCategory.nameEn;
                            if (translatedCategory.nameEs) categories[categoryKey].nameEs = translatedCategory.nameEs;
                            if (translatedCategory.descriptionEn) categories[categoryKey].descriptionEn = translatedCategory.descriptionEn;
                            if (translatedCategory.descriptionEs) categories[categoryKey].descriptionEs = translatedCategory.descriptionEs;
                        }
                    });
                    localStorage.setItem('customCategories', JSON.stringify(categories));
                    populateCategoryDropdowns();
                    loadCategoriesList(); // Re-render category list to show updated names
                    renderBudgetItems(); // Re-render budget items to show updated category names
                    console.log('Category translation complete and updated!');
                } else {
                    console.log('No categories needed translation updates.');
                }
            } else {
                console.log('No categories need translation.');
            }
        }
        
        async function translateAllItemsAndCategories() {
            const apiKey = getDeepLAPIKey();
            if (!apiKey) {
                alert(currentLanguage === 'en' ? 
                    'Please configure your DeepL API key in Settings first.' : 
                    'Por favor configura tu clave API de DeepL en ConfiguraciÃ³n primero.');
                return;
            }
            
            try {
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'Translating all items and categories... This may take a moment.' : 
                    'Traduciendo todos los artÃ­culos y categorÃ­as... Esto puede tomar un momento.');
                
                // Translate budget items
                await translateMissingItemText();
                await translateMissingNotes();
                
                // Translate category items (itemDatabase)
                await translateAllCategoryItems();
                
                // Translate categories
                await translateMissingCategoryNames();
                
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    'Translation complete! All items and categories have been translated.' : 
                    'Â¡TraducciÃ³n completa! Todos los artÃ­culos y categorÃ­as han sido traducidos.');
                
                // Refresh displays
                loadCategoriesList();
                if (document.getElementById('manageCategorySelect') && document.getElementById('manageCategorySelect').value) {
                    loadManageCategoryItems();
                }
            } catch (error) {
                console.error('Translation error:', error);
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    `Translation error: ${error.message}` : 
                    `Error de traducciÃ³n: ${error.message}`);
            }
        }
        
        async function translateAllCategoryItems() {
            const apiKey = getDeepLAPIKey();
            if (!apiKey) {
                console.warn('DeepL API key not set. Skipping category items translation.');
                return;
            }
            
            let needsUpdate = false;
            const translationPromises = [];
            
            console.log('Translating all items in all categories...');
            
            // Iterate through all categories in itemDatabase
            Object.keys(itemDatabase).forEach(category => {
                const categoryItems = itemDatabase[category] || [];
                
                categoryItems.forEach((item, index) => {
                    // Translate item name
                    if (currentLanguage === 'en') {
                        // Need English translation
                        if (item.nameEs && item.nameEs.trim() !== '' && (!item.nameEn || item.nameEn.trim() === '')) {
                            const promise = translateTextAPI(item.nameEs, 'es', 'en').then(translated => {
                                if (translated && translated.trim() !== '') {
                                    item.nameEn = translated;
                                    needsUpdate = true;
                                }
                            });
                            translationPromises.push(promise);
                        }
                        // Translate description
                        if (item.descriptionEs && item.descriptionEs.trim() !== '' && (!item.descriptionEn || item.descriptionEn.trim() === '')) {
                            const promise = translateTextAPI(item.descriptionEs, 'es', 'en').then(translated => {
                                if (translated && translated.trim() !== '') {
                                    item.descriptionEn = translated;
                                    needsUpdate = true;
                                }
                            });
                            translationPromises.push(promise);
                        }
                    } else {
                        // Need Spanish translation
                        if (item.nameEn && item.nameEn.trim() !== '' && (!item.nameEs || item.nameEs.trim() === '')) {
                            const promise = translateTextAPI(item.nameEn, 'en', 'es').then(translated => {
                                if (translated && translated.trim() !== '') {
                                    item.nameEs = translated;
                                    needsUpdate = true;
                                }
                            });
                            translationPromises.push(promise);
                        }
                        // Translate description
                        if (item.descriptionEn && item.descriptionEn.trim() !== '' && (!item.descriptionEs || item.descriptionEs.trim() === '')) {
                            const promise = translateTextAPI(item.descriptionEn, 'en', 'es').then(translated => {
                                if (translated && translated.trim() !== '') {
                                    item.descriptionEs = translated;
                                    needsUpdate = true;
                                }
                            });
                            translationPromises.push(promise);
                        }
                    }
                });
            });
            
            // Wait for all translations to complete
            if (translationPromises.length > 0) {
                await Promise.all(translationPromises);
                
                if (needsUpdate) {
                    // Save updated itemDatabase to localStorage
                    localStorage.setItem('itemDatabase', JSON.stringify(itemDatabase));
                    console.log('Category items translations saved to localStorage');
                }
            } else {
                console.log('No category items needed translation.');
            }
        }
        
        async function translateMissingNotes() {
            // Get items from the global items array (which is synced with localStorage)
            const itemsToTranslate = JSON.parse(JSON.stringify(items)); // Deep copy
            let needsUpdate = false;
            const translationPromises = [];
            
            console.log(`Checking ${itemsToTranslate.length} items for translation (current language: ${currentLanguage})...`);
            
            itemsToTranslate.forEach((item, index) => {
                // Log all items to see what we have
                console.log(`Item ${index}:`, {
                    name: item.nameEn || item.nameEs || item.name,
                    notes: item.notes || '(none)',
                    notesEn: item.notesEn || '(none)',
                    notesEs: item.notesEs || '(none)'
                });
                
                // Determine what text we have and what we need
                let sourceText = null;
                let sourceLang = null;
                let targetLang = null;
                
                // Skip if item has no notes at all
                if (!item.notes && !item.notesEn && !item.notesEs) {
                    console.log(`  â†’ Skipping: No notes found`);
                    return;
                }
                
                if (currentLanguage === 'en') {
                    // We're viewing in English, need English version
                    // Always translate from Spanish to English using API for better quality
                    // Prefer notesEs as source (original Spanish), fallback to notes
                    if (item.notesEs && item.notesEs.trim() !== '') {
                        // Only translate if notesEn doesn't exist or is empty
                        if (!item.notesEn || item.notesEn.trim() === '') {
                            sourceText = item.notesEs;
                            sourceLang = 'es';
                            targetLang = 'en';
                        } else {
                            // Already have English translation, skip
                            return;
                        }
                    } else if (item.notes && item.notes.trim() !== '') {
                        // Have old notes field, try to translate (assume it might be Spanish)
                        if (!item.notesEn || item.notesEn.trim() === '') {
                            sourceText = item.notes;
                            sourceLang = 'es';
                            targetLang = 'en';
                        } else {
                            return;
                        }
                    } else {
                        // No source text to translate from
                        return;
                    }
                } else {
                    // We're viewing in Spanish, need Spanish version
                    // Always translate from English to Spanish using API for better quality
                    // Prefer notesEn as source (original English), fallback to notes
                    if (item.notesEn && item.notesEn.trim() !== '') {
                        // Only translate if notesEs doesn't exist or is empty
                        if (!item.notesEs || item.notesEs.trim() === '') {
                            sourceText = item.notesEn;
                            sourceLang = 'en';
                            targetLang = 'es';
                        } else {
                            // Already have Spanish translation, skip
                            return;
                        }
                    } else if (item.notes && item.notes.trim() !== '') {
                        // Have old notes field, try to translate (assume it might be English)
                        if (!item.notesEs || item.notesEs.trim() === '') {
                            sourceText = item.notes;
                            sourceLang = 'en';
                            targetLang = 'es';
                        } else {
                            return;
                        }
                    } else {
                        // No source text to translate from
                        return;
                    }
                }
                
                if (sourceText && sourceText.trim() !== '') {
                    console.log(`  â†’ Will translate from ${sourceLang} to ${targetLang}: "${sourceText.substring(0, 50)}..."`);
                    // Create translation promise
                    const promise = translateTextAPI(sourceText, sourceLang, targetLang).then(translated => {
                        console.log(`  â†’ Translation result: "${translated}" (original: "${sourceText}")`);
                        if (translated && translated.trim() !== '' && translated !== sourceText) {
                            console.log(`  âœ“ Translated: "${translated.substring(0, 50)}..."`);
                            if (targetLang === 'en') {
                                item.notesEn = translated;
                            } else {
                                item.notesEs = translated;
                            }
                            needsUpdate = true;
                        } else {
                            console.log(`  âœ— Translation failed or returned same text`);
                        }
                    }).catch(error => {
                        console.warn('Translation failed for item:', error);
                    });
                    translationPromises.push(promise);
                } else {
                    console.log(`  â†’ No source text found for translation`);
                }
            });
            
            // Wait for all translations to complete
            if (translationPromises.length > 0) {
                console.log(`Translating ${translationPromises.length} note(s) using API...`);
                await Promise.all(translationPromises);
                
                // Save updated items if any translations were fetched
                if (needsUpdate) {
                    console.log('Translations complete, updating items...');
                    // Update the original items array by finding and updating each item
                    itemsToTranslate.forEach(translatedItem => {
                        const originalIndex = items.findIndex(item => item.id === translatedItem.id);
                        if (originalIndex !== -1) {
                            // Update the original item with translated values
                            if (translatedItem.notesEn) items[originalIndex].notesEn = translatedItem.notesEn;
                            if (translatedItem.notesEs) items[originalIndex].notesEs = translatedItem.notesEs;
                        }
                    });
                    saveItems(); // Save to localStorage
                    renderBudgetItems(); // Re-render to show translations
                    console.log('Notes translation complete and items updated!');
                } else {
                    console.log('No notes needed translation updates.');
                }
            } else {
                console.log('No items need translation.');
            }
        }

        function translateText(text, fromLang, toLang) {
            if (!text) return text;
            
            // Simple translation mapping - in a real app, you'd use a translation API
            const translationMap = {
                'en': {
                    'computer': 'computadora',
                    'desktop': 'escritorio',
                    'laptop': 'portÃ¡til',
                    'monitor': 'monitor',
                    'keyboard': 'teclado',
                    'mouse': 'ratÃ³n',
                    'printer': 'impresora',
                    'scanner': 'escÃ¡ner',
                    'office': 'oficina',
                    'chair': 'silla',
                    'desk': 'escritorio',
                    'table': 'mesa',
                    'lamp': 'lÃ¡mpara',
                    'phone': 'telÃ©fono',
                    'equipment': 'equipamiento',
                    'materials': 'materiales',
                    'services': 'servicios',
                    'supplies': 'suministros',
                    'other': 'otro',
                    'high': 'alta',
                    'medium': 'media',
                    'low': 'baja',
                    'construction': 'construcciÃ³n',
                    'building': 'edificio',
                    'maintenance': 'mantenimiento',
                    'professional': 'profesional',
                    'administrative': 'administrativo',
                    'miscellaneous': 'miscelÃ¡neo'
                },
                'es': {
                    'computadora': 'computer',
                    'escritorio': 'desktop',
                    'portÃ¡til': 'laptop',
                    'monitor': 'monitor',
                    'teclado': 'keyboard',
                    'ratÃ³n': 'mouse',
                    'impresora': 'printer',
                    'escÃ¡ner': 'scanner',
                    'oficina': 'office',
                    'silla': 'chair',
                    'mesa': 'table',
                    'lÃ¡mpara': 'lamp',
                    'telÃ©fono': 'phone',
                    'equipamiento': 'equipment',
                    'materiales': 'materials',
                    'servicios': 'services',
                    'suministros': 'supplies',
                    'otro': 'other',
                    'alta': 'high',
                    'media': 'medium',
                    'baja': 'low',
                    'construcciÃ³n': 'construction',
                    'edificio': 'building',
                    'mantenimiento': 'maintenance',
                    'profesional': 'professional',
                    'administrativo': 'administrative',
                    'miscelÃ¡neo': 'miscellaneous'
                }
            };
            
            const words = text.toLowerCase().split(' ');
            const translatedWords = words.map(word => {
                return translationMap[toLang] && translationMap[toLang][word] ? translationMap[toLang][word] : word;
            });
            
            return translatedWords.join(' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Check if user has permission to access this tab
            if (userRole !== 'admin') {
                const restrictedTabs = ['addItems', 'manageItems', 'categories', 'monitor', 'alerts', 'settings'];
                if (restrictedTabs.includes(tabName)) {
                    alert(currentLanguage === 'en' ? 
                        'You do not have permission to access this tab. Please contact an administrator.' : 
                        'No tienes permiso para acceder a esta pestaÃ±a. Por favor contacta a un administrador.');
                    return;
                }
            }
            
            // First, hide ALL tabs explicitly
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none'; // Explicitly hide all tabs
            });
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            // Now show only the target tab
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block'; // Explicitly show the target tab
                console.log('Tab content found and activated:', tabName);
                
                // Refresh monitor dashboard when switching to monitor tab
                if (tabName === 'monitor') {
                    // Ensure data is loaded from localStorage
                    items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                    activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
                    changeHistory = JSON.parse(localStorage.getItem('changeHistory')) || [];
                    
                    // Load settings
                    loadMonitorSettings();
                    
                    // Update displays
                    updateMonitorDashboard();
                    refreshActivityLog();
                    loadChangeHistory();
                }
                
                // Refresh alerts when switching to alerts tab
                if (tabName === 'alerts') {
                    // Ensure data is loaded from localStorage
                    items = JSON.parse(localStorage.getItem('budgetItems')) || [];
                    
                    // Load alerts data
                    loadMissingReceipts();
                    calculateBudgetVsActual();
                    loadWeeklyBudgetsVsActual();
                }
                
                // Refresh Can/Mex tab when switching to it
                if (tabName === 'canada') {
                    // Ensure data is loaded from localStorage first
                    const canadaHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                    console.log('Loading Can/Mex tab - history from localStorage:', canadaHistory.length);
                    
                    // Reload canadaSelectedItems
                    if (typeof canadaSelectedItems !== 'undefined') {
                        canadaSelectedItems = JSON.parse(localStorage.getItem('canadaSelectedItems') || '{}');
                        console.log('Reloaded canadaSelectedItems for Can/Mex tab');
                    }
                    
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        loadCanadaItems();
                        updateCanadaRequestSummary();
                        loadCanadaHistory(); // Always refresh history to show latest tracking status
                    }, 100);
                }
                
                // Refresh Mex/Can tab when switching to it
                if (tabName === 'mexcan') {
                    loadMexcanItems();
                    updateMexcanRequestSummary();
                    loadMexcanHistory(); // Always refresh history to show latest tracking status
                }
                
                // Load reports when switching to reports tab
                if (tabName === 'reports') {
                    // Ensure saved budgets are loaded from localStorage
                    const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
                    console.log('Loading Reports tab - saved budgets from localStorage:', savedBudgets.length);
                    
                    // Check which report type is currently selected (default to budget)
                    const budgetSection = document.getElementById('budgetReportsSection');
                    const canadaSection = document.getElementById('canadaReportsSection');
                    if (budgetSection && budgetSection.style.display !== 'none') {
                        populateBudgetReportItemFilter();
                        loadReport();
                    } else if (canadaSection && canadaSection.style.display !== 'none') {
                        populateCanadaReportItemFilter();
                        loadCanadaReport();
                    } else {
                        // Default to budget reports
                        switchReportType('budget');
                    }
                }
            } else {
                console.error('Tab content not found:', tabName + 'Tab');
            }
            const targetButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
                console.log('Button activated');
            } else {
                console.error('Button not found for tab:', tabName);
            }
        }
        
        function switchReportType(reportType) {
            const budgetSection = document.getElementById('budgetReportsSection');
            const canadaSection = document.getElementById('canadaReportsSection');
            const budgetBtn = document.getElementById('budgetReportsBtn');
            const canadaBtn = document.getElementById('canadaReportsBtn');
            
            if (reportType === 'budget') {
                // Show budget reports, hide Canada reports
                if (budgetSection) budgetSection.style.display = 'block';
                if (canadaSection) canadaSection.style.display = 'none';
                
                // Update button styles
                if (budgetBtn) {
                    budgetBtn.classList.add('btn-primary');
                    budgetBtn.classList.remove('btn-secondary');
                    budgetBtn.style.background = '';
                    budgetBtn.style.color = '';
                }
                if (canadaBtn) {
                    canadaBtn.classList.remove('btn-primary');
                    canadaBtn.classList.add('btn-secondary');
                    canadaBtn.style.background = '#6c757d';
                    canadaBtn.style.color = 'white';
                }
                
                // Load budget report
                populateBudgetReportItemFilter();
                loadReport();
            } else if (reportType === 'canada') {
                // Show Canada reports, hide budget reports
                if (budgetSection) budgetSection.style.display = 'none';
                if (canadaSection) canadaSection.style.display = 'block';
                
                // Update button styles
                if (canadaBtn) {
                    canadaBtn.classList.add('btn-primary');
                    canadaBtn.classList.remove('btn-secondary');
                    canadaBtn.style.background = '';
                    canadaBtn.style.color = '';
                }
                if (budgetBtn) {
                    budgetBtn.classList.remove('btn-primary');
                    budgetBtn.classList.add('btn-secondary');
                    budgetBtn.style.background = '#6c757d';
                    budgetBtn.style.color = 'white';
                }
                
                // Load Canada report
                populateCanadaReportItemFilter();
                loadCanadaReport();
            }
        }

        // Populate day of month dropdown
        function populateMonthlyDayDropdown() {
            const select = document.getElementById('itemMonthlyDay');
            if (!select) return;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Select day...</option>';
            
            // Add days 1-31
            for (let day = 1; day <= 31; day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day;
                select.appendChild(option);
            }
        }

        function toggleItemRecurringWeekly() {
            const checkbox = document.getElementById('itemRecurringWeekly');
            const monthlyCheckbox = document.getElementById('itemRecurringMonthly');
            const dueDateCheckbox = document.getElementById('itemHasDueDate');
            
            // If recurring weekly is checked, uncheck monthly and due date (they're mutually exclusive)
            if (checkbox.checked) {
                if (monthlyCheckbox.checked) {
                    monthlyCheckbox.checked = false;
                    toggleItemRecurringMonthly();
                }
                if (dueDateCheckbox.checked) {
                    dueDateCheckbox.checked = false;
                    toggleItemDueDate();
                }
            }
        }

        function toggleItemRecurringMonthly() {
            const checkbox = document.getElementById('itemRecurringMonthly');
            const monthlyDayRow = document.getElementById('itemMonthlyDayRow');
            const weeklyCheckbox = document.getElementById('itemRecurringWeekly');
            const dueDateCheckbox = document.getElementById('itemHasDueDate');
            
            if (checkbox.checked) {
                monthlyDayRow.style.display = 'block';
                // Populate dropdown if not already populated
                if (document.getElementById('itemMonthlyDay').options.length <= 1) {
                    populateMonthlyDayDropdown();
                }
                // Uncheck other options (they're mutually exclusive)
                if (weeklyCheckbox.checked) {
                    weeklyCheckbox.checked = false;
                }
                if (dueDateCheckbox.checked) {
                    dueDateCheckbox.checked = false;
                    toggleItemDueDate();
                }
            } else {
                monthlyDayRow.style.display = 'none';
                document.getElementById('itemMonthlyDay').value = '';
            }
        }

        function toggleNotesField() {
            const addNotesCheckbox = document.getElementById('addNotes');
            const notesRow = document.getElementById('notesRow');
            if (addNotesCheckbox.checked) {
                notesRow.style.display = 'block';
            } else {
                notesRow.style.display = 'none';
                document.getElementById('itemNotes').value = '';
            }
        }

        function toggleItemDueDate() {
            const checkbox = document.getElementById('itemHasDueDate');
            const dueDateRow = document.getElementById('itemDueDateRow');
            const recurringCheckbox = document.getElementById('itemRecurringWeekly');
            const monthlyCheckbox = document.getElementById('itemRecurringMonthly');
            
            if (checkbox.checked) {
                dueDateRow.style.display = 'block';
                // If due date is checked, uncheck recurring weekly and monthly (they're mutually exclusive)
                if (recurringCheckbox.checked) {
                    recurringCheckbox.checked = false;
                }
                if (monthlyCheckbox.checked) {
                    monthlyCheckbox.checked = false;
                    toggleItemRecurringMonthly();
                }
            } else {
                dueDateRow.style.display = 'none';
                document.getElementById('itemDueDate').value = '';
            }
        }

        function toggleItemForCanada() {
            const checkbox = document.getElementById('itemForCanada');
            const unitPriceInput = document.getElementById('unitPrice');
            
            if (checkbox.checked) {
                // For Canada items, make price field optional (not required)
                unitPriceInput.required = false;
                unitPriceInput.removeAttribute('required');
                // Add a note that it's optional for Canada
                const unitPriceHelp = document.getElementById('unitPriceHelp');
                if (unitPriceHelp) {
                    unitPriceHelp.textContent = currentLanguage === 'en' 
                        ? 'Optional for Canada requests (enter any value)' 
                        : 'Opcional para solicitudes de CanadÃ¡ (ingresa cualquier valor)';
                    unitPriceHelp.style.display = 'block';
                }
            } else {
                // Restore normal validation
                unitPriceInput.removeAttribute('data-canada');
                // Check if category is flexible cost or Mexico
                const mexicoCheckbox = document.getElementById('itemForMexico');
                if (!mexicoCheckbox || !mexicoCheckbox.checked) {
                    // Only restore required if Mexico is also not checked
                    const category = document.getElementById('category').value;
                    const isFlexibleCost = categories[category] && categories[category].pricingType === 'flexible';
                    if (!isFlexibleCost) {
                        unitPriceInput.required = true;
                        unitPriceInput.setAttribute('required', 'required');
                    } else {
                        unitPriceInput.required = false;
                        unitPriceInput.removeAttribute('required');
                    }
                }
                // Update the field based on category
                updateUnitPriceField();
            }
        }

        function toggleItemForMexico() {
            const checkbox = document.getElementById('itemForMexico');
            const unitPriceInput = document.getElementById('unitPrice');
            
            if (checkbox.checked) {
                // For Mexico items, make price field optional (not required)
                unitPriceInput.required = false;
                unitPriceInput.removeAttribute('required');
                // Add a note that it's optional for Mexico
                const unitPriceHelp = document.getElementById('unitPriceHelp');
                if (unitPriceHelp) {
                    unitPriceHelp.textContent = currentLanguage === 'en' 
                        ? 'Optional for Mexico requests (enter any value)' 
                        : 'Opcional para solicitudes de MÃ©xico (ingresa cualquier valor)';
                    unitPriceHelp.style.display = 'block';
                }
            } else {
                // Restore normal validation
                unitPriceInput.removeAttribute('data-mexico');
                // Check if category is flexible cost or Canada
                const canadaCheckbox = document.getElementById('itemForCanada');
                if (!canadaCheckbox || !canadaCheckbox.checked) {
                    // Only restore required if Canada is also not checked
                    const category = document.getElementById('category').value;
                    const isFlexibleCost = categories[category] && categories[category].pricingType === 'flexible';
                    if (!isFlexibleCost) {
                        unitPriceInput.required = true;
                        unitPriceInput.setAttribute('required', 'required');
                    } else {
                        unitPriceInput.required = false;
                        unitPriceInput.removeAttribute('required');
                    }
                }
                // Update the field based on category
                updateUnitPriceField();
            }
        }

        // Toggle functions for edit form
        function toggleEditItemRecurringWeekly() {
            const checkbox = document.getElementById('editRecurringWeekly');
            const monthlyCheckbox = document.getElementById('editRecurringMonthly');
            const dueDateCheckbox = document.getElementById('editHasDueDate');
            
            // If recurring weekly is checked, uncheck monthly and due date (they're mutually exclusive)
            if (checkbox.checked) {
                if (monthlyCheckbox.checked) {
                    monthlyCheckbox.checked = false;
                    toggleEditItemRecurringMonthly();
                }
                if (dueDateCheckbox.checked) {
                    dueDateCheckbox.checked = false;
                    toggleEditItemDueDate();
                }
            }
        }

        function toggleEditItemRecurringMonthly() {
            const checkbox = document.getElementById('editRecurringMonthly');
            const monthlyDayRow = document.getElementById('editMonthlyDayRow');
            const weeklyCheckbox = document.getElementById('editRecurringWeekly');
            const dueDateCheckbox = document.getElementById('editHasDueDate');
            
            if (checkbox.checked) {
                monthlyDayRow.style.display = 'block';
                // Populate dropdown if not already populated
                const editMonthlyDaySelect = document.getElementById('editMonthlyDay');
                if (editMonthlyDaySelect.options.length <= 1) {
                    editMonthlyDaySelect.innerHTML = '<option value="">Select day...</option>';
                    for (let day = 1; day <= 31; day++) {
                        const option = document.createElement('option');
                        option.value = day;
                        option.textContent = day;
                        editMonthlyDaySelect.appendChild(option);
                    }
                }
                // Uncheck other options (they're mutually exclusive)
                if (weeklyCheckbox.checked) {
                    weeklyCheckbox.checked = false;
                }
                if (dueDateCheckbox.checked) {
                    dueDateCheckbox.checked = false;
                    toggleEditItemDueDate();
                }
            } else {
                monthlyDayRow.style.display = 'none';
                document.getElementById('editMonthlyDay').value = '';
            }
        }

        function toggleEditItemDueDate() {
            const checkbox = document.getElementById('editHasDueDate');
            const dueDateRow = document.getElementById('editDueDateRow');
            const recurringCheckbox = document.getElementById('editRecurringWeekly');
            const monthlyCheckbox = document.getElementById('editRecurringMonthly');
            
            if (checkbox.checked) {
                dueDateRow.style.display = 'block';
                // If due date is checked, uncheck recurring weekly and monthly (they're mutually exclusive)
                if (recurringCheckbox.checked) {
                    recurringCheckbox.checked = false;
                }
                if (monthlyCheckbox.checked) {
                    monthlyCheckbox.checked = false;
                    toggleEditItemRecurringMonthly();
                }
            } else {
                dueDateRow.style.display = 'none';
                document.getElementById('editDueDate').value = '';
            }
        }

        function validateItemForm(event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            // Remove required attribute from price field if Canada is checked
            const canadaCheckbox = document.getElementById('itemForCanada');
            const unitPriceInput = document.getElementById('unitPrice');
            const category = document.getElementById('category').value;
            
            // Check item pricing type (user can override category setting)
            const itemPricingType = document.getElementById('itemPricingType');
            let isFlexibleCost = false;
            
            if (itemPricingType) {
                isFlexibleCost = itemPricingType.value === 'flexible';
            } else if (category && categories[category]) {
                // Fallback to category pricing type
                isFlexibleCost = categories[category].pricingType === 'flexible';
            }
            
            // Check if category is Canada
            const isCanadaCategory = category && (
                category.toLowerCase() === 'canada' ||
                (categories[category] && (
                    (categories[category].nameEn && categories[category].nameEn.toLowerCase() === 'canada') ||
                    (categories[category].nameEs && categories[category].nameEs.toLowerCase() === 'canadÃ¡')
                ))
            );
            
            // Remove required from unit price if it's flexible cost, Canada item, or Canada category
            if ((canadaCheckbox && canadaCheckbox.checked) || isCanadaCategory || isFlexibleCost) {
                if (unitPriceInput) {
                    unitPriceInput.removeAttribute('required');
                    unitPriceInput.required = false;
                    // If empty, set to 0 to avoid validation issues
                    if (!unitPriceInput.value || unitPriceInput.value.trim() === '') {
                        unitPriceInput.value = '0';
                    }
                }
            } else {
                // Add required back if it's a fixed cost category
                if (unitPriceInput && category) {
                    unitPriceInput.setAttribute('required', 'required');
                    unitPriceInput.required = true;
                }
            }
            
            // Now run our custom validation
            addItem(event);
            return false;
        }

        async function addItem(event) {
            event.preventDefault();
            
            const itemName = document.getElementById('itemName').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const supplier = document.getElementById('supplier').value.trim();
            const itemForCanada = document.getElementById('itemForCanada').checked;
            const unitPriceInput = document.getElementById('unitPrice');
            const unitPriceValue = unitPriceInput ? unitPriceInput.value.trim() : '';
            const unitPrice = unitPriceValue ? parseFloat(unitPriceValue) : 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const supplierPhone = document.getElementById('supplierPhone').value.trim();
            const supplierEmail = document.getElementById('supplierEmail').value.trim();
            const supplierAddress = document.getElementById('supplierAddress').value.trim();
            const saveToCategory = document.getElementById('saveToCategory').checked;
            const addNotes = document.getElementById('addNotes').checked;
            const itemNotes = addNotes ? document.getElementById('itemNotes').value.trim() : '';
            // Store notes in the current language only (API will translate when switching languages)
            // Store original text in current language, leave other language empty for API translation
            const notesEn = itemNotes && currentLanguage === 'en' ? itemNotes : '';
            const notesEs = itemNotes && currentLanguage === 'es' ? itemNotes : '';
            const itemRecurringWeekly = document.getElementById('itemRecurringWeekly').checked;
            const itemRecurringMonthly = document.getElementById('itemRecurringMonthly').checked;
            const itemMonthlyDay = itemRecurringMonthly ? parseInt(document.getElementById('itemMonthlyDay').value) : null;
            const itemHasDueDate = document.getElementById('itemHasDueDate').checked;
            const itemDueDate = itemHasDueDate ? document.getElementById('itemDueDate').value : null;
            const receiptAmount = document.getElementById('receiptAmount').value ? parseFloat(document.getElementById('receiptAmount').value) : null;
            
            // Check item pricing type (user can override category setting)
            const itemPricingType = document.getElementById('itemPricingType');
            let isFlexibleCost = false;
            
            if (itemPricingType) {
                isFlexibleCost = itemPricingType.value === 'flexible';
            } else if (category && categories[category]) {
                // Fallback to category pricing type
                isFlexibleCost = categories[category].pricingType === 'flexible';
            }
            
            // Check if category is Canada (case-insensitive)
            const isCanadaCategory = category && (
                category.toLowerCase() === 'canada' ||
                (categories[category] && (
                    (categories[category].nameEn && categories[category].nameEn.toLowerCase() === 'canada') ||
                    (categories[category].nameEs && categories[category].nameEs.toLowerCase() === 'canadÃ¡')
                ))
            );
            
            // Auto-set forCanada flag if Canada category is selected
            if (isCanadaCategory && !itemForCanada) {
                itemForCanada = true;
                document.getElementById('itemForCanada').checked = true;
            }
            
            // Validation - basic required fields
            if (!itemName || !category || !supplier) {
                const missingFields = [];
                if (!itemName) missingFields.push(currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo');
                if (!category) missingFields.push(currentLanguage === 'en' ? 'Category' : 'CategorÃ­a');
                if (!supplier) missingFields.push(currentLanguage === 'en' ? 'Supplier' : 'Proveedor');
                const message = currentLanguage === 'en' 
                    ? `Please fill in all required fields: ${missingFields.join(', ')}` 
                    : `Por favor completa todos los campos requeridos: ${missingFields.join(', ')}`;
                alert(message);
                // Focus on first missing field
                if (!itemName) document.getElementById('itemName').focus();
                else if (!category) document.getElementById('category').focus();
                else if (!supplier) document.getElementById('supplier').focus();
                return false;
            }
            
            // For Canada items, price is optional - use whatever is entered or 0
            let finalUnitPrice = 0;
            if (itemForCanada || isCanadaCategory) {
                // For Canada items, use the entered value or default to 0
                finalUnitPrice = (unitPriceValue && !isNaN(unitPrice) && unitPrice > 0) ? unitPrice : 0;
            } else {
                // Validation - unit price is required only for fixed cost categories (not flexible)
                if (!isFlexibleCost) {
                    if (!unitPriceValue || isNaN(unitPrice) || unitPrice <= 0) {
                        const message = currentLanguage === 'en' 
                            ? 'Please enter a valid unit price (MXN)' 
                            : 'Por favor ingresa un precio unitario vÃ¡lido (MXN)';
                        alert(message);
                        document.getElementById('unitPrice').focus();
                        return false;
                    }
                    finalUnitPrice = unitPrice;
                } else {
                    finalUnitPrice = unitPrice || 0;
                }
            }
            
            // Store names and descriptions in current language only (API will translate when switching languages)
            const nameEn = itemName && currentLanguage === 'en' ? itemName : '';
            const nameEs = itemName && currentLanguage === 'es' ? itemName : '';
            const descriptionEn = description && currentLanguage === 'en' ? description : '';
            const descriptionEs = description && currentLanguage === 'es' ? description : '';
            
            const newItem = {
                id: Date.now(),
                nameEn: nameEn,
                nameEs: nameEs,
                descriptionEn: descriptionEn,
                descriptionEs: descriptionEs,
                category: category,
                pricingType: itemPricingType ? itemPricingType.value : (categories[category] ? categories[category].pricingType : 'fixed'),
                unitPrice: finalUnitPrice,
                quantity: quantity,
                totalPrice: finalUnitPrice * quantity,
                priority: 'medium',
                invoicePhoto: window.addPhotoData || null,
                invoiceFileName: window.addFileName || null,
                invoiceFileType: window.addFileType || null,
                receiptAmount: receiptAmount,
                notes: itemNotes, // Keep for backward compatibility
                notesEn: notesEn,
                notesEs: notesEs,
                dateAdded: new Date().toISOString(),
                recurringWeekly: itemRecurringWeekly,
                recurringMonthly: itemRecurringMonthly,
                monthlyDay: itemMonthlyDay,
                hasDueDate: itemHasDueDate,
                dueDate: itemDueDate,
                forCanada: itemForCanada,
                forMexico: document.getElementById('itemForMexico') ? document.getElementById('itemForMexico').checked : false,
                supplier: {
                    name: supplier,
                    phone: supplierPhone,
                    email: supplierEmail,
                    address: supplierAddress
                }
            };
            
            // Apply automatic credit if item was in alerts
            applyAutomaticCreditIfInAlerts(newItem);
            
            items.push(newItem);
            
            // Save to Supabase and localStorage
            try {
                await saveItems();
                console.log('Item saved successfully:', newItem.nameEn || newItem.nameEs);
            } catch (error) {
                console.error('Error saving item:', error);
                // Still show the item even if Supabase save fails (it's in localStorage)
                alert(currentLanguage === 'en' 
                    ? 'Item added but there was an error saving to database. It has been saved locally.' 
                    : 'ArtÃ­culo agregado pero hubo un error al guardar en la base de datos. Se ha guardado localmente.');
            }
            
            // Always render items immediately after adding
            renderBudgetItems();
            updateTotal();
            
            // Refresh alerts if on alerts tab
            if (document.getElementById('alertsTab') && document.getElementById('alertsTab').classList.contains('active')) {
                loadMissingReceipts();
                calculateBudgetVsActual();
            }
            
            if (saveToCategory) {
                addItemToCategory(newItem);
            }
            
            // If item is for Canada (either by checkbox or Canada category), don't add it to budget items
            // Canada items should only appear in the Canada tab, not in the regular budget
            // Reuse isCanadaCategory from above
            if (itemForCanada || isCanadaCategory) {
                // Ensure forCanada flag is set
                newItem.forCanada = true;
                const index = items.findIndex(i => i.id === newItem.id);
                if (index !== -1) {
                    items.splice(index, 1);
                    saveItems();
                    renderBudgetItems();
                    updateTotal();
                }
            }
            
            // If item is for Mexico (either by checkbox or Mexico category), don't add it to budget items
            if (itemForMexico || isMexicoCategory) {
                // Ensure forMexico flag is set
                newItem.forMexico = true;
                const index = items.findIndex(i => i.id === newItem.id);
                if (index !== -1) {
                    items.splice(index, 1);
                    saveItems();
                    renderBudgetItems();
                    updateTotal();
                }
            }
            
            // Refresh Can/Mex tab if it's currently open
            if (document.getElementById('canadaTab') && document.getElementById('canadaTab').classList.contains('active')) {
                loadCanadaItems();
                updateCanadaRequestSummary();
            }
            
            // Refresh Mex/Can tab if it's currently open
            if (document.getElementById('mexcanTab') && document.getElementById('mexcanTab').classList.contains('active')) {
                loadMexcanItems();
                updateMexcanRequestSummary();
            }
            
            // Log activity and change
            const loggedItemName = currentLanguage === 'en' ? newItem.nameEn : newItem.nameEs;
            logActivity('add', `${currentLanguage === 'en' ? 'Added item' : 'ArtÃ­culo agregado'}: ${loggedItemName}`, newItem.id);
            logChange('added', newItem.id, loggedItemName, null, newItem.totalPrice, 'totalPrice');
            
            // Clear form
            document.getElementById('itemForm').reset();
            document.getElementById('saveToCategory').checked = true;
            document.getElementById('addNotes').checked = false;
            document.getElementById('notesRow').style.display = 'none';
            document.getElementById('itemRecurringWeekly').checked = false;
            document.getElementById('itemHasDueDate').checked = false;
            document.getElementById('itemDueDate').value = '';
            document.getElementById('itemDueDateRow').style.display = 'none';
            
            // Clear photo data and preview
            window.addPhotoData = null;
            const photoPreview = document.getElementById('addPhotoPreview');
            photoPreview.classList.remove('show');
            photoPreview.src = '';
            document.getElementById('receiptAmount').value = '';
            document.getElementById('receiptAmountRow').style.display = 'none';
            document.getElementById('itemForCanada').checked = false;
            if (document.getElementById('itemForMexico')) {
                document.getElementById('itemForMexico').checked = false;
            }
            
            // Switch to budget tab
            switchTab('budget');
            
            // Update monitor dashboard
            updateMonitorDashboard();
        }

        function addToCategoryOnly() {
            const itemName = document.getElementById('itemName').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const supplier = document.getElementById('supplier').value;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplierPhone = document.getElementById('supplierPhone').value;
            const supplierEmail = document.getElementById('supplierEmail').value;
            const supplierAddress = document.getElementById('supplierAddress').value;
            const addNotes = document.getElementById('addNotes').checked;
            const itemNotes = addNotes ? document.getElementById('itemNotes').value.trim() : '';
            // Store notes in the current language only (API will translate when switching languages)
            // Store original text in current language, leave other language empty for API translation
            const notesEn = itemNotes && currentLanguage === 'en' ? itemNotes : '';
            const notesEs = itemNotes && currentLanguage === 'es' ? itemNotes : '';
            const itemRecurringWeekly = document.getElementById('itemRecurringWeekly').checked;
            const itemHasDueDate = document.getElementById('itemHasDueDate').checked;
            const itemDueDate = itemHasDueDate ? document.getElementById('itemDueDate').value : null;
            
            // Check if category is flexible cost
            const isFlexibleCost = categories[category] && categories[category].pricingType === 'flexible';
            
            // Validation - unit price is required only for fixed cost categories
            if (!itemName || !category || !supplier || (!isFlexibleCost && !unitPrice)) {
                const message = currentLanguage === 'en' 
                    ? 'Please fill in all required fields' 
                    : 'Por favor completa todos los campos requeridos';
                alert(message);
                return;
            }
            
            // Store names and descriptions in current language only (API will translate when switching languages)
            const nameEn = itemName && currentLanguage === 'en' ? itemName : '';
            const nameEs = itemName && currentLanguage === 'es' ? itemName : '';
            const descriptionEn = description && currentLanguage === 'en' ? description : '';
            const descriptionEs = description && currentLanguage === 'es' ? description : '';
            
            const newItem = {
                nameEn: nameEn,
                nameEs: nameEs,
                descriptionEn: descriptionEn,
                descriptionEs: descriptionEs,
                category: category,
                unitPrice: unitPrice,
                priority: 'medium',
                invoicePhoto: window.addPhotoData || null,
                notes: itemNotes, // Keep for backward compatibility
                notesEn: notesEn,
                notesEs: notesEs,
                recurringWeekly: itemRecurringWeekly,
                hasDueDate: itemHasDueDate,
                dueDate: itemDueDate,
                supplier: {
                    name: supplier,
                    phone: supplierPhone,
                    email: supplierEmail,
                    address: supplierAddress
                }
            };
            
            addItemToCategory(newItem);
            
            // Clear form
            document.getElementById('itemForm').reset();
            document.getElementById('saveToCategory').checked = true;
            document.getElementById('addNotes').checked = false;
            document.getElementById('notesRow').style.display = 'none';
            document.getElementById('itemRecurringWeekly').checked = false;
            document.getElementById('itemHasDueDate').checked = false;
            document.getElementById('itemDueDate').value = '';
            document.getElementById('itemDueDateRow').style.display = 'none';
            
            // Clear photo data and preview
            window.addPhotoData = null;
            const photoPreview = document.getElementById('addPhotoPreview');
            photoPreview.classList.remove('show');
            photoPreview.src = '';
            
            alert(currentLanguage === 'en' ? 'Item added to category successfully' : 'ArtÃ­culo agregado a la categorÃ­a exitosamente');
        }

        function addItemToCategory(item) {
            if (!itemDatabase[item.category]) {
                itemDatabase[item.category] = [];
            }
            itemDatabase[item.category].push(item);
            saveCategoryItems();
        }

        async function saveItems() {
            // Always save to localStorage as backup
            localStorage.setItem('budgetItems', JSON.stringify(items));
            
            // If using Supabase and user is logged in, save to database
            if (useSupabase && currentUser) {
                try {
                    // Get all current items from database
                    const { data: existingItems } = await supabase
                        .from('budget_items')
                        .select('id')
                        .eq('user_id', currentUser.id);
                    
                    const existingIds = new Set(existingItems?.map(item => item.id) || []);
                    // Include both number and string IDs for comparison
                    const currentIds = new Set(items.map(item => {
                        const id = item.id;
                        // Convert to number if it's a valid number string, otherwise keep as is
                        if (typeof id === 'string' && !isNaN(id) && !isNaN(parseFloat(id))) {
                            return parseFloat(id);
                        }
                        return id;
                    }).filter(id => id !== null && id !== undefined));
                    
                    // Delete items that are no longer in the current items array
                    const toDelete = Array.from(existingIds).filter(id => !currentIds.has(id));
                    if (toDelete.length > 0) {
                        const { error: deleteError } = await supabase
                            .from('budget_items')
                            .delete()
                            .in('id', toDelete)
                            .eq('user_id', currentUser.id);
                        
                        if (deleteError) {
                            console.error('Error deleting items from Supabase:', deleteError);
                            console.error('Delete error details:', JSON.stringify(deleteError, null, 2));
                        }
                    }
                    
                    // Upsert (insert or update) all current items
                    for (const item of items) {
                        try {
                            const dbItem = convertAppItemToDbItem(item);
                            dbItem.user_id = currentUser.id;
                            
                            // Convert item.id to number for comparison
                            const itemIdNum = typeof item.id === 'string' && !isNaN(item.id) 
                                ? parseFloat(item.id) 
                                : (typeof item.id === 'number' ? item.id : null);
                            
                            // Check if item exists (by numeric ID)
                            const itemExists = itemIdNum !== null && existingIds.has(itemIdNum);
                            
                            if (itemExists) {
                                // Update existing
                                let dbItemToUpdate = { ...dbItem };
                                
                                const { error: updateError } = await supabase
                                    .from('budget_items')
                                    .update(dbItemToUpdate)
                                    .eq('id', itemIdNum)
                                    .eq('user_id', currentUser.id);
                                
                                if (updateError) {
                                    // If error is schema cache related (PGRST204), try without new columns
                                    if (updateError.code === 'PGRST204' && (
                                        updateError.message?.includes('weekly_added_week') ||
                                        updateError.message?.includes('monthly_added_month') ||
                                        updateError.message?.includes('monthly_added_year')
                                    )) {
                                        console.warn('Schema cache not refreshed yet. Retrying update without new columns...');
                                        // Remove the new columns and retry
                                        delete dbItemToUpdate.weekly_added_week;
                                        delete dbItemToUpdate.monthly_added_month;
                                        delete dbItemToUpdate.monthly_added_year;
                                        
                                        const { error: retryError } = await supabase
                                            .from('budget_items')
                                            .update(dbItemToUpdate)
                                            .eq('id', itemIdNum)
                                            .eq('user_id', currentUser.id);
                                        
                                        if (retryError) {
                                            console.error('Error updating item in Supabase (retry):', retryError);
                                            console.error('Item being updated:', { id: itemIdNum, name: item.nameEn || item.nameEs });
                                        }
                                    } else {
                                        console.error('Error updating item in Supabase:', updateError);
                                        console.error('Update error details:', JSON.stringify(updateError, null, 2));
                                        console.error('Item being updated:', { id: itemIdNum, name: item.nameEn || item.nameEs });
                                    }
                                }
                            } else {
                                // Insert new
                                let dbItemToInsert = { ...dbItem };
                                
                                // If schema cache error (PGRST204), remove the new columns and retry
                                const { data, error: insertError } = await supabase
                                    .from('budget_items')
                                    .insert([dbItemToInsert])
                                    .select()
                                    .single();
                                
                                if (insertError) {
                                    // If error is schema cache related (PGRST204), try without new columns
                                    if (insertError.code === 'PGRST204' && (
                                        insertError.message?.includes('weekly_added_week') ||
                                        insertError.message?.includes('monthly_added_month') ||
                                        insertError.message?.includes('monthly_added_year')
                                    )) {
                                        console.warn('Schema cache not refreshed yet. Retrying without new columns...');
                                        // Remove the new columns and retry
                                        delete dbItemToInsert.weekly_added_week;
                                        delete dbItemToInsert.monthly_added_month;
                                        delete dbItemToInsert.monthly_added_year;
                                        
                                        const { data: retryData, error: retryError } = await supabase
                                            .from('budget_items')
                                            .insert([dbItemToInsert])
                                            .select()
                                            .single();
                                        
                                        if (retryError) {
                                            console.error('Error inserting item to Supabase (retry):', retryError);
                                            console.error('Item being inserted:', { name: item.nameEn || item.nameEs });
                                        } else if (retryData) {
                                            // Update the item ID in the local array
                                            item.id = retryData.id;
                                        }
                                    } else {
                                        console.error('Error inserting item to Supabase:', insertError);
                                        console.error('Insert error details:', JSON.stringify(insertError, null, 2));
                                        console.error('Item being inserted:', { name: item.nameEn || item.nameEs });
                                    }
                                } else if (data) {
                                    // Update the item ID in the local array
                                    item.id = data.id;
                                }
                            }
                        } catch (itemError) {
                            console.error('Error processing item in saveItems:', itemError);
                            console.error('Item that caused error:', item);
                        }
                    }
                } catch (error) {
                    console.error('Error saving items to Supabase:', error);
                    // Continue with localStorage only if Supabase fails
                }
            }
        }

        function renderBudgetItems() {
            const tbody = document.getElementById('budgetItemsList');
            tbody.innerHTML = '';
            
            // Filter out Canada-only items from budget display
            const budgetItems = items.filter(item => !item.forCanada && !item.forMexico);
            
            budgetItems.forEach(item => {
                const row = document.createElement('tr');
                // Store the actual item ID in a data attribute for reliable matching
                row.setAttribute('data-item-id', String(item.id));
                const categoryName = categories[item.category] ? (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : item.category;
                const hasPhoto = item.invoicePhoto ? 'has-photo' : '';
                
                // Display name: prefer current language, but fall back to other language if current is empty
                const displayName = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                // Display description: prefer current language, but fall back to other language if current is empty
                const displayDescription = currentLanguage === 'en' 
                    ? (item.descriptionEn || item.descriptionEs || item.description || '') 
                    : (item.descriptionEs || item.descriptionEn || item.description || '');
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${displayDescription}</td>
                    <td>${(() => {
                        // Display notes: prefer current language, but fall back to other language if current is empty
                        const displayNotes = currentLanguage === 'en' 
                            ? (item.notesEn || item.notesEs || item.notes || '') 
                            : (item.notesEs || item.notesEn || item.notes || '');
                        let notesHTML = displayNotes ? `<span style="font-size: 0.9rem; color: #555; font-style: italic;">${displayNotes}</span>` : '<span style="color: #999;">-</span>';
                        
                        // Add price adjustment note if exists
                        if (item.priceAdjustmentNote) {
                            notesHTML += `<div style="margin-top: 5px; font-size: 0.75rem; color: #3498db; background: #e8f4fd; padding: 4px 6px; border-radius: 4px; border-left: 3px solid #3498db;">
                                <strong>ðŸ’° ${currentLanguage === 'en' ? 'Price Adjustment:' : 'Ajuste de Precio:'}</strong><br>
                                ${item.priceAdjustmentNote}
                            </div>`;
                        }
                        
                        return notesHTML;
                    })()}
                    ${(() => {
                        // Show date and week number for recurring items
                        const isRecurring = item.recurringWeekly || item.recurringMonthly || item.hasDueDate || 
                                          item.weeklyAddedWeek || item.monthlyAddedMonth !== undefined || 
                                          item.dueDateAdded || item.itemDueDateAdded;
                        if (isRecurring) {
                            const dateToShow = item.dateAdded || new Date().toISOString();
                            const weekNumber = getWeekNumber(new Date(dateToShow));
                            const dateStr = new Date(dateToShow).toLocaleDateString();
                            let recurringType = '';
                            if (item.recurringWeekly || item.weeklyAddedWeek) {
                                recurringType = currentLanguage === 'en' ? 'Weekly' : 'Semanal';
                            } else if (item.recurringMonthly || item.monthlyAddedMonth !== undefined) {
                                recurringType = currentLanguage === 'en' ? 'Monthly' : 'Mensual';
                            } else if (item.hasDueDate || item.dueDateAdded || item.itemDueDateAdded) {
                                recurringType = currentLanguage === 'en' ? 'Due Date' : 'Fecha de Vencimiento';
                            }
                            return `<div style="margin-top: 5px; font-size: 0.75rem; color: #27ae60; background: #e8f8f5; padding: 4px 6px; border-radius: 4px; border-left: 3px solid #27ae60;">
                                <strong>ðŸ“… ${recurringType ? recurringType + ' - ' : ''}${currentLanguage === 'en' ? 'Added' : 'Agregado'}:</strong> ${dateStr} (${currentLanguage === 'en' ? 'Week' : 'Semana'} ${weekNumber})
                            </div>`;
                        }
                        return '';
                    })()}</td>
                    <td>${categoryName}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                            <input type="number" value="${item.unitPrice}" step="0.01" min="0" 
                                   id="price_input_${item.id}"
                                   style="width: 100px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; ${item.hasPriceAdjustment ? 'border-color: #3498db; border-width: 2px;' : ''}"
                                   title="${item.priceAdjustmentNote || (currentLanguage === 'en' ? 'Click to edit unit price' : 'Haz clic para editar precio unitario')}">
                            <div style="font-size: 0.8rem; color: #666;">MXN</div>
                            ${item.priceAdjustmentNote ? `
                                <div style="font-size: 0.65rem; color: #3498db; text-align: center; max-width: 120px; padding: 2px 4px; background: #e8f4fd; border-radius: 3px; line-height: 1.2;" 
                                     title="${item.priceAdjustmentNote}">
                                    ðŸ’° ${currentLanguage === 'en' ? 'Price Adjusted' : 'Precio Ajustado'}
                                </div>
                            ` : ''}
                            <button class="btn btn-sm btn-primary" onclick="updateItemPrice('${item.id}', document.getElementById('price_input_${item.id}').value)" 
                                    style="padding: 2px 8px; font-size: 0.7rem;" 
                                    data-en="Update" data-es="Actualizar">Update</button>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                            <input type="number" value="${item.quantity}" min="1" 
                                   id="qty_input_${item.id}"
                                   style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                   title="${currentLanguage === 'en' ? 'Click to edit quantity' : 'Haz clic para editar cantidad'}">
                            <button class="btn btn-sm btn-primary" onclick="updateItemQuantity('${item.id}', document.getElementById('qty_input_${item.id}').value)" 
                                    style="padding: 2px 8px; font-size: 0.7rem;" 
                                    data-en="Update" data-es="Actualizar">Update</button>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateItemPriority(${item.id}, this.value)" class="priority-${item.priority}">
                            <option value="high" ${item.priority === 'high' ? 'selected' : ''} data-en="High" data-es="Alta">High</option>
                            <option value="medium" ${item.priority === 'medium' ? 'selected' : ''} data-en="Medium" data-es="Media">Medium</option>
                            <option value="low" ${item.priority === 'low' ? 'selected' : ''} data-en="Low" data-es="Baja">Low</option>
                        </select>
                    </td>
                    <td>
                        <div class="photo-upload">
                            <input type="file" id="photo_${item.id}" accept="image/*,.pdf,.xlsx,.xls" onchange="uploadInvoicePhoto(${item.id}, this)">
                            <button class="photo-btn ${hasPhoto}" type="button">
                                <span class="camera-icon">ðŸ“·</span>
                                <span data-en="${item.invoicePhoto ? 'Change Photo' : 'Add Photo'}" data-es="${item.invoicePhoto ? 'Cambiar Foto' : 'Agregar Foto'}">${item.invoicePhoto ? 'Change Photo' : 'Add Photo'}</span>
                            </button>
                            ${item.invoicePhoto ? `<img src="${item.invoicePhoto}" class="photo-preview show" alt="Invoice photo">` : ''}
                        </div>
                    </td>
                    <td>$${item.totalPrice.toLocaleString('es-MX')} MXN</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 4px; min-width: 120px;">
                            <span style="font-size: 0.75rem; color: #7f8c8d; margin-bottom: 2px;" data-en="Status:" data-es="Estado:">Status:</span>
                            <span class="approval-${item.approvalStatus || 'pending'}" style="font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; display: inline-block; width: fit-content; font-weight: 600;">
                                ${currentLanguage === 'en' ? 
                                    (item.approvalStatus === 'approved' ? 'âœ“ Approved' : item.approvalStatus === 'denied' ? 'âœ— Denied' : item.approvalStatus === 'needs_edit' ? 'âœŽ Needs Edit' : 'â³ Pending') :
                                    (item.approvalStatus === 'approved' ? 'âœ“ Aprobado' : item.approvalStatus === 'denied' ? 'âœ— Rechazado' : item.approvalStatus === 'needs_edit' ? 'âœŽ Necesita EdiciÃ³n' : 'â³ Pendiente')}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="approval-controls" style="display: flex; flex-direction: column; gap: 4px;">
                            <button class="btn btn-success" onclick="updateItemApproval(${item.id}, 'approved')" 
                                    style="padding: 6px 10px; font-size: 0.75rem; width: 100%; ${item.approvalStatus === 'approved' ? 'opacity: 0.6; cursor: not-allowed;' : ''}" 
                                    ${item.approvalStatus === 'approved' ? 'disabled' : ''}
                                    data-en="Approve" data-es="Aprobar">Approve</button>
                            <button class="btn btn-danger" onclick="removeItem(${item.id}, event)" 
                                    style="padding: 6px 10px; font-size: 0.75rem; width: 100%;" 
                                    data-en="Remove" data-es="Eliminar">Remove</button>
                            <button class="btn btn-info" onclick="pushItemToNextWeek(${item.id})" 
                                    style="padding: 6px 10px; font-size: 0.75rem; width: 100%;" 
                                    data-en="Push to Next Week" data-es="Pasar a la PrÃ³xima Semana">Push to Next Week</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function updateItemPriority(id, newPriority) {
            // Convert id to number if it's a string representation of a number
            const itemId = typeof id === 'string' && !isNaN(id) ? parseFloat(id) : id;
            
            // Try to find item with flexible ID matching
            let item = items.find(i => i.id === itemId || i.id == id || String(i.id) === String(id));
            
            if (!item) {
                console.error('Item not found for priority update! Looking for id:', itemId);
                return;
            }
            
            item.priority = newPriority;
            await saveItems();
            renderBudgetItems();
        }

        async function updateItemApproval(id, newStatus) {
            // Convert id to number if it's a string representation of a number
            const itemId = typeof id === 'string' && !isNaN(id) ? parseFloat(id) : id;
            
            // Try to find item with flexible ID matching
            let item = items.find(i => i.id === itemId || i.id == id || String(i.id) === String(id));
            
            if (!item) {
                console.error('Item not found for approval update! Looking for id:', itemId);
                return;
            }
            
            const oldStatus = item.approvalStatus || 'pending';
            item.approvalStatus = newStatus;
            if (newStatus === 'approved') {
                item.approvalReason = '';
            }
            await saveItems();
            renderBudgetItems();
            updateApprovalSummary();
            
            // Log change
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            const changeType = newStatus === 'approved' ? 'approved' : newStatus === 'denied' ? 'denied' : 'updated';
            logActivity(newStatus === 'approved' ? 'approve' : newStatus === 'denied' ? 'deny' : 'update', 
                `${currentLanguage === 'en' ? 'Changed approval status' : 'Estado de aprobaciÃ³n cambiado'}: ${itemName}`, item.id);
            logChange(changeType, item.id, itemName, oldStatus, newStatus, 'approvalStatus');
            updateMonitorDashboard();
        }

        function updateItemApprovalReason(id, reason) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.approvalReason = reason;
                saveItems();
            }
        }

        async function updateItemQuantity(id, newQuantity) {
            console.log('updateItemQuantity called with id:', id, 'type:', typeof id, 'newQuantity:', newQuantity);
            
            // Try to find item with flexible ID matching (handle both string and number IDs)
            let item = items.find(i => {
                // Try exact match
                if (i.id === id) return true;
                // Try loose equality
                if (i.id == id) return true;
                // Try string comparison
                if (String(i.id) === String(id)) return true;
                // Try number comparison if both are numbers
                const iIdNum = typeof i.id === 'string' && !isNaN(i.id) ? parseFloat(i.id) : i.id;
                const idNum = typeof id === 'string' && !isNaN(id) ? parseFloat(id) : id;
                if (typeof iIdNum === 'number' && typeof idNum === 'number' && iIdNum === idNum) return true;
                return false;
            });
            
            // If not found by ID, try to find by the item name from the input element's row
            if (!item) {
                const inputElement = document.getElementById(`qty_input_${id}`);
                if (inputElement) {
                    const row = inputElement.closest('tr');
                    if (row) {
                        // First, try to get the item ID from the data attribute (most reliable)
                        const rowItemId = row.getAttribute('data-item-id');
                        if (rowItemId) {
                            item = items.find(i => String(i.id) === String(rowItemId));
                            if (item) {
                                console.log('âœ… Found item by data-item-id attribute:', rowItemId);
                            }
                        }
                        
                        // If still not found, try by name
                        if (!item) {
                            const nameCell = row.querySelector('td:first-child');
                            if (nameCell) {
                                const itemName = nameCell.textContent.trim();
                                console.log('Quantity update: ID not found, trying to find by name:', itemName, 'Looking for ID:', id);
                                
                                // Try to find by name (exact match)
                                let matchingItems = items.filter(i => {
                                    const iName = currentLanguage === 'en' ? i.nameEn : i.nameEs;
                                    return iName && iName.trim() === itemName;
                                });
                                
                                // If multiple matches, try to match by category and quantity from the row
                                if (matchingItems.length > 1) {
                                    const categoryCell = row.querySelector('td:nth-child(3)');
                                    const qtyCell = row.querySelector('td:nth-child(6)');
                                    if (categoryCell && qtyCell) {
                                        const categoryText = categoryCell.textContent.trim();
                                        const qtyText = qtyCell.textContent.trim();
                                        const currentQty = parseInt(qtyText) || 0;
                                        
                                        matchingItems = matchingItems.filter(i => {
                                            const matchesCategory = !categoryText || i.category === categoryText || 
                                                (i.category && i.category.toLowerCase() === categoryText.toLowerCase());
                                            const matchesQty = i.quantity === currentQty;
                                            return matchesCategory && matchesQty;
                                        });
                                    }
                                }
                                
                                if (matchingItems.length > 0) {
                                    item = matchingItems[0];
                                    console.log('âœ… Found item by name for quantity update:', itemName, 'Using ID:', item.id);
                                } else {
                                    console.warn('âš ï¸ No matching item found by name:', itemName, 'Available items:', items.map(i => ({
                                        id: i.id,
                                        name: currentLanguage === 'en' ? i.nameEn : i.nameEs,
                                        category: i.category,
                                        quantity: i.quantity
                                    })));
                                }
                            }
                        }
                    }
                }
            }
            
            if (!item) {
                console.error('âŒ Item not found for quantity update! Looking for id:', id, 'Available IDs:', items.map(i => i.id));
                // Re-render to fix any ID mismatches - this will regenerate HTML with correct IDs
                await saveItems();
                renderBudgetItems();
                updateTotal();
                alert(currentLanguage === 'en' 
                    ? 'Item ID mismatch detected. Page refreshed. Please try updating the quantity again.' 
                    : 'Se detectÃ³ un desajuste de ID. PÃ¡gina actualizada. Por favor intenta actualizar la cantidad nuevamente.');
                return;
            }
            
            const oldQuantity = item.quantity;
            const quantity = parseInt(newQuantity) || 1;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            
            console.log('Updating quantity:', {
                itemName: item.nameEn || item.nameEs,
                oldQuantity: oldQuantity,
                newQuantity: quantity,
                unitPrice: unitPrice,
                oldTotalPrice: item.totalPrice
            });
            
            // Update item properties
            item.quantity = quantity;
            item.totalPrice = unitPrice * quantity;
            item.lastEdited = new Date().toISOString();
            
            console.log('After update:', {
                quantity: item.quantity,
                totalPrice: item.totalPrice
            });
            
            // Save to localStorage and Supabase (this may update item.id if it's a new item)
            try {
                await saveItems();
            } catch (saveError) {
                console.error('Error saving items after quantity update:', saveError);
                // Continue anyway - localStorage is already saved
            }
            
            // Re-find the item in case its ID was updated by Supabase
            const savedItemId = item.id; // Save the ID before we might lose the reference
            item = items.find(i => {
                // Try to match by ID first
                if (i.id === savedItemId || i.id == id || String(i.id) === String(id)) return true;
                // If ID doesn't match, try to match by other unique properties
                return i.nameEn === item.nameEn && 
                       i.nameEs === item.nameEs && 
                       i.category === item.category && 
                       i.unitPrice === item.unitPrice &&
                       i.quantity === quantity; // Use the new quantity we just set
            });
            
            if (!item) {
                console.error('Item lost after save! This should not happen.');
                // Re-render anyway to show current state
                renderBudgetItems();
                updateTotal();
                return;
            }
            
            // Re-render and update totals (this will regenerate HTML with correct IDs)
            renderBudgetItems();
            updateTotal();
            updateApprovalSummary();
            
            // Verify the total was updated
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
                console.log('Total amount element updated to:', totalElement.textContent);
            }
            
            // Log change (these might fail but shouldn't block the update)
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            try {
                await logActivity('update', `${currentLanguage === 'en' ? 'Updated quantity' : 'Cantidad actualizada'}: ${itemName}`, item.id);
            } catch (logError) {
                console.error('Error logging activity:', logError);
            }
            try {
                await logChange('updated', item.id, itemName, oldQuantity, quantity, 'quantity');
            } catch (logError) {
                console.error('Error logging change:', logError);
            }
            updateMonitorDashboard();
        }

        async function updateItemPrice(id, newPrice) {
            console.log('updateItemPrice called with id:', id, 'type:', typeof id, 'newPrice:', newPrice);
            
            // Try to find item with flexible ID matching (handle both string and number IDs)
            let item = items.find(i => {
                // Try exact match
                if (i.id === id) return true;
                // Try loose equality
                if (i.id == id) return true;
                // Try string comparison
                if (String(i.id) === String(id)) return true;
                // Try number comparison if both are numbers
                const iIdNum = typeof i.id === 'string' && !isNaN(i.id) ? parseFloat(i.id) : i.id;
                const idNum = typeof id === 'string' && !isNaN(id) ? parseFloat(id) : id;
                if (typeof iIdNum === 'number' && typeof idNum === 'number' && iIdNum === idNum) return true;
                return false;
            });
            
            // If not found by ID, try to find by the item name from the input element's row
            if (!item) {
                const priceInput = document.getElementById(`price_input_${id}`);
                if (priceInput) {
                    const row = priceInput.closest('tr');
                    if (row) {
                        // First, try to get the item ID from the data attribute (most reliable)
                        const rowItemId = row.getAttribute('data-item-id');
                        if (rowItemId) {
                            item = items.find(i => String(i.id) === String(rowItemId));
                            if (item) {
                                console.log('âœ… Found item by data-item-id attribute:', rowItemId);
                            }
                        }
                        
                        // If still not found, try by name
                        if (!item) {
                            const nameCell = row.querySelector('td:first-child');
                            if (nameCell) {
                                const itemName = nameCell.textContent.trim();
                                console.log('Price update: ID not found, trying to find by name:', itemName, 'Looking for ID:', id);
                                
                                // Try to find by name (exact match)
                                let matchingItems = items.filter(i => {
                                    const iName = currentLanguage === 'en' ? i.nameEn : i.nameEs;
                                    return iName && iName.trim() === itemName;
                                });
                                
                                // If multiple matches, try to match by category and price from the row
                                if (matchingItems.length > 1) {
                                    const categoryCell = row.querySelector('td:nth-child(3)');
                                    const priceCell = row.querySelector('td:nth-child(5)');
                                    if (categoryCell && priceCell) {
                                        const categoryText = categoryCell.textContent.trim();
                                        const priceText = priceCell.textContent.trim().replace(/[^0-9.]/g, '');
                                        const currentPrice = parseFloat(priceText) || 0;
                                        
                                        matchingItems = matchingItems.filter(i => {
                                            const matchesCategory = !categoryText || i.category === categoryText || 
                                                (i.category && i.category.toLowerCase() === categoryText.toLowerCase());
                                            const matchesPrice = Math.abs((i.unitPrice || 0) - currentPrice) < 0.01;
                                            return matchesCategory && matchesPrice;
                                        });
                                    }
                                }
                                
                                if (matchingItems.length > 0) {
                                    item = matchingItems[0];
                                    console.log('âœ… Found item by name for price update:', itemName, 'Using ID:', item.id);
                                } else {
                                    console.warn('âš ï¸ No matching item found by name:', itemName, 'Available items:', items.map(i => ({
                                        id: i.id,
                                        name: currentLanguage === 'en' ? i.nameEn : i.nameEs,
                                        category: i.category
                                    })));
                                }
                            }
                        }
                    }
                }
            }
            
            if (!item) {
                console.error('âŒ Item not found for price update! Looking for id:', id, 'Available IDs:', items.map(i => i.id));
                // Re-render to fix any ID mismatches - this will regenerate HTML with correct IDs
                await saveItems();
                renderBudgetItems();
                updateTotal();
                alert(currentLanguage === 'en' 
                    ? 'Item ID mismatch detected. Page refreshed. Please try updating the price again.' 
                    : 'Se detectÃ³ un desajuste de ID. PÃ¡gina actualizada. Por favor intenta actualizar el precio nuevamente.');
                return;
            }
            
            const oldPrice = item.unitPrice;
            // Parse the price - allow 0.01 and other small values
            // Don't use || 0 because it would convert 0.01 to 0 (0.01 is truthy, but we want to be explicit)
            const price = newPrice !== null && newPrice !== undefined && newPrice !== '' 
                ? (isNaN(parseFloat(newPrice)) ? 0 : parseFloat(newPrice))
                : 0;
            // Ensure price is not negative
            const finalPrice = Math.max(0, price);
            
            console.log('Price update:', {
                itemId: item.id,
                itemName: item.nameEn || item.nameEs,
                oldPrice: oldPrice,
                newPriceInput: newPrice,
                parsedPrice: price,
                finalPrice: finalPrice
            });
            
            item.unitPrice = finalPrice;
            item.totalPrice = finalPrice * item.quantity;
            item.lastEdited = new Date().toISOString();
            
            // Save to localStorage and Supabase
            try {
                await saveItems();
            } catch (saveError) {
                console.error('Error saving items after price update:', saveError);
                // Continue anyway - localStorage is already saved
            }
            
            renderBudgetItems();
            updateTotal();
            updateApprovalSummary();
            
            // Log change (these might fail but shouldn't block the update)
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            try {
                await logActivity('update', `${currentLanguage === 'en' ? 'Updated price' : 'Precio actualizado'}: ${itemName}`, item.id);
            } catch (logError) {
                console.error('Error logging activity:', logError);
            }
            try {
                await logChange('updated', item.id, itemName, oldPrice, price, 'unitPrice');
            } catch (logError) {
                console.error('Error logging change:', logError);
            }
            updateMonitorDashboard();
        }

        function approveAllItems() {
            items.forEach(item => {
                item.approvalStatus = 'approved';
                item.approvalReason = '';
            });
            saveItems();
            renderBudgetItems();
            updateApprovalSummary();
            showApprovalStatus('success', currentLanguage === 'en' ? 'All items approved!' : 'Â¡Todos los artÃ­culos aprobados!');
            
            // Clear all items after approval
            setTimeout(() => {
                if (confirm(currentLanguage === 'en' ? 
                    'All items have been approved! Would you like to clear the budget to start fresh?' : 
                    'Â¡Todos los artÃ­culos han sido aprobados! Â¿Te gustarÃ­a limpiar el presupuesto para empezar de nuevo?')) {
                    clearBudget(false); // Don't show confirmation dialog
                    sendApprovalEmail(); // Send email notification
                }
            }, 2000); // Wait 2 seconds to show the approval message first
        }

        function resetAllApprovals() {
            if (confirm(currentLanguage === 'en' ? 'Are you sure you want to reset all approvals?' : 'Â¿EstÃ¡s seguro de que quieres restablecer todas las aprobaciones?')) {
                items.forEach(item => {
                    item.approvalStatus = 'pending';
                    item.approvalReason = '';
                });
                saveItems();
                renderBudgetItems();
                updateApprovalSummary();
                showApprovalStatus('info', currentLanguage === 'en' ? 'All approvals reset to pending' : 'Todas las aprobaciones restablecidas a pendiente');
            }
        }

        function showPartialPaymentModal() {
            console.log('showPartialPaymentModal called, items.length:', items.length);
            
            if (items.length === 0) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 'No items in budget to pay' : 'No hay artÃ­culos en el presupuesto para pagar');
                return;
            }

            // Remove existing modal if any
            const existingModal = document.getElementById('partialPaymentModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            try {

            // Create modal HTML
            let modalHTML = `
                <div id="partialPaymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id === 'partialPaymentModal') closePartialPaymentModal();">
                    <div style="background: white; border-radius: 10px; padding: 25px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
                        <h3 style="margin-top: 0; color: #2c3e50;" data-en="Select Items for Partial Payment" data-es="Seleccionar ArtÃ­culos para Pago Parcial">Select Items for Partial Payment</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;" data-en="Select the items you want to pay for now. The remaining items will stay on the budget." data-es="Selecciona los artÃ­culos que deseas pagar ahora. Los artÃ­culos restantes permanecerÃ¡n en el presupuesto.">Select the items you want to pay for now. The remaining items will stay on the budget.</p>
                        
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-sm" onclick="selectAllPartialItems()" style="padding: 5px 15px; font-size: 0.85rem;" data-en="Select All" data-es="Seleccionar Todos">Select All</button>
                            <button class="btn btn-sm" onclick="deselectAllPartialItems()" style="padding: 5px 15px; font-size: 0.85rem;" data-en="Deselect All" data-es="Deseleccionar Todos">Deselect All</button>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #e1e8ed;">
                                        <th style="padding: 10px; text-align: left; width: 40px;">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllPartialItems()">
                                        </th>
                                        <th style="padding: 10px; text-align: left;" data-en="Item" data-es="ArtÃ­culo">Item</th>
                                        <th style="padding: 10px; text-align: right;" data-en="Quantity" data-es="Cantidad">Qty</th>
                                        <th style="padding: 10px; text-align: right;" data-en="Unit Price" data-es="Precio Unitario">Unit Price</th>
                                        <th style="padding: 10px; text-align: right;" data-en="Total" data-es="Total">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="partialPaymentItemsList">
            `;

            items.forEach((item, index) => {
                const itemName = currentLanguage === 'en' ? (item.nameEn || item.name) : (item.nameEs || item.name);
                modalHTML += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px;">
                            <input type="checkbox" class="partial-item-checkbox" value="${item.id}" id="partialItem_${item.id}" checked>
                        </td>
                        <td style="padding: 10px;">${itemName}</td>
                        <td style="padding: 10px; text-align: right;">${item.quantity || 1}</td>
                        <td style="padding: 10px; text-align: right;">$${(item.unitPrice || 0).toLocaleString('es-MX')} MXN</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600;">$${(item.totalPrice || 0).toLocaleString('es-MX')} MXN</td>
                    </tr>
                `;
            });

            modalHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong data-en="Selected Total:" data-es="Total Seleccionado:">Selected Total:</strong>
                                <strong id="partialPaymentTotal" style="color: #27ae60; font-size: 1.2rem;">$0.00 MXN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong data-en="Remaining Total:" data-es="Total Restante:">Remaining Total:</strong>
                                <strong id="partialPaymentRemaining" style="color: #3498db; font-size: 1.2rem;">$0.00 MXN</strong>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closePartialPaymentModal()" data-en="Cancel" data-es="Cancelar">Cancel</button>
                            <button class="btn btn-success" onclick="processPartialPayment()" data-en="Process Partial Payment" data-es="Procesar Pago Parcial">Process Partial Payment</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Wait a moment for DOM to update, then initialize
            setTimeout(() => {
                try {
                    updateLanguage();
                    updatePartialPaymentTotals();
                    
                    // Add event listeners to checkboxes
                    const checkboxes = document.querySelectorAll('.partial-item-checkbox');
                    console.log('Found checkboxes:', checkboxes.length);
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', updatePartialPaymentTotals);
                    });
                    
                    // Also add listener to select all checkbox
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.addEventListener('change', toggleAllPartialItems);
                    }
                } catch (error) {
                    console.error('Error initializing partial payment modal:', error);
                    showApprovalStatus('error', 'Error loading partial payment modal: ' + error.message);
                }
            }, 100);
            } catch (error) {
                console.error('Error creating partial payment modal:', error);
                showApprovalStatus('error', 'Error creating partial payment modal: ' + error.message);
            }
        }

        function closePartialPaymentModal() {
            const modal = document.getElementById('partialPaymentModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectAllPartialItems() {
            document.querySelectorAll('.partial-item-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updatePartialPaymentTotals();
        }

        function deselectAllPartialItems() {
            document.querySelectorAll('.partial-item-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updatePartialPaymentTotals();
        }

        function toggleAllPartialItems() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.partial-item-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updatePartialPaymentTotals();
        }

        function updatePartialPaymentTotals() {
            const selectedIds = Array.from(document.querySelectorAll('.partial-item-checkbox:checked')).map(cb => parseInt(cb.value));
            const selectedTotal = items
                .filter(item => selectedIds.includes(item.id))
                .reduce((sum, item) => sum + item.totalPrice, 0);
            const remainingTotal = items
                .filter(item => !selectedIds.includes(item.id))
                .reduce((sum, item) => sum + item.totalPrice, 0);

            const selectedTotalEl = document.getElementById('partialPaymentTotal');
            const remainingTotalEl = document.getElementById('partialPaymentRemaining');
            
            if (selectedTotalEl) {
                selectedTotalEl.textContent = `$${selectedTotal.toLocaleString('es-MX')} MXN`;
            }
            if (remainingTotalEl) {
                remainingTotalEl.textContent = `$${remainingTotal.toLocaleString('es-MX')} MXN`;
            }
        }

        function processPartialPayment() {
            console.log('processPartialPayment called');
            console.log('Current items array:', items);
            console.log('Items array length:', items ? items.length : 'items is undefined');
            
            const checkboxes = document.querySelectorAll('.partial-item-checkbox:checked');
            console.log('Checked checkboxes:', checkboxes.length);
            
            if (!items || items.length === 0) {
                console.error('Items array is empty or undefined');
                showApprovalStatus('error', currentLanguage === 'en' ? 'No items found in budget' : 'No se encontraron artÃ­culos en el presupuesto');
                closePartialPaymentModal();
                return;
            }
            
            // Get selected IDs - handle both integer and decimal IDs
            const selectedIds = Array.from(checkboxes).map(cb => {
                const value = cb.value;
                // Try to parse as number first (handles decimals), then fall back to string
                const numValue = parseFloat(value);
                console.log('Parsing checkbox value:', value, '->', isNaN(numValue) ? value : numValue);
                return isNaN(numValue) ? value : numValue;
            });
            console.log('Selected IDs:', selectedIds);
            console.log('All item IDs:', items.map(i => ({ id: i.id, type: typeof i.id })));
            
            if (selectedIds.length === 0) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 'Please select at least one item to pay' : 'Por favor selecciona al menos un artÃ­culo para pagar');
                return;
            }
            
            try {
            console.log('Processing partial payment, total items:', items.length);

            if (selectedIds.length === items.length) {
                // If all items selected, just use approveAllItems
                console.log('All items selected, using approveAllItems');
                closePartialPaymentModal();
                approveAllItems();
                return;
            }

            // Get selected items - compare IDs with flexible matching (number, string, or exact match)
            const selectedItems = items.filter(item => {
                const itemId = item.id;
                // Try multiple comparison methods
                const matches = selectedIds.some(selectedId => {
                    // Exact match
                    if (itemId === selectedId) return true;
                    // Number comparison
                    if (Number(itemId) === Number(selectedId)) return true;
                    // String comparison
                    if (String(itemId) === String(selectedId)) return true;
                    // Handle decimal IDs
                    if (Math.abs(Number(itemId) - Number(selectedId)) < 0.0001) return true;
                    return false;
                });
                return matches;
            });
            
            const remainingItems = items.filter(item => {
                const itemId = item.id;
                // Check if this item is NOT in selected items
                return !selectedIds.some(selectedId => {
                    if (itemId === selectedId) return true;
                    if (Number(itemId) === Number(selectedId)) return true;
                    if (String(itemId) === String(selectedId)) return true;
                    if (Math.abs(Number(itemId) - Number(selectedId)) < 0.0001) return true;
                    return false;
                });
            });
            console.log('Selected items:', selectedItems.length, 'Remaining items:', remainingItems.length);
            console.log('Selected items details:', selectedItems.map(i => ({ id: i.id, name: i.nameEn || i.name })));

            // Save selected items as a partial payment budget
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
            const now = new Date();
            const weekStart = getWeekStart(now);
            console.log('Week start calculated:', weekStart);
            
            // Mark selected items as approved
            selectedItems.forEach(item => {
                item.approvalStatus = 'approved';
                item.approvalReason = '';
            });

            const partialPaymentSnapshot = {
                id: Date.now(),
                savedDate: now.toISOString(),
                weekStart: weekStart.toISOString(),
                weekLabel: getWeekLabel(weekStart) + ' (Partial Payment)',
                items: JSON.parse(JSON.stringify(selectedItems)), // Deep copy
                total: selectedItems.reduce((sum, item) => sum + item.totalPrice, 0),
                itemCount: selectedItems.length,
                approvedCount: selectedItems.length,
                pendingCount: 0,
                language: currentLanguage,
                isPartialPayment: true
            };

            savedBudgets.push(partialPaymentSnapshot);

            // Keep only last 100 budgets
            if (savedBudgets.length > 100) {
                savedBudgets.shift();
            }

            localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
            console.log('Saved budget snapshot, total saved budgets:', savedBudgets.length);

            // Remove selected items from current budget
            items = remainingItems;
            console.log('Updated items array, new length:', items.length);
            saveItems();
            console.log('Items saved');
            renderBudgetItems();
            console.log('Items rendered');
            updateApprovalSummary();
            console.log('Approval summary updated');

            // Log activity
            selectedItems.forEach(item => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                logActivity('approve', `${currentLanguage === 'en' ? 'Partial payment approved' : 'Pago parcial aprobado'}: ${itemName}`, item.id);
                logChange('approved', item.id, itemName, 'pending', 'approved', 'approvalStatus');
            });

            updateMonitorDashboard();
            closePartialPaymentModal();

            const selectedTotal = partialPaymentSnapshot.total;
            const remainingTotal = remainingItems.reduce((sum, item) => sum + item.totalPrice, 0);
            
            showApprovalStatus('success', 
                currentLanguage === 'en' 
                    ? `Partial payment processed! $${selectedTotal.toLocaleString('es-MX')} MXN paid. $${remainingTotal.toLocaleString('es-MX')} MXN remaining on budget.`
                    : `Â¡Pago parcial procesado! $${selectedTotal.toLocaleString('es-MX')} MXN pagado. $${remainingTotal.toLocaleString('es-MX')} MXN restante en el presupuesto.`
            );
            } catch (error) {
                console.error('Error processing partial payment:', error);
                showApprovalStatus('error', 'Error processing partial payment: ' + error.message);
            }
        }

        function updateApprovalSummary() {
            const totalItems = items.length;
            const approvedItems = items.filter(item => item.approvalStatus === 'approved').length;
            const deniedItems = items.filter(item => item.approvalStatus === 'denied').length;
            const needsEditItems = items.filter(item => item.approvalStatus === 'needs_edit').length;
            const pendingItems = items.filter(item => !item.approvalStatus || item.approvalStatus === 'pending').length;
            
            // Update the approval status display
            const statusDiv = document.getElementById('approvalStatus');
            if (statusDiv) {
                let statusText = `Approval Status: ${approvedItems} approved, ${deniedItems} denied, ${needsEditItems} need edit, ${pendingItems} pending`;
                if (currentLanguage === 'es') {
                    statusText = `Estado de AprobaciÃ³n: ${approvedItems} aprobados, ${deniedItems} rechazados, ${needsEditItems} necesitan ediciÃ³n, ${pendingItems} pendientes`;
                }
                statusDiv.textContent = statusText;
                statusDiv.className = 'alert alert-info';
                statusDiv.style.display = 'block';
            }
        }

        function uploadInvoicePhoto(itemId, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type (images, PDF, Excel)
            const validTypes = ['image/', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            const isValidType = validTypes.some(type => file.type.startsWith(type)) || 
                               file.name.toLowerCase().endsWith('.pdf') || 
                               file.name.toLowerCase().endsWith('.xlsx') || 
                               file.name.toLowerCase().endsWith('.xls');
            
            if (!isValidType) {
                alert(currentLanguage === 'en' ? 'Please select an image, PDF, or Excel file' : 'Por favor selecciona una imagen, PDF o archivo Excel');
                return;
            }
            
            // Validate file size (max 25MB for PDF/Excel, 10MB for images)
            const maxSize = file.type.startsWith('image/') ? 10 * 1024 * 1024 : 25 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxSizeMB = maxSize / (1024 * 1024);
                alert(currentLanguage === 'en' ? `File size must be less than ${maxSizeMB}MB` : `El tamaÃ±o del archivo debe ser menor a ${maxSizeMB}MB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = items.find(i => i.id === itemId);
                if (item) {
                    item.invoicePhoto = e.target.result;
                    item.invoiceFileName = file.name;
                    item.invoiceFileType = file.type;
                    saveItems();
                    renderBudgetItems();
                }
            };
            reader.readAsDataURL(file);
        }

        function uploadEditInvoicePhoto(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type (images, PDF, Excel)
            const validTypes = ['image/', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            const isValidType = validTypes.some(type => file.type.startsWith(type)) || 
                               file.name.toLowerCase().endsWith('.pdf') || 
                               file.name.toLowerCase().endsWith('.xlsx') || 
                               file.name.toLowerCase().endsWith('.xls');
            
            if (!isValidType) {
                alert(currentLanguage === 'en' ? 'Please select an image, PDF, or Excel file' : 'Por favor selecciona una imagen, PDF o archivo Excel');
                return;
            }
            
            // Validate file size (max 25MB for PDF/Excel, 10MB for images)
            const maxSize = file.type.startsWith('image/') ? 10 * 1024 * 1024 : 25 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxSizeMB = maxSize / (1024 * 1024);
                alert(currentLanguage === 'en' ? `File size must be less than ${maxSizeMB}MB` : `El tamaÃ±o del archivo debe ser menor a ${maxSizeMB}MB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('editPhotoPreview');
                const fileType = file.type;
                
                if (fileType.startsWith('image/')) {
                    preview.src = e.target.result;
                    preview.classList.add('show');
                } else {
                    // For PDF/Excel, show a placeholder
                    preview.style.display = 'none';
                    const previewContainer = preview.parentElement;
                    let placeholder = previewContainer.querySelector('.file-preview-placeholder');
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.className = 'file-preview-placeholder';
                        placeholder.style.cssText = 'padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd; margin-top: 10px; text-align: center;';
                        previewContainer.appendChild(placeholder);
                    }
                    const icon = fileType === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf') ? 'ðŸ“„' : 'ðŸ“Š';
                    const typeName = fileType === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf') ? 'PDF' : 'Excel';
                    placeholder.innerHTML = `${icon} ${file.name} (${typeName})`;
                }
                
                // Store the photo data for when the form is saved
                window.editPhotoData = e.target.result;
                window.editFileName = file.name;
                window.editFileType = file.type;
                
                // Show receipt amount input
                document.getElementById('editReceiptAmountRow').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function uploadAddItemPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type (images, PDF, Excel)
            const validTypes = ['image/', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            const isValidType = validTypes.some(type => file.type.startsWith(type)) || 
                               file.name.toLowerCase().endsWith('.pdf') || 
                               file.name.toLowerCase().endsWith('.xlsx') || 
                               file.name.toLowerCase().endsWith('.xls');
            
            if (!isValidType) {
                alert(currentLanguage === 'en' ? 'Please select an image, PDF, or Excel file' : 'Por favor selecciona una imagen, PDF o archivo Excel');
                return;
            }
            
            // Validate file size (max 25MB for PDF/Excel, 10MB for images)
            const maxSize = file.type.startsWith('image/') ? 10 * 1024 * 1024 : 25 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxSizeMB = maxSize / (1024 * 1024);
                alert(currentLanguage === 'en' ? `File size must be less than ${maxSizeMB}MB` : `El tamaÃ±o del archivo debe ser menor a ${maxSizeMB}MB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('addPhotoPreview');
                const fileType = file.type;
                
                if (fileType.startsWith('image/')) {
                    preview.src = e.target.result;
                    preview.classList.add('show');
                } else {
                    // For PDF/Excel, show a placeholder
                    preview.style.display = 'none';
                    const previewContainer = preview.parentElement;
                    let placeholder = previewContainer.querySelector('.file-preview-placeholder');
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.className = 'file-preview-placeholder';
                        placeholder.style.cssText = 'padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd; margin-top: 10px; text-align: center;';
                        previewContainer.appendChild(placeholder);
                    }
                    const icon = fileType === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf') ? 'ðŸ“„' : 'ðŸ“Š';
                    const typeName = fileType === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf') ? 'PDF' : 'Excel';
                    placeholder.innerHTML = `${icon} ${file.name} (${typeName})`;
                }
                
                // Show receipt amount input
                document.getElementById('receiptAmountRow').style.display = 'block';
                
                // Store the photo data for when the form is saved
                window.addPhotoData = e.target.result;
                window.addFileName = file.name;
                window.addFileType = file.type;
            };
            reader.readAsDataURL(file);
        }

        async function removeItem(id) {
            // Convert id to number if it's a string representation of a number
            const itemId = typeof id === 'string' && !isNaN(id) ? parseFloat(id) : id;
            
            console.log('removeItem called with id:', id, 'converted to:', itemId, 'type:', typeof itemId);
            console.log('Current items count:', items.length);
            console.log('Items IDs:', items.map(i => ({ id: i.id, type: typeof i.id, name: i.nameEn || i.nameEs })));
            
            if (confirm(currentLanguage === 'en' ? 'Are you sure you want to remove this item?' : 'Â¿EstÃ¡s seguro de que quieres eliminar este artÃ­culo?')) {
                // Try to find item with flexible ID matching
                let item = items.find(i => i.id === itemId || i.id == id || String(i.id) === String(id));
                
                // If not found by ID, try to find by the item name from the button's row
                if (!item) {
                    // Try to find by getting the name from the DOM
                    const removeButtons = document.querySelectorAll(`button[onclick*="removeItem(${id})"]`);
                    if (removeButtons.length > 0) {
                        const removeButton = removeButtons[0];
                        const row = removeButton.closest('tr');
                        if (row) {
                            const nameCell = row.querySelector('td:first-child');
                            if (nameCell) {
                                const itemName = nameCell.textContent.trim();
                                // Try to find by name
                                item = items.find(i => {
                                    const iName = currentLanguage === 'en' ? i.nameEn : i.nameEs;
                                    return iName === itemName;
                                });
                                if (item) {
                                    console.log('Found item by name:', itemName);
                                }
                            }
                        }
                    }
                }
                
                if (!item) {
                    console.error('Item not found! Looking for id:', itemId, 'Available IDs:', items.map(i => i.id));
                    // Re-render to fix any ID mismatches
                    renderBudgetItems();
                    return;
                }
                
                const itemName = item ? (currentLanguage === 'en' ? item.nameEn : item.nameEs) : 'Unknown';
                const itemDbId = item.id; // Store the actual ID from the item
                
                console.log('Removing item:', itemName, 'with ID:', itemDbId, 'type:', typeof itemDbId);
                
                // Remove from local array using flexible matching
                const beforeCount = items.length;
                items = items.filter(item => {
                    // Keep items that DON'T match the ID we want to remove
                    const itemMatches = item.id === itemId || item.id == id || String(item.id) === String(id);
                    return !itemMatches; // Return true (keep) if it doesn't match
                });
                const afterCount = items.length;
                console.log('Items filtered. Before:', beforeCount, 'After:', afterCount, 'Removed:', beforeCount - afterCount);
                
                // If using Supabase, delete directly from database
                if (useSupabase && currentUser && itemDbId) {
                    try {
                        // Convert to number if it's a valid number
                        const dbId = typeof itemDbId === 'string' && !isNaN(itemDbId) ? parseFloat(itemDbId) : itemDbId;
                        console.log('Deleting from Supabase with ID:', dbId, 'type:', typeof dbId);
                        
                        const { error } = await supabase
                            .from('budget_items')
                            .delete()
                            .eq('id', dbId)
                            .eq('user_id', currentUser.id);
                        
                        if (error) {
                            console.error('Error deleting item from Supabase:', error);
                        } else {
                            console.log('Successfully deleted from Supabase');
                        }
                    } catch (error) {
                        console.error('Error deleting item from Supabase:', error);
                    }
                }
                
                // Save to localStorage and sync to Supabase (this will handle cleanup)
                await saveItems();
                renderBudgetItems();
                updateTotal();
                
                // Log change
                logActivity('delete', `${currentLanguage === 'en' ? 'Removed item' : 'ArtÃ­culo eliminado'}: ${itemName}`, itemDbId);
                logChange('deleted', itemDbId, itemName, item ? item.totalPrice : null, null, 'item');
                updateMonitorDashboard();
            }
        }

        function updateTotal() {
            // Include approved items and items without approval status (pending) in the total amount
            const includedItems = items.filter(item => item.approvalStatus === 'approved' || !item.approvalStatus || item.approvalStatus === 'pending');
            
            // Ensure totalPrice is a number for each item
            const total = includedItems.reduce((sum, item) => {
                const price = parseFloat(item.totalPrice) || 0;
                return sum + price;
            }, 0);
            
            const totalItems = items.length;
            const approvedItems = items.filter(item => item.approvalStatus === 'approved').length;
            const pendingItems = items.filter(item => !item.approvalStatus || item.approvalStatus === 'pending').length;
            const deniedItems = items.filter(item => item.approvalStatus === 'denied').length;
            const needsEditItems = items.filter(item => item.approvalStatus === 'needs_edit').length;
            
            // Update total amount (only approved items)
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
                totalElement.textContent = `$${total.toLocaleString('es-MX')} MXN`;
                console.log('updateTotal: Updated total to', total, 'from', includedItems.length, 'items');
            }
            
            // Update item counts
            const totalItemsEl = document.getElementById('totalItems');
            if (totalItemsEl) totalItemsEl.textContent = totalItems;
            
            const approvedItemsEl = document.getElementById('approvedItems');
            if (approvedItemsEl) approvedItemsEl.textContent = approvedItems;
            
            const pendingItemsEl = document.getElementById('pendingItems');
            if (pendingItemsEl) pendingItemsEl.textContent = pendingItems;
            
            const deniedItemsEl = document.getElementById('deniedItems');
            if (deniedItemsEl) deniedItemsEl.textContent = deniedItems;
            
            const needsEditItemsEl = document.getElementById('needsEditItems');
            if (needsEditItemsEl) needsEditItemsEl.textContent = needsEditItems;
            
            // Update approval summary if it exists
            updateApprovalSummary();
        }

        async function clearBudget(showConfirmation = true) {
            if (!showConfirmation || confirm(currentLanguage === 'en' ? 'Are you sure you want to clear all items? This will also clear any items pushed to next week.' : 'Â¿EstÃ¡s seguro de que quieres limpiar todos los artÃ­culos? Esto tambiÃ©n limpiarÃ¡ los artÃ­culos empujados a la prÃ³xima semana.')) {
                const itemCount = items.length;
                
                // Delete from Supabase if logged in
                if (useSupabase && currentUser) {
                    try {
                        // Delete ALL budget items for this user from Supabase
                        // This ensures we clear everything, even if IDs don't match
                        const { error } = await supabase
                            .from('budget_items')
                            .delete()
                            .eq('user_id', currentUser.id);
                        
                        if (error) {
                            console.error('Error deleting items from Supabase:', error);
                            showApprovalStatus('error', currentLanguage === 'en' 
                                ? `Error clearing items from database: ${error.message}` 
                                : `Error al limpiar artÃ­culos de la base de datos: ${error.message}`);
                            // Continue with localStorage clear even if Supabase delete fails
                        } else {
                            console.log(`Cleared all items from Supabase for user ${currentUser.id}`);
                        }
                    } catch (error) {
                        console.error('Error clearing items from Supabase:', error);
                        showApprovalStatus('error', currentLanguage === 'en' 
                            ? `Error clearing items: ${error.message}` 
                            : `Error al limpiar artÃ­culos: ${error.message}`);
                        // Continue with localStorage clear even if Supabase delete fails
                    }
                }
                
                // Clear from localStorage
                items = [];
                saveItems();
                
                // Also clear pushed items
                localStorage.setItem('pushedToNextWeek', JSON.stringify([]));
                console.log('Cleared all items and pushed items list');
                
                renderBudgetItems();
                updateTotal();
                updateApprovalSummary();
                
                // Log activity
                logActivity('clear', `${currentLanguage === 'en' ? 'Cleared all items and pushed items' : 'Todos los artÃ­culos y artÃ­culos empujados limpiados'}: ${itemCount} items`, null);
                updateMonitorDashboard();
            }
        }

        async function saveBudgetSnapshot() {
            // Get all saved budgets
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
            
            // Create snapshot with current date/time and week identifier
            const now = new Date();
            const weekStart = getWeekStart(now);
            const snapshot = {
                id: Date.now(),
                savedDate: now.toISOString(),
                weekStart: weekStart.toISOString(),
                weekLabel: getWeekLabel(weekStart),
                items: JSON.parse(JSON.stringify(items)), // Deep copy of items
                total: items.filter(item => item.approvalStatus === 'approved' || !item.approvalStatus || item.approvalStatus === 'pending')
                    .reduce((sum, item) => sum + item.totalPrice, 0),
                itemCount: items.length,
                approvedCount: items.filter(item => item.approvalStatus === 'approved').length,
                pendingCount: items.filter(item => !item.approvalStatus || item.approvalStatus === 'pending').length,
                language: currentLanguage
            };
            
            // Check for existing budget with same week_start in localStorage and remove it
            const existingIndex = savedBudgets.findIndex(b => b.weekStart === snapshot.weekStart);
            if (existingIndex !== -1) {
                savedBudgets.splice(existingIndex, 1);
            }
            
            // Add to saved budgets
            savedBudgets.push(snapshot);
            
            // Keep only last 100 budgets to avoid storage issues
            if (savedBudgets.length > 100) {
                savedBudgets.shift();
            }
            
            // Save to localStorage
            localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
            
            // If using Supabase and user is logged in, save to database
            if (useSupabase && currentUser) {
                try {
                    // Check if a budget with the same week_start already exists for this user
                    const { data: existingBudgets } = await supabase
                        .from('saved_budgets')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('week_start', snapshot.weekStart);
                    
                    // If budget exists, update it instead of creating a duplicate
                    if (existingBudgets && existingBudgets.length > 0) {
                        const existingId = existingBudgets[0].id;
                        
                        // Delete old items
                        await supabase
                            .from('saved_budget_items')
                            .delete()
                            .eq('saved_budget_id', existingId);
                        
                        // Update the budget
                        const { data: savedBudget, error: budgetError } = await supabase
                            .from('saved_budgets')
                            .update({
                                saved_date: snapshot.savedDate,
                                week_label: snapshot.weekLabel,
                                total: snapshot.total,
                                item_count: snapshot.itemCount,
                                approved_count: snapshot.approvedCount,
                                pending_count: snapshot.pendingCount,
                                language: snapshot.language
                            })
                            .eq('id', existingId)
                            .select()
                            .single();
                        
                        if (budgetError) throw budgetError;
                        
                        // Save new budget items
                        const budgetItems = snapshot.items.map(item => ({
                            saved_budget_id: savedBudget.id,
                            item_data: item
                        }));
                        
                        if (budgetItems.length > 0) {
                            await supabase.from('saved_budget_items').insert(budgetItems);
                        }
                        
                        // Update snapshot ID with database ID
                        snapshot.id = savedBudget.id;
                    } else {
                        // Create new saved budget record
                        const { data: savedBudget, error: budgetError } = await supabase
                            .from('saved_budgets')
                            .insert([{
                                user_id: currentUser.id,
                                saved_date: snapshot.savedDate,
                                week_start: snapshot.weekStart,
                                week_label: snapshot.weekLabel,
                                total: snapshot.total,
                                item_count: snapshot.itemCount,
                                approved_count: snapshot.approvedCount,
                                pending_count: snapshot.pendingCount,
                                language: snapshot.language
                            }])
                            .select()
                            .single();
                        
                        if (budgetError) throw budgetError;
                        
                        // Save budget items
                        const budgetItems = snapshot.items.map(item => ({
                            saved_budget_id: savedBudget.id,
                            item_data: item
                        }));
                        
                        if (budgetItems.length > 0) {
                            await supabase.from('saved_budget_items').insert(budgetItems);
                        }
                        
                        // Update snapshot ID with database ID
                        snapshot.id = savedBudget.id;
                    }
                } catch (error) {
                    console.error('Error saving budget to Supabase:', error);
                    // Continue with localStorage only if Supabase fails
                }
            }
            
            return snapshot;
        }
        
        // Function to update an existing saved budget in Supabase
        async function updateSavedBudgetInSupabase(budget) {
            if (!useSupabase || !currentUser) return;
            
            try {
                // Check if budget exists in Supabase (by ID or week_start)
                const { data: existingBudgets } = await supabase
                    .from('saved_budgets')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .or(`id.eq.${budget.id},week_start.eq.${budget.weekStart}`);
                
                let budgetId;
                
                if (existingBudgets && existingBudgets.length > 0) {
                    // Update existing budget
                    budgetId = existingBudgets[0].id;
                    
                    // Delete old items
                    await supabase
                        .from('saved_budget_items')
                        .delete()
                        .eq('saved_budget_id', budgetId);
                    
                    // Update the budget
                    const { error: budgetError } = await supabase
                        .from('saved_budgets')
                        .update({
                            saved_date: budget.savedDate,
                            week_label: budget.weekLabel,
                            total: budget.total || 0,
                            item_count: budget.itemCount || 0,
                            approved_count: budget.approvedCount || 0,
                            pending_count: budget.pendingCount || 0,
                            language: budget.language || 'en',
                            is_partial_payment: budget.isPartialPayment || false
                        })
                        .eq('id', budgetId);
                    
                    if (budgetError) throw budgetError;
                } else {
                    // Create new budget if it doesn't exist
                    const { data: savedBudget, error: budgetError } = await supabase
                        .from('saved_budgets')
                        .insert([{
                            user_id: currentUser.id,
                            saved_date: budget.savedDate,
                            week_start: budget.weekStart,
                            week_label: budget.weekLabel,
                            total: budget.total || 0,
                            item_count: budget.itemCount || 0,
                            approved_count: budget.approvedCount || 0,
                            pending_count: budget.pendingCount || 0,
                            language: budget.language || 'en',
                            is_partial_payment: budget.isPartialPayment || false
                        }])
                        .select()
                        .single();
                    
                    if (budgetError) throw budgetError;
                    budgetId = savedBudget.id;
                }
                
                // Save budget items
                if (budget.items && budget.items.length > 0) {
                    const budgetItems = budget.items.map(item => ({
                        saved_budget_id: budgetId,
                        item_data: item
                    }));
                    
                    await supabase.from('saved_budget_items').insert(budgetItems);
                }
                
                // Update budget ID if it was a new record
                if (!existingBudgets || existingBudgets.length === 0) {
                    budget.id = budgetId;
                }
            } catch (error) {
                console.error('Error updating saved budget in Supabase:', error);
                throw error;
            }
        }

        // Save budget without clearing - allows adding more items later
        function saveAndContinueBudget() {
            if (items.length === 0) {
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'No items to save. Budget is already empty.' : 
                    'No hay artÃ­culos para guardar. El presupuesto ya estÃ¡ vacÃ­o.');
                return;
            }
            
            // Save budget snapshot
            const snapshot = saveBudgetSnapshot();
            
            // Generate PDF and Excel, then send emails
            generatePDFAndExcelForEmail(snapshot);
            
            // Show success message
            showApprovalStatus('success', currentLanguage === 'en' 
                ? `Budget saved successfully! You can continue adding items.` 
                : `Â¡Presupuesto guardado exitosamente! Puedes continuar agregando artÃ­culos.`);
            
            // Log activity
            logActivity('export', `${currentLanguage === 'en' ? 'Saved budget (continue mode)' : 'Presupuesto guardado (modo continuar)'}: ${snapshot.weekLabel}`, null);
        }

        function saveAndClearBudget() {
            if (items.length === 0) {
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'No items to save. Budget is already empty.' : 
                    'No hay artÃ­culos para guardar. El presupuesto ya estÃ¡ vacÃ­o.');
                return;
            }
            
            if (confirm(currentLanguage === 'en' ? 
                'This will save the current week\'s budget and clear it for next week. Continue?' : 
                'Esto guardarÃ¡ el presupuesto de la semana actual y lo limpiarÃ¡ para la prÃ³xima semana. Â¿Continuar?')) {
                
                // Save budget snapshot
                const snapshot = saveBudgetSnapshot();
                
                // Generate PDF and Excel, then send emails
                generatePDFAndExcelForEmail(snapshot);
                
                // Clear budget after a short delay to allow export to complete
                setTimeout(() => {
                    // Reload categories to ensure we have latest data
                    categories = JSON.parse(localStorage.getItem('customCategories')) || {};
                    
                    // Get count before clearing
                    const itemCountBeforeClear = items.length;
                    console.log('About to clear budget. Current items:', itemCountBeforeClear);
                    
                    // Check for payroll items with receipt amounts before clearing
                    let payrollAdjustment = null;
                    const payrollItems = items.filter(item => {
                        const categoryKey = item.category;
                        const category = categories[categoryKey];
                        // Check if category name contains "payroll" (case insensitive) or category key is "payroll"
                        const isPayroll = categoryKey && (
                            categoryKey.toLowerCase() === 'payroll' ||
                            (category && (
                                category.nameEn && category.nameEn.toLowerCase().includes('payroll') ||
                                category.nameEs && category.nameEs.toLowerCase().includes('nÃ³mina')
                            ))
                        );
                        return isPayroll && item.receiptAmount && item.receiptAmount > 0;
                    });
                    
                    if (payrollItems.length > 0) {
                        // Use the first payroll item with receipt amount
                        const payrollItem = payrollItems[0];
                        const budgeted = payrollItem.totalPrice || 0;
                        const actual = payrollItem.receiptAmount || 0;
                        const difference = actual - budgeted;
                        
                        if (Math.abs(difference) > 0.01) { // Only adjust if difference is significant
                            payrollAdjustment = {
                                difference: difference,
                                budgeted: budgeted,
                                actual: actual,
                                itemNameEn: payrollItem.nameEn,
                                itemNameEs: payrollItem.nameEs
                            };
                            console.log('Payroll adjustment found:', payrollAdjustment);
                        }
                    }
                    
                    // Clear items array completely
                    items = [];
                    
                    // Save empty array to localStorage immediately
                    localStorage.setItem('budgetItems', JSON.stringify([]));
                    
                    console.log('Budget cleared. Items array length:', items.length);
                    
                    // Update UI immediately after clearing
                    renderBudgetItems();
                    updateTotal();
                    updateApprovalSummary();
                    console.log('Budget UI updated after clear. Items should be empty now.');
                    
                    // Get count before adding items back
                    const itemsBeforeAdd = items.length;
                    console.log('Before adding recurring/due date/pushed items. Current items:', itemsBeforeAdd, '(should be 0)');
                    
                    // Use the existing checkAndAddDueItems function to add back:
                    // - Recurring weekly items
                    // - Recurring monthly items
                    // - Items with due dates
                    // - Categories with due dates
                    // - Pushed items for next week
                    // Pass true to checkNextWeek and false to skipRecurring (we want recurring items)
                    checkAndAddDueItems(true, false);
                    
                    // Reload categories again after items are added (checkAndAddDueItems may have reloaded them)
                    categories = JSON.parse(localStorage.getItem('customCategories')) || {};
                    
                    // Apply payroll adjustment if there was one
                    if (payrollAdjustment) {
                        // Find the payroll item that was just added
                        const newPayrollItems = items.filter(item => {
                            const categoryKey = item.category;
                            const category = categories[categoryKey];
                            const isPayroll = categoryKey && (
                                categoryKey.toLowerCase() === 'payroll' ||
                                (category && (
                                    category.nameEn && category.nameEn.toLowerCase().includes('payroll') ||
                                    category.nameEs && category.nameEs.toLowerCase().includes('nÃ³mina')
                                ))
                            );
                            return isPayroll && 
                                   item.nameEn === payrollAdjustment.itemNameEn &&
                                   item.nameEs === payrollAdjustment.itemNameEs;
                        });
                        
                        if (newPayrollItems.length > 0) {
                            const newPayrollItem = newPayrollItems[0];
                            const originalTotal = newPayrollItem.totalPrice || 0;
                            const adjustment = payrollAdjustment.difference;
                            const newTotal = Math.max(0, originalTotal + adjustment); // Don't allow negative
                            
                            // Update the total price
                            newPayrollItem.totalPrice = newTotal;
                            
                            // Calculate new unit price based on quantity
                            if (newPayrollItem.quantity && newPayrollItem.quantity > 0) {
                                newPayrollItem.unitPrice = newTotal / newPayrollItem.quantity;
                            }
                            
                            // Add adjustment note
                            const adjustmentNote = currentLanguage === 'en'
                                ? `Previous week adjustment: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Actual: $${payrollAdjustment.actual.toFixed(2)} vs Budgeted: $${payrollAdjustment.budgeted.toFixed(2)})`
                                : `Ajuste semana anterior: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Real: $${payrollAdjustment.actual.toFixed(2)} vs Presupuestado: $${payrollAdjustment.budgeted.toFixed(2)})`;
                            
                            // Add or update notes
                            if (!newPayrollItem.notes || newPayrollItem.notes === '(none)') {
                                newPayrollItem.notes = adjustmentNote;
                            } else {
                                newPayrollItem.notes = newPayrollItem.notes + '\n' + adjustmentNote;
                            }
                            
                            // Also update notesEn and notesEs
                            if (!newPayrollItem.notesEn || newPayrollItem.notesEn === '(none)') {
                                newPayrollItem.notesEn = `Previous week adjustment: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Actual: $${payrollAdjustment.actual.toFixed(2)} vs Budgeted: $${payrollAdjustment.budgeted.toFixed(2)})`;
                            } else {
                                newPayrollItem.notesEn = newPayrollItem.notesEn + '\n' + `Previous week adjustment: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Actual: $${payrollAdjustment.actual.toFixed(2)} vs Budgeted: $${payrollAdjustment.budgeted.toFixed(2)})`;
                            }
                            
                            if (!newPayrollItem.notesEs || newPayrollItem.notesEs === '(none)') {
                                newPayrollItem.notesEs = `Ajuste semana anterior: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Real: $${payrollAdjustment.actual.toFixed(2)} vs Presupuestado: $${payrollAdjustment.budgeted.toFixed(2)})`;
                            } else {
                                newPayrollItem.notesEs = newPayrollItem.notesEs + '\n' + `Ajuste semana anterior: ${adjustment >= 0 ? '+' : ''}$${adjustment.toFixed(2)} MXN (Real: $${payrollAdjustment.actual.toFixed(2)} vs Presupuestado: $${payrollAdjustment.budgeted.toFixed(2)})`;
                            }
                            
                            console.log('Payroll adjustment applied:', {
                                original: originalTotal,
                                adjustment: adjustment,
                                newTotal: newTotal
                            });
                        }
                    }
                    
                    const itemsAfterAdd = items.length;
                    const addedCount = itemsAfterAdd - itemsBeforeAdd;
                    
                    console.log('After adding recurring/due date/pushed items. Items added:', addedCount, 'Total items now:', items.length);
                    
                    // Save the final state (with only recurring/due date/pushed items)
                    saveItems();
                    console.log('Final save complete. Total items:', items.length);
                    
                    // Refresh the display
                    renderBudgetItems();
                    updateTotal();
                    updateApprovalSummary();
                    updateMonitorDashboard();
                    console.log('UI refreshed. Budget should now show only recurring/due date/pushed items.');
                    
                    if (addedCount > 0) {
                        showApprovalStatus('success', currentLanguage === 'en' ? 
                            `Budget saved for ${snapshot.weekLabel}, exported to Excel, and cleared for next week! ${addedCount} recurring/due date/pushed item(s) added.` : 
                            `Â¡Presupuesto guardado para ${snapshot.weekLabel}, exportado a Excel, y limpiado para la prÃ³xima semana! ${addedCount} artÃ­culo(s) recurrente(s)/fecha lÃ­mite/empujado(s) agregado(s).`);
                    } else {
                        showApprovalStatus('success', currentLanguage === 'en' ? 
                            `Budget saved for ${snapshot.weekLabel}, exported to Excel, and cleared for next week!` : 
                            `Â¡Presupuesto guardado para ${snapshot.weekLabel}, exportado a Excel, y limpiado para la prÃ³xima semana!`);
                    }
                    
                    // Log activity
                    logActivity('export', `${currentLanguage === 'en' ? 'Saved, exported, and cleared budget for next week' : 'Presupuesto guardado, exportado y limpiado para la prÃ³xima semana'}: ${snapshot.weekLabel}`, null);
                }, 500);
            }
        }

        function exportBudget() {
            // Show export format selection
            const format = confirm(currentLanguage === 'en' ? 
                'Click OK for Excel format, Cancel for JSON format' : 
                'Haz clic en Aceptar para formato Excel, Cancelar para formato JSON') ? 'excel' : 'json';
            
            if (format === 'excel') {
                exportToExcel();
            } else {
                exportToJSON();
            }
            
            // Log activity
            logActivity('export', `${currentLanguage === 'en' ? 'Exported budget' : 'Presupuesto exportado'}: ${format.toUpperCase()} format`, null);
        }
        
        // Save and load email list
        function saveEmailList() {
            const emailList = document.getElementById('saveClearEmailList').value;
            localStorage.setItem('saveClearEmailList', emailList);
        }
        
        function loadEmailList() {
            const savedList = localStorage.getItem('saveClearEmailList');
            const defaultEmails = 'mike@oolab.com, accounting@oolab.com, graeme@oolab.com, consufis@gmail.com, josejuanpalafoxrodriguez@gmail.com';
            if (savedList) {
                document.getElementById('saveClearEmailList').value = savedList;
            } else {
                // Set default emails if nothing is saved
                document.getElementById('saveClearEmailList').value = defaultEmails;
                saveEmailList(); // Save the defaults
            }
        }
        
        // Toggle email configuration visibility
        function toggleEmailConfig() {
            const configDetails = document.getElementById('emailConfigDetails');
            const toggleButton = document.getElementById('emailConfigToggle');
            
            if (configDetails.style.display === 'none') {
                configDetails.style.display = 'block';
                toggleButton.textContent = currentLanguage === 'en' ? 'Hide Configuration' : 'Ocultar ConfiguraciÃ³n';
                toggleButton.setAttribute('data-en', 'Hide Configuration');
                toggleButton.setAttribute('data-es', 'Ocultar ConfiguraciÃ³n');
            } else {
                configDetails.style.display = 'none';
                toggleButton.textContent = currentLanguage === 'en' ? 'Show Configuration' : 'Mostrar ConfiguraciÃ³n';
                toggleButton.setAttribute('data-en', 'Show Configuration');
                toggleButton.setAttribute('data-es', 'Mostrar ConfiguraciÃ³n');
            }
        }
        
        // EmailJS Settings Functions
        function saveEmailJSSettings() {
            const publicKey = document.getElementById('emailjsPublicKey').value.trim();
            const serviceId = document.getElementById('emailjsServiceId').value.trim();
            const templateId = document.getElementById('emailjsTemplateId').value.trim();
            
            if (publicKey) localStorage.setItem('emailjsPublicKey', publicKey);
            if (serviceId) localStorage.setItem('emailjsServiceId', serviceId);
            if (templateId) localStorage.setItem('emailjsTemplateId', templateId);
            
            // Clear if empty
            if (!publicKey) localStorage.removeItem('emailjsPublicKey');
            if (!serviceId) localStorage.removeItem('emailjsServiceId');
            if (!templateId) localStorage.removeItem('emailjsTemplateId');
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                'EmailJS settings saved!' : 
                'Â¡ConfiguraciÃ³n de EmailJS guardada!');
        }
        
        function loadEmailJSSettings() {
            const publicKey = localStorage.getItem('emailjsPublicKey');
            const serviceId = localStorage.getItem('emailjsServiceId');
            const templateId = localStorage.getItem('emailjsTemplateId');
            
            if (publicKey && document.getElementById('emailjsPublicKey')) {
                document.getElementById('emailjsPublicKey').value = publicKey;
            }
            if (serviceId && document.getElementById('emailjsServiceId')) {
                document.getElementById('emailjsServiceId').value = serviceId;
            }
            if (templateId && document.getElementById('emailjsTemplateId')) {
                document.getElementById('emailjsTemplateId').value = templateId;
            }
        }
        
        function saveDeepLSettings() {
            const apiKey = document.getElementById('deeplApiKey').value.trim();
            
            if (apiKey) {
                localStorage.setItem('deeplApiKey', apiKey);
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    'DeepL API key saved!' : 
                    'Â¡Clave API de DeepL guardada!');
            } else {
                localStorage.removeItem('deeplApiKey');
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'DeepL API key removed. Translation will use fallback method.' : 
                    'Clave API de DeepL eliminada. La traducciÃ³n usarÃ¡ el mÃ©todo de respaldo.');
            }
        }
        
        function loadDeepLSettings() {
            const apiKey = localStorage.getItem('deeplApiKey');
            
            if (apiKey && document.getElementById('deeplApiKey')) {
                document.getElementById('deeplApiKey').value = apiKey;
            }
        }
        
        // UPS Tracking API Functions
        function saveUPSSettings() {
            const clientId = document.getElementById('upsClientId').value.trim();
            const clientSecret = document.getElementById('upsClientSecret').value.trim();
            let proxyUrl = document.getElementById('upsProxyUrl') ? document.getElementById('upsProxyUrl').value.trim() : '';
            const checkInterval = parseInt(document.getElementById('upsCheckInterval').value) || 6;
            
            // Normalize proxy URL: ensure it starts with https:// or http://
            if (proxyUrl && !proxyUrl.match(/^https?:\/\//i)) {
                proxyUrl = 'https://' + proxyUrl;
                // Update the input field to show the corrected URL
                if (document.getElementById('upsProxyUrl')) {
                    document.getElementById('upsProxyUrl').value = proxyUrl;
                }
            }
            
            if (clientId) localStorage.setItem('upsClientId', clientId);
            if (clientSecret) localStorage.setItem('upsClientSecret', clientSecret);
            if (proxyUrl) localStorage.setItem('upsProxyUrl', proxyUrl);
            localStorage.setItem('upsCheckInterval', checkInterval.toString());
            
            // Clear if empty
            if (!clientId) localStorage.removeItem('upsClientId');
            if (!clientSecret) localStorage.removeItem('upsClientSecret');
            
            // Restart polling if settings changed
            if (clientId && clientSecret) {
                startUPSTrackingPolling();
            }
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                'UPS settings saved!' : 
                'Â¡ConfiguraciÃ³n de UPS guardada!');
        }
        
        function loadUPSSettings() {
            const clientId = localStorage.getItem('upsClientId');
            const clientSecret = localStorage.getItem('upsClientSecret');
            const proxyUrl = localStorage.getItem('upsProxyUrl');
            const checkInterval = localStorage.getItem('upsCheckInterval') || '6';
            
            if (clientId && document.getElementById('upsClientId')) {
                document.getElementById('upsClientId').value = clientId;
            }
            if (clientSecret && document.getElementById('upsClientSecret')) {
                document.getElementById('upsClientSecret').value = clientSecret;
            }
            if (proxyUrl && document.getElementById('upsProxyUrl')) {
                document.getElementById('upsProxyUrl').value = proxyUrl;
            }
            if (document.getElementById('upsCheckInterval')) {
                document.getElementById('upsCheckInterval').value = checkInterval;
            }
            
            // Start polling if credentials are set
            if (clientId && clientSecret) {
                startUPSTrackingPolling();
            }
        }
        
        // Clear proxy URL (useful if proxy is not working)
        function clearProxyUrl() {
            if (document.getElementById('upsProxyUrl')) {
                document.getElementById('upsProxyUrl').value = '';
                localStorage.removeItem('upsProxyUrl');
                saveUPSSettings();
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'Proxy URL cleared. System will use direct API calls with CORS proxy.' : 
                    'URL del proxy eliminada. El sistema usarÃ¡ llamadas API directas con proxy CORS.');
            }
        }
        
        // Get UPS OAuth token
        async function getUPSToken() {
            const clientId = localStorage.getItem('upsClientId');
            const clientSecret = localStorage.getItem('upsClientSecret');
            
            if (!clientId || !clientSecret) {
                throw new Error('UPS credentials not configured');
            }
            
            // Get proxy server URL from settings, or use direct (will fail due to CORS)
            let PROXY_URL = localStorage.getItem('upsProxyUrl') || '';
            // Normalize proxy URL: ensure it starts with https:// or http://
            if (PROXY_URL && !PROXY_URL.match(/^https?:\/\//i)) {
                PROXY_URL = 'https://' + PROXY_URL;
            }
            // Remove trailing slash if present to avoid double slashes
            PROXY_URL = PROXY_URL.replace(/\/+$/, '');
            
            let useDirectCall = false;
            
            // If proxy URL is configured, try it first
            if (PROXY_URL) {
                try {
                    const response = await fetch(`${PROXY_URL}/api/ups/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ clientId, clientSecret })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.access_token;
                    } else {
                        // Proxy failed (404, 500, etc.) - fall back to direct call
                        console.warn(`Proxy returned ${response.status} for token, falling back to direct API call`);
                        useDirectCall = true;
                    }
                } catch (proxyError) {
                    // Proxy request failed (network error, CORS, etc.) - fall back to direct call
                    console.warn('Proxy request failed for token, falling back to direct API call:', proxyError);
                    useDirectCall = true;
                }
            } else {
                // No proxy configured, use direct call
                useDirectCall = true;
            }
            
            // Fallback: Try direct (with CORS proxy for web-based calls)
            if (useDirectCall) {
                const isLocalFile = window.location.protocol === 'file:';
                
                if (isLocalFile) {
                    throw new Error('UPS API cannot be called directly from local files due to CORS restrictions. Please either:\n1. Deploy your proxy server and enter its URL in Settings\n2. Deploy the app to GitHub Pages\n3. Use a local development server (not file://)');
                }
                
                let tokenUrl = 'https://onlinetools.ups.com/security/v1/oauth/token';
                
                // Try using allorigins.win for OAuth token (may not work due to custom headers)
                const upsOAuthUrl = 'https://onlinetools.ups.com/security/v1/oauth/token';
                tokenUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(upsOAuthUrl)}`;
                
                const credentials = btoa(`${clientId}:${clientSecret}`);
                
                try {
                    const response = await fetch(tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': `Basic ${credentials}`,
                            'x-merchant-id': clientId
                        },
                        body: 'grant_type=client_credentials'
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`UPS OAuth error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    return data.access_token;
                } catch (error) {
                    console.error('UPS OAuth error (direct call):', error);
                    throw new Error(`UPS OAuth failed. This is likely due to CORS restrictions. Please configure a working proxy server URL in Settings. Error: ${error.message}`);
                }
            }
        }
        
        // Subscribe tracking numbers to UPS Track Alert API
        async function subscribeToTrackAlert(trackingNumbers) {
            try {
                const clientId = localStorage.getItem('upsClientId');
                const clientSecret = localStorage.getItem('upsClientSecret');
                const proxyUrl = localStorage.getItem('upsProxyUrl') || '';
                
                if (!clientId || !clientSecret) {
                    console.log('UPS credentials not configured, skipping Track Alert subscription');
                    return { success: false, error: 'Credentials not configured' };
                }
                
                if (!proxyUrl) {
                    console.log('Proxy URL not configured, skipping Track Alert subscription');
                    return { success: false, error: 'Proxy URL not configured' };
                }
                
                // Normalize proxy URL
                let PROXY_URL = proxyUrl;
                if (!PROXY_URL.match(/^https?:\/\//i)) {
                    PROXY_URL = 'https://' + PROXY_URL;
                }
                PROXY_URL = PROXY_URL.replace(/\/+$/, '');
                
                // Get OAuth token
                const token = await getUPSToken();
                
                // Build webhook URL (UPS will POST to this when events occur)
                const webhookUrl = `${PROXY_URL}/api/ups/track-alert/webhook`;
                
                // Filter out empty tracking numbers
                const validTrackingNumbers = trackingNumbers.filter(tn => tn && tn.trim());
                
                if (validTrackingNumbers.length === 0) {
                    return { success: false, error: 'No valid tracking numbers' };
                }
                
                // Subscribe in batches of 100 (UPS limit)
                const batches = [];
                for (let i = 0; i < validTrackingNumbers.length; i += 100) {
                    batches.push(validTrackingNumbers.slice(i, i + 100));
                }
                
                const results = [];
                for (const batch of batches) {
                    try {
                        const response = await fetch(`${PROXY_URL}/api/ups/track-alert/subscribe`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                trackingNumbers: batch,
                                webhookUrl: webhookUrl,
                                accessToken: token,
                                clientId: clientId,
                                environment: 'production' // or 'test' if using test credentials
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Track Alert subscription successful for batch:', batch, data);
                            results.push({ success: true, batch: batch, data: data });
                        } else {
                            const errorData = await response.json();
                            console.error('Track Alert subscription failed:', response.status, errorData);
                            results.push({ success: false, batch: batch, error: errorData });
                        }
                    } catch (error) {
                        console.error('Error subscribing batch to Track Alert:', error);
                        results.push({ success: false, batch: batch, error: error.message });
                    }
                }
                
                const allSuccess = results.every(r => r.success);
                return {
                    success: allSuccess,
                    results: results,
                    message: allSuccess 
                        ? `Subscribed ${validTrackingNumbers.length} tracking numbers to Track Alert`
                        : `Some subscriptions failed. Check console for details.`
                };
                
            } catch (error) {
                console.error('Error subscribing to Track Alert:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Check UPS tracking status
        async function checkUPSTracking(trackingNumber) {
            try {
                const token = await getUPSToken();
                const clientId = localStorage.getItem('upsClientId');
                
                // Get proxy server URL from settings
                let PROXY_URL = localStorage.getItem('upsProxyUrl') || '';
                // Normalize proxy URL: ensure it starts with https:// or http://
                if (PROXY_URL && !PROXY_URL.match(/^https?:\/\//i)) {
                    PROXY_URL = 'https://' + PROXY_URL;
                }
                // Remove trailing slash if present to avoid double slashes
                PROXY_URL = PROXY_URL.replace(/\/+$/, '');
                
                let data; // Declare data variable outside if/else
                let useDirectCall = false;
                
                // If proxy URL is configured, try it first
                if (PROXY_URL) {
                    try {
                        const response = await fetch(`${PROXY_URL}/api/ups/track`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                trackingNumber,
                                accessToken: token,
                                clientId
                            })
                        });
                        
                        if (response.ok) {
                            data = await response.json();
                        } else {
                            // Proxy failed - log the error response for debugging
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                                console.error(`Proxy returned ${response.status}:`, errorData);
                                
                                // If it's a 502, the proxy is working but UPS API failed
                                if (response.status === 502 && errorData.upsError) {
                                    throw new Error(`UPS API Error (${errorData.upsStatus}): ${errorData.upsError}`);
                                }
                            } catch (e) {
                                if (e.message && e.message.includes('UPS API Error')) {
                                    // Re-throw UPS API errors
                                    throw e;
                                }
                                console.error(`Proxy returned ${response.status}:`, errorText);
                            }
                            
                            // Only fall back to direct call if it's a proxy error (not UPS API error)
                            if (response.status !== 502) {
                                console.warn(`Proxy returned ${response.status}, falling back to direct API call`);
                                useDirectCall = true;
                            } else {
                                // 502 means proxy is working but UPS API failed - don't fall back
                                throw new Error(errorData?.message || 'UPS API returned an error');
                            }
                        }
                    } catch (proxyError) {
                        // Proxy request failed (network error, CORS, etc.) - fall back to direct call
                        console.warn('Proxy request failed, falling back to direct API call:', proxyError);
                        useDirectCall = true;
                    }
                } else {
                    // No proxy configured, use direct call
                    useDirectCall = true;
                }
                
                // Use direct API call (either as fallback or primary method)
                if (useDirectCall) {
                    // Note: Direct API calls from browser will fail due to CORS
                    // The UPS API requires custom headers that CORS proxies typically don't support
                    // A working proxy server is required for this to work
                    const isLocalFile = window.location.protocol === 'file:';
                    
                    if (isLocalFile) {
                        throw new Error('UPS API cannot be called directly from local files due to CORS restrictions. Please either:\n1. Deploy your proxy server and enter its URL in Settings\n2. Deploy the app to GitHub Pages\n3. Use a local development server (not file://)');
                    }
                    
                    // For web-based calls, try using a CORS proxy
                    // Note: Most CORS proxies don't support POST with custom headers, so this may still fail
                    // The proxy server is the recommended solution
                    let trackUrl = 'https://onlinetools.ups.com/api/track/v1/details';
                    
                    // Try using allorigins.win which can proxy POST requests
                    // Format: https://api.allorigins.win/raw?url=ENCODED_URL
                    const upsApiUrl = 'https://onlinetools.ups.com/api/track/v1/details';
                    trackUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(upsApiUrl)}`;
                    
                    const transId = 'tracking-' + Date.now();
                    const headers = {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'transId': transId,
                        'transactionSrc': 'budget-manager'
                    };
                    
                    if (clientId) {
                        headers['x-merchant-id'] = clientId;
                    }
                    
                    const requestBody = {
                        TrackRequest: {
                            Request: {
                                RequestOption: '1',
                                TransactionReference: {
                                    CustomerContext: transId
                                }
                            },
                            InquiryNumber: trackingNumber
                        }
                    };
                    
                    try {
                        const response = await fetch(trackUrl, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`UPS Tracking error: ${response.status} - ${errorText}`);
                        }
                        
                        data = await response.json();
                    } catch (fetchError) {
                        // If CORS proxy fails, provide helpful error message
                        console.error('Direct API call failed:', fetchError);
                        throw new Error(`UPS API call failed. This is likely due to CORS restrictions. Please configure a working proxy server URL in Settings. Error: ${fetchError.message}`);
                    }
                }
                
                // Process response (data is set from either proxy or direct call above)
                
                // Log full UPS response for debugging
                console.log('ðŸ“¦ Full UPS API Response for tracking:', trackingNumber, data);
                
                // Check if delivered and get status details
                if (data.trackResponse && data.trackResponse.shipment) {
                    const shipment = data.trackResponse.shipment[0];
                    if (shipment.package && shipment.package[0]) {
                        const packageInfo = shipment.package[0];
                        const activity = packageInfo.activity || [];
                        
                        // Check entire API response for "import fees have already been paid" message
                        const fullResponseText = JSON.stringify(data).toLowerCase();
                        const feesPaidInResponse = fullResponseText.includes('import fees have already been paid') ||
                                                   fullResponseText.includes('fees have already been paid') ||
                                                   fullResponseText.includes('import fees paid') ||
                                                   fullResponseText.includes('duties paid') ||
                                                   fullResponseText.includes('fees paid');
                        
                        // Log package info for debugging
                        console.log('ðŸ“¦ Package Info:', {
                            currentStatus: packageInfo.currentStatus,
                            customsInfo: packageInfo.customsInfo,
                            activity: activity,
                            packageInfo: packageInfo,
                            feesPaidInResponse: feesPaidInResponse
                        });
                        
                        // Get current status
                        const currentStatus = packageInfo.currentStatus || {};
                        const statusCode = currentStatus.code || '';
                        const statusDescription = currentStatus.description || 'In Transit';
                        
                        // Check if delivered
                        const delivered = activity.some(act => 
                            act.status && act.status.type && 
                            (act.status.type === 'D' || act.status.description?.toLowerCase().includes('delivered'))
                        );
                        
                        // Check if picked up (origin scan) - status code 'O' or description indicates pickup
                        // Check both activity array and current status description
                        const pickedUp = activity.some(act => {
                            const actDesc = (act.status?.description || '').toLowerCase();
                            const actType = act.status?.type || '';
                            return actType === 'O' || 
                                   actDesc.includes('origin scan') ||
                                   actDesc.includes('picked up') ||
                                   actDesc.includes('pickup scan') ||
                                   actDesc.includes('we have your package') ||
                                   actDesc.includes('package received');
                        }) || statusCode === 'O' ||
                        statusDescription.toLowerCase().includes('origin scan') ||
                        statusDescription.toLowerCase().includes('picked up') ||
                        statusDescription.toLowerCase().includes('pickup scan') ||
                        statusDescription.toLowerCase().includes('we have your package') ||
                        statusDescription.toLowerCase().includes('package received');
                        
                        // Check if in transit - status code 'I' or description indicates in transit
                        // Check both activity array and current status description
                        const inTransit = activity.some(act => {
                            const actDesc = (act.status?.description || '').toLowerCase();
                            const actType = act.status?.type || '';
                            return actType === 'I' ||
                                   actDesc.includes('in transit') ||
                                   actDesc.includes('on the way') ||
                                   actDesc.includes('shipped') ||
                                   actDesc.includes('departed') ||
                                   actDesc.includes('arrived');
                        }) || statusCode === 'I' ||
                        statusDescription.toLowerCase().includes('in transit') ||
                        statusDescription.toLowerCase().includes('on the way') ||
                        statusDescription.toLowerCase().includes('shipped') ||
                        statusDescription.toLowerCase().includes('departed') ||
                        statusDescription.toLowerCase().includes('arrived') ||
                        (statusCode !== 'D' && statusCode !== 'E' && statusCode !== 'O' && 
                         statusDescription.toLowerCase() !== 'unknown' && 
                         !delivered && !pickedUp && statusDescription.toLowerCase() !== 'label created');
                        
                        // Check for delays or exceptions
                        const hasDelay = statusCode === 'E' || 
                                        statusDescription.toLowerCase().includes('exception') ||
                                        statusDescription.toLowerCase().includes('delay') ||
                                        statusDescription.toLowerCase().includes('held') ||
                                        statusDescription.toLowerCase().includes('damage');
                        
                        // Check package-level customs/duties info FIRST (before using it)
                        const customsInfo = packageInfo.customsInfo || {};
                        const dutiesAmount = customsInfo.dutiesAmount || '';
                        const hasCustomsCharges = dutiesAmount || customsInfo.customsValue || false;
                        
                        // Check for duties/taxes due
                        const hasDutiesDue = statusDescription.toLowerCase().includes('duties') ||
                                            statusDescription.toLowerCase().includes('taxes') ||
                                            statusDescription.toLowerCase().includes('customs') ||
                                            statusDescription.toLowerCase().includes('payment required') ||
                                            statusDescription.toLowerCase().includes('held for payment') ||
                                            statusDescription.toLowerCase().includes('import charges') ||
                                            activity.some(act => 
                                                act.status && act.status.description && 
                                                (act.status.description.toLowerCase().includes('duties') ||
                                                 act.status.description.toLowerCase().includes('taxes') ||
                                                 act.status.description.toLowerCase().includes('customs') ||
                                                 act.status.description.toLowerCase().includes('payment required'))
                                            );
                        
                        // Check if duties/fees have been paid - check multiple variations
                        const dutiesPaidByStatus = statusDescription.toLowerCase().includes('duties paid') ||
                                          statusDescription.toLowerCase().includes('fees paid') ||
                                          statusDescription.toLowerCase().includes('payment received') ||
                                          statusDescription.toLowerCase().includes('payment processed') ||
                                          statusDescription.toLowerCase().includes('cleared customs') ||
                                          statusDescription.toLowerCase().includes('customs cleared') ||
                                          statusDescription.toLowerCase().includes('import fees paid') ||
                                          statusDescription.toLowerCase().includes('import fees have already been paid') ||
                                          statusDescription.toLowerCase().includes('fees have already been paid') ||
                                          statusDescription.toLowerCase().includes('duty paid') ||
                                          statusDescription.toLowerCase().includes('fee paid') ||
                                          statusDescription.toLowerCase().includes('paid and released') ||
                                          statusDescription.toLowerCase().includes('released from customs') ||
                                          statusDescription.toLowerCase().includes('icod charges have been paid') ||
                                          statusDescription.toLowerCase().includes('import c.o.d. charges have been paid') ||
                                          statusDescription.toLowerCase().includes('charges have been paid or billed') ||
                                          statusDescription.toLowerCase().includes('import charges have been paid');
                        
                        const dutiesPaidByActivity = activity.some(act => {
                                              const actDesc = (act.status?.description || '').toLowerCase();
                                              const actType = (act.status?.type || '').toLowerCase();
                                              // Check description and type for payment indicators
                                              return actDesc.includes('duties paid') ||
                                                     actDesc.includes('fees paid') ||
                                                     actDesc.includes('payment received') ||
                                                     actDesc.includes('payment processed') ||
                                                     actDesc.includes('cleared customs') ||
                                                     actDesc.includes('customs cleared') ||
                                                     actDesc.includes('import fees paid') ||
                                                     actDesc.includes('duty paid') ||
                                                     actDesc.includes('fee paid') ||
                                                     actDesc.includes('paid and released') ||
                                                     actDesc.includes('released from customs') ||
                                                     actDesc.includes('already been paid') ||
                                                     actDesc.includes('fees have already been paid') ||
                                                     actDesc.includes('icod charges have been paid') ||
                                                     actDesc.includes('import c.o.d. charges have been paid') ||
                                                     actDesc.includes('charges have been paid or billed') ||
                                                     actDesc.includes('import charges have been paid') ||
                                                     actType === 'p' || // P might indicate payment/processed
                                                     (actDesc.includes('customs') && actDesc.includes('release'));
                                          });
                        
                        // Check customs info: if it exists but dutiesAmount is empty/zero, might indicate paid
                        const customsPaid = customsInfo && Object.keys(customsInfo).length > 0 && 
                                           (!dutiesAmount || dutiesAmount === '0' || dutiesAmount === '$0.00' || dutiesAmount === '0.00') &&
                                           !hasDutiesDue; // Only if no active duties due status
                        
                        const dutiesPaid = dutiesPaidByStatus || dutiesPaidByActivity || customsPaid || feesPaidInResponse;
                        
                        // If duties are paid, don't show as due
                        const finalHasDutiesDue = (hasDutiesDue || hasCustomsCharges) && !dutiesPaid;
                        
                        // Log duties detection for debugging
                        console.log('ðŸ’° Duties/Taxes Detection:', {
                            statusDescription: statusDescription,
                            statusCode: statusCode,
                            customsInfo: customsInfo,
                            dutiesAmount: dutiesAmount,
                            hasDutiesDue: hasDutiesDue,
                            hasCustomsCharges: hasCustomsCharges,
                            dutiesPaid: dutiesPaid,
                            finalHasDutiesDue: finalHasDutiesDue,
                            activityWithDuties: activity.filter(act => 
                                act.status && act.status.description && 
                                (act.status.description.toLowerCase().includes('duties') ||
                                 act.status.description.toLowerCase().includes('taxes') ||
                                 act.status.description.toLowerCase().includes('customs') ||
                                 act.status.description.toLowerCase().includes('payment required') ||
                                 act.status.description.toLowerCase().includes('paid'))
                            ),
                            allActivityDescriptions: activity.map(act => act.status?.description || '').filter(d => d)
                        });
                        
                        // Get latest activity for more details
                        const latestActivity = activity.length > 0 ? activity[0] : null;
                        const lastLocation = latestActivity?.location?.address?.city || '';
                        const lastDate = latestActivity?.date || '';
                        
                        return {
                            delivered: delivered,
                            pickedUp: pickedUp,
                            inTransit: inTransit,
                            status: statusDescription,
                            statusCode: statusCode,
                            hasDelay: hasDelay,
                            hasDutiesDue: finalHasDutiesDue,
                            dutiesPaid: dutiesPaid,
                            dutiesAmount: dutiesAmount,
                            trackingNumber: trackingNumber,
                            lastLocation: lastLocation,
                            lastDate: lastDate,
                            latestActivity: latestActivity,
                            // Include raw data for debugging
                            rawCustomsInfo: customsInfo,
                            rawPackageInfo: packageInfo
                        };
                    }
                }
                
                return {
                    delivered: false,
                    pickedUp: false,
                    inTransit: false,
                    status: 'Unknown',
                    statusCode: '',
                    hasDelay: false,
                    hasDutiesDue: false,
                    dutiesPaid: false,
                    dutiesAmount: '',
                    trackingNumber: trackingNumber,
                    lastLocation: '',
                    lastDate: ''
                };
            } catch (error) {
                console.error('Error checking UPS tracking:', error);
                throw error;
            }
        }
        
        // Check all tracking numbers and update status
        async function checkAllTrackingNumbers() {
            const clientId = localStorage.getItem('upsClientId');
            const clientSecret = localStorage.getItem('upsClientSecret');
            
            if (!clientId || !clientSecret) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please configure UPS credentials in Settings first' : 
                    'Por favor configura las credenciales de UPS en ConfiguraciÃ³n primero');
                return;
            }
            
            showApprovalStatus('info', currentLanguage === 'en' ? 
                'Checking tracking numbers...' : 
                'Verificando nÃºmeros de seguimiento...');
            
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            let updated = false;
            let checked = 0;
            
            for (const request of history) {
                // Check all requests with tracking numbers (not just "sent" status)
                if (request.trackingShipments && request.trackingShipments.length > 0) {
                    // Track delivered shipments for this request
                    let deliveredShipments = 0;
                    const totalShipments = request.trackingShipments.filter(s => s.trackingNumber && s.trackingNumber.trim()).length;
                    
                    for (const shipment of request.trackingShipments) {
                        if (shipment.trackingNumber && shipment.trackingNumber.trim()) {
                            try {
                                checked++;
                                const result = await checkUPSTracking(shipment.trackingNumber.trim());
                                
                                // Store UPS status in shipment object
                                shipment.upsStatus = result.status;
                                shipment.upsStatusCode = result.statusCode;
                                shipment.upsHasDelay = result.hasDelay;
                                shipment.upsHasDutiesDue = result.hasDutiesDue || false;
                                shipment.upsDutiesPaid = result.dutiesPaid || false;
                                shipment.upsDutiesAmount = result.dutiesAmount || '';
                                shipment.upsLastLocation = result.lastLocation;
                                shipment.upsLastDate = result.lastDate;
                                shipment.upsLastChecked = new Date().toISOString();
                                shipment.upsPickedUp = result.pickedUp || false;
                                shipment.upsInTransit = result.inTransit || false;
                                
                                // If duties are paid, clear the duties due flag
                                if (result.dutiesPaid) {
                                    shipment.upsHasDutiesDue = false;
                                    shipment.dutiesAlerted = false; // Reset alert so it doesn't show again
                                }
                                
                                // Debug logging
                                console.log(`ðŸ“¦ Tracking ${shipment.trackingNumber}:`, {
                                    status: result.status,
                                    statusCode: result.statusCode,
                                    pickedUp: result.pickedUp,
                                    inTransit: result.inTransit,
                                    delivered: result.delivered,
                                    hasDutiesDue: result.hasDutiesDue,
                                    dutiesPaid: result.dutiesPaid,
                                    dutiesAmount: result.dutiesAmount
                                });
                                
                                // Track if this shipment is delivered
                                if (result.delivered) {
                                    deliveredShipments++;
                                }
                                
                                // Automatically update request status to "sent" if package is picked up or in transit
                                if ((result.pickedUp || result.inTransit) && request.status === 'pending') {
                                    request.status = 'sent';
                                    request.sentDate = request.sentDate || new Date().toISOString();
                                    updated = true;
                                    console.log(`Package picked up/in transit for request ${request.id} - updating status to sent`);
                                }
                                
                                // Alert for delays
                                if (result.hasDelay && !shipment.delayAlerted) {
                                    shipment.delayAlerted = true;
                                    showApprovalStatus('warning', currentLanguage === 'en' ? 
                                        `âš ï¸ DELAY ALERT: Tracking ${shipment.trackingNumber} has a delay or exception. Status: ${result.status}` : 
                                        `âš ï¸ ALERTA DE RETRASO: El seguimiento ${shipment.trackingNumber} tiene un retraso o excepciÃ³n. Estado: ${result.status}`);
                                    updated = true;
                                }
                                
                                // Alert for duties/taxes due
                                if (result.hasDutiesDue && !shipment.dutiesAlerted) {
                                    shipment.dutiesAlerted = true;
                                    const dutiesMsg = result.dutiesAmount ? 
                                        (currentLanguage === 'en' ? 
                                            `ðŸ’° DUTIES/TAXES DUE: Tracking ${shipment.trackingNumber} requires payment of duties/taxes. Amount: ${result.dutiesAmount}. Status: ${result.status}` : 
                                            `ðŸ’° IMPUESTOS/ARANCELES PENDIENTES: El seguimiento ${shipment.trackingNumber} requiere pago de impuestos/aranceles. Monto: ${result.dutiesAmount}. Estado: ${result.status}`) :
                                        (currentLanguage === 'en' ? 
                                            `ðŸ’° DUTIES/TAXES DUE: Tracking ${shipment.trackingNumber} requires payment of duties/taxes. Status: ${result.status}` : 
                                            `ðŸ’° IMPUESTOS/ARANCELES PENDIENTES: El seguimiento ${shipment.trackingNumber} requiere pago de impuestos/aranceles. Estado: ${result.status}`);
                                    showApprovalStatus('warning', dutiesMsg);
                                    updated = true;
                                }
                                
                                // Mark duties as detected (for persistent alert)
                                if (result.hasDutiesDue) {
                                    shipment.upsHasDutiesDue = true;
                                    shipment.upsDutiesAmount = result.dutiesAmount || '';
                                }
                                
                                // Add small delay to avoid rate limiting
                                await new Promise(resolve => setTimeout(resolve, 500));
                            } catch (error) {
                                console.error(`Error checking tracking ${shipment.trackingNumber}:`, error);
                                // Store error status with more detail
                                const errorMsg = error.message || 'Error checking status';
                                shipment.upsStatus = `Error: ${errorMsg}`;
                                shipment.upsLastChecked = new Date().toISOString();
                                
                                // If it's a CORS or network error, provide helpful message
                                if (errorMsg.includes('CORS') || errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                                    console.warn('âš ï¸ CORS/Network error detected. The UPS API may require a proxy server. Check your proxy URL in Settings.');
                                }
                            }
                        }
                    }
                    
                    // Mark request as received only when ALL shipments are delivered
                    if (totalShipments > 0 && deliveredShipments === totalShipments && request.status !== 'received') {
                        request.status = 'received';
                        request.receivedDate = new Date().toISOString();
                        updated = true;
                        console.log(`All shipments delivered for request ${request.id} - updating status to received`);
                    }
                }
            }
            
            // Always save history even if no status changes (to save UPS status data)
            localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
            
            // Save tracking updates to Supabase if logged in
            // Always save tracking updates (not just when request status changes)
            // This ensures tracking status refreshes are persisted
            if (useSupabase && currentUser) {
                try {
                    for (const request of history) {
                        if (request.trackingShipments && request.trackingShipments.length > 0 && request.id) {
                            // Update request status if changed
                            if (updated && request.status) {
                                await supabase
                                    .from('canada_requests')
                                    .update({
                                        status: request.status,
                                        sent_date: request.sentDate,
                                        received_date: request.receivedDate
                                    })
                                    .eq('id', request.id)
                                    .eq('user_id', currentUser.id);
                            }
                            
                            // Always update tracking shipments (even if request status didn't change)
                            // This ensures tracking status refreshes are saved
                            for (const shipment of request.trackingShipments) {
                                if (shipment.trackingNumber) {
                                    await supabase
                                        .from('canada_tracking_shipments')
                                        .update({
                                            ups_status: shipment.upsStatus || null,
                                            ups_last_update: shipment.upsLastChecked || null,
                                            ups_has_duties_due: shipment.upsHasDutiesDue || false,
                                            ups_has_delay: shipment.upsHasDelay || false,
                                            ups_duties_paid: shipment.upsDutiesPaid || false,
                                            ups_duties_amount: shipment.upsDutiesAmount || null,
                                            ups_picked_up: shipment.upsPickedUp || false,
                                            ups_in_transit: shipment.upsInTransit || false,
                                            ups_last_location: shipment.upsLastLocation || null,
                                            ups_last_date: shipment.upsLastDate || null
                                        })
                                        .eq('request_id', request.id)
                                        .eq('tracking_number', shipment.trackingNumber);
                                }
                            }
                        }
                    }
                    console.log('Tracking updates saved to Supabase');
                } catch (error) {
                    console.error('Error saving tracking updates to Supabase:', error);
                }
            }
            
            // Always refresh Canada tab to show updated tracking status
            // Wait a moment for Supabase to propagate the changes, then refresh
            // Refresh even if tab isn't active so data is ready when user switches to it
            const canadaTab = document.getElementById('canadaTab');
            if (canadaTab) {
                // Small delay to ensure Supabase has processed the updates
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // If tab is active, refresh immediately
                if (canadaTab.classList.contains('active')) {
                    await loadCanadaHistory();
                    updateCanadaRequestSummary();
                } else {
                    // If tab is not active, refresh in background so data is ready
                    loadCanadaHistory().catch(err => console.error('Error refreshing Canada history:', err));
                }
            }
            
            // Check for duties/taxes alerts after tracking update
            checkForDutiesAlerts();
            
            if (updated) {
                // Show notification that updates were made
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    `Checked ${checked} tracking number(s). Status updated. The Canada tab has been refreshed.` : 
                    `Verificado(s) ${checked} nÃºmero(s) de seguimiento. Estado actualizado. La pestaÃ±a de CanadÃ¡ se ha actualizado.`);
            } else {
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    `Checked ${checked} tracking number(s). Tracking data refreshed. The Canada tab has been updated.` : 
                    `Verificado(s) ${checked} nÃºmero(s) de seguimiento. Datos de seguimiento actualizados. La pestaÃ±a de CanadÃ¡ se ha actualizado.`);
            }
            
            // Always check for duties alerts after tracking check
            checkForDutiesAlerts();
        }
        
        // Start automatic tracking polling
        let upsTrackingInterval = null;
        
        function startUPSTrackingPolling() {
            // Clear existing interval
            if (upsTrackingInterval) {
                clearInterval(upsTrackingInterval);
            }
            
            const clientId = localStorage.getItem('upsClientId');
            const clientSecret = localStorage.getItem('upsClientSecret');
            const intervalHours = parseInt(localStorage.getItem('upsCheckInterval')) || 6;
            
            if (!clientId || !clientSecret) {
                return; // Don't start polling without credentials
            }
            
            // Check immediately on load
            checkAllTrackingNumbers();
            
            // Set up interval (convert hours to milliseconds)
            const intervalMs = intervalHours * 60 * 60 * 1000;
            upsTrackingInterval = setInterval(() => {
                checkAllTrackingNumbers();
            }, intervalMs);
            
            console.log(`UPS tracking polling started - checking every ${intervalHours} hours`);
            
            // Check for duties alerts on startup
            checkForDutiesAlerts();
        }
        
        // Test UPS tracking
        async function testUPSTracking() {
            console.log('Test UPS Tracking button clicked');
            const clientId = document.getElementById('upsClientId').value.trim();
            const clientSecret = document.getElementById('upsClientSecret').value.trim();
            
            if (!clientId || !clientSecret) {
                console.log('Missing credentials');
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please enter UPS credentials first' : 
                    'Por favor ingresa las credenciales de UPS primero');
                return;
            }
            
            // Save settings first
            saveUPSSettings();
            
            try {
                // First, test OAuth token retrieval
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'Testing UPS OAuth connection...' : 
                    'Probando conexiÃ³n OAuth de UPS...');
                
                console.log('Getting UPS OAuth token...');
                const token = await getUPSToken();
                console.log('OAuth token received successfully');
                
                // Get a test tracking number from history if available
                const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
                let testTrackingNumber = null;
                
                console.log('Checking for tracking numbers in history, found', history.length, 'requests');
                
                for (const request of history) {
                    if (request.trackingShipments && request.trackingShipments.length > 0) {
                        for (const shipment of request.trackingShipments) {
                            if (shipment.trackingNumber && shipment.trackingNumber.trim()) {
                                testTrackingNumber = shipment.trackingNumber.trim();
                                console.log('Found tracking number:', testTrackingNumber);
                                break;
                            }
                        }
                        if (testTrackingNumber) break;
                    }
                }
                
                if (testTrackingNumber) {
                    // Test with actual tracking number
                    console.log('Testing with tracking number:', testTrackingNumber);
                    showApprovalStatus('info', currentLanguage === 'en' ? 
                        `Testing UPS tracking with ${testTrackingNumber}...` : 
                        `Probando seguimiento de UPS con ${testTrackingNumber}...`);
                    
                    const result = await checkUPSTracking(testTrackingNumber);
                    console.log('Tracking result:', result);
                    
                    showApprovalStatus('success', currentLanguage === 'en' ? 
                        `UPS connection successful! Status: ${result.status} (Delivered: ${result.delivered ? 'Yes' : 'No'})` : 
                        `Â¡ConexiÃ³n de UPS exitosa! Estado: ${result.status} (Entregado: ${result.delivered ? 'SÃ­' : 'No'})`);
                } else {
                    // Just confirm OAuth works
                    console.log('No tracking numbers found, showing OAuth success message');
                    const successMsg = currentLanguage === 'en' ? 
                        'UPS OAuth connection successful! Credentials are valid. Add a tracking number in the Canada tab to test full tracking.' : 
                        'Â¡ConexiÃ³n OAuth de UPS exitosa! Las credenciales son vÃ¡lidas. Agrega un nÃºmero de seguimiento en la pestaÃ±a de CanadÃ¡ para probar el seguimiento completo.';
                    console.log('Calling showApprovalStatus with message:', successMsg);
                    showApprovalStatus('success', successMsg);
                    console.log('showApprovalStatus called');
                }
            } catch (error) {
                console.error('UPS test error:', error);
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    `UPS connection failed: ${error.message}. Please check your credentials and make sure Tracking API is enabled in your UPS app.` : 
                    `ConexiÃ³n de UPS fallida: ${error.message}. Por favor verifica tus credenciales y asegÃºrate de que la API de Seguimiento estÃ© habilitada en tu aplicaciÃ³n de UPS.`);
            }
        }
        
        async function testDeepLConnection() {
            console.log('Test DeepL Connection button clicked');
            const apiKeyInput = document.getElementById('deeplApiKey');
            if (!apiKeyInput) {
                console.error('DeepL API key input field not found!');
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    'Error: DeepL API key field not found. Please refresh the page.' : 
                    'Error: Campo de clave API de DeepL no encontrado. Por favor actualiza la pÃ¡gina.');
                return;
            }
            
            const apiKey = apiKeyInput.value.trim();
            console.log('API key length:', apiKey.length);
            
            if (!apiKey) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please enter your DeepL API key first' : 
                    'Por favor ingresa tu clave API de DeepL primero');
                return;
            }
            
            // Save settings first
            saveDeepLSettings();
            
            try {
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'Testing DeepL connection...' : 
                    'Probando conexiÃ³n de DeepL...');
                
                // Test with a simple translation
                const testText = 'Hello';
                const formData = new URLSearchParams();
                formData.append('auth_key', apiKey);
                formData.append('text', testText);
                formData.append('source_lang', 'EN');
                formData.append('target_lang', 'ES');
                
                // Check if running from file:// and use CORS proxy if needed
                const isLocalFile = window.location.protocol === 'file:';
                let apiUrl = 'https://api-free.deepl.com/v2/translate';
                
                // Try direct API call first, then fallback to CORS proxy if needed
                let response;
                let data;
                let lastError = null;
                
                try {
                    // Direct API call
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`DeepL API error: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    
                    data = await response.json();
                } catch (directError) {
                    console.warn('Direct API call failed, trying CORS proxy:', directError);
                    lastError = directError;
                    
                    // Fallback to CORS proxy
                    try {
                        const proxyOptions = [
                            'https://corsproxy.io/?' + encodeURIComponent('https://api-free.deepl.com/v2/translate'),
                            'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api-free.deepl.com/v2/translate')
                        ];
                        
                        let proxySuccess = false;
                        for (const proxyUrl of proxyOptions) {
                            try {
                                response = await fetch(proxyUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: formData
                                });
                                
                                if (response.ok) {
                                    const responseText = await response.text();
                                    try {
                                        data = JSON.parse(responseText);
                                        proxySuccess = true;
                                        break;
                                    } catch (parseError) {
                                        console.warn('Failed to parse proxy response, trying next proxy...');
                                        continue;
                                    }
                                } else {
                                    const errorText = await response.text();
                                    console.warn(`Proxy returned error ${response.status}: ${errorText}`);
                                }
                            } catch (proxyError) {
                                console.warn('Proxy failed, trying next...', proxyError);
                                continue;
                            }
                        }
                        
                        if (!proxySuccess) {
                            throw lastError || new Error('All CORS proxy attempts failed');
                        }
                    } catch (proxyError) {
                        console.error('CORS proxy also failed:', proxyError);
                        throw lastError || proxyError;
                    }
                }
                
                // Validate response
                if (!data) {
                    throw new Error('No data received from DeepL API');
                }
                
                if (data.translations && data.translations.length > 0 && data.translations[0].text) {
                    const translated = data.translations[0].text;
                    showApprovalStatus('success', currentLanguage === 'en' ? 
                        `DeepL connection successful! Test translation: "Hello" â†’ "${translated}"` : 
                        `Â¡ConexiÃ³n de DeepL exitosa! TraducciÃ³n de prueba: "Hello" â†’ "${translated}"`);
                    console.log('DeepL test successful! Translation:', translated);
                } else {
                    console.error('Unexpected API response:', data);
                    throw new Error('No translation returned from DeepL API. Response: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('DeepL test error:', error);
                const errorMessage = error.message || 'Unknown error';
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    `DeepL connection failed: ${errorMessage}. Please check your API key and try again.` : 
                    `ConexiÃ³n de DeepL fallida: ${errorMessage}. Por favor verifica tu clave API e intenta de nuevo.`);
            }
        }
        
        async function testEmailJSConnection() {
            const publicKey = document.getElementById('emailjsPublicKey').value.trim();
            const serviceId = document.getElementById('emailjsServiceId').value.trim();
            const templateId = document.getElementById('emailjsTemplateId').value.trim();
            
            if (!publicKey || !serviceId || !templateId) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please fill in all EmailJS fields first' : 
                    'Por favor completa todos los campos de EmailJS primero');
                return;
            }
            
            // Save settings first
            saveEmailJSSettings();
            
            // Get test email from the email list
            const emailListInput = document.getElementById('saveClearEmailList').value || 'mike@oolab.com, accounting@oolab.com, graeme@oolab.com, consufis@gmail.com, josejuanpalafoxrodriguez@gmail.com';
            const emailList = emailListInput.split(',').map(email => email.trim()).filter(email => email);
            const testEmail = emailList[0] || 'test@example.com';
            
            try {
                emailjs.init(publicKey);
                
                const templateParams = {
                    to_email: testEmail,
                    subject: currentLanguage === 'en' ? 'EmailJS Test - Budget Manager' : 'Prueba de EmailJS - Gestor de Presupuesto',
                    message: currentLanguage === 'en' ? 
                        'This is a test email from your Budget Manager. If you receive this, EmailJS is configured correctly!' : 
                        'Este es un correo de prueba de tu Gestor de Presupuesto. Si recibes esto, Â¡EmailJS estÃ¡ configurado correctamente!',
                    week_label: 'Test Week',
                    total_budget: '$0.00 MXN',
                    total_items: '0',
                    pdf_attachment: '', // Empty for test
                    pdf_filename: 'test.pdf',
                    excel_attachment: '', // Empty for test
                    excel_filename: 'test.xlsx'
                };
                
                await emailjs.send(serviceId, templateId, templateParams);
                
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    `Test email sent successfully to ${testEmail}! Check your inbox.` : 
                    `Â¡Correo de prueba enviado exitosamente a ${testEmail}! Revisa tu bandeja de entrada.`);
                
                logActivity('email', `EmailJS test email sent to ${testEmail}`, null);
            } catch (error) {
                console.error('EmailJS test error:', error);
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    `EmailJS test failed: ${error.text || error.message || 'Unknown error'}. Please check your credentials and template configuration.` : 
                    `Prueba de EmailJS fallÃ³: ${error.text || error.message || 'Error desconocido'}. Por favor verifica tus credenciales y configuraciÃ³n de plantilla.`);
            }
        }
        
        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            const today = new Date();
            const weekLabel = getWeekLabel(today);
            const weekOfYear = getWeekOfYear(today);
            doc.setFontSize(18);
            doc.text(currentLanguage === 'en' ? 'Budget Report' : 'Reporte de Presupuesto', 14, 20);
            doc.setFontSize(12);
            doc.text(weekLabel, 14, 30);
            doc.text(currentLanguage === 'en' ? `Week ${weekOfYear} of ${today.getFullYear()}` : `Semana ${weekOfYear} de ${today.getFullYear()}`, 14, 37);
            doc.text(new Date().toLocaleDateString(), 14, 44);
            
            // Prepare table data
            const tableData = items.map(item => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const supplierName = typeof item.supplier === 'string' ? item.supplier : item.supplier.name;
                const priorityName = currentLanguage === 'en' ? 
                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja');
                const approvalStatus = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'rejected' ? 'Rejected' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'rejected' ? 'Rechazado' : 'Pendiente');
                const lastOrderedDate = getLastOrderedDate(item);
                
                // Display name: prefer current language, but fall back to other language if current is empty
                const displayNameForPDF = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                
                return [
                    displayNameForPDF,
                    categoryName,
                    supplierName,
                    `$${item.unitPrice.toLocaleString('es-MX')}`,
                    item.quantity,
                    `$${item.totalPrice.toLocaleString('es-MX')}`,
                    priorityName,
                    approvalStatus,
                    lastOrderedDate
                ];
            });
            
            // Add table
            doc.autoTable({
                head: [[
                    currentLanguage === 'en' ? 'Item' : 'ArtÃ­culo',
                    currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                    currentLanguage === 'en' ? 'Supplier' : 'Proveedor',
                    currentLanguage === 'en' ? 'Unit Price' : 'Precio Unitario',
                    currentLanguage === 'en' ? 'Qty' : 'Cant',
                    currentLanguage === 'en' ? 'Total' : 'Total',
                    currentLanguage === 'en' ? 'Priority' : 'Prioridad',
                    currentLanguage === 'en' ? 'Status' : 'Estado',
                    currentLanguage === 'en' ? 'Last Ordered' : 'Ãšltimo Pedido'
                ]],
                body: tableData,
                startY: 50,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [102, 126, 234] }
            });
            
            // Add summary
            const total = items.reduce((sum, item) => sum + item.totalPrice, 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(currentLanguage === 'en' ? `Total Budget: $${total.toLocaleString('es-MX')} MXN` : 
                `Presupuesto Total: $${total.toLocaleString('es-MX')} MXN`, 14, finalY);
            doc.text(currentLanguage === 'en' ? `Total Items: ${items.length}` : 
                `Total de ArtÃ­culos: ${items.length}`, 14, finalY + 7);
            
            return doc;
        }
        
        // Generate Excel as blob for email attachment
        function generateExcelBlob() {
            const wb = XLSX.utils.book_new();
            const today = new Date();
            const weekOfYear = getWeekOfYear(today);
            
            // Add header row with week info
            const excelData = [
                [currentLanguage === 'en' ? `Budget Report - Week ${weekOfYear} of ${today.getFullYear()}` : `Reporte de Presupuesto - Semana ${weekOfYear} de ${today.getFullYear()}`],
                [currentLanguage === 'en' ? `Generated: ${today.toLocaleDateString()}` : `Generado: ${today.toLocaleDateString()}`],
                [], // Empty row
                [
                    currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo',
                    currentLanguage === 'en' ? 'Description' : 'DescripciÃ³n',
                    currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                    currentLanguage === 'en' ? 'Supplier' : 'Proveedor',
                    currentLanguage === 'en' ? 'Unit Price (MXN)' : 'Precio Unitario (MXN)',
                    currentLanguage === 'en' ? 'Quantity' : 'Cantidad',
                    currentLanguage === 'en' ? 'Total Price (MXN)' : 'Precio Total (MXN)',
                    currentLanguage === 'en' ? 'Priority' : 'Prioridad',
                    currentLanguage === 'en' ? 'Approval Status' : 'Estado de AprobaciÃ³n',
                    currentLanguage === 'en' ? 'Last Ordered Date' : 'Fecha de Ãšltimo Pedido'
                ]
            ];
            
            items.forEach(item => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const supplierName = typeof item.supplier === 'string' ? item.supplier : item.supplier.name;
                const priorityName = currentLanguage === 'en' ? 
                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja');
                const approvalStatus = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'rejected' ? 'Rejected' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'rejected' ? 'Rechazado' : 'Pendiente');
                const lastOrderedDate = getLastOrderedDate(item);
                
                // Display name and description: prefer current language, but fall back to other language if current is empty
                const displayNameForExcel = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                const displayDescForExcel = currentLanguage === 'en' 
                    ? (item.descriptionEn || item.descriptionEs || item.description || '') 
                    : (item.descriptionEs || item.descriptionEn || item.description || '');
                
                excelData.push([
                    displayNameForExcel,
                    displayDescForExcel,
                    categoryName,
                    supplierName,
                    item.unitPrice || 0,
                    item.quantity,
                    item.totalPrice,
                    priorityName,
                    approvalStatus,
                    lastOrderedDate
                ]);
            });
            
            const total = items.reduce((sum, item) => sum + item.totalPrice, 0);
            excelData.push(['', '', '', '', '', '', 
                currentLanguage === 'en' ? 'TOTAL:' : 'TOTAL:', total, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'Budget');
            
            return XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        }
        
        // Generate PDF and Excel, then send emails
        async function generatePDFAndExcelForEmail(snapshot) {
            try {
                // Generate PDF
                const pdfDoc = generatePDF();
                const pdfBlob = pdfDoc.output('blob');
                const pdfData = new Uint8Array(await pdfBlob.arrayBuffer());
                
                // Generate Excel
                const excelData = generateExcelBlob();
                
                // Get email list (use default list if field is empty)
                const defaultEmails = 'mike@oolab.com, accounting@oolab.com, graeme@oolab.com, consufis@gmail.com, josejuanpalafoxrodriguez@gmail.com';
                const emailListInput = document.getElementById('saveClearEmailList').value || defaultEmails;
                const emailList = emailListInput.split(',').map(email => email.trim()).filter(email => email);
                
                if (emailList.length === 0) {
                    showApprovalStatus('warning', currentLanguage === 'en' ? 
                        'No email addresses configured. Please add emails in Email Settings.' : 
                        'No hay direcciones de correo configuradas. Por favor agrega correos en ConfiguraciÃ³n de Correo.');
                    // Still export files for download
                    exportToExcel();
                    pdfDoc.save(`budget-${snapshot.weekLabel.replace(/\s+/g, '-')}.pdf`);
                    return;
                }
                
                // Send emails with attachments
                sendBudgetEmail(emailList, pdfData, excelData, snapshot);
                
            } catch (error) {
                console.error('Error generating PDF/Excel for email:', error);
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    'Error generating files. Files will be downloaded instead.' : 
                    'Error al generar archivos. Los archivos se descargarÃ¡n en su lugar.');
                // Fallback: download files
                exportToExcel();
                const pdfDoc = generatePDF();
                pdfDoc.save(`budget-${snapshot.weekLabel.replace(/\s+/g, '-')}.pdf`);
            }
        }
        
        // Send email with PDF and Excel attachments
        async function sendBudgetEmail(emailList, pdfData, excelData, snapshot) {
            const today = new Date();
            const weekLabel = snapshot.weekLabel;
            const total = snapshot.total;
            const itemCount = snapshot.itemCount;
            
            // Also download files locally as backup
            exportToExcel();
            const pdfDoc = generatePDF();
            pdfDoc.save(`budget-${weekLabel.replace(/\s+/g, '-')}.pdf`);
            
            const budgetLink = window.location.href;
            const dateStr = today.toISOString().split('T')[0];
            const pdfFileName = `budget-${weekLabel.replace(/\s+/g, '-')}.pdf`;
            const excelFileName = `budget-export-${dateStr}.xlsx`;
            
            // Convert files to base64 for email attachment
            // Note: For large files, consider using a more efficient base64 conversion
            // Convert Uint8Array to base64 string
            let pdfBase64 = '';
            let excelBase64 = '';
            
            // More efficient base64 conversion for large files
            const chunkSize = 8192;
            for (let i = 0; i < pdfData.length; i += chunkSize) {
                const chunk = pdfData.slice(i, i + chunkSize);
                pdfBase64 += String.fromCharCode.apply(null, chunk);
            }
            pdfBase64 = btoa(pdfBase64);
            
            for (let i = 0; i < excelData.length; i += chunkSize) {
                const chunk = excelData.slice(i, i + chunkSize);
                excelBase64 += String.fromCharCode.apply(null, chunk);
            }
            excelBase64 = btoa(excelBase64);
            
            const emailSubject = `Budget Report - ${weekLabel}`;
            const emailBody = `Hello,

Please find the budget report for ${weekLabel} attached.

Budget Summary:
- Total Items: ${itemCount}
- Total Budget: $${total.toLocaleString('es-MX')} MXN

The PDF and Excel files are attached to this email.

Budget Link: ${budgetLink}

Thank you,
Budget Manager System`;
            
            // Check if EmailJS is configured
            const emailjsPublicKey = localStorage.getItem('emailjsPublicKey');
            const emailjsServiceId = localStorage.getItem('emailjsServiceId');
            const emailjsTemplateId = localStorage.getItem('emailjsTemplateId');
            
            if (emailjsPublicKey && emailjsServiceId && emailjsTemplateId) {
                // Use EmailJS to send emails with attachments
                try {
                    emailjs.init(emailjsPublicKey);
                    
                    // Send to each recipient
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const email of emailList) {
                        try {
                            const templateParams = {
                                to_email: email,
                                subject: emailSubject,
                                message: emailBody,
                                week_label: weekLabel,
                                total_budget: `$${total.toLocaleString('es-MX')} MXN`,
                                total_items: itemCount.toString(),
                                // EmailJS attachments: Pass base64 data and filenames
                                // Note: EmailJS browser SDK has limitations with attachments
                                // The template must be configured to use these parameter names
                                // Parameter names in template should be: pdf_attachment and excel_attachment (without curly braces)
                                pdf_attachment: pdfBase64,
                                pdf_filename: pdfFileName,
                                excel_attachment: excelBase64,
                                excel_filename: excelFileName
                            };
                            
                            // Log attachment data size for debugging
                            console.log(`Sending email to ${email} with attachments:`, {
                                pdf_size: pdfBase64.length,
                                excel_size: excelBase64.length,
                                pdf_filename: pdfFileName,
                                excel_filename: excelFileName
                            });
                            
                            await emailjs.send(emailjsServiceId, emailjsTemplateId, templateParams);
                            successCount++;
                            console.log(`Email sent successfully to ${email} with attachments`);
                        } catch (error) {
                            console.error(`Error sending email to ${email}:`, error);
                            errorCount++;
                        }
                    }
                    
                    if (successCount > 0) {
                        showApprovalStatus('success', currentLanguage === 'en' ? 
                            `Budget saved! Emails sent successfully to ${successCount} recipient(s)${errorCount > 0 ? ` (${errorCount} failed)` : ''}. PDF and Excel files attached automatically.` : 
                            `Â¡Presupuesto guardado! Correos enviados exitosamente a ${successCount} destinatario(s)${errorCount > 0 ? ` (${errorCount} fallaron)` : ''}. Archivos PDF y Excel adjuntados automÃ¡ticamente.`);
                    } else {
                        throw new Error('All emails failed to send');
                    }
                    
                    logActivity('email', `Budget report sent via EmailJS to ${emailList.join(', ')}`, null);
                    return;
                } catch (error) {
                    console.error('EmailJS error:', error);
                    showApprovalStatus('warning', currentLanguage === 'en' ? 
                        'EmailJS failed. Falling back to mailto. Please configure EmailJS for automatic attachments.' : 
                        'EmailJS fallÃ³. Usando mailto como respaldo. Por favor configura EmailJS para adjuntos automÃ¡ticos.');
                }
            }
            
            // Fallback: Use mailto (no attachments possible)
            const allRecipients = emailList.join(';');
            const mailtoLink = `mailto:${allRecipients}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.open(mailtoLink);
            
            showApprovalStatus('info', currentLanguage === 'en' ? 
                `Budget saved! Email opened. To enable automatic attachments, please configure EmailJS in Settings. Files downloaded: ${pdfFileName}, ${excelFileName}` : 
                `Â¡Presupuesto guardado! Correo abierto. Para habilitar adjuntos automÃ¡ticos, por favor configura EmailJS en ConfiguraciÃ³n. Archivos descargados: ${pdfFileName}, ${excelFileName}`);
            
            logActivity('email', `Budget report opened via mailto for ${emailList.join(', ')}`, null);
        }

        function exportToJSON() {
            const data = {
                items: items,
                total: items.reduce((sum, item) => sum + item.totalPrice, 0),
                exportDate: new Date().toISOString(),
                language: currentLanguage
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToExcel() {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel
            const excelData = [
                // Header row
                [
                    currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo',
                    currentLanguage === 'en' ? 'Description' : 'DescripciÃ³n',
                    currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                    currentLanguage === 'en' ? 'Supplier' : 'Proveedor',
                    currentLanguage === 'en' ? 'Unit Price (MXN)' : 'Precio Unitario (MXN)',
                    currentLanguage === 'en' ? 'Quantity' : 'Cantidad',
                    currentLanguage === 'en' ? 'Total Price (MXN)' : 'Precio Total (MXN)',
                    currentLanguage === 'en' ? 'Priority' : 'Prioridad',
                    currentLanguage === 'en' ? 'Approval Status' : 'Estado de AprobaciÃ³n',
                    currentLanguage === 'en' ? 'Approval Reason' : 'RazÃ³n de AprobaciÃ³n',
                    currentLanguage === 'en' ? 'Date Added' : 'Fecha Agregado'
                ]
            ];
            
            // Add item data
            items.forEach(item => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                
                const supplierName = typeof item.supplier === 'string' ? item.supplier : item.supplier.name;
                const priorityName = currentLanguage === 'en' ? 
                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja');
                
                const approvalStatus = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'rejected' ? 'Rejected' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'rejected' ? 'Rechazado' : 'Pendiente');
                
                excelData.push([
                    currentLanguage === 'en' ? item.nameEn : item.nameEs,
                    currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs,
                    categoryName,
                    supplierName,
                    item.unitPrice || 0,
                    item.quantity,
                    item.totalPrice,
                    priorityName,
                    approvalStatus,
                    item.approvalReason || '',
                    new Date(item.dateAdded).toLocaleDateString()
                ]);
            });
            
            // Add summary row
            const total = items.reduce((sum, item) => sum + item.totalPrice, 0);
            excelData.push([
                '', '', '', '', '', '',
                currentLanguage === 'en' ? 'TOTAL:' : 'TOTAL:',
                total,
                '', '', ''
            ]);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 20 }, // Item Name
                { wch: 30 }, // Description
                { wch: 15 }, // Category
                { wch: 20 }, // Supplier
                { wch: 15 }, // Unit Price
                { wch: 10 }, // Quantity
                { wch: 15 }, // Total Price
                { wch: 10 }, // Priority
                { wch: 15 }, // Approval Status
                { wch: 25 }, // Approval Reason
                { wch: 15 }  // Date Added
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'en' ? 'Budget Items' : 'ArtÃ­culos del Presupuesto');
            
            // Export file
            const fileName = `budget-export-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                'Budget exported to Excel successfully!' : 
                'Â¡Presupuesto exportado a Excel exitosamente!');
        }
        
        function exportAllItemsToExcel() {
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare header row with all fields needed for re-entry
            const headerRow = [
                'Item Name',
                'Description',
                'Category',
                'Supplier',
                'Supplier Phone',
                'Supplier Email',
                'Supplier Address',
                'Unit Price (MXN)',
                'Quantity',
                'Priority',
                'Pricing Type',
                'Notes',
                'For Canada',
                'Date Added'
            ];
            
            const allItemsData = [headerRow];
            
            // Collect all items from budget (including Canada items)
            items.forEach(item => {
                const categoryName = categories[item.category] ? 
                    (categories[item.category].nameEn || categories[item.category].nameEs || item.category) : 
                    item.category;
                
                const supplierName = typeof item.supplier === 'string' ? item.supplier : (item.supplier ? item.supplier.name : '');
                const supplierPhone = typeof item.supplier === 'object' && item.supplier ? (item.supplier.phone || '') : '';
                const supplierEmail = typeof item.supplier === 'object' && item.supplier ? (item.supplier.email || '') : '';
                const supplierAddress = typeof item.supplier === 'object' && item.supplier ? (item.supplier.address || '') : '';
                
                // Get item name - prefer current language, fallback to other, then old name field
                const itemName = item.nameEn || item.nameEs || item.name || '';
                const itemDescription = item.descriptionEn || item.descriptionEs || item.description || '';
                const itemNotes = item.notesEn || item.notesEs || item.notes || '';
                
                const priorityName = item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low';
                const pricingType = item.pricingType || (categories[item.category] ? categories[item.category].pricingType : 'fixed');
                
                allItemsData.push([
                    itemName,
                    itemDescription,
                    categoryName,
                    supplierName,
                    supplierPhone,
                    supplierEmail,
                    supplierAddress,
                    item.unitPrice || 0,
                    item.quantity || 1,
                    priorityName,
                    pricingType,
                    itemNotes,
                    item.forCanada ? 'Yes' : 'No',
                    item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : ''
                ]);
            });
            
            // Collect all items from category database
            Object.keys(itemDatabase).forEach(categoryKey => {
                const categoryItems = itemDatabase[categoryKey] || [];
                const categoryName = categories[categoryKey] ? 
                    (categories[categoryKey].nameEn || categories[categoryKey].nameEs || categoryKey) : 
                    categoryKey;
                
                categoryItems.forEach(item => {
                    // Skip if this item is already in the budget items (by ID)
                    if (items.some(budgetItem => budgetItem.id === item.id)) {
                        return;
                    }
                    
                    const supplierName = typeof item.supplier === 'string' ? item.supplier : (item.supplier ? item.supplier.name : '');
                    const supplierPhone = typeof item.supplier === 'object' && item.supplier ? (item.supplier.phone || '') : '';
                    const supplierEmail = typeof item.supplier === 'object' && item.supplier ? (item.supplier.email || '') : '';
                    const supplierAddress = typeof item.supplier === 'object' && item.supplier ? (item.supplier.address || '') : '';
                    
                    // Get item name - prefer current language, fallback to other, then old name field
                    const itemName = item.nameEn || item.nameEs || item.name || '';
                    const itemDescription = item.descriptionEn || item.descriptionEs || item.description || '';
                    const itemNotes = item.notesEn || item.notesEs || item.notes || '';
                    
                    const priorityName = item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low';
                    const pricingType = item.pricingType || (categories[categoryKey] ? categories[categoryKey].pricingType : 'fixed');
                    
                    allItemsData.push([
                        itemName,
                        itemDescription,
                        categoryName,
                        supplierName,
                        supplierPhone,
                        supplierEmail,
                        supplierAddress,
                        item.unitPrice || 0,
                        item.quantity || 1,
                        priorityName,
                        pricingType,
                        itemNotes,
                        item.forCanada ? 'Yes' : 'No',
                        item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : ''
                    ]);
                });
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(allItemsData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 25 }, // Item Name
                { wch: 35 }, // Description
                { wch: 20 }, // Category
                { wch: 25 }, // Supplier
                { wch: 18 }, // Supplier Phone
                { wch: 25 }, // Supplier Email
                { wch: 35 }, // Supplier Address
                { wch: 15 }, // Unit Price
                { wch: 10 }, // Quantity
                { wch: 10 }, // Priority
                { wch: 15 }, // Pricing Type
                { wch: 30 }, // Notes
                { wch: 12 }, // For Canada
                { wch: 15 }  // Date Added
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'All Items');
            
            // Export file
            const fileName = `all-items-export-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                `All items exported to Excel successfully! (${allItemsData.length - 1} items)` : 
                `Â¡Todos los artÃ­culos exportados a Excel exitosamente! (${allItemsData.length - 1} artÃ­culos)`);
        }

        function printBudget() {
            // Switch to Budget tab if not already there
            const budgetTab = document.getElementById('budgetTab');
            if (budgetTab && !budgetTab.classList.contains('active')) {
                switchTab('budget');
                // Wait a moment for tab to switch, then print
                setTimeout(() => {
                    window.print();
                }, 100);
            } else {
                window.print();
            }
        }
        
        // Function to print saved budget (if needed)
        function printSavedBudget(budgetId) {
            // This function can be called from saved budgets view
            // For now, just trigger print
            window.print();
        }
        
        function clearAllData() {
            // Double confirmation to prevent accidental deletion
            const confirmMessage1 = currentLanguage === 'en' 
                ? 'Are you absolutely sure you want to delete ALL items and categories? This cannot be undone!'
                : 'Â¿EstÃ¡s absolutamente seguro de que quieres eliminar TODOS los artÃ­culos y categorÃ­as? Â¡Esto no se puede deshacer!';
            
            const confirmMessage2 = currentLanguage === 'en'
                ? 'This will delete:\n- All budget items\n- All category items\n- All categories\n\nType "DELETE" to confirm:'
                : 'Esto eliminarÃ¡:\n- Todos los artÃ­culos del presupuesto\n- Todos los artÃ­culos de categorÃ­as\n- Todas las categorÃ­as\n\nEscribe "ELIMINAR" para confirmar:';
            
            if (!confirm(confirmMessage1)) {
                return;
            }
            
            const confirmation = prompt(confirmMessage2);
            const requiredText = currentLanguage === 'en' ? 'DELETE' : 'ELIMINAR';
            
            if (confirmation !== requiredText) {
                showApprovalStatus('error', currentLanguage === 'en' 
                    ? 'Clear cancelled. You must type "' + requiredText + '" to confirm.' 
                    : 'Limpieza cancelada. Debes escribir "' + requiredText + '" para confirmar.');
                return;
            }
            
            // Clear all data
            items = [];
            itemDatabase = {};
            categories = {};
            
            // Clear localStorage
            localStorage.removeItem('budgetItems');
            localStorage.removeItem('categoryItems');
            localStorage.removeItem('categories');
            
            // Clear any other related data
            localStorage.removeItem('pushedToNextWeek');
            localStorage.removeItem('savedBudgets');
            
            // Re-render everything
            renderBudgetItems();
            renderCategories();
            updateTotal();
            
            // Refresh category dropdowns
            populateCategoryDropdowns();
            
            // Switch to Budget tab
            switchTab('budget');
            
            showApprovalStatus('success', currentLanguage === 'en' 
                ? 'All items and categories have been cleared successfully!' 
                : 'Â¡Todos los artÃ­culos y categorÃ­as han sido eliminados exitosamente!');
            
            logActivity('system', currentLanguage === 'en' ? 'All data cleared' : 'Todos los datos eliminados', null);
        }

        // Category and Item Database
        let itemDatabase = JSON.parse(localStorage.getItem('categoryItems')) || {};

        async function saveCategoryItems() {
            // Always save to localStorage as backup
            localStorage.setItem('categoryItems', JSON.stringify(itemDatabase));
            
            // If using Supabase and user is logged in, save to database
            if (useSupabase && currentUser) {
                try {
                    // Save each category to Supabase
                    for (const [categoryKey, categoryData] of Object.entries(categories)) {
                        const categoryItems = itemDatabase[categoryKey] || [];
                        
                        const categoryRecord = {
                            user_id: currentUser.id,
                            category_key: categoryKey,
                            name_en: categoryData.nameEn,
                            name_es: categoryData.nameEs,
                            description_en: categoryData.descriptionEn,
                            description_es: categoryData.descriptionEs,
                            pricing_type: categoryData.pricingType || 'fixed',
                            recurring_weekly: categoryData.recurringWeekly || false,
                            recurring_monthly: categoryData.recurringMonthly || false,
                            monthly_day: categoryData.monthlyDay,
                            has_due_date: categoryData.hasDueDate || false,
                            due_date: categoryData.dueDate,
                            items: categoryItems
                        };
                        
                        // Upsert category
                        const { error } = await supabase
                            .from('custom_categories')
                            .upsert(categoryRecord, {
                                onConflict: 'user_id,category_key'
                            });
                        
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error('Error saving categories to Supabase:', error);
                    // Continue with localStorage only if Supabase fails
                }
            }
        }

        function exportCategoriesAndItems() {
            const data = {
                categories: categories,
                items: itemDatabase,
                settings: {
                    deeplApiKey: localStorage.getItem('deeplApiKey') || '',
                    emailjsPublicKey: localStorage.getItem('emailjsPublicKey') || '',
                    emailjsServiceId: localStorage.getItem('emailjsServiceId') || '',
                    emailjsTemplateId: localStorage.getItem('emailjsTemplateId') || '',
                    canadaEmailjsPublicKey: localStorage.getItem('canadaEmailjsPublicKey') || '',
                    canadaEmailjsServiceId: localStorage.getItem('canadaEmailjsServiceId') || '',
                    canadaEmailjsTemplateId: localStorage.getItem('canadaEmailjsTemplateId') || '',
                    upsClientId: localStorage.getItem('upsClientId') || '',
                    upsClientSecret: localStorage.getItem('upsClientSecret') || '',
                    upsCheckInterval: localStorage.getItem('upsCheckInterval') || '6'
                },
                // Include all data for complete backup
                canadaRequestHistory: JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]'),
                savedBudgets: JSON.parse(localStorage.getItem('savedBudgets') || '[]'),
                budgetItems: JSON.parse(localStorage.getItem('budgetItems') || '[]'),
                activityLog: JSON.parse(localStorage.getItem('activityLog') || '[]'),
                changeHistory: JSON.parse(localStorage.getItem('changeHistory') || '[]'),
                canadaSelectedItems: JSON.parse(localStorage.getItem('canadaSelectedItems') || '{}'),
                dismissedBackorders: JSON.parse(localStorage.getItem('dismissedBackorders') || '{}'),
                canadaRequestCounter: localStorage.getItem('canadaRequestCounter') || '0',
                exportDate: new Date().toISOString(),
                version: '1.2' // Updated version to indicate full backup
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-complete-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.innerHTML = '<strong style="color: #155724;">âœ“ Complete backup file downloaded successfully! Includes all data: categories, items, Canada requests, saved budgets, and more.</strong>';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.style.color = '#155724';
            statusDiv.style.display = 'block';
        }

        // Comprehensive backup function that includes all Supabase data
        async function exportCompleteBackupWithSupabase(silent = false) {
            console.log('ðŸ”µ Starting backup export...', { silent, useSupabase, currentUser: currentUser ? currentUser.email : 'not logged in' });
            const statusDiv = document.getElementById('backupStatus');
            if (!silent && statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.border = '1px solid #bee5eb';
                statusDiv.style.color = '#0c5460';
                statusDiv.innerHTML = '<strong>â³ Exporting complete backup with Supabase data... This may take a moment.</strong>';
            }
            
            try {
                const backupData = {
                    exportDate: new Date().toISOString(),
                    version: '2.0', // Version 2.0 includes Supabase data
                    exportSource: 'complete_with_supabase'
                };
                
                // 1. Get localStorage data (same as existing backup)
                backupData.categories = categories;
                backupData.items = itemDatabase;
                backupData.settings = {
                    deeplApiKey: localStorage.getItem('deeplApiKey') || '',
                    emailjsPublicKey: localStorage.getItem('emailjsPublicKey') || '',
                    emailjsServiceId: localStorage.getItem('emailjsServiceId') || '',
                    emailjsTemplateId: localStorage.getItem('emailjsTemplateId') || '',
                    canadaEmailjsPublicKey: localStorage.getItem('canadaEmailjsPublicKey') || '',
                    canadaEmailjsServiceId: localStorage.getItem('canadaEmailjsServiceId') || '',
                    canadaEmailjsTemplateId: localStorage.getItem('canadaEmailjsTemplateId') || '',
                    upsClientId: localStorage.getItem('upsClientId') || '',
                    upsClientSecret: localStorage.getItem('upsClientSecret') || '',
                    upsCheckInterval: localStorage.getItem('upsCheckInterval') || '6',
                    upsProxyUrl: localStorage.getItem('upsProxyUrl') || ''
                };
                backupData.canadaRequestHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                backupData.savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
                backupData.budgetItems = JSON.parse(localStorage.getItem('budgetItems') || '[]');
                backupData.activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
                backupData.changeHistory = JSON.parse(localStorage.getItem('changeHistory') || '[]');
                backupData.canadaSelectedItems = JSON.parse(localStorage.getItem('canadaSelectedItems') || '{}');
                backupData.dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders') || '{}');
                backupData.canadaRequestCounter = localStorage.getItem('canadaRequestCounter') || '0';
                
                // 2. Get Supabase data if user is logged in
                if (useSupabase && currentUser) {
                    console.log('ðŸ”µ Fetching Supabase data for user:', currentUser.email);
                    if (!silent && statusDiv) {
                        statusDiv.innerHTML = '<strong>â³ Fetching data from Supabase...</strong>';
                    }
                    
                    try {
                        // Get all Canada requests
                        console.log('ðŸ”µ Fetching Canada requests...');
                        const { data: requests, error: requestsError } = await supabase
                            .from('canada_requests')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('created_at', { ascending: false });
                        
                        if (requestsError) {
                            console.error('âŒ Error fetching requests:', requestsError);
                            throw requestsError;
                        }
                        backupData.supabaseRequests = requests || [];
                        console.log('âœ… Fetched', requests?.length || 0, 'Canada requests');
                        
                        // Get all tracking shipments
                        const requestIds = (requests || []).map(r => r.id);
                        if (requestIds.length > 0) {
                            const { data: tracking, error: trackingError } = await supabase
                                .from('canada_tracking_shipments')
                                .select('*')
                                .in('request_id', requestIds);
                            
                            if (trackingError) throw trackingError;
                            backupData.supabaseTrackingShipments = tracking || [];
                            
                            // Get request items
                            const { data: requestItems, error: itemsError } = await supabase
                                .from('canada_request_items')
                                .select('*')
                                .in('request_id', requestIds);
                            
                            if (itemsError) throw itemsError;
                            backupData.supabaseRequestItems = requestItems || [];
                            
                            // Get backorders
                            const { data: backorders, error: backordersError } = await supabase
                                .from('canada_backorders')
                                .select('*')
                                .in('request_id', requestIds);
                            
                            if (backordersError) throw backordersError;
                            backupData.supabaseBackorders = backorders || [];
                        }
                        
                        // Get budget items from Supabase
                        console.log('ðŸ”µ Fetching budget items...');
                        const { data: budgetItems, error: budgetError } = await supabase
                            .from('budget_items')
                            .select('*')
                            .eq('user_id', currentUser.id);
                        
                        if (budgetError) {
                            console.error('âŒ Error fetching budget items:', budgetError);
                            throw budgetError;
                        }
                        backupData.supabaseBudgetItems = budgetItems || [];
                        console.log('âœ… Fetched', budgetItems?.length || 0, 'budget items');
                        
                        // Get saved budgets
                        console.log('ðŸ”µ Fetching saved budgets...');
                        const { data: savedBudgets, error: savedError } = await supabase
                            .from('saved_budget_items')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('created_at', { ascending: false });
                        
                        if (savedError) {
                            console.error('âŒ Error fetching saved budgets:', savedError);
                            throw savedError;
                        }
                        backupData.supabaseSavedBudgets = savedBudgets || [];
                        console.log('âœ… Fetched', savedBudgets?.length || 0, 'saved budgets');
                        
                        // Get request counter
                        console.log('ðŸ”µ Fetching request counter...');
                        const { data: counter, error: counterError } = await supabase
                            .from('canada_request_counters')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .single();
                        
                        if (!counterError && counter) {
                            backupData.supabaseRequestCounter = counter;
                            console.log('âœ… Fetched request counter');
                        }
                        
                        backupData.supabaseDataIncluded = true;
                        backupData.supabaseUserEmail = currentUser.email;
                        console.log('âœ… Supabase data fetch complete');
                    } catch (supabaseError) {
                        console.error('âŒ Error fetching Supabase data:', supabaseError);
                        backupData.supabaseDataIncluded = false;
                        backupData.supabaseError = supabaseError.message;
                        // Continue with localStorage data even if Supabase fails
                    }
                } else {
                    console.log('âš ï¸ User not logged in - only localStorage data will be included');
                    backupData.supabaseDataIncluded = false;
                    backupData.supabaseNote = 'User not logged in - only localStorage data included';
                }
                
                // 3. Create and download backup file
                const jsonStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                
                // Try to use File System Access API to save to a specific folder (modern browsers)
                if ('showSaveFilePicker' in window) {
                    try {
                        // Include date and time in filename to avoid overwriting same-day backups
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_').slice(0, -5); // Format: YYYY-MM-DD_HH-MM-SS
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: `budget-full-backup-with-supabase-${timestamp}.json`,
                            types: [{
                                description: 'JSON Backup File',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        if (!silent && statusDiv) {
                            statusDiv.style.background = '#d4edda';
                            statusDiv.style.border = '1px solid #c3e6cb';
                            statusDiv.style.color = '#155724';
                            let message = '<strong>âœ“ Complete backup saved successfully!</strong><br>';
                            if (backupData.supabaseDataIncluded) {
                                message += `Included: localStorage data + Supabase data (${backupData.supabaseRequests?.length || 0} requests, ${backupData.supabaseTrackingShipments?.length || 0} tracking shipments)`;
                            } else {
                                message += 'Included: localStorage data (Supabase data not available - user not logged in)';
                            }
                            statusDiv.innerHTML = message;
                        }
                        console.log('âœ… Backup saved using File System Access API');
                        return;
                    } catch (saveError) {
                        // User cancelled or error - fall back to download
                        console.log('âš ï¸ File System Access API not available or cancelled, using download:', saveError);
                    }
                }
                
                // Fallback: Download file
                console.log('ðŸ”µ Downloading backup file...');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Include date and time in filename to avoid overwriting same-day backups
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_').slice(0, -5); // Format: YYYY-MM-DD_HH-MM-SS
                a.download = `budget-full-backup-with-supabase-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('âœ… Backup file downloaded');
                
                if (!silent && statusDiv) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.border = '1px solid #c3e6cb';
                    statusDiv.style.color = '#155724';
                    let message = '<strong>âœ“ Complete backup downloaded successfully!</strong><br>';
                    if (backupData.supabaseDataIncluded) {
                        message += `Included: localStorage data + Supabase data (${backupData.supabaseRequests?.length || 0} requests, ${backupData.supabaseTrackingShipments?.length || 0} tracking shipments).<br>`;
                    } else {
                        message += 'Included: localStorage data (Supabase data not available - user not logged in).<br>';
                    }
                    message += '<small>You can move this file to Desktop/Budget manager folder.</small>';
                    statusDiv.innerHTML = message;
                }
                        
            } catch (error) {
                console.error('âŒ Error creating backup:', error);
                if (!silent && statusDiv) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.border = '1px solid #f5c6cb';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `<strong>âœ— Error creating backup:</strong> ${error.message}`;
                }
                throw error; // Re-throw so caller knows it failed
            }
        }

        // Automatic backup functionality
        let autoBackupInterval = null;
        let lastBackupDate = null;

        function toggleAutoBackup() {
            const enabled = document.getElementById('autoBackupEnabled').checked;
            const frequency = document.getElementById('backupFrequency').value;
            
            localStorage.setItem('autoBackupEnabled', enabled ? 'true' : 'false');
            localStorage.setItem('backupFrequency', frequency);
            
            if (enabled) {
                startAutoBackup(frequency);
                showApprovalStatus('success', currentLanguage === 'en' ? 
                    `Automatic backup enabled (${frequency})` : 
                    `Respaldo automÃ¡tico habilitado (${frequency})`);
            } else {
                stopAutoBackup();
                showApprovalStatus('info', currentLanguage === 'en' ? 
                    'Automatic backup disabled' : 
                    'Respaldo automÃ¡tico deshabilitado');
            }
        }

        function updateAutoBackupSchedule() {
            const enabled = document.getElementById('autoBackupEnabled').checked;
            if (enabled) {
                const frequency = document.getElementById('backupFrequency').value;
                localStorage.setItem('backupFrequency', frequency);
                stopAutoBackup();
                startAutoBackup(frequency);
            }
        }

        function startAutoBackup(frequency) {
            stopAutoBackup(); // Clear any existing interval
            
            let intervalMs;
            switch(frequency) {
                case 'daily':
                    intervalMs = 24 * 60 * 60 * 1000; // 24 hours
                    break;
                case 'weekly':
                    intervalMs = 7 * 24 * 60 * 60 * 1000; // 7 days
                    break;
                case 'monthly':
                    intervalMs = 30 * 24 * 60 * 60 * 1000; // 30 days
                    break;
                default:
                    intervalMs = 24 * 60 * 60 * 1000;
            }
            
            // Check if backup is needed on load
            checkAndRunAutoBackup();
            
            // Set up interval
            autoBackupInterval = setInterval(() => {
                checkAndRunAutoBackup();
            }, intervalMs);
            
            console.log(`Automatic backup scheduled: ${frequency} (every ${intervalMs / 1000 / 60 / 60} hours)`);
        }

        function stopAutoBackup() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
                autoBackupInterval = null;
            }
        }

        async function checkAndRunAutoBackup() {
            const lastBackup = localStorage.getItem('lastAutoBackupDate');
            const frequency = localStorage.getItem('backupFrequency') || 'daily';
            const now = new Date();
            
            let shouldBackup = false;
            
            if (!lastBackup) {
                shouldBackup = true;
            } else {
                const lastBackupDate = new Date(lastBackup);
                const hoursSinceBackup = (now - lastBackupDate) / (1000 * 60 * 60);
                
                switch(frequency) {
                    case 'daily':
                        shouldBackup = hoursSinceBackup >= 24;
                        break;
                    case 'weekly':
                        shouldBackup = hoursSinceBackup >= 168; // 7 days
                        break;
                    case 'monthly':
                        shouldBackup = hoursSinceBackup >= 720; // 30 days
                        break;
                }
            }
            
            if (shouldBackup) {
                console.log('Running automatic backup...');
                try {
                    // Run backup silently (don't show status messages)
                    await exportCompleteBackupWithSupabase(true);
                    localStorage.setItem('lastAutoBackupDate', now.toISOString());
                    console.log('Automatic backup completed successfully');
                } catch (error) {
                    console.error('Automatic backup failed:', error);
                }
            }
        }

        // Initialize auto-backup on page load
        function initializeAutoBackup() {
            const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
            const frequency = localStorage.getItem('backupFrequency') || 'daily';
            
            if (document.getElementById('autoBackupEnabled')) {
                document.getElementById('autoBackupEnabled').checked = enabled;
            }
            if (document.getElementById('backupFrequency')) {
                document.getElementById('backupFrequency').value = frequency;
            }
            
            if (enabled) {
                startAutoBackup(frequency);
            }
        }

        // Helper function to import backup data (used by both import functions)
        function importBackupData(data, statusDiv) {
            try {
                if (data.categories && Object.keys(data.categories).length > 0) {
                    Object.assign(categories, data.categories);
                    localStorage.setItem('customCategories', JSON.stringify(categories));
                }
                
                if (data.items && Object.keys(data.items).length > 0) {
                    Object.keys(data.items).forEach(category => {
                        if (!itemDatabase[category]) {
                            itemDatabase[category] = [];
                        }
                        data.items[category].forEach(newItem => {
                            const exists = itemDatabase[category].some(existingItem => 
                                existingItem.nameEn === newItem.nameEn && 
                                existingItem.nameEs === newItem.nameEs
                            );
                            if (!exists) {
                                itemDatabase[category].push(newItem);
                            }
                        });
                    });
                    saveCategoryItems();
                }
                
                // Restore settings
                if (data.settings) {
                    if (data.settings.deeplApiKey) localStorage.setItem('deeplApiKey', data.settings.deeplApiKey);
                    if (data.settings.emailjsPublicKey) localStorage.setItem('emailjsPublicKey', data.settings.emailjsPublicKey);
                    if (data.settings.emailjsServiceId) localStorage.setItem('emailjsServiceId', data.settings.emailjsServiceId);
                    if (data.settings.emailjsTemplateId) localStorage.setItem('emailjsTemplateId', data.settings.emailjsTemplateId);
                    if (data.settings.canadaEmailjsPublicKey) localStorage.setItem('canadaEmailjsPublicKey', data.settings.canadaEmailjsPublicKey);
                    if (data.settings.canadaEmailjsServiceId) localStorage.setItem('canadaEmailjsServiceId', data.settings.canadaEmailjsServiceId);
                    if (data.settings.canadaEmailjsTemplateId) localStorage.setItem('canadaEmailjsTemplateId', data.settings.canadaEmailjsTemplateId);
                    if (data.settings.upsClientId) localStorage.setItem('upsClientId', data.settings.upsClientId);
                    if (data.settings.upsClientSecret) localStorage.setItem('upsClientSecret', data.settings.upsClientSecret);
                    if (data.settings.upsCheckInterval) localStorage.setItem('upsCheckInterval', data.settings.upsCheckInterval);
                    if (data.settings.upsProxyUrl) localStorage.setItem('upsProxyUrl', data.settings.upsProxyUrl);
                    
                    if (typeof loadDeepLSettings === 'function') loadDeepLSettings();
                    if (typeof loadEmailJSSettings === 'function') loadEmailJSSettings();
                    if (typeof loadCanadaEmailJSSettings === 'function') loadCanadaEmailJSSettings();
                    if (typeof loadUPSSettings === 'function') loadUPSSettings();
                }
                
                // Restore Canada request history
                if (data.canadaRequestHistory && Array.isArray(data.canadaRequestHistory) && data.canadaRequestHistory.length > 0) {
                    localStorage.setItem('canadaRequestHistory', JSON.stringify(data.canadaRequestHistory));
                }
                
                // Restore saved budgets
                if (data.savedBudgets && Array.isArray(data.savedBudgets) && data.savedBudgets.length > 0) {
                    // Ensure isPartialPayment field is preserved
                    const restoredBudgets = data.savedBudgets.map(budget => {
                        // Make sure isPartialPayment is set correctly
                        if (budget.weekLabel && budget.weekLabel.includes('Partial Payment')) {
                            budget.isPartialPayment = true;
                        }
                        return budget;
                    });
                    localStorage.setItem('savedBudgets', JSON.stringify(restoredBudgets));
                    console.log('Restored saved budgets:', restoredBudgets.length, 'Partial payments:', restoredBudgets.filter(b => b.isPartialPayment).length);
                }
                
                // Restore current budget items
                if (data.budgetItems && Array.isArray(data.budgetItems) && data.budgetItems.length > 0) {
                    localStorage.setItem('budgetItems', JSON.stringify(data.budgetItems));
                    items = data.budgetItems;
                }
                
                // Restore activity log
                if (data.activityLog && Array.isArray(data.activityLog) && data.activityLog.length > 0) {
                    localStorage.setItem('activityLog', JSON.stringify(data.activityLog));
                    activityLog = data.activityLog;
                }
                
                // Restore change history
                if (data.changeHistory && Array.isArray(data.changeHistory) && data.changeHistory.length > 0) {
                    localStorage.setItem('changeHistory', JSON.stringify(data.changeHistory));
                    changeHistory = data.changeHistory;
                }
                
                // Restore Mex/Can data
                if (data.mexcanRequestHistory && Array.isArray(data.mexcanRequestHistory)) {
                    localStorage.setItem('mexcanRequestHistory', JSON.stringify(data.mexcanRequestHistory));
                }
                if (data.mexcanSelectedItems && typeof data.mexcanSelectedItems === 'object') {
                    localStorage.setItem('mexcanSelectedItems', JSON.stringify(data.mexcanSelectedItems));
                }
                if (data.mexcanTrackingShipments && Array.isArray(data.mexcanTrackingShipments)) {
                    localStorage.setItem('mexcanTrackingShipments', JSON.stringify(data.mexcanTrackingShipments));
                }
                
                // Restore other data
                if (data.canadaSelectedItems) localStorage.setItem('canadaSelectedItems', JSON.stringify(data.canadaSelectedItems));
                if (data.dismissedBackorders) localStorage.setItem('dismissedBackorders', JSON.stringify(data.dismissedBackorders));
                if (data.canadaRequestCounter) localStorage.setItem('canadaRequestCounter', data.canadaRequestCounter);
                
                // Build success message
                let successMessage = '<strong style="color: #155724;">âœ“ Backup restored successfully!</strong><br>';
                successMessage += 'Restored: Categories, Items';
                if (data.canadaRequestHistory && data.canadaRequestHistory.length > 0) {
                    successMessage += `, ${data.canadaRequestHistory.length} Canada request(s)`;
                }
                if (data.activityLog && data.activityLog.length > 0) {
                    successMessage += `, ${data.activityLog.length} activity log entry/entries`;
                }
                if (data.changeHistory && data.changeHistory.length > 0) {
                    successMessage += `, ${data.changeHistory.length} change history entry/entries`;
                }
                if (data.savedBudgets && data.savedBudgets.length > 0) {
                    successMessage += `, ${data.savedBudgets.length} saved budget(s)`;
                }
                if (data.budgetItems && data.budgetItems.length > 0) {
                    successMessage += `, ${data.budgetItems.length} current budget item(s)`;
                }
                successMessage += '<br><small>You can now try logging in again. If you log in, data will be migrated to Supabase.</small>';
                
                if (statusDiv) {
                    statusDiv.innerHTML = successMessage;
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.border = '1px solid #c3e6cb';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.display = 'block';
                }
                
                console.log('Backup restored successfully!');
                
            } catch (error) {
                console.error('Error in importBackupData:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '<strong style="color: #e74c3c;">âœ— Error: ' + error.message + '</strong>';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.border = '1px solid #f5c6cb';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.display = 'block';
                }
            }
        }
        
        // Function to restore backup without login (accessible from login screen)
        function restoreBackupWithoutLogin(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const statusDiv = document.getElementById('restoreStatus');
                    
                    console.log('Restoring backup without login...', data);
                    
                    // Use the shared import logic but show status on login screen
                    importBackupData(data, statusDiv);
                    
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    const statusDiv = document.getElementById('restoreStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<strong style="color: #e74c3c;">âœ— Error restoring backup: ' + error.message + '</strong>';
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.border = '1px solid #f5c6cb';
                        statusDiv.style.color = '#721c24';
                        statusDiv.style.display = 'block';
                    }
                }
            };
            reader.readAsText(file);
        }
        
        function importCategoriesAndItems(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const statusDiv = document.getElementById('backupStatus');
                    
                    // Use the shared import function
                    importBackupData(data, statusDiv);
                    
                    // Refresh UI if we're in the app (not on login screen)
                    if (document.getElementById('mainContainer') && document.getElementById('mainContainer').style.display !== 'none') {
                        // Refresh UI elements
                        if (typeof populateCategoryDropdowns === 'function') populateCategoryDropdowns();
                        if (typeof loadCategoriesList === 'function') loadCategoriesList();
                        if (typeof renderBudgetItems === 'function') renderBudgetItems();
                        if (typeof updateTotal === 'function') updateTotal();
                        
                        // Refresh monitor and alerts displays if data was restored
                        if (data.activityLog && data.activityLog.length > 0) {
                            if (typeof refreshActivityLog === 'function') refreshActivityLog();
                        }
                        if (data.changeHistory && data.changeHistory.length > 0) {
                            if (typeof loadChangeHistory === 'function') loadChangeHistory();
                        }
                        if (typeof updateMonitorDashboard === 'function') updateMonitorDashboard();
                        
                        // Reload Canada history if it was restored
                        if (data.canadaRequestHistory && data.canadaRequestHistory.length > 0) {
                            if (typeof loadCanadaHistory === 'function') {
                                loadCanadaHistory().catch(err => console.error('Error loading Canada history:', err));
                            }
                        }
                    }
                    
                    // Handle Supabase migration if logged in (importBackupData already restored to localStorage)
                    if (useSupabase && currentUser) {
                        // Migrate Canada requests if present
                        if (data.canadaRequestHistory && Array.isArray(data.canadaRequestHistory) && data.canadaRequestHistory.length > 0) {
                            if (typeof migrateCanadaRequests === 'function') {
                                migrateCanadaRequests(data.canadaRequestHistory).catch(err => {
                                    console.error('Error migrating Canada requests:', err);
                                });
                            }
                        }
                        
                        // Migrate saved budgets if present
                        if (data.savedBudgets && Array.isArray(data.savedBudgets) && data.savedBudgets.length > 0) {
                            if (typeof migrateSavedBudgets === 'function') {
                                migrateSavedBudgets(data.savedBudgets).catch(err => {
                                    console.error('Error migrating saved budgets:', err);
                                });
                            }
                        }
                    }
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    const statusDiv = document.getElementById('backupStatus');
                    statusDiv.innerHTML = '<strong style="color: #721c24;">âœ— Error importing file: ' + error.message + '</strong>';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.border = '1px solid #f5c6cb';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }

        function loadCategoryItems() {
            const category = document.getElementById('categorySelect').value;
            const categoryItemsDiv = document.getElementById('categoryItems');
            
            if (!category) {
                categoryItemsDiv.style.display = 'none';
                return;
            }
            
            let categoryItems = itemDatabase[category] || [];
            
            // Filter out recurring weekly items (they're added automatically)
            // Check if category is recurring weekly
            const categoryIsRecurring = categories[category] && categories[category].recurringWeekly;
            
            if (categoryIsRecurring) {
                // If entire category is recurring, don't show any items (they're auto-added)
                categoryItems = [];
            } else {
                // Filter out individual items that are marked as recurring weekly
                categoryItems = categoryItems.filter(item => !item.recurringWeekly);
            }
            
            currentCategoryItems = categoryItems; // Store for filtering
            categoryItemsDiv.style.display = 'block';
            
            renderCategoryItems(categoryItems, category);
        }

        function renderCategoryItems(categoryItems, category) {
            const itemsListDiv = document.getElementById('itemsList');
            const enableNotesCheckbox = document.getElementById('enableNotesForCategoryItems');
            const notesEnabled = enableNotesCheckbox && enableNotesCheckbox.checked;
            
            // Check if category is recurring weekly
            const categoryIsRecurring = categories[category] && categories[category].recurringWeekly;
            
            if (categoryItems.length === 0) {
                let message = '<p data-en="No items available in this category." data-es="No hay artÃ­culos disponibles en esta categorÃ­a.">No items available in this category.</p>';
                if (categoryIsRecurring) {
                    message = '<p data-en="This category is set to recurring weekly. Items are automatically added each week and do not need to be manually added." data-es="Esta categorÃ­a estÃ¡ configurada como recurrente semanal. Los artÃ­culos se agregan automÃ¡ticamente cada semana y no necesitan agregarse manualmente.">This category is set to recurring weekly. Items are automatically added each week and do not need to be manually added.</p>';
                }
                itemsListDiv.innerHTML = message;
                updateLanguage();
                return;
            }
            
            // Add header with select all
            itemsHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="selectAll_${category}" onchange="toggleSelectAll('${category}')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span data-en="Select All" data-es="Seleccionar Todo">Select All</span>
                    </label>
                </div>
            `;
            
            categoryItems.forEach((item, index) => {
                const supplierName = typeof item.supplier === 'string' ? item.supplier : item.supplier.name;
                // Display name and description: prefer current language, but fall back to other language if current is empty
                const displayItemName = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                const displayItemDesc = currentLanguage === 'en' 
                    ? (item.descriptionEn || item.descriptionEs || item.description || '') 
                    : (item.descriptionEs || item.descriptionEn || item.description || '');
                
                itemsHTML += `
                    <div class="item-card">
                        <div class="item-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="item-checkbox" id="item_${category}_${index}" data-category="${category}" data-index="${index}" style="width: 18px; height: 18px; cursor: pointer;">
                                <div>
                                    <div class="item-name">${displayItemName}</div>
                                    <div class="item-description">${displayItemDesc}</div>
                                </div>
                            </div>
                        </div>
                        <div class="item-details">
                            <div class="detail-item">
                                <div class="detail-label" data-en="Unit Price" data-es="Precio Unitario">Unit Price</div>
                                <div class="detail-value">$${item.unitPrice.toLocaleString('es-MX')} MXN</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label" data-en="Priority" data-es="Prioridad">Priority</div>
                                <div class="detail-value priority-${item.priority}">${currentLanguage === 'en' ? 
                                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja')}</div>
                            </div>
                        </div>
                        <div class="supplier-info" style="margin-bottom: 4px;">
                            <span data-en="Supplier:" data-es="Proveedor:">Supplier:</span> ${supplierName}
                        </div>
                        <div class="quantity-priority">
                            <div class="form-group" style="margin: 0;">
                                <label data-en="Qty:" data-es="Cant:" style="font-size: 0.75rem; margin-bottom: 2px;">Qty:</label>
                                <input type="number" id="qty_${category}_${index}" min="1" value="1" style="width: 60px; padding: 4px 6px; font-size: 0.85rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label data-en="Priority:" data-es="Prioridad:" style="font-size: 0.75rem; margin-bottom: 2px;">Priority:</label>
                                <select id="priority_${category}_${index}" style="width: 70px; padding: 4px 6px; font-size: 0.85rem;">
                                    <option value="high" selected data-en="High" data-es="Alta">High</option>
                                    <option value="medium" data-en="Medium" data-es="Media">Medium</option>
                                    <option value="low" data-en="Low" data-es="Baja">Low</option>
                                </select>
                            </div>
                            ${categories[category] && categories[category].pricingType === 'flexible' ? `
                                <div class="form-group" style="margin: 0;">
                                    <label data-en="Price:" data-es="Precio:" style="font-size: 0.75rem; margin-bottom: 2px;">Price:</label>
                                    <input type="number" id="price_${category}_${index}" step="0.01" min="0" value="${item.unitPrice || ''}" placeholder="Price" style="width: 80px; padding: 4px 6px; font-size: 0.85rem;">
                                </div>
                            ` : ''}
                        </div>
                        <div class="notes-field-row" id="notesRow_${category}_${index}" style="display: ${notesEnabled ? 'block' : 'none'}; margin-top: 8px;">
                            <div class="form-group" style="margin: 0; width: 100%;">
                                <label data-en="Notes:" data-es="Notas:" style="font-size: 0.75rem; margin-bottom: 2px;">Notes:</label>
                                <textarea id="notes_${category}_${index}" rows="2" placeholder="What are you buying? (e.g., printer paper and pens)" style="width: 100%; padding: 6px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add footer with "Add to Budget" button
            itemsHTML += `
                <div style="display: flex; justify-content: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <button class="btn btn-success" onclick="addSelectedItemsToBudget('${category}')" style="padding: 12px 30px; font-size: 1rem; font-weight: 600;" data-en="Add to Budget" data-es="Agregar al Presupuesto">Add to Budget</button>
                </div>
            `;
            
            itemsListDiv.innerHTML = itemsHTML;
            updateLanguage();
        }

        function toggleNotesForCategoryItems() {
            const enableNotes = document.getElementById('enableNotesForCategoryItems').checked;
            const notesRows = document.querySelectorAll('.notes-field-row');
            notesRows.forEach(row => {
                row.style.display = enableNotes ? 'block' : 'none';
            });
            
            // If category items are already displayed, re-render them to show/hide notes fields
            const categorySelect = document.getElementById('categorySelect');
            if (categorySelect && categorySelect.value) {
                loadCategoryItems();
            }
        }

        function toggleSelectAll(category) {
            const selectAllCheckbox = document.getElementById(`selectAll_${category}`);
            const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function addSelectedItemsToBudget(category) {
            const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]:checked`);
            
            if (checkboxes.length === 0) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please select at least one item to add.' : 
                    'Por favor selecciona al menos un artÃ­culo para agregar.');
                return;
            }
            
            let itemsAdded = 0;
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-index'));
                addItemFromCategory(category, index, true); // Pass true to skip individual notifications
                itemsAdded++;
            });
            
            // Refresh display after adding all items
            renderBudgetItems();
            updateTotal();
            updateApprovalSummary();
            updateMonitorDashboard();
            
            // Uncheck all after adding
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            const selectAllCheckbox = document.getElementById(`selectAll_${category}`);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            // Uncheck the "Add Notes" checkbox and hide notes fields
            const enableNotesCheckbox = document.getElementById('enableNotesForCategoryItems');
            if (enableNotesCheckbox) {
                enableNotesCheckbox.checked = false;
                // Hide notes fields directly without re-rendering
                const notesRows = document.querySelectorAll('.notes-field-row');
                notesRows.forEach(row => {
                    row.style.display = 'none';
                });
            }
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                `${itemsAdded} item(s) added to budget successfully!` : 
                `Â¡${itemsAdded} artÃ­culo(s) agregado(s) al presupuesto exitosamente!`);
        }

        async function addItemFromCategory(category, index, silent = false) {
            // Get the displayed item name from the input element to find the correct item
            const qtyInput = document.getElementById(`qty_${category}_${index}`);
            const prioritySelect = document.getElementById(`priority_${category}_${index}`);
            const priceInput = document.getElementById(`price_${category}_${index}`);
            const notesInput = document.getElementById(`notes_${category}_${index}`);
            
            if (!qtyInput || !prioritySelect) {
                console.error('Input elements not found for category:', category, 'index:', index);
                return;
            }
            
            // Find the item by getting the name from the DOM (more reliable than index)
            const itemCard = qtyInput.closest('.item-card');
            let item = null;
            
            if (itemCard) {
                const itemNameElement = itemCard.querySelector('.item-name');
                if (itemNameElement) {
                    const displayedName = itemNameElement.textContent.trim();
                    // Find the item in the original array by matching the displayed name
                    const categoryItems = itemDatabase[category] || [];
                    item = categoryItems.find(catItem => {
                        const catItemName = currentLanguage === 'en' 
                            ? (catItem.nameEn || catItem.nameEs || catItem.name || '')
                            : (catItem.nameEs || catItem.nameEn || catItem.name || '');
                        return catItemName === displayedName;
                    });
                }
            }
            
            // Fallback to index-based lookup if name matching fails
            if (!item) {
                const categoryItems = itemDatabase[category] || [];
                item = categoryItems[index];
                console.warn('Could not find item by name, using index fallback. Category:', category, 'Index:', index);
            }
            
            if (!item) {
                console.error('Item not found! Category:', category, 'Index:', index);
                return;
            }
            
            const quantity = parseInt(qtyInput.value) || 1;
            const priority = prioritySelect.value;
            const itemNotes = notesInput ? notesInput.value.trim() : '';
            console.log(`Adding item from category - notes input: "${itemNotes}", currentLanguage: ${currentLanguage}`);
            // Store notes in the current language only (API will translate when switching languages)
            // Store original text in current language, leave other language empty for API translation
            const notesEn = itemNotes && currentLanguage === 'en' ? itemNotes : '';
            const notesEs = itemNotes && currentLanguage === 'es' ? itemNotes : '';
            console.log(`Storing notes - notesEn: "${notesEn}", notesEs: "${notesEs}"`);
            
            // Use custom price if category is flexible and price input exists and has a value, otherwise use item's default price
            let unitPrice;
            if (categories[category] && categories[category].pricingType === 'flexible' && priceInput) {
                const customPrice = parseFloat(priceInput.value);
                unitPrice = (!isNaN(customPrice) && customPrice > 0) ? customPrice : item.unitPrice;
            } else {
                unitPrice = item.unitPrice;
            }
            
            // For flexible cost items, if no price is provided, use 0 as default
            if (categories[category] && categories[category].pricingType === 'flexible' && (!unitPrice || isNaN(unitPrice))) {
                unitPrice = 0;
            }
            
            // Validate that we have a valid unit price
            if (isNaN(unitPrice) || unitPrice < 0) {
                alert(currentLanguage === 'en' ? 'Please enter a valid unit price' : 'Por favor ingresa un precio unitario vÃ¡lido');
                return;
            }
            
            // Check if item has adjustments and get the latest one
            let priceAdjustmentNote = null;
            if (item.adjustments && item.adjustments.length > 0) {
                const latestAdjustment = item.adjustments[item.adjustments.length - 1];
                const adjustmentDate = new Date(latestAdjustment.date).toLocaleDateString();
                const adjustmentAmount = latestAdjustment.difference;
                const adjustmentType = adjustmentAmount >= 0 ? 
                    (currentLanguage === 'en' ? 'added' : 'agregado') : 
                    (currentLanguage === 'en' ? 'subtracted' : 'restado');
                priceAdjustmentNote = currentLanguage === 'en' 
                    ? `Price adjusted: ${Math.abs(adjustmentAmount).toFixed(2)} MXN ${adjustmentType} on ${adjustmentDate} (from budget vs actual difference)`
                    : `Precio ajustado: ${Math.abs(adjustmentAmount).toFixed(2)} MXN ${adjustmentType} el ${adjustmentDate} (de diferencia presupuesto vs real)`;
            }
            
            const newItem = {
                id: Date.now(),
                nameEn: item.nameEn,
                nameEs: item.nameEs,
                descriptionEn: item.descriptionEn,
                descriptionEs: item.descriptionEs,
                category: category,
                unitPrice: unitPrice,
                quantity: quantity,
                totalPrice: unitPrice * quantity,
                priority: priority,
                invoicePhoto: null,
                notes: itemNotes, // Keep for backward compatibility
                notesEn: notesEn,
                notesEs: notesEs,
                supplier: item.supplier,
                priceAdjustmentNote: priceAdjustmentNote, // Store the adjustment note
                hasPriceAdjustment: priceAdjustmentNote !== null
            };
            
            // Apply automatic credit if item was in alerts
            applyAutomaticCreditIfInAlerts(newItem);
            
            console.log(`New item created with notes:`, {
                notes: newItem.notes,
                notesEn: newItem.notesEn,
                notesEs: newItem.notesEs
            });
            
            items.push(newItem);
            saveItems();
            
            if (!silent) {
                renderBudgetItems();
                updateTotal();
                
                // Reset inputs
                qtyInput.value = 1;
                prioritySelect.value = 'medium';
                if (priceInput) {
                    priceInput.value = ''; // Clear the price input after adding
                }
                if (notesInput) {
                    notesInput.value = ''; // Clear the notes input after adding
                }
                
                // Hide the category items section and reset category selection
                document.getElementById('categoryItems').style.display = 'none';
                document.getElementById('categorySelect').value = '';
            } else {
                // When adding multiple, just update totals at the end
                // Don't hide the category section so user can add more
                updateTotal();
            }
        }

        function loadManageCategoryItems() {
            const category = document.getElementById('manageCategorySelect').value;
            const manageCategoryItemsDiv = document.getElementById('manageCategoryItems');
            const manageItemsListDiv = document.getElementById('manageItemsList');
            
            if (!category) {
                manageCategoryItemsDiv.style.display = 'none';
                return;
            }
            
            const categoryItems = itemDatabase[category] || [];
            manageCategoryItemsDiv.style.display = 'block';
            
            if (categoryItems.length === 0) {
                manageItemsListDiv.innerHTML = '<p data-en="No items in this category." data-es="No hay artÃ­culos en esta categorÃ­a.">No items in this category.</p>';
                return;
            }
            
            let itemsHTML = '';
            categoryItems.forEach((item, index) => {
                const supplierName = typeof item.supplier === 'string' ? item.supplier : item.supplier.name;
                const supplierPhone = typeof item.supplier === 'object' && item.supplier.phone ? item.supplier.phone : '';
                const supplierEmail = typeof item.supplier === 'object' && item.supplier.email ? item.supplier.email : '';
                const supplierAddress = typeof item.supplier === 'object' && item.supplier.address ? item.supplier.address : '';
                
                // Display name and description: prefer current language, but fall back to other language if current is empty
                const displayItemName2 = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                const displayItemDesc2 = currentLanguage === 'en' 
                    ? (item.descriptionEn || item.descriptionEs || item.description || '') 
                    : (item.descriptionEs || item.descriptionEn || item.description || '');
                
                itemsHTML += `
                    <div class="item-card" 
                         draggable="true" 
                         data-category="${category}" 
                         data-index="${index}">
                        <div class="drag-handle" title="${currentLanguage === 'en' ? 'Drag to reorder' : 'Arrastrar para reordenar'}">â˜°</div>
                        <div class="item-header" style="margin-left: 30px;">
                            <div>
                                <div class="item-name">${displayItemName2}</div>
                                <div class="item-description">${displayItemDesc2}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-primary" onclick="editItem('${category}', ${index})" data-en="Edit" data-es="Editar">Edit</button>
                                <button class="btn btn-danger" onclick="removeItemFromCategory('${category}', ${index})" data-en="Remove" data-es="Eliminar">Remove</button>
                            </div>
                        </div>
                        <div class="item-details">
                            <div class="detail-item">
                                <div class="detail-label" data-en="Unit Price" data-es="Precio Unitario">Unit Price</div>
                                <div class="detail-value">$${item.unitPrice.toLocaleString('es-MX')} MXN</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label" data-en="Priority" data-es="Prioridad">Priority</div>
                                <div class="detail-value priority-${item.priority}">${currentLanguage === 'en' ? 
                                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja')}</div>
                            </div>
                        </div>
                        <div class="supplier-info">
                            <strong data-en="Supplier:" data-es="Proveedor:">Supplier:</strong> ${supplierName}
                            <div class="supplier-details">
                                ${supplierPhone ? `<div class="supplier-detail"><strong data-en="Phone:" data-es="TelÃ©fono:">Phone:</strong> ${supplierPhone}</div>` : ''}
                                ${supplierEmail ? `<div class="supplier-detail"><strong data-en="Email:" data-es="Correo:">Email:</strong> ${supplierEmail}</div>` : ''}
                                ${supplierAddress ? `<div class="supplier-detail"><strong data-en="Address:" data-es="DirecciÃ³n:">Address:</strong> ${supplierAddress}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            manageItemsListDiv.innerHTML = itemsHTML;
            
            // Attach drag and drop event listeners
            const itemCards = manageItemsListDiv.querySelectorAll('.item-card');
            itemCards.forEach(card => {
                card.addEventListener('dragstart', function(e) {
                    handleDragStart(e, this.dataset.category, parseInt(this.dataset.index));
                });
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', function(e) {
                    handleDrop(e, this.dataset.category, parseInt(this.dataset.index));
                });
            });
        }

        // Drag and Drop Functions
        let draggedElement = null;
        let draggedIndex = null;
        let draggedCategory = null;

        function handleDragStart(event, category, index) {
            // Don't start drag if clicking on a button
            const target = event.target;
            if (target.tagName === 'BUTTON' || target.closest('button')) {
                event.preventDefault();
                return false;
            }
            
            draggedElement = event.currentTarget;
            draggedIndex = parseInt(index);
            draggedCategory = category;
            draggedElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', '');
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('drag-over', 'drag-over-bottom');
            });
            draggedElement = null;
            draggedIndex = null;
            draggedCategory = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const targetCard = event.currentTarget;
            const rect = targetCard.getBoundingClientRect();
            const mouseY = event.clientY;
            const cardMiddle = rect.top + rect.height / 2;
            
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            if (mouseY < cardMiddle) {
                targetCard.classList.add('drag-over');
            } else {
                targetCard.classList.add('drag-over-bottom');
            }
        }

        function handleDragLeave(event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                event.currentTarget.classList.remove('drag-over', 'drag-over-bottom');
            }
        }

        function handleDrop(event, category, index) {
            event.preventDefault();
            event.stopPropagation();
            
            const targetIndex = parseInt(index);
            
            if (!draggedElement || !draggedCategory || draggedIndex === null || draggedIndex === undefined) {
                document.querySelectorAll('.item-card').forEach(card => {
                    card.classList.remove('drag-over', 'drag-over-bottom');
                });
                return;
            }
            
            if (draggedCategory !== category || draggedIndex === targetIndex) {
                document.querySelectorAll('.item-card').forEach(card => {
                    card.classList.remove('drag-over', 'drag-over-bottom');
                });
                return;
            }
            
            const items = itemDatabase[category];
            if (!items || !items[draggedIndex]) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const mouseY = event.clientY;
            const cardMiddle = rect.top + rect.height / 2;
            
            let newIndex = targetIndex;
            if (mouseY < cardMiddle && draggedIndex > targetIndex) {
                newIndex = targetIndex;
            } else if (mouseY >= cardMiddle && draggedIndex < targetIndex) {
                newIndex = targetIndex + 1;
            } else if (mouseY < cardMiddle && draggedIndex < targetIndex) {
                newIndex = targetIndex;
            } else if (mouseY >= cardMiddle && draggedIndex > targetIndex) {
                newIndex = targetIndex + 1;
            }
            
            if (newIndex < 0) newIndex = 0;
            if (newIndex > items.length) newIndex = items.length;
            
            const draggedItem = items.splice(draggedIndex, 1)[0];
            
            if (draggedIndex < newIndex) {
                newIndex--;
            }
            
            items.splice(newIndex, 0, draggedItem);
            
            saveCategoryItems();
            loadManageCategoryItems();
            
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('drag-over', 'drag-over-bottom');
            });
        }

        function removeItemFromCategory(category, index) {
            if (confirm(currentLanguage === 'en' ? 'Are you sure you want to remove this item from the category?' : 'Â¿EstÃ¡s seguro de que quieres eliminar este artÃ­culo de la categorÃ­a?')) {
                itemDatabase[category].splice(index, 1);
                saveCategoryItems();
                loadManageCategoryItems();
            }
        }

        function editBudgetItemForReceipt(itemIndex) {
            const item = items[itemIndex];
            if (!item) return;
            
            // Create a temporary editing context for budget items
            editingItem = { isBudgetItem: true, itemIndex: itemIndex };
            
            // Populate edit form
            document.getElementById('editNameEn').value = item.nameEn;
            document.getElementById('editNameEs').value = item.nameEs;
            document.getElementById('editDescriptionEn').value = item.descriptionEn || '';
            document.getElementById('editDescriptionEs').value = item.descriptionEs || '';
            document.getElementById('editCategory').value = item.category;
            document.getElementById('editUnitPrice').value = item.unitPrice;
            document.getElementById('editPriority').value = item.priority || 'medium';
            
            // Handle supplier data (both old string format and new object format)
            if (typeof item.supplier === 'string') {
                document.getElementById('editSupplierName').value = item.supplier;
                document.getElementById('editSupplierPhone').value = '';
                document.getElementById('editSupplierEmail').value = '';
                document.getElementById('editSupplierAddress').value = '';
            } else {
                document.getElementById('editSupplierName').value = item.supplier?.name || '';
                document.getElementById('editSupplierPhone').value = item.supplier?.phone || '';
                document.getElementById('editSupplierEmail').value = item.supplier?.email || '';
                document.getElementById('editSupplierAddress').value = item.supplier?.address || '';
            }
            
            // Handle photo
            const photoPreview = document.getElementById('editPhotoPreview');
            if (item.invoicePhoto) {
                photoPreview.src = item.invoicePhoto;
                photoPreview.classList.add('show');
                document.getElementById('editReceiptAmountRow').style.display = 'block';
            } else {
                photoPreview.classList.remove('show');
                document.getElementById('editReceiptAmountRow').style.display = 'none';
            }
            window.editPhotoData = item.invoicePhoto || null;
            
            // Handle receipt amount
            if (item.receiptAmount) {
                document.getElementById('editReceiptAmount').value = item.receiptAmount;
            } else {
                document.getElementById('editReceiptAmount').value = '';
            }
            
            // Handle recurring options
            document.getElementById('editRecurringWeekly').checked = item.recurringWeekly || false;
            document.getElementById('editRecurringMonthly').checked = item.recurringMonthly || false;
            document.getElementById('editHasDueDate').checked = item.hasDueDate || false;
            
            // Handle forCanada and forMexico checkboxes
            if (document.getElementById('editItemForCanada')) {
                document.getElementById('editItemForCanada').checked = item.forCanada || false;
            }
            if (document.getElementById('editItemForMexico')) {
                document.getElementById('editItemForMexico').checked = item.forMexico || false;
            }
            
            // Populate monthly day dropdown if not already populated
            const editMonthlyDaySelect = document.getElementById('editMonthlyDay');
            if (editMonthlyDaySelect.options.length <= 1) {
                editMonthlyDaySelect.innerHTML = '<option value="">Select day...</option>';
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    editMonthlyDaySelect.appendChild(option);
                }
            }
            
            if (item.recurringMonthly && item.monthlyDay) {
                document.getElementById('editMonthlyDay').value = item.monthlyDay;
                document.getElementById('editMonthlyDayRow').style.display = 'block';
            } else {
                document.getElementById('editMonthlyDay').value = '';
                document.getElementById('editMonthlyDayRow').style.display = 'none';
            }
            
            if (item.hasDueDate && item.dueDate) {
                document.getElementById('editDueDate').value = item.dueDate;
                document.getElementById('editDueDateRow').style.display = 'block';
            } else {
                document.getElementById('editDueDate').value = '';
                document.getElementById('editDueDateRow').style.display = 'none';
            }
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        function editItem(category, index) {
            const item = itemDatabase[category][index];
            editingItem = { category, index };
            
            // Populate edit form
            document.getElementById('editNameEn').value = item.nameEn;
            document.getElementById('editNameEs').value = item.nameEs;
            document.getElementById('editDescriptionEn').value = item.descriptionEn || '';
            document.getElementById('editDescriptionEs').value = item.descriptionEs || '';
            document.getElementById('editCategory').value = category;
            document.getElementById('editUnitPrice').value = item.unitPrice;
            document.getElementById('editPriority').value = item.priority;
            
            // Handle supplier data (both old string format and new object format)
            if (typeof item.supplier === 'string') {
                document.getElementById('editSupplierName').value = item.supplier;
                document.getElementById('editSupplierPhone').value = '';
                document.getElementById('editSupplierEmail').value = '';
                document.getElementById('editSupplierAddress').value = '';
            } else {
                document.getElementById('editSupplierName').value = item.supplier.name || '';
                document.getElementById('editSupplierPhone').value = item.supplier.phone || '';
                document.getElementById('editSupplierEmail').value = item.supplier.email || '';
                document.getElementById('editSupplierAddress').value = item.supplier.address || '';
            }
            
            // Handle photo
            const photoPreview = document.getElementById('editPhotoPreview');
            if (item.invoicePhoto) {
                photoPreview.src = item.invoicePhoto;
                photoPreview.classList.add('show');
                document.getElementById('editReceiptAmountRow').style.display = 'block';
            } else {
                photoPreview.classList.remove('show');
                document.getElementById('editReceiptAmountRow').style.display = 'none';
            }
            window.editPhotoData = item.invoicePhoto || null;
            
            // Handle receipt amount
            if (item.receiptAmount) {
                document.getElementById('editReceiptAmount').value = item.receiptAmount;
            } else {
                document.getElementById('editReceiptAmount').value = '';
            }
            
            // Handle recurring options
            document.getElementById('editRecurringWeekly').checked = item.recurringWeekly || false;
            document.getElementById('editRecurringMonthly').checked = item.recurringMonthly || false;
            document.getElementById('editHasDueDate').checked = item.hasDueDate || false;
            
            // Populate monthly day dropdown if not already populated
            const editMonthlyDaySelect = document.getElementById('editMonthlyDay');
            if (editMonthlyDaySelect.options.length <= 1) {
                editMonthlyDaySelect.innerHTML = '<option value="">Select day...</option>';
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    editMonthlyDaySelect.appendChild(option);
                }
            }
            
            if (item.recurringMonthly && item.monthlyDay) {
                document.getElementById('editMonthlyDay').value = item.monthlyDay;
                document.getElementById('editMonthlyDayRow').style.display = 'block';
            } else {
                document.getElementById('editMonthlyDay').value = '';
                document.getElementById('editMonthlyDayRow').style.display = 'none';
            }
            
            if (item.hasDueDate && item.dueDate) {
                document.getElementById('editDueDate').value = item.dueDate;
                document.getElementById('editDueDateRow').style.display = 'block';
            } else {
                document.getElementById('editDueDate').value = '';
                document.getElementById('editDueDateRow').style.display = 'none';
            }
            
            // Handle forCanada and forMexico checkboxes
            if (document.getElementById('editItemForCanada')) {
                document.getElementById('editItemForCanada').checked = item.forCanada || false;
            }
            if (document.getElementById('editItemForMexico')) {
                document.getElementById('editItemForMexico').checked = item.forMexico || false;
            }
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingItem = null;
            // Reset recurring fields
            document.getElementById('editRecurringWeekly').checked = false;
            document.getElementById('editRecurringMonthly').checked = false;
            document.getElementById('editMonthlyDay').value = '';
            document.getElementById('editMonthlyDayRow').style.display = 'none';
            document.getElementById('editHasDueDate').checked = false;
            document.getElementById('editDueDate').value = '';
            document.getElementById('editDueDateRow').style.display = 'none';
            document.getElementById('editReceiptAmount').value = '';
            document.getElementById('editReceiptAmountRow').style.display = 'none';
        }

        function saveEditedItem(event) {
            event.preventDefault();
            
            if (!editingItem) return;
            
            // Handle budget items differently from category items
            if (editingItem.isBudgetItem) {
                const item = items[editingItem.itemIndex];
                if (!item) return;
                
                // Update item with new data
                item.nameEn = document.getElementById('editNameEn').value;
                item.nameEs = document.getElementById('editNameEs').value;
                item.descriptionEn = document.getElementById('editDescriptionEn').value;
                item.descriptionEs = document.getElementById('editDescriptionEs').value;
                item.unitPrice = parseFloat(document.getElementById('editUnitPrice').value);
                item.priority = document.getElementById('editPriority').value;
                
                // Update photo if changed
                if (window.editPhotoData !== undefined) {
                    item.invoicePhoto = window.editPhotoData;
                    if (window.editFileName) item.invoiceFileName = window.editFileName;
                    if (window.editFileType) item.invoiceFileType = window.editFileType;
                }
                
                // Update receipt amount
                const editReceiptAmount = document.getElementById('editReceiptAmount').value ? parseFloat(document.getElementById('editReceiptAmount').value) : null;
                item.receiptAmount = editReceiptAmount;
                
                // Remove from alerts tracking if receipt was added
                removeItemFromAlertsTracking(item);
                
                // Update supplier
                item.supplier = {
                    name: document.getElementById('editSupplierName').value,
                    phone: document.getElementById('editSupplierPhone').value,
                    email: document.getElementById('editSupplierEmail').value,
                    address: document.getElementById('editSupplierAddress').value
                };
                
                // Update recurring options
                item.recurringWeekly = document.getElementById('editRecurringWeekly').checked;
                item.recurringMonthly = document.getElementById('editRecurringMonthly').checked;
                item.monthlyDay = item.recurringMonthly ? parseInt(document.getElementById('editMonthlyDay').value) : null;
                item.hasDueDate = document.getElementById('editHasDueDate').checked;
                item.dueDate = item.hasDueDate ? document.getElementById('editDueDate').value : null;
                
                // Update forCanada and forMexico flags
                item.forCanada = document.getElementById('editItemForCanada') ? document.getElementById('editItemForCanada').checked : false;
                item.forMexico = document.getElementById('editItemForMexico') ? document.getElementById('editItemForMexico').checked : false;
                
                // Recalculate total price
                item.totalPrice = item.unitPrice * item.quantity;
                
                saveItems();
                closeEditModal();
                renderBudgetItems();
                updateTotal();
                updateApprovalSummary();
                updateMonitorDashboard();
                
                // Refresh alerts if on alerts tab
                if (document.getElementById('alertsTab') && document.getElementById('alertsTab').classList.contains('active')) {
                    loadMissingReceipts();
                    calculateBudgetVsActual();
                }
                
                alert(currentLanguage === 'en' ? 'Item updated successfully' : 'ArtÃ­culo actualizado exitosamente');
                return;
            }
            
            const { category, index } = editingItem;
            const item = itemDatabase[category][index];
            
            // Update item with new data
            item.nameEn = document.getElementById('editNameEn').value;
            item.nameEs = document.getElementById('editNameEs').value;
            item.descriptionEn = document.getElementById('editDescriptionEn').value;
            item.descriptionEs = document.getElementById('editDescriptionEs').value;
            item.unitPrice = parseFloat(document.getElementById('editUnitPrice').value);
            item.priority = document.getElementById('editPriority').value;
            
            // Update photo if changed
            if (window.editPhotoData !== undefined) {
                item.invoicePhoto = window.editPhotoData;
            }
            
            // Update receipt amount
            const editReceiptAmount = document.getElementById('editReceiptAmount').value ? parseFloat(document.getElementById('editReceiptAmount').value) : null;
            item.receiptAmount = editReceiptAmount;
            
            // Update supplier
            item.supplier = {
                name: document.getElementById('editSupplierName').value,
                phone: document.getElementById('editSupplierPhone').value,
                email: document.getElementById('editSupplierEmail').value,
                address: document.getElementById('editSupplierAddress').value
            };
            
            // Update recurring options
            item.recurringWeekly = document.getElementById('editRecurringWeekly').checked;
            item.recurringMonthly = document.getElementById('editRecurringMonthly').checked;
            item.monthlyDay = item.recurringMonthly ? parseInt(document.getElementById('editMonthlyDay').value) : null;
            item.hasDueDate = document.getElementById('editHasDueDate').checked;
            
            // Update forCanada and forMexico flags
            item.forCanada = document.getElementById('editItemForCanada') ? document.getElementById('editItemForCanada').checked : false;
            item.forMexico = document.getElementById('editItemForMexico') ? document.getElementById('editItemForMexico').checked : false;
            item.dueDate = item.hasDueDate ? document.getElementById('editDueDate').value : null;
            
            // If category changed, move item to new category
            const newCategory = document.getElementById('editCategory').value;
            if (newCategory !== category) {
                itemDatabase[category].splice(index, 1);
                if (!itemDatabase[newCategory]) {
                    itemDatabase[newCategory] = [];
                }
                itemDatabase[newCategory].push(item);
            }
            
            saveCategoryItems();
            loadManageCategoryItems();
            closeEditModal();
            
            alert(currentLanguage === 'en' ? 'Item updated successfully' : 'ArtÃ­culo actualizado exitosamente');
        }

        // Categories Management
        let categories = JSON.parse(localStorage.getItem('customCategories')) || {};

        function toggleRecurringWeekly() {
            const checkbox = document.getElementById('newCategoryRecurringWeekly');
            const dueDateCheckbox = document.getElementById('newCategoryHasDueDate');
            // If recurring weekly is checked, uncheck due date (they're mutually exclusive)
            if (checkbox.checked && dueDateCheckbox.checked) {
                dueDateCheckbox.checked = false;
                toggleDueDate();
            }
        }

        function toggleDueDate() {
            const checkbox = document.getElementById('newCategoryHasDueDate');
            const dueDateRow = document.getElementById('dueDateRow');
            const recurringCheckbox = document.getElementById('newCategoryRecurringWeekly');
            
            if (checkbox.checked) {
                dueDateRow.style.display = 'block';
                // If due date is checked, uncheck recurring weekly (they're mutually exclusive)
                if (recurringCheckbox.checked) {
                    recurringCheckbox.checked = false;
                }
            } else {
                dueDateRow.style.display = 'none';
                document.getElementById('newCategoryDueDate').value = '';
            }
        }

        async function addNewCategory() {
            const nameEn = document.getElementById('newCategoryNameEn').value.trim();
            const nameEs = document.getElementById('newCategoryNameEs').value.trim();
            const description = document.getElementById('newCategoryDescription').value.trim();
            const pricingType = document.getElementById('newCategoryPricingType').value;
            
            // Allow entering in one language - the other will be auto-translated
            if (!nameEn && !nameEs) {
                alert(currentLanguage === 'en' ? 'Please enter a category name' : 'Por favor ingresa un nombre de categorÃ­a');
                return;
            }
            
            // Store based on which field was actually filled
            // If user typed in English field, store in nameEn
            // If user typed in Spanish field, store in nameEs
            // If both are entered, use both
            let finalNameEn = '';
            let finalNameEs = '';
            
            if (nameEn && !nameEs) {
                // Only English field was filled - store in English, leave Spanish empty for translation
                finalNameEn = nameEn;
                finalNameEs = '';
            } else if (nameEs && !nameEn) {
                // Only Spanish field was filled - store in Spanish, leave English empty for translation
                finalNameEn = '';
                finalNameEs = nameEs;
            } else if (nameEn && nameEs) {
                // Both fields filled - use both as-is
                finalNameEn = nameEn;
                finalNameEs = nameEs;
            } else {
                // Neither field filled - this should have been caught by validation, but handle it
                finalNameEn = '';
                finalNameEs = '';
            }
            
            // Store description in current language only (API will translate when switching languages)
            const descriptionEn = description && currentLanguage === 'en' ? description : '';
            const descriptionEs = description && currentLanguage === 'es' ? description : '';
            
            const categoryKey = (finalNameEn || finalNameEs).toLowerCase().replace(/\s+/g, '_');
            const recurringWeekly = document.getElementById('newCategoryRecurringWeekly').checked;
            const hasDueDate = document.getElementById('newCategoryHasDueDate').checked;
            const dueDate = hasDueDate ? document.getElementById('newCategoryDueDate').value : null;
            
            categories[categoryKey] = {
                nameEn: finalNameEn,
                nameEs: finalNameEs,
                description: description, // Keep for backward compatibility
                descriptionEn: descriptionEn,
                descriptionEs: descriptionEs,
                pricingType: pricingType,
                recurringWeekly: recurringWeekly,
                hasDueDate: hasDueDate,
                dueDate: dueDate
            };
            
            // Initialize empty category in item database
            if (!itemDatabase[categoryKey]) {
                itemDatabase[categoryKey] = [];
            }
            
            localStorage.setItem('customCategories', JSON.stringify(categories));
            
            // Save to Supabase if logged in
            if (useSupabase && currentUser) {
                try {
                    await saveCategoryItems();
                    console.log('Category saved successfully:', categoryKey);
                } catch (error) {
                    console.error('Error saving category:', error);
                    // Still show the category even if Supabase save fails (it's in localStorage)
                    alert(currentLanguage === 'en' 
                        ? 'Category added but there was an error saving to database. It has been saved locally.' 
                        : 'CategorÃ­a agregada pero hubo un error al guardar en la base de datos. Se ha guardado localmente.');
                }
            }
            
            // Always display categories immediately after adding
            loadCategoriesList();
            populateCategoryDropdowns();
            
            // Clear form
            document.getElementById('newCategoryNameEn').value = '';
            document.getElementById('newCategoryNameEs').value = '';
            document.getElementById('newCategoryDescription').value = '';
            document.getElementById('newCategoryPricingType').value = 'fixed';
            document.getElementById('newCategoryRecurringWeekly').checked = false;
            document.getElementById('newCategoryHasDueDate').checked = false;
            document.getElementById('newCategoryDueDate').value = '';
            document.getElementById('dueDateRow').style.display = 'none';
            
            alert(currentLanguage === 'en' ? 'Category added successfully' : 'CategorÃ­a agregada exitosamente');
        }

        function loadCategoriesList() {
            const categoriesListDiv = document.getElementById('categoriesList');
            let categoriesHTML = '<div style="display: grid; gap: 15px;">';
            
            Object.keys(categories).forEach(key => {
                const category = categories[key];
                const itemCount = itemDatabase[key] ? itemDatabase[key].length : 0;
                
                const pricingTypeText = category.pricingType === 'flexible' ? 
                    (currentLanguage === 'en' ? 'Flexible Cost' : 'Costo Flexible') :
                    (currentLanguage === 'en' ? 'Fixed Cost' : 'Costo Fijo');
                const pricingTypeColor = category.pricingType === 'flexible' ? '#e74c3c' : '#27ae60';
                
                categoriesHTML += `
                    <div style="border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${(() => {
                                // Display name: prefer current language, but fall back to other language if current is empty
                                const displayName = currentLanguage === 'en' 
                                    ? (category.nameEn || category.nameEs || '') 
                                    : (category.nameEs || category.nameEn || '');
                                return displayName;
                            })()}</h4>
                            <p style="margin: 0 0 5px 0; color: #7f8c8d; font-size: 0.9rem;">${(() => {
                                // Display description: prefer current language, but fall back to other language if current is empty
                                const displayDesc = currentLanguage === 'en' 
                                    ? (category.descriptionEn || category.descriptionEs || category.description || '') 
                                    : (category.descriptionEs || category.descriptionEn || category.description || '');
                                return displayDesc;
                            })()}</p>
                            <div style="display: flex; gap: 15px; align-items: center; margin-top: 5px; flex-wrap: wrap;">
                                <span style="font-size: 0.85rem; color: #5d6d7e;" data-en="Items: " data-es="ArtÃ­culos: ">Items: ${itemCount}</span>
                                <span style="font-size: 0.85rem; color: ${pricingTypeColor}; font-weight: 600;">${pricingTypeText}</span>
                                ${category.recurringWeekly ? `<span style="font-size: 0.85rem; color: #3498db; font-weight: 600;" data-en="ðŸ”„ Recurring Weekly" data-es="ðŸ”„ Recurrente Semanal">ðŸ”„ Recurring Weekly</span>` : ''}
                                ${category.hasDueDate && category.dueDate ? `<span style="font-size: 0.85rem; color: #e67e22; font-weight: 600;" data-en="ðŸ“… Due: ${new Date(category.dueDate).toLocaleDateString()}" data-es="ðŸ“… Vence: ${new Date(category.dueDate).toLocaleDateString()}">ðŸ“… Due: ${new Date(category.dueDate).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-primary" onclick="editCategory('${key}')" 
                                    style="padding: 8px 15px; font-size: 0.9rem;" 
                                    data-en="Edit" data-es="Editar">Edit</button>
                            <button class="btn btn-danger" onclick="deleteCategory('${key}')" 
                                    style="padding: 8px 15px; font-size: 0.9rem;" 
                                    data-en="Delete" data-es="Eliminar">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            categoriesHTML += '</div>';
            categoriesListDiv.innerHTML = categoriesHTML;
        }

        function populateCategoryDropdowns() {
            const dropdowns = ['categorySelect', 'category', 'manageCategorySelect', 'editCategory'];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Save the currently selected value before clearing
                    const selectedValue = dropdown.value;
                    
                    // Clear existing options except the first one
                    const firstOption = dropdown.querySelector('option[value=""]');
                    const firstOptionText = firstOption ? firstOption.textContent : '';
                    const firstOptionDataEn = firstOption ? firstOption.getAttribute('data-en') : '';
                    const firstOptionDataEs = firstOption ? firstOption.getAttribute('data-es') : '';
                    
                    dropdown.innerHTML = '';
                    
                    // Recreate the first option
                    const newFirstOption = document.createElement('option');
                    newFirstOption.value = '';
                    newFirstOption.textContent = firstOptionText || (currentLanguage === 'en' ? 'Choose a category...' : 'Elige una categorÃ­a...');
                    newFirstOption.setAttribute('data-en', firstOptionDataEn || 'Choose a category...');
                    newFirstOption.setAttribute('data-es', firstOptionDataEs || 'Elige una categorÃ­a...');
                    dropdown.appendChild(newFirstOption);
                    
                    // Add all categories
                    Object.keys(categories).forEach(key => {
                        const category = categories[key];
                        const option = document.createElement('option');
                        option.value = key;
                        // Use fallback logic for category names
                        const displayName = currentLanguage === 'en' 
                            ? (category.nameEn || category.nameEs || '') 
                            : (category.nameEs || category.nameEn || '');
                        option.textContent = displayName;
                        option.setAttribute('data-en', category.nameEn);
                        option.setAttribute('data-es', category.nameEs);
                        dropdown.appendChild(option);
                    });
                    
                    // Restore the previously selected value if it still exists
                    if (selectedValue && categories[selectedValue]) {
                        dropdown.value = selectedValue;
                    }
                }
            });
        }

        function editCategory(categoryKey) {
            const category = categories[categoryKey];
            if (!category) return;
            
            // Populate the form with existing data
            document.getElementById('newCategoryNameEn').value = category.nameEn || '';
            document.getElementById('newCategoryNameEs').value = category.nameEs || '';
            // Show description in current language, fallback to other language or old field
            const displayDesc = currentLanguage === 'en' 
                ? (category.descriptionEn || category.descriptionEs || category.description || '') 
                : (category.descriptionEs || category.descriptionEn || category.description || '');
            document.getElementById('newCategoryDescription').value = displayDesc;
            document.getElementById('newCategoryPricingType').value = category.pricingType || 'fixed';
            document.getElementById('newCategoryRecurringWeekly').checked = category.recurringWeekly || false;
            document.getElementById('newCategoryHasDueDate').checked = category.hasDueDate || false;
            if (category.hasDueDate && category.dueDate) {
                document.getElementById('newCategoryDueDate').value = category.dueDate;
                document.getElementById('dueDateRow').style.display = 'block';
            } else {
                document.getElementById('newCategoryDueDate').value = '';
                document.getElementById('dueDateRow').style.display = 'none';
            }
            
            // Change the button to "Update Category"
            const addButton = document.querySelector('button[onclick="addNewCategory()"]');
            addButton.textContent = currentLanguage === 'en' ? 'Update Category' : 'Actualizar CategorÃ­a';
            addButton.setAttribute('onclick', `updateCategory('${categoryKey}')`);
            
            // Show cancel button
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Scroll to the form
            document.getElementById('newCategoryNameEn').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditCategory() {
            // Clear form
            document.getElementById('newCategoryNameEn').value = '';
            document.getElementById('newCategoryNameEs').value = '';
            document.getElementById('newCategoryDescription').value = '';
            document.getElementById('newCategoryPricingType').value = 'fixed';
            document.getElementById('newCategoryRecurringWeekly').checked = false;
            document.getElementById('newCategoryHasDueDate').checked = false;
            document.getElementById('newCategoryDueDate').value = '';
            document.getElementById('dueDateRow').style.display = 'none';
            
            // Reset button
            const addButton = document.querySelector('button[onclick*="updateCategory"]');
            addButton.textContent = currentLanguage === 'en' ? 'Add Category' : 'Agregar CategorÃ­a';
            addButton.setAttribute('onclick', 'addNewCategory()');
            
            // Hide cancel button
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function updateCategory(categoryKey) {
            const nameEn = document.getElementById('newCategoryNameEn').value;
            const nameEs = document.getElementById('newCategoryNameEs').value;
            const description = document.getElementById('newCategoryDescription').value;
            const pricingType = document.getElementById('newCategoryPricingType').value;
            
            if (!nameEn || !nameEs) {
                alert(currentLanguage === 'en' ? 'Please enter category names in both languages' : 'Por favor ingresa nombres de categorÃ­a en ambos idiomas');
                return;
            }
            
            // Update the category
            const recurringWeekly = document.getElementById('newCategoryRecurringWeekly').checked;
            const hasDueDate = document.getElementById('newCategoryHasDueDate').checked;
            const dueDate = hasDueDate ? document.getElementById('newCategoryDueDate').value : null;
            
            categories[categoryKey] = {
                nameEn: nameEn,
                nameEs: nameEs,
                description: description,
                pricingType: pricingType,
                recurringWeekly: recurringWeekly,
                hasDueDate: hasDueDate,
                dueDate: dueDate
            };
            
            localStorage.setItem('customCategories', JSON.stringify(categories));
            
            // Save to Supabase if logged in
            if (useSupabase && currentUser) {
                await saveCategoryItems();
            }
            
            loadCategoriesList();
            populateCategoryDropdowns();
            
            // Reset form and button
            document.getElementById('newCategoryNameEn').value = '';
            document.getElementById('newCategoryNameEs').value = '';
            document.getElementById('newCategoryDescription').value = '';
            document.getElementById('newCategoryPricingType').value = 'fixed';
            document.getElementById('newCategoryRecurringWeekly').checked = false;
            document.getElementById('newCategoryHasDueDate').checked = false;
            document.getElementById('newCategoryDueDate').value = '';
            document.getElementById('dueDateRow').style.display = 'none';
            
            const addButton = document.querySelector('button[onclick*="updateCategory"]');
            addButton.textContent = currentLanguage === 'en' ? 'Add Category' : 'Agregar CategorÃ­a';
            addButton.setAttribute('onclick', 'addNewCategory()');
            
            // Hide cancel button
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            alert(currentLanguage === 'en' ? 'Category updated successfully' : 'CategorÃ­a actualizada exitosamente');
        }

        async function deleteCategory(categoryKey) {
            if (confirm(currentLanguage === 'en' ? 'Are you sure you want to delete this category? All items in this category will be permanently deleted.' : 'Â¿EstÃ¡s seguro de que quieres eliminar esta categorÃ­a? Todos los artÃ­culos en esta categorÃ­a se eliminarÃ¡n permanentemente.')) {
                // Delete from Supabase first if logged in
                if (useSupabase && currentUser) {
                    try {
                        const { error } = await supabase
                            .from('custom_categories')
                            .delete()
                            .eq('user_id', currentUser.id)
                            .eq('category_key', categoryKey);
                        
                        if (error) {
                            console.error('Error deleting category from Supabase:', error);
                        }
                    } catch (error) {
                        console.error('Error deleting category from Supabase:', error);
                    }
                }
                
                // Delete items in this category
                if (itemDatabase[categoryKey] && itemDatabase[categoryKey].length > 0) {
                    delete itemDatabase[categoryKey];
                }
                
                delete categories[categoryKey];
                localStorage.setItem('customCategories', JSON.stringify(categories));
                
                // Save remaining categories to Supabase if logged in
                if (useSupabase && currentUser) {
                    await saveCategoryItems();
                }
                
                loadCategoriesList();
                populateCategoryDropdowns();
            }
        }

        // Reports and Analytics
        async function loadReport() {
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('dateRange').value;
            const itemFilter = document.getElementById('reportItemFilter') ? document.getElementById('reportItemFilter').value : 'all';
            const reportContent = document.getElementById('reportContent');
            
            let reportHTML = '';
            
            switch (reportType) {
                case 'summary':
                    reportHTML = generateSummaryReport(dateRange, itemFilter);
                    break;
                case 'savedBudgets':
                    reportHTML = await generateSavedBudgetsReport(dateRange, itemFilter);
                    break;
                case 'byCategory':
                    reportHTML = await generateCategoryReport(dateRange, itemFilter);
                    break;
                case 'bySupplier':
                    reportHTML = await generateSupplierReport(dateRange, itemFilter);
                    break;
                case 'byPriority':
                    reportHTML = await generatePriorityReport(dateRange, itemFilter);
                    break;
                case 'historical':
                    reportHTML = generateHistoricalReport(dateRange, itemFilter);
                    break;
                case 'itemAnalysis':
                    reportHTML = await generateItemAnalysisReport(dateRange, itemFilter);
                    break;
            }
            
            reportContent.innerHTML = reportHTML;
        }

        function populateBudgetReportItemFilter() {
            const itemFilter = document.getElementById('reportItemFilter');
            if (!itemFilter) return;
            
            // Get all items from current budget items and saved budgets
            const currentItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
            const allItemsMap = new Map();
            
            // Collect items from current budget
            currentItems.forEach(item => {
                const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                if (!allItemsMap.has(itemKey)) {
                    allItemsMap.set(itemKey, {
                        nameEn: item.nameEn || item.name,
                        nameEs: item.nameEs || item.name,
                        category: item.category || 'uncategorized',
                        key: itemKey
                    });
                }
            });
            
            // Collect items from saved budgets
            savedBudgets.forEach(budget => {
                if (budget.items) {
                    budget.items.forEach(item => {
                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        if (!allItemsMap.has(itemKey)) {
                            allItemsMap.set(itemKey, {
                                nameEn: item.nameEn || item.name,
                                nameEs: item.nameEs || item.name,
                                category: item.category || 'uncategorized',
                                key: itemKey
                            });
                        }
                    });
                }
            });
            
            // Store current selection
            const currentValue = itemFilter.value;
            
            // Clear existing options except "All Items"
            itemFilter.innerHTML = '<option value="all" data-en="All Items" data-es="Todos los ArtÃ­culos">All Items</option>';
            
            // Add items to dropdown, sorted by name
            Array.from(allItemsMap.values())
                .sort((a, b) => {
                    const nameA = currentLanguage === 'en' ? a.nameEn : a.nameEs;
                    const nameB = currentLanguage === 'en' ? b.nameEn : b.nameEs;
                    return nameA.localeCompare(nameB);
                })
                .forEach(item => {
                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                    const option = document.createElement('option');
                    option.value = item.key;
                    option.textContent = itemName;
                    itemFilter.appendChild(option);
                });
            
            // Restore previous selection if it still exists
            if (currentValue && currentValue !== 'all') {
                itemFilter.value = currentValue;
            }
        }

        // Helper function to get approval date from change history
        function getItemApprovalDate(itemId) {
            const changeHistory = JSON.parse(localStorage.getItem('changeHistory')) || [];
            const approvalChange = changeHistory.find(change => 
                change.itemId == itemId && 
                change.type === 'approved' && 
                change.field === 'approvalStatus'
            );
            return approvalChange ? new Date(approvalChange.timestamp).toLocaleDateString() : null;
        }

        // Helper function to calculate days between orders for Canada items
        function getDaysBetweenCanadaOrders(itemKey, itemNameEn, itemCategory) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const itemDates = [];
            
            // Collect all dates when this item was ordered
            history.forEach(request => {
                const hasItem = request.items.some(item => {
                    const key = `${item.nameEn}_${item.category}`;
                    return key === itemKey || (item.nameEn === itemNameEn && item.category === itemCategory);
                });
                if (hasItem) {
                    itemDates.push(new Date(request.date));
                }
            });
            
            if (itemDates.length === 0) {
                return null;
            }
            
            // Sort dates ascending
            itemDates.sort((a, b) => a - b);
            
            if (itemDates.length === 1) {
                // Only one order - return first order info
                return {
                    days: null,
                    firstOrder: true,
                    firstOrderDate: itemDates[0],
                    totalOrders: 1
                };
            }
            
            // Calculate days between the last two orders
            const lastDate = itemDates[itemDates.length - 1];
            const previousDate = itemDates[itemDates.length - 2];
            const daysDiff = Math.floor((lastDate - previousDate) / (1000 * 60 * 60 * 24));
            
            return {
                days: daysDiff,
                lastOrderDate: lastDate,
                previousOrderDate: previousDate,
                totalOrders: itemDates.length,
                firstOrder: false
            };
        }

        // Helper function to calculate days between orders for Budget items
        function getDaysBetweenBudgetOrders(itemKey, itemNameEn, itemCategory) {
            const currentItems = JSON.parse(localStorage.getItem('budgetItems')) || [];
            const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
            const itemDates = [];
            
            // Collect dates from current items
            currentItems.forEach(item => {
                const key = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                if (key === itemKey || ((item.nameEn || item.name) === itemNameEn && (item.category || 'uncategorized') === itemCategory)) {
                    if (item.dateAdded) {
                        itemDates.push(new Date(item.dateAdded));
                    }
                }
            });
            
            // Collect dates from saved budgets
            savedBudgets.forEach(budget => {
                if (budget.items) {
                    budget.items.forEach(item => {
                        const key = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        if (key === itemKey || ((item.nameEn || item.name) === itemNameEn && (item.category || 'uncategorized') === itemCategory)) {
                            // Use budget saved date as proxy for item date
                            if (budget.savedDate) {
                                itemDates.push(new Date(budget.savedDate));
                            } else if (item.dateAdded) {
                                itemDates.push(new Date(item.dateAdded));
                            }
                        }
                    });
                }
            });
            
            if (itemDates.length === 0) {
                return null;
            }
            
            // Sort dates ascending
            itemDates.sort((a, b) => a - b);
            
            if (itemDates.length === 1) {
                // Only one order - return first order info
                return {
                    days: null,
                    firstOrder: true,
                    firstOrderDate: itemDates[0],
                    totalOrders: 1
                };
            }
            
            // Calculate days between the last two orders
            const lastDate = itemDates[itemDates.length - 1];
            const previousDate = itemDates[itemDates.length - 2];
            const daysDiff = Math.floor((lastDate - previousDate) / (1000 * 60 * 60 * 24));
            
            return {
                days: daysDiff,
                lastOrderDate: lastDate,
                previousOrderDate: previousDate,
                totalOrders: itemDates.length,
                firstOrder: false
            };
        }

        // Canada Reports and Analytics
        function loadCanadaReport() {
            const reportType = document.getElementById('canadaReportType').value;
            const dateRange = document.getElementById('canadaDateRange').value;
            const itemFilter = document.getElementById('canadaReportItemFilter').value;
            const reportContent = document.getElementById('canadaReportContent');
            
            // Populate item filter dropdown
            populateCanadaReportItemFilter();
            
            let reportHTML = '';
            
            switch (reportType) {
                case 'requestHistory':
                    reportHTML = generateCanadaRequestHistoryReport(dateRange, itemFilter);
                    break;
                case 'shippingStatus':
                    reportHTML = generateCanadaShippingStatusReport(dateRange, itemFilter);
                    break;
                case 'backorders':
                    reportHTML = generateCanadaBackordersReport(dateRange, itemFilter);
                    break;
                case 'dutiesTaxes':
                    reportHTML = generateCanadaDutiesTaxesReport(dateRange, itemFilter);
                    break;
                case 'deliveryTimeline':
                    reportHTML = generateCanadaDeliveryTimelineReport(dateRange, itemFilter);
                    break;
            }
            
            reportContent.innerHTML = reportHTML;
        }

        function populateCanadaReportItemFilter() {
            const itemFilter = document.getElementById('canadaReportItemFilter');
            if (!itemFilter) return;
            
            // Get all items from the entire history (not filtered)
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const allItemsMap = new Map();
            
            // Collect all unique items from entire history
            history.forEach(request => {
                request.items.forEach(item => {
                    const itemKey = `${item.nameEn}_${item.category}`;
                    if (!allItemsMap.has(itemKey)) {
                        allItemsMap.set(itemKey, {
                            nameEn: item.nameEn,
                            nameEs: item.nameEs,
                            category: item.category,
                            key: itemKey
                        });
                    }
                });
            });
            
            // Store current selection
            const currentValue = itemFilter.value;
            
            // Clear existing options except "All Items"
            itemFilter.innerHTML = '<option value="all" data-en="All Items" data-es="Todos los ArtÃ­culos">All Items</option>';
            
            // Add items to dropdown, sorted by name
            Array.from(allItemsMap.values())
                .sort((a, b) => {
                    const nameA = currentLanguage === 'en' ? a.nameEn : a.nameEs;
                    const nameB = currentLanguage === 'en' ? b.nameEn : b.nameEs;
                    return nameA.localeCompare(nameB);
                })
                .forEach(item => {
                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                    const option = document.createElement('option');
                    option.value = item.key;
                    option.textContent = itemName;
                    itemFilter.appendChild(option);
                });
            
            // Restore previous selection if it still exists
            if (currentValue && currentValue !== 'all') {
                itemFilter.value = currentValue;
            }
        }

        function generateCanadaRequestHistoryReport(dateRange, itemFilter) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            let filteredHistory = history;
            
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (dateRange === 'last30') startDate.setDate(now.getDate() - 30);
                else if (dateRange === 'last90') startDate.setDate(now.getDate() - 90);
                else if (dateRange === 'lastYear') startDate.setFullYear(now.getFullYear() - 1);
                
                filteredHistory = history.filter(req => new Date(req.date) >= startDate);
            }
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredHistory = filteredHistory.filter(req => {
                    return req.items.some(item => {
                        const itemKey = `${item.nameEn}_${item.category}`;
                        return itemKey === itemFilter;
                    });
                });
            }
            
            if (filteredHistory.length === 0) {
                return `<div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                    <p>${currentLanguage === 'en' ? 'No requests found for the selected filters.' : 'No se encontraron solicitudes para los filtros seleccionados.'}</p>
                </div>`;
            }
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            let html = `<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>${currentLanguage === 'en' ? 'Request History Summary' : 'Resumen del Historial de Solicitudes'}</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">${currentLanguage === 'en' ? 'Total Requests: ' : 'Total de Solicitudes: '}${filteredHistory.length}</p>
                <div style="display: grid; gap: 15px;">`;
            
            filteredHistory.forEach(request => {
                const date = new Date(request.date).toLocaleDateString();
                const statusColor = request.status === 'received' ? '#27ae60' : (request.status === 'sent' ? '#3498db' : '#f39c12');
                const statusText = request.status === 'received' ? 
                    (currentLanguage === 'en' ? 'Received' : 'Recibido') :
                    (request.status === 'sent' ? 
                    (currentLanguage === 'en' ? 'Sent' : 'Enviada') : 
                    (currentLanguage === 'en' ? 'Pending' : 'Pendiente'));
                
                html += `<div style="padding: 15px; background: #f8f9fa; border-left: 4px solid ${statusColor}; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong>
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 3px;">${date}</div>
                        </div>
                        <span style="padding: 5px 12px; background: ${statusColor}; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                            ${statusText}
                        </span>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="color: #2c3e50; font-weight: 600; margin-bottom: 5px;">
                            ${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'} (${request.items.length}):
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            ${request.items.map(item => {
                                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                const unit = item.unit || 'sheet';
                                const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                                const itemKey = `${item.nameEn}_${item.category}`;
                                const daysBetween = getDaysBetweenCanadaOrders(itemKey, item.nameEn, item.category);
                                let daysInfo = '';
                                if (daysBetween) {
                                    if (daysBetween.firstOrder) {
                                        daysInfo = `<span style="color: #95a5a6; font-weight: 600; margin-left: 8px;" title="${currentLanguage === 'en' ? `First order on ${daysBetween.firstOrderDate.toLocaleDateString()}` : `Primera orden el ${daysBetween.firstOrderDate.toLocaleDateString()}`}">
                                            (${currentLanguage === 'en' ? 'First order' : 'Primera orden'})
                                        </span>`;
                                    } else {
                                        daysInfo = `<span style="color: #3498db; font-weight: 600; margin-left: 8px;" title="${currentLanguage === 'en' ? `Last ordered ${daysBetween.days} days ago (${daysBetween.totalOrders} total orders)` : `Ãšltima orden hace ${daysBetween.days} dÃ­as (${daysBetween.totalOrders} Ã³rdenes totales)`}">
                                            (${currentLanguage === 'en' ? `${daysBetween.days} days` : `${daysBetween.days} dÃ­as`})
                                        </span>`;
                                    }
                                }
                                return `<div style="padding: 5px; background: white; border-radius: 4px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span>â€¢ ${itemName}: ${item.quantity} ${unitLabel}</span>
                                    ${daysInfo}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div></div>';
            return html;
        }

        function generateCanadaShippingStatusReport(dateRange, itemFilter) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            let filteredHistory = history.filter(req => req.trackingShipments && req.trackingShipments.length > 0);
            
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (dateRange === 'last30') startDate.setDate(now.getDate() - 30);
                else if (dateRange === 'last90') startDate.setDate(now.getDate() - 90);
                else if (dateRange === 'lastYear') startDate.setFullYear(now.getFullYear() - 1);
                
                filteredHistory = filteredHistory.filter(req => new Date(req.date) >= startDate);
            }
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredHistory = filteredHistory.filter(req => {
                    return req.items.some(item => {
                        const itemKey = `${item.nameEn}_${item.category}`;
                        return itemKey === itemFilter;
                    });
                });
            }
            
            if (filteredHistory.length === 0) {
                return `<div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                    <p>${currentLanguage === 'en' ? 'No shipping data found.' : 'No se encontraron datos de envÃ­o.'}</p>
                </div>`;
            }
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            let html = `<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>${currentLanguage === 'en' ? 'Shipping Status Report' : 'Reporte de Estado de EnvÃ­o'}</h3>
                <div style="display: grid; gap: 15px;">`;
            
            filteredHistory.forEach(request => {
                const date = new Date(request.date).toLocaleDateString();
                html += `<div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <strong>${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong> - ${date}
                    <div style="margin-top: 10px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'}:</div>
                        ${request.items.map(item => {
                            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                            const unit = item.unit || 'sheet';
                            const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                            const itemKey = `${item.nameEn}_${item.category}`;
                            const daysBetween = getDaysBetweenCanadaOrders(itemKey, item.nameEn, item.category);
                            let daysInfo = '';
                            if (daysBetween) {
                                if (daysBetween.firstOrder) {
                                    daysInfo = `<span style="color: #95a5a6; font-weight: 600; margin-left: 8px;" title="${currentLanguage === 'en' ? `First order on ${daysBetween.firstOrderDate.toLocaleDateString()}` : `Primera orden el ${daysBetween.firstOrderDate.toLocaleDateString()}`}">
                                        (${currentLanguage === 'en' ? 'First order' : 'Primera orden'})
                                    </span>`;
                                } else {
                                    daysInfo = `<span style="color: #3498db; font-weight: 600; margin-left: 8px;" title="${currentLanguage === 'en' ? `Last ordered ${daysBetween.days} days ago (${daysBetween.totalOrders} total orders)` : `Ãšltima orden hace ${daysBetween.days} dÃ­as (${daysBetween.totalOrders} Ã³rdenes totales)`}">
                                        (${currentLanguage === 'en' ? `${daysBetween.days} days` : `${daysBetween.days} dÃ­as`})
                                    </span>`;
                                }
                            }
                            return `<div style="padding: 3px 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                                <span>â€¢ ${itemName}: ${item.quantity} ${unitLabel}</span>
                                ${daysInfo}
                            </div>`;
                        }).join('')}
                    </div>
                    <div style="margin-top: 10px;">`;
                
                request.trackingShipments.forEach((shipment, idx) => {
                    const status = shipment.upsStatus || (currentLanguage === 'en' ? 'No status' : 'Sin estado');
                    html += `<div style="padding: 8px; background: white; border-radius: 4px; margin-top: 5px;">
                        ${currentLanguage === 'en' ? 'Tracking' : 'Seguimiento'} #${idx + 1}: ${shipment.trackingNumber}<br>
                        ${currentLanguage === 'en' ? 'Status' : 'Estado'}: ${status}
                    </div>`;
                });
                
                html += '</div></div>';
            });
            
            html += '</div></div>';
            return html;
        }

        function generateCanadaBackordersReport(dateRange, itemFilter) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders')) || {};
            let allBackorders = [];
            
            history.forEach(request => {
                if (request.backorders && request.backorders.length > 0) {
                    request.backorders.forEach(bo => {
                        const groupKey = `${bo.nameEn}_${bo.category}`;
                        if (dismissedBackorders[groupKey] !== true) {
                            allBackorders.push({...bo, requestId: request.id, requestDate: request.date});
                        }
                    });
                }
            });
            
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (dateRange === 'last30') startDate.setDate(now.getDate() - 30);
                else if (dateRange === 'last90') startDate.setDate(now.getDate() - 90);
                else if (dateRange === 'lastYear') startDate.setFullYear(now.getFullYear() - 1);
                
                allBackorders = allBackorders.filter(bo => new Date(bo.requestDate) >= startDate);
            }
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                allBackorders = allBackorders.filter(bo => {
                    const itemKey = `${bo.nameEn}_${bo.category}`;
                    return itemKey === itemFilter;
                });
            }
            
            if (allBackorders.length === 0) {
                return `<div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                    <p>${currentLanguage === 'en' ? 'No backorders found.' : 'No se encontraron pedidos pendientes.'}</p>
                </div>`;
            }
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            // Group by item
            const grouped = {};
            allBackorders.forEach(bo => {
                const key = `${bo.nameEn}_${bo.category}`;
                if (!grouped[key]) {
                    grouped[key] = {...bo, totalQty: 0, requests: []};
                }
                grouped[key].totalQty += bo.backorderQty;
                grouped[key].requests.push({requestId: bo.requestId, qty: bo.backorderQty, requestedQty: bo.requestedQty, sentQty: bo.sentQty});
            });
            
            let html = `<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>${currentLanguage === 'en' ? 'Backorders Report' : 'Reporte de Pedidos Pendientes'}</h3>
                <div style="display: grid; gap: 15px;">`;
            
            Object.values(grouped).forEach(group => {
                const itemName = currentLanguage === 'en' ? group.nameEn : group.nameEs;
                const unit = group.unit || 'sheet';
                const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                const itemKey = `${group.nameEn}_${group.category}`;
                const daysBetween = getDaysBetweenCanadaOrders(itemKey, group.nameEn, group.category);
                let daysInfo = '';
                if (daysBetween) {
                    if (daysBetween.firstOrder) {
                        daysInfo = `<br><span style="color: #95a5a6; font-weight: 600;" title="${currentLanguage === 'en' ? `First order on ${daysBetween.firstOrderDate.toLocaleDateString()}` : `Primera orden el ${daysBetween.firstOrderDate.toLocaleDateString()}`}">
                            ${currentLanguage === 'en' ? 'First Order' : 'Primera Orden'}
                        </span>`;
                    } else {
                        daysInfo = `<br><span style="color: #3498db; font-weight: 600;" title="${currentLanguage === 'en' ? `Last ordered ${daysBetween.days} days ago (${daysBetween.totalOrders} total orders)` : `Ãšltima orden hace ${daysBetween.days} dÃ­as (${daysBetween.totalOrders} Ã³rdenes totales)`}">
                            ${currentLanguage === 'en' ? `Days Between Orders: ${daysBetween.days} days` : `DÃ­as Entre Ã“rdenes: ${daysBetween.days} dÃ­as`}
                        </span>`;
                    }
                }
                html += `<div style="padding: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;">
                    <strong>${itemName}</strong><br>
                    ${currentLanguage === 'en' ? 'Total Backorder: ' : 'Total Pendiente: '}${group.totalQty} ${unitLabel}<br>
                    ${currentLanguage === 'en' ? 'Affected Requests: ' : 'Solicitudes Afectadas: '}${group.requests.length}${daysInfo}
                    <div style="margin-top: 8px; font-size: 0.9rem; color: #856404;">
                        ${group.requests.map(req => {
                            return `${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${req.requestId}: ${req.qty} ${unitLabel} (${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${req.requestedQty}, ${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${req.sentQty})`;
                        }).join('<br>')}
                    </div>
                </div>`;
            });
            
            html += '</div></div>';
            return html;
        }

        function generateCanadaDutiesTaxesReport(dateRange, itemFilter) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            let filteredHistory = history.filter(req => {
                if (!req.trackingShipments) return false;
                return req.trackingShipments.some(s => s.upsHasDutiesDue || s.upsDutiesPaid);
            });
            
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (dateRange === 'last30') startDate.setDate(now.getDate() - 30);
                else if (dateRange === 'last90') startDate.setDate(now.getDate() - 90);
                else if (dateRange === 'lastYear') startDate.setFullYear(now.getFullYear() - 1);
                
                filteredHistory = filteredHistory.filter(req => new Date(req.date) >= startDate);
            }
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredHistory = filteredHistory.filter(req => {
                    return req.items.some(item => {
                        const itemKey = `${item.nameEn}_${item.category}`;
                        return itemKey === itemFilter;
                    });
                });
            }
            
            if (filteredHistory.length === 0) {
                return `<div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                    <p>${currentLanguage === 'en' ? 'No duties/taxes data found.' : 'No se encontraron datos de impuestos/aranceles.'}</p>
                </div>`;
            }
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            let html = `<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>${currentLanguage === 'en' ? 'Duties & Taxes Report' : 'Reporte de Impuestos y Aranceles'}</h3>
                <div style="display: grid; gap: 15px;">`;
            
            filteredHistory.forEach(request => {
                const date = new Date(request.date).toLocaleDateString();
                request.trackingShipments.forEach(shipment => {
                    if (shipment.upsHasDutiesDue || shipment.upsDutiesPaid) {
                        const status = shipment.upsDutiesPaid ? 
                            (currentLanguage === 'en' ? 'PAID' : 'PAGADO') :
                            (currentLanguage === 'en' ? 'DUE' : 'PENDIENTE');
                        const bgColor = shipment.upsDutiesPaid ? '#e8f5e9' : '#fff3cd';
                        const borderColor = shipment.upsDutiesPaid ? '#27ae60' : '#f39c12';
                        
                        // Get items in this shipment
                        const shipmentItems = request.items.filter((item, itemIdx) => {
                            const itemId = item.id || `item_${item.nameEn}_${item.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                            return shipment.itemIds && shipment.itemIds.includes(itemId);
                        });
                        
                        html += `<div style="padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 4px;">
                            <strong>${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong> - ${date}<br>
                            ${currentLanguage === 'en' ? 'Tracking' : 'Seguimiento'}: ${shipment.trackingNumber}<br>
                            ${currentLanguage === 'en' ? 'Status' : 'Estado'}: ${status}
                            ${shipment.upsDutiesAmount ? `<br>${currentLanguage === 'en' ? 'Amount' : 'Monto'}: ${shipment.upsDutiesAmount}` : ''}
                            ${shipmentItems.length > 0 ? `<div style="margin-top: 8px; font-size: 0.9rem;">
                                ${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'}: ${shipmentItems.map(item => {
                                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                    const unit = item.unit || 'sheet';
                                    const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                                    return `${itemName} (${item.quantity} ${unitLabel})`;
                                }).join(', ')}
                            </div>` : ''}
                        </div>`;
                    }
                });
            });
            
            html += '</div></div>';
            return html;
        }

        function generateCanadaDeliveryTimelineReport(dateRange, itemFilter) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            let filteredHistory = history.filter(req => req.trackingShipments && req.trackingShipments.length > 0);
            
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (dateRange === 'last30') startDate.setDate(now.getDate() - 30);
                else if (dateRange === 'last90') startDate.setDate(now.getDate() - 90);
                else if (dateRange === 'lastYear') startDate.setFullYear(now.getFullYear() - 1);
                
                filteredHistory = filteredHistory.filter(req => new Date(req.date) >= startDate);
            }
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredHistory = filteredHistory.filter(req => {
                    return req.items.some(item => {
                        const itemKey = `${item.nameEn}_${item.category}`;
                        return itemKey === itemFilter;
                    });
                });
            }
            
            if (filteredHistory.length === 0) {
                return `<div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                    <p>${currentLanguage === 'en' ? 'No delivery data found.' : 'No se encontraron datos de entrega.'}</p>
                </div>`;
            }
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            let html = `<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3>${currentLanguage === 'en' ? 'Delivery Timeline' : 'LÃ­nea de Tiempo de Entrega'}</h3>
                <div style="display: grid; gap: 15px;">`;
            
            filteredHistory.forEach(request => {
                const requestDate = new Date(request.date).toLocaleDateString();
                const receivedDate = request.receivedDate ? new Date(request.receivedDate).toLocaleDateString() : null;
                
                html += `<div style="padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <strong>${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong><br>
                    ${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${requestDate}<br>
                    ${receivedDate ? `${currentLanguage === 'en' ? 'Received' : 'Recibido'}: ${receivedDate}` : `${currentLanguage === 'en' ? 'Status' : 'Estado'}: ${request.status}`}
                    <div style="margin-top: 10px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'}:</div>
                        ${request.items.map(item => {
                            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                            const unit = item.unit || 'sheet';
                            const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                            return `<div style="padding: 3px 0; font-size: 0.9rem;">â€¢ ${itemName}: ${item.quantity} ${unitLabel}</div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            
            html += '</div></div>';
            return html;
        }

        // Synchronous version - reads from localStorage only (for immediate access)
        function getAllSavedBudgetsSync() {
            return JSON.parse(localStorage.getItem('savedBudgets')) || [];
        }
        
        // Synchronous version with date range filter
        function getSavedBudgetsByDateRangeSync(dateRange) {
            const allBudgets = getAllSavedBudgetsSync();
            const now = new Date();
            let startDate;
            
            switch(dateRange) {
                case 'last30':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'last90':
                    startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case 'lastYear':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    return allBudgets;
            }
            
            return allBudgets.filter(budget => {
                const budgetDate = new Date(budget.savedDate);
                return budgetDate >= startDate;
            });
        }
        
        // Helper function to deduplicate budgets by week_start
        function deduplicateBudgets(budgets) {
            if (!Array.isArray(budgets)) {
                return [];
            }
            
            const deduplicated = [];
            const weekStartMap = new Map();
            
            budgets.forEach(budget => {
                if (!budget || !budget.weekStart) return;
                
                const weekStartKey = budget.weekStart;
                const existing = weekStartMap.get(weekStartKey);
                
                if (!existing || new Date(budget.savedDate) > new Date(existing.savedDate)) {
                    if (existing) {
                        const index = deduplicated.findIndex(b => b.id === existing.id);
                        if (index !== -1) {
                            deduplicated.splice(index, 1);
                        }
                    }
                    weekStartMap.set(weekStartKey, budget);
                    deduplicated.push(budget);
                }
            });
            
            return deduplicated;
        }
        
        async function getAllSavedBudgets() {
            // Always check localStorage first as backup
            const localBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
            console.log('getAllSavedBudgets: Found', localBudgets.length, 'budgets in localStorage');
            
            // If using Supabase and user is logged in, load from database
            if (useSupabase && currentUser) {
                try {
                    const { data: savedBudgets, error } = await supabase
                        .from('saved_budgets')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('saved_date', { ascending: false });
                    
                    if (error) throw error;
                    
                    // If Supabase has data, use it
                    if (savedBudgets && savedBudgets.length > 0) {
                        // Load items for each budget
                        const budgetsWithItems = await Promise.all(
                            savedBudgets.map(async (budget) => {
                                const { data: budgetItems } = await supabase
                                    .from('saved_budget_items')
                                    .select('item_data')
                                    .eq('saved_budget_id', budget.id);
                                
                                return {
                                    id: budget.id,
                                    savedDate: budget.saved_date,
                                    weekStart: budget.week_start,
                                    weekLabel: budget.week_label,
                                    total: parseFloat(budget.total || 0),
                                    itemCount: budget.item_count,
                                    approvedCount: budget.approved_count,
                                    pendingCount: budget.pending_count,
                                    language: budget.language,
                                    isPartialPayment: budget.is_partial_payment || false,
                                    items: (budgetItems || []).map(bi => bi.item_data)
                                };
                            })
                        );
                        
                        // Deduplicate budgets by week_start, keeping only the most recent one
                        const deduplicatedBudgets = deduplicateBudgets(budgetsWithItems);
                        
                        // Update localStorage to match Supabase (to keep them in sync and prevent duplicates)
                        localStorage.setItem('savedBudgets', JSON.stringify(deduplicatedBudgets));
                        return deduplicatedBudgets;
                    } else {
                        // If Supabase is empty but localStorage has data, deduplicate and return localStorage
                        const deduplicatedLocal = deduplicateBudgets(localBudgets);
                        
                        // Update localStorage with deduplicated data
                        if (deduplicatedLocal.length !== localBudgets.length) {
                            localStorage.setItem('savedBudgets', JSON.stringify(deduplicatedLocal));
                        }
                        
                        return deduplicatedLocal;
                    }
                } catch (error) {
                    console.error('Error loading saved budgets from Supabase:', error);
                    // Fallback to localStorage with deduplication
                    const deduplicatedLocal = deduplicateBudgets(localBudgets);
                    
                    if (deduplicatedLocal.length !== localBudgets.length) {
                        localStorage.setItem('savedBudgets', JSON.stringify(deduplicatedLocal));
                    }
                    
                    return deduplicatedLocal;
                }
            }
            
            // Not using Supabase - return localStorage data with deduplication
            const deduplicatedLocal = deduplicateBudgets(localBudgets);
            console.log('getAllSavedBudgets: Returning localStorage budgets (no Supabase):', deduplicatedLocal.length);
            
            if (deduplicatedLocal.length !== localBudgets.length) {
                localStorage.setItem('savedBudgets', JSON.stringify(deduplicatedLocal));
            }
            
            return deduplicatedLocal;
        }

        async function getSavedBudgetsByDateRange(dateRange) {
            const allBudgets = await getAllSavedBudgets();
            const now = new Date();
            let startDate;
            
            switch(dateRange) {
                case 'last30':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'last90':
                    startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case 'lastYear':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    return allBudgets;
            }
            
            return allBudgets.filter(budget => {
                const budgetDate = new Date(budget.savedDate);
                return budgetDate >= startDate;
            });
        }

        async function generateSavedBudgetsReport(dateRange, itemFilter = 'all') {
            console.log('generateSavedBudgetsReport: Starting, dateRange:', dateRange);
            let savedBudgets = await getSavedBudgetsByDateRange(dateRange);
            console.log('generateSavedBudgetsReport: Loaded', savedBudgets.length, 'budgets');
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                savedBudgets = savedBudgets.filter(budget => {
                    if (!budget.items) return false;
                    return budget.items.some(item => {
                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        return itemKey === itemFilter;
                    });
                });
            }
            
            if (savedBudgets.length === 0) {
                return `<div class="alert alert-info" style="padding: 20px; text-align: center;">
                    <p data-en="No saved budgets found" data-es="No se encontraron presupuestos guardados">No saved budgets found</p>
                </div>`;
            }
            
            let reportHTML = '<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">';
            reportHTML += `<h3 data-en="Saved Budgets" data-es="Presupuestos Guardados">Saved Budgets</h3>`;
            reportHTML += `<p style="color: #7f8c8d; margin-bottom: 20px;" data-en="Total saved budgets: " data-es="Total de presupuestos guardados: ">Total saved budgets: ${savedBudgets.length}</p>`;
            
            // Sort by date (newest first)
            const sortedBudgets = savedBudgets.sort((a, b) => new Date(b.savedDate) - new Date(a.savedDate));
            
            reportHTML += '<div style="display: grid; gap: 15px;">';
            sortedBudgets.forEach(budget => {
                const savedDate = new Date(budget.savedDate).toLocaleString();
                const isPartial = budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment');
                reportHTML += `
                    <div style="border: 1px solid ${isPartial ? '#3498db' : '#e1e8ed'}; border-left: 4px solid ${isPartial ? '#3498db' : '#e1e8ed'}; border-radius: 8px; padding: 15px; background: ${isPartial ? '#e8f4fd' : '#f8f9fa'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <h4 style="margin: 0; color: #2c3e50;">${budget.weekLabel}</h4>
                                    ${isPartial ? '<span style="background: #3498db; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">' + (currentLanguage === 'en' ? 'PARTIAL PAYMENT' : 'PAGO PARCIAL') + '</span>' : ''}
                                </div>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9rem;">${savedDate}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #27ae60;">$${budget.total.toLocaleString('es-MX')} MXN</div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">${budget.itemCount} ${currentLanguage === 'en' ? 'items' : 'artÃ­culos'}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <span style="font-size: 0.85rem; color: #27ae60;">
                                âœ“ ${budget.approvedCount || 0} ${currentLanguage === 'en' ? 'approved' : 'aprobados'}
                            </span>
                            <span style="font-size: 0.85rem; color: #ffc107;">
                                â³ ${budget.pendingCount || 0} ${currentLanguage === 'en' ? 'pending' : 'pendientes'}
                            </span>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="viewSavedBudget(${budget.id})" style="padding: 6px 12px; font-size: 0.85rem;" 
                                    data-en="View Details" data-es="Ver Detalles">View Details</button>
                            <button class="btn btn-success" onclick="exportSavedBudget(${budget.id})" style="padding: 6px 12px; font-size: 0.85rem;" 
                                    data-en="Export" data-es="Exportar">Export</button>
                            <button class="btn btn-danger" onclick="deleteSavedBudget(${budget.id})" style="padding: 6px 12px; font-size: 0.85rem;" 
                                    data-en="Delete" data-es="Eliminar">Delete</button>
                        </div>
                    </div>
                `;
            });
            reportHTML += '</div></div>';
            
            return reportHTML;
        }

        function viewSavedBudget(budgetId) {
            try {
                // Convert budgetId to number if it's a string (for comparison)
                const idToFind = typeof budgetId === 'string' ? parseInt(budgetId) : budgetId;
                
                const savedBudgets = getAllSavedBudgetsSync();
                console.log('Looking for budget ID:', idToFind, 'Found budgets:', savedBudgets.length);
                
                // Try to find by exact match first, then try string/number conversion
                let budget = savedBudgets.find(b => b.id === idToFind || b.id === budgetId || String(b.id) === String(budgetId));
                
                if (!budget) {
                    console.error('Budget not found. Available IDs:', savedBudgets.map(b => b.id));
                    alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                    return;
                }
                
                console.log('Found budget:', budget.weekLabel);
                
                // Create a modal or detailed view
            const isPartial = budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment');
            let detailsHTML = `
                <div style="background: white; border-radius: 10px; padding: 20px; max-width: 800px; margin: 20px auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <h3 style="color: #2c3e50; margin-bottom: 10px;">${budget.weekLabel}</h3>
                            <p style="color: #7f8c8d; margin-bottom: 20px;">${new Date(budget.savedDate).toLocaleString()}</p>
                        </div>
                        ${isPartial ? '<div style="background: #3498db; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">' + (currentLanguage === 'en' ? 'PARTIAL PAYMENT' : 'PAGO PARCIAL') + '</div>' : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Total Amount" data-es="Monto Total">Total Amount</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #27ae60;">$${budget.total.toLocaleString('es-MX')} MXN</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Total Items" data-es="Total de ArtÃ­culos">Total Items</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">${budget.itemCount}</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Approved" data-es="Aprobados">Approved</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #27ae60;">${budget.approvedCount || 0}</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Pending" data-es="Pendientes">Pending</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #ffc107;">${budget.pendingCount || 0}</div>
                        </div>
                    </div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px;" data-en="Items" data-es="ArtÃ­culos">Items</h4>
                    <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 10px;" data-en="ðŸ’¡ Scroll horizontally to see all columns including 'Add Receipt' button" data-es="ðŸ’¡ DesplÃ¡zate horizontalmente para ver todas las columnas incluyendo el botÃ³n 'Agregar Recibo'">ðŸ’¡ Scroll horizontally to see all columns including 'Add Receipt' button</p>
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto; border: 1px solid #e1e8ed; border-radius: 8px;">
                        <table class="budget-table" style="width: 100%; min-width: 1200px; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;" data-en="Item" data-es="ArtÃ­culo">Item</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;" data-en="Category" data-es="CategorÃ­a">Category</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Quantity" data-es="Cantidad">Quantity</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Unit Price" data-es="Precio Unitario">Unit Price</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Total" data-es="Total">Total</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Status" data-es="Estado">Status</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Receipt Photo" data-es="Foto de Recibo">Receipt Photo</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Receipt Amount" data-es="Monto del Recibo">Receipt Amount</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Difference" data-es="Diferencia">Difference</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; background: #f8f9fa; position: sticky; right: 0; z-index: 10;" data-en="Actions" data-es="Acciones">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            let totalBudgeted = 0;
            let totalActual = 0;
            
            budget.items.forEach((item, index) => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const status = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'denied' ? 'Denied' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'denied' ? 'Rechazado' : 'Pendiente');
                
                const budgeted = item.totalPrice || 0;
                const actual = item.receiptAmount || 0;
                const difference = actual - budgeted;
                totalBudgeted += budgeted;
                totalActual += actual;
                
                let receiptPhoto = '<span style="color: #95a5a6;">-</span>';
                if (item.invoicePhoto) {
                    const fileType = item.invoiceFileType || '';
                    const fileName = item.invoiceFileName || '';
                    const isImage = fileType.startsWith('image/') || (!fileType && !fileName);
                    const isPDF = fileType === 'application/pdf' || fileName.toLowerCase().endsWith('.pdf');
                    const isExcel = fileType.includes('excel') || fileType.includes('spreadsheet') || fileName.toLowerCase().endsWith('.xlsx') || fileName.toLowerCase().endsWith('.xls');
                    
                    if (isImage) {
                        receiptPhoto = `<img src="${item.invoicePhoto}" style="max-width: 50px; max-height: 50px; cursor: pointer; border-radius: 4px;" onclick="viewReceiptPhoto('${item.invoicePhoto}')" title="${currentLanguage === 'en' ? 'Click to view full size' : 'Clic para ver tamaÃ±o completo'}">`;
                    } else if (isPDF) {
                        receiptPhoto = `<div style="text-align: center; cursor: pointer;" onclick="viewReceiptPhoto('${item.invoicePhoto}', 'pdf', '${fileName || 'receipt.pdf'}')" title="${currentLanguage === 'en' ? 'Click to view PDF' : 'Clic para ver PDF'}">
                            <div style="font-size: 2rem;">ðŸ“„</div>
                            <div style="font-size: 0.7rem; color: #7f8c8d;">PDF</div>
                        </div>`;
                    } else if (isExcel) {
                        receiptPhoto = `<div style="text-align: center; cursor: pointer;" onclick="viewReceiptPhoto('${item.invoicePhoto}', 'excel', '${fileName || 'receipt.xlsx'}')" title="${currentLanguage === 'en' ? 'Click to download Excel' : 'Clic para descargar Excel'}">
                            <div style="font-size: 2rem;">ðŸ“Š</div>
                            <div style="font-size: 0.7rem; color: #7f8c8d;">Excel</div>
                        </div>`;
                    }
                }
                
                const receiptAmount = actual > 0 ? `$${actual.toFixed(2)} MXN` : '<span style="color: #95a5a6;">-</span>';
                const diffColor = difference >= 0 ? '#27ae60' : '#e74c3c';
                const diffIcon = difference >= 0 ? 'â†‘' : 'â†“';
                const differenceDisplay = actual > 0 ? 
                    `<span style="color: ${diffColor}; font-weight: bold;">${diffIcon} $${Math.abs(difference).toFixed(2)} MXN</span>` : 
                    '<span style="color: #95a5a6;">-</span>';
                
                detailsHTML += `
                    <tr style="border-bottom: 1px solid #e1e8ed;">
                        <td style="padding: 10px;">${itemName}</td>
                        <td style="padding: 10px;">${categoryName}</td>
                        <td style="padding: 10px; text-align: center;">${item.quantity || 1}</td>
                        <td style="padding: 10px; text-align: right;">$${(item.unitPrice || 0).toLocaleString('es-MX')} MXN</td>
                        <td style="padding: 10px; text-align: right;">$${budgeted.toLocaleString('es-MX')} MXN</td>
                        <td style="padding: 10px; text-align: center;">${status}</td>
                        <td style="padding: 10px; text-align: center;">${receiptPhoto}</td>
                        <td style="padding: 10px; text-align: right;">${receiptAmount}</td>
                        <td style="padding: 10px; text-align: right;">${differenceDisplay}</td>
                        <td style="padding: 10px; text-align: center; background: white; position: sticky; right: 0; z-index: 5;">
                            <button class="btn btn-primary" onclick="addReceiptToSavedBudgetItem(${budgetId}, ${index})" style="padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;" 
                                    data-en="Add Receipt" data-es="Agregar Recibo">Add Receipt</button>
                        </td>
                    </tr>
                `;
            });
            
            // Add summary totals
            const runningBalance = totalActual - totalBudgeted;
            const balanceColor = runningBalance >= 0 ? '#27ae60' : '#e74c3c';
            const balanceStatus = runningBalance >= 0 ? 
                (currentLanguage === 'en' ? 'Surplus' : 'Excedente') : 
                (currentLanguage === 'en' ? 'Over Budget' : 'Sobre Presupuesto');
            
            detailsHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h4 style="margin-top: 0; color: #2c3e50;" data-en="Budget vs Actual Summary" data-es="Resumen Presupuesto vs Real">Budget vs Actual Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;" data-en="Total Budgeted" data-es="Total Presupuestado">Total Budgeted</div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">$${totalBudgeted.toFixed(2)} MXN</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;" data-en="Total Actual (Receipts)" data-es="Total Real (Recibos)">Total Actual (Receipts)</div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">$${totalActual.toFixed(2)} MXN</div>
                            </div>
                            <div style="background: ${runningBalance >= 0 ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 8px; border: 2px solid ${balanceColor};">
                                <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Running Balance" data-es="Balance Acumulado">Running Balance</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${balanceColor};">
                                    ${runningBalance >= 0 ? '+' : '-'}$${Math.abs(runningBalance).toFixed(2)} MXN
                                </div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: ${balanceColor}; margin-top: 5px;">
                                    ${balanceStatus}
                                    ${runningBalance >= 0 ? 
                                        (currentLanguage === 'en' ? ' (You overpaid)' : ' (Pagaste de mÃ¡s)') : 
                                        (currentLanguage === 'en' ? ' (Under budget)' : ' (Bajo presupuesto)')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="exportSavedBudget(${budgetId})" data-en="Export This Budget" data-es="Exportar Este Presupuesto">Export This Budget</button>
                        <button class="btn btn-info" onclick="printSavedBudget(${budgetId})" style="background: #17a2b8; color: white;" data-en="Print" data-es="Imprimir">Print</button>
                        <button class="btn btn-danger" onclick="deleteSavedBudget(${budgetId})" data-en="Delete Budget" data-es="Eliminar Presupuesto">Delete Budget</button>
                        <button class="btn btn-primary" onclick="document.getElementById('reportType').value='savedBudgets'; loadReport();" 
                                data-en="Back to List" data-es="Volver a la Lista">Back to List</button>
                    </div>
                </div>
            `;
            
                // Switch to Reports tab and set report type to savedBudgets
                switchTab('reports');
                
                // Ensure budget reports section is visible
                setTimeout(() => {
                    switchReportType('budget');
                    
                    // Wait a moment for tab switch to complete, then set content
                    setTimeout(() => {
                        const reportContent = document.getElementById('reportContent');
                        if (reportContent) {
                            reportContent.innerHTML = detailsHTML;
                            updateLanguage();
                        }
                        
                        const reportTypeSelect = document.getElementById('reportType');
                        if (reportTypeSelect) {
                            reportTypeSelect.value = 'savedBudgets';
                        }
                    }, 200);
                }, 100);
            } catch (error) {
                console.error('Error in viewSavedBudget:', error);
                alert(currentLanguage === 'en' 
                    ? 'Error loading budget details: ' + error.message 
                    : 'Error al cargar detalles del presupuesto: ' + error.message);
            }
        }

        function addReceiptToSavedBudgetItem(budgetId, itemIndex) {
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget || !budget.items || !budget.items[itemIndex]) {
                alert(currentLanguage === 'en' ? 'Item not found' : 'ArtÃ­culo no encontrado');
                return;
            }
            
            const item = budget.items[itemIndex];
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            
            // Create modal for adding receipt
            const modalHTML = `
                <div id="addReceiptModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; margin: 50px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; color: #2c3e50;" data-en="Add Receipt" data-es="Agregar Recibo">Add Receipt</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">
                            <strong data-en="Item:" data-es="ArtÃ­culo:">Item:</strong> ${itemName}<br>
                            <strong data-en="Budgeted Amount:" data-es="Monto Presupuestado:">Budgeted Amount:</strong> $${(item.totalPrice || 0).toFixed(2)} MXN
                        </p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;" data-en="Receipt/Invoice (Image, PDF, or Excel)" data-es="Recibo/Factura (Imagen, PDF o Excel)">Receipt/Invoice (Image, PDF, or Excel)</label>
                            <input type="file" id="savedBudgetReceiptPhoto" accept="image/*,.pdf,.xlsx,.xls" onchange="uploadSavedBudgetReceiptPhoto(this)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <small style="color: #7f8c8d; display: block; margin-top: 5px;" data-en="Upload image, PDF, or Excel file (Note: Large files may cause storage issues. Consider compressing PDFs or using smaller images.)" data-es="Sube imagen, PDF o archivo Excel (Nota: Los archivos grandes pueden causar problemas de almacenamiento. Considera comprimir PDFs o usar imÃ¡genes mÃ¡s pequeÃ±as.)">Upload image, PDF, or Excel file (Note: Large files may cause storage issues. Consider compressing PDFs or using smaller images.)</small>
                            <div id="savedBudgetPhotoPreview" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600;" data-en="Receipt Amount (MXN)" data-es="Monto del Recibo (MXN)">Receipt Amount (MXN)</label>
                            <input type="number" id="savedBudgetReceiptAmount" step="0.01" min="0" placeholder="0.00" value="${item.receiptAmount || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <small style="color: #7f8c8d; display: block; margin-top: 5px;" data-en="Enter the exact amount shown on the receipt" data-es="Ingresa el monto exacto que aparece en el recibo">Enter the exact amount shown on the receipt</small>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button class="btn btn-success" onclick="saveReceiptToSavedBudgetItem(${budgetId}, ${itemIndex})" style="flex: 1;" data-en="Save Receipt" data-es="Guardar Recibo">Save Receipt</button>
                            <button class="btn btn-secondary" onclick="closeAddReceiptModal()" style="flex: 1;" data-en="Cancel" data-es="Cancelar">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('addReceiptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            updateLanguage();
            
            // Store photo data temporarily
            window.savedBudgetReceiptPhotoData = null;
        }

        function uploadSavedBudgetReceiptPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type (images, PDF, Excel)
            const validTypes = ['image/', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            const isValidType = validTypes.some(type => file.type.startsWith(type)) || 
                               file.name.toLowerCase().endsWith('.pdf') || 
                               file.name.toLowerCase().endsWith('.xlsx') || 
                               file.name.toLowerCase().endsWith('.xls');
            
            if (!isValidType) {
                alert(currentLanguage === 'en' ? 'Please select an image, PDF, or Excel file' : 'Por favor selecciona una imagen, PDF o archivo Excel');
                return;
            }
            
            // Validate file size (max 25MB for PDF/Excel, 10MB for images)
            const maxSize = file.type.startsWith('image/') ? 10 * 1024 * 1024 : 25 * 1024 * 1024;
            if (file.size > maxSize) {
                const maxSizeMB = maxSize / (1024 * 1024);
                alert(currentLanguage === 'en' ? `File size must be less than ${maxSizeMB}MB` : `El tamaÃ±o del archivo debe ser menor a ${maxSizeMB}MB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('savedBudgetPhotoPreview');
                const fileType = file.type;
                const fileName = file.name;
                
                let previewHTML = '';
                if (fileType.startsWith('image/')) {
                    previewHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">`;
                } else if (fileType === 'application/pdf' || fileName.toLowerCase().endsWith('.pdf')) {
                    previewHTML = `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ“„</div>
                            <div style="font-weight: 600; color: #2c3e50;">${fileName}</div>
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 5px;">PDF Document</div>
                        </div>
                    `;
                } else if (fileType.includes('excel') || fileType.includes('spreadsheet') || fileName.toLowerCase().endsWith('.xlsx') || fileName.toLowerCase().endsWith('.xls')) {
                    previewHTML = `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ“Š</div>
                            <div style="font-weight: 600; color: #2c3e50;">${fileName}</div>
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 5px;">Excel Spreadsheet</div>
                        </div>
                    `;
                }
                
                preview.innerHTML = previewHTML;
                
                // Store the file data
                window.savedBudgetReceiptPhotoData = e.target.result;
                window.savedBudgetReceiptFileName = fileName;
                window.savedBudgetReceiptFileType = fileType;
            };
            reader.readAsDataURL(file);
        }

        async function saveReceiptToSavedBudgetItem(budgetId, itemIndex) {
            // Use sync version for immediate access, then update Supabase if needed
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget || !budget.items || !budget.items[itemIndex]) {
                alert(currentLanguage === 'en' ? 'Item not found' : 'ArtÃ­culo no encontrado');
                return;
            }
            
            const receiptAmount = document.getElementById('savedBudgetReceiptAmount').value ? 
                parseFloat(document.getElementById('savedBudgetReceiptAmount').value) : null;
            const receiptPhoto = window.savedBudgetReceiptPhotoData || budget.items[itemIndex].invoicePhoto;
            
            // Check file size before saving (base64 is ~33% larger than original)
            if (receiptPhoto && window.savedBudgetReceiptPhotoData) {
                const base64Size = receiptPhoto.length;
                const estimatedOriginalSize = (base64Size * 3) / 4; // Approximate original size
                
                // Warn if file is very large (over 2MB original size)
                if (estimatedOriginalSize > 2 * 1024 * 1024) {
                    const sizeMB = (estimatedOriginalSize / (1024 * 1024)).toFixed(1);
                    const proceed = confirm(
                        currentLanguage === 'en' 
                            ? `Warning: This file is approximately ${sizeMB}MB. Large files may cause storage issues. Continue anyway?`
                            : `Advertencia: Este archivo es aproximadamente ${sizeMB}MB. Los archivos grandes pueden causar problemas de almacenamiento. Â¿Continuar de todos modos?`
                    );
                    if (!proceed) {
                        return;
                    }
                }
            }
            
            // Update the item
            if (receiptPhoto) {
                budget.items[itemIndex].invoicePhoto = receiptPhoto;
                if (window.savedBudgetReceiptFileName) budget.items[itemIndex].invoiceFileName = window.savedBudgetReceiptFileName;
                if (window.savedBudgetReceiptFileType) budget.items[itemIndex].invoiceFileType = window.savedBudgetReceiptFileType;
            }
            if (receiptAmount !== null) {
                budget.items[itemIndex].receiptAmount = receiptAmount;
            }
            
            // Save to localStorage
            try {
                localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.code === 22) {
                    // Storage quota exceeded - offer to save without file
                    const saveWithoutFile = confirm(
                        currentLanguage === 'en' 
                            ? 'Storage limit exceeded! The file is too large to save.\n\nWould you like to save only the receipt amount without the file?\n\n(Click OK to save amount only, Cancel to try a smaller file)'
                            : 'Â¡LÃ­mite de almacenamiento excedido! El archivo es demasiado grande para guardar.\n\nÂ¿Te gustarÃ­a guardar solo el monto del recibo sin el archivo?\n\n(Haz clic en Aceptar para guardar solo el monto, Cancelar para intentar con un archivo mÃ¡s pequeÃ±o)'
                    );
                    
                    if (saveWithoutFile) {
                        // Save without the file
                        budget.items[itemIndex].invoicePhoto = null;
                        budget.items[itemIndex].invoiceFileName = null;
                        budget.items[itemIndex].invoiceFileType = null;
                        
                        // Try saving again without the file
                        try {
                            localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
                            
                            // Save to Supabase if using Supabase
                            if (useSupabase && currentUser) {
                                try {
                                    await updateSavedBudgetInSupabase(budget);
                                } catch (error) {
                                    console.error('Error saving receipt amount to Supabase:', error);
                                }
                            }
                            
                            // Log activity
                            const itemName = currentLanguage === 'en' ? budget.items[itemIndex].nameEn : budget.items[itemIndex].nameEs;
                            logActivity('update', `${currentLanguage === 'en' ? 'Added receipt amount to saved budget item (file too large)' : 'Monto de recibo agregado a artÃ­culo de presupuesto guardado (archivo demasiado grande)'}: ${itemName} (${budget.weekLabel})`, null);
                            
                            // Close modal
                            closeAddReceiptModal();
                            
                            // Reload the saved budget view
                            viewSavedBudget(budgetId);
                            
                            showApprovalStatus('warning', currentLanguage === 'en' 
                                ? 'Receipt amount saved, but file was too large to store. Please keep the file separately.' 
                                : 'Monto del recibo guardado, pero el archivo era demasiado grande para almacenar. Por favor guarda el archivo por separado.');
                            return;
                        } catch (error2) {
                            alert(
                                currentLanguage === 'en' 
                                    ? 'Still too large! Please delete some old saved budgets or use a smaller file.'
                                    : 'Â¡AÃºn es demasiado grande! Por favor elimina algunos presupuestos guardados antiguos o usa un archivo mÃ¡s pequeÃ±o.'
                            );
                            return;
                        }
                    } else {
                        return; // User cancelled
                    }
                } else {
                    alert(
                        currentLanguage === 'en' 
                            ? 'Error saving receipt: ' + error.message
                            : 'Error al guardar recibo: ' + error.message
                    );
                    return;
                }
            }
            
            // Save to Supabase if using Supabase
            if (useSupabase && currentUser) {
                try {
                    // Update the budget in Supabase
                    await updateSavedBudgetInSupabase(budget);
                } catch (error) {
                    console.error('Error saving receipt to Supabase:', error);
                    showApprovalStatus('warning', currentLanguage === 'en' 
                        ? 'Receipt saved locally, but there was an error saving to cloud. Please try again later.' 
                        : 'Recibo guardado localmente, pero hubo un error al guardar en la nube. Por favor intenta de nuevo mÃ¡s tarde.');
                }
            }
            
            // Save was successful - proceed with normal flow
            // Log activity
            const itemName = currentLanguage === 'en' ? budget.items[itemIndex].nameEn : budget.items[itemIndex].nameEs;
            logActivity('update', `${currentLanguage === 'en' ? 'Added receipt to saved budget item' : 'Recibo agregado a artÃ­culo de presupuesto guardado'}: ${itemName} (${budget.weekLabel})`, null);
            
            // Close modal
            closeAddReceiptModal();
            
            // Reload the saved budget view
            viewSavedBudget(budgetId);
            
            // Show success message
            showApprovalStatus('success', currentLanguage === 'en' 
                ? 'Receipt added successfully!' 
                : 'Â¡Recibo agregado exitosamente!');
        }

        function closeAddReceiptModal() {
            const modal = document.getElementById('addReceiptModal');
            if (modal) {
                modal.remove();
            }
            window.savedBudgetReceiptPhotoData = null;
        }

        function viewReceiptPhoto(photoData, fileType = 'image', fileName = '') {
            // Create modal to view receipt (image, PDF, or download Excel)
            let modalHTML = '';
            
            if (fileType === 'pdf') {
                // For PDF, embed it
                modalHTML = `
                    <div id="viewReceiptModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; overflow-y: auto;">
                        <div style="padding: 20px; max-width: 95%; margin: 20px auto;">
                            <button onclick="closeViewReceiptModal()" style="position: fixed; top: 20px; right: 20px; background: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; z-index: 10002;">Ã—</button>
                            <iframe src="${photoData}" style="width: 100%; height: 90vh; border: none; border-radius: 8px; background: white;"></iframe>
                        </div>
                    </div>
                `;
            } else if (fileType === 'excel') {
                // For Excel, provide download link
                modalHTML = `
                    <div id="viewReceiptModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; overflow-y: auto;">
                        <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; margin: 100px auto; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <button onclick="closeViewReceiptModal()" style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; padding: 5px 15px; cursor: pointer; font-size: 24px; font-weight: bold;">Ã—</button>
                            <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ“Š</div>
                            <h3 style="margin-top: 0; color: #2c3e50;">${fileName || 'Excel File'}</h3>
                            <p style="color: #7f8c8d; margin-bottom: 30px;">${currentLanguage === 'en' ? 'Click the button below to download the Excel file' : 'Haz clic en el botÃ³n de abajo para descargar el archivo Excel'}</p>
                            <a href="${photoData}" download="${fileName || 'receipt.xlsx'}" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; text-decoration: none; display: inline-block;">
                                ${currentLanguage === 'en' ? 'Download Excel File' : 'Descargar Archivo Excel'}
                            </a>
                        </div>
                    </div>
                `;
            } else {
                // For images, show full size
                modalHTML = `
                    <div id="viewReceiptModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; overflow-y: auto; text-align: center;">
                        <div style="padding: 20px; max-width: 90%; margin: 20px auto;">
                            <button onclick="closeViewReceiptModal()" style="position: absolute; top: 20px; right: 20px; background: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">Ã—</button>
                            <img src="${photoData}" style="max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(255,255,255,0.1);">
                        </div>
                    </div>
                `;
            }
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewReceiptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeViewReceiptModal() {
            const modal = document.getElementById('viewReceiptModal');
            if (modal) {
                modal.remove();
            }
        }

        async         function printSavedBudget(budgetId) {
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget) {
                alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                return;
            }

            const isPartial = budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment');
            const savedDate = new Date(budget.savedDate);
            const dateStr = savedDate.toLocaleDateString();
            const timeStr = savedDate.toLocaleTimeString();

            // Create print-friendly HTML
            let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${isPartial ? (currentLanguage === 'en' ? 'Partial Payment' : 'Pago Parcial') : (currentLanguage === 'en' ? 'Budget' : 'Presupuesto')} - ${budget.weekLabel}</title>
                    <style>
                        @media print {
                            @page {
                                margin: 1cm;
                            }
                            body {
                                margin: 0;
                                padding: 20px;
                            }
                            .no-print {
                                display: none !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            color: #000;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .header {
                            border-bottom: 3px solid #2c3e50;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            color: #2c3e50;
                            font-size: 24px;
                        }
                        .header .badge {
                            display: inline-block;
                            background: #3498db;
                            color: white;
                            padding: 5px 15px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                            margin-top: 10px;
                        }
                        .summary {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                            margin: 20px 0;
                            padding: 15px;
                            background: #f8f9fa;
                            border-radius: 8px;
                        }
                        .summary-item {
                            text-align: center;
                        }
                        .summary-label {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .summary-value {
                            font-size: 18px;
                            font-weight: 600;
                            color: #2c3e50;
                        }
                        .summary-value.total {
                            color: #27ae60;
                            font-size: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th {
                            background: #2c3e50;
                            color: white;
                            padding: 10px;
                            text-align: left;
                            font-size: 12px;
                            font-weight: 600;
                        }
                        td {
                            padding: 8px 10px;
                            border-bottom: 1px solid #ddd;
                            font-size: 12px;
                        }
                        tr:nth-child(even) {
                            background: #f8f9fa;
                        }
                        .total-row {
                            font-weight: 600;
                            background: #e8f4fd !important;
                            border-top: 2px solid #2c3e50;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            font-size: 11px;
                            color: #666;
                            text-align: center;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${budget.weekLabel}</h1>
                        ${isPartial ? '<div class="badge">' + (currentLanguage === 'en' ? 'PARTIAL PAYMENT' : 'PAGO PARCIAL') + '</div>' : ''}
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            ${currentLanguage === 'en' ? 'Date:' : 'Fecha:'} ${dateStr} ${timeStr}
                        </div>
                    </div>

                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-label">${currentLanguage === 'en' ? 'Total Amount' : 'Monto Total'}</div>
                            <div class="summary-value total">$${budget.total.toLocaleString('es-MX')} MXN</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${currentLanguage === 'en' ? 'Total Items' : 'Total de ArtÃ­culos'}</div>
                            <div class="summary-value">${budget.itemCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${currentLanguage === 'en' ? 'Approved' : 'Aprobados'}</div>
                            <div class="summary-value">${budget.approvedCount || 0}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${currentLanguage === 'en' ? 'Pending' : 'Pendientes'}</div>
                            <div class="summary-value">${budget.pendingCount || 0}</div>
                        </div>
                    </div>

                    <h3 style="color: #2c3e50; margin: 20px 0 10px 0;">${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>${currentLanguage === 'en' ? 'Item' : 'ArtÃ­culo'}</th>
                                <th>${currentLanguage === 'en' ? 'Category' : 'CategorÃ­a'}</th>
                                <th style="text-align: right;">${currentLanguage === 'en' ? 'Qty' : 'Cant'}</th>
                                <th style="text-align: right;">${currentLanguage === 'en' ? 'Unit Price' : 'Precio Unitario'}</th>
                                <th style="text-align: right;">${currentLanguage === 'en' ? 'Total' : 'Total'}</th>
                                <th>${currentLanguage === 'en' ? 'Status' : 'Estado'}</th>
                                ${isPartial ? '' : '<th>' + (currentLanguage === 'en' ? 'Date Approved' : 'Fecha Aprobado') + '</th>'}
                                <th>${currentLanguage === 'en' ? 'Notes' : 'Notas'}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let grandTotal = 0;
            budget.items.forEach(item => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const itemName = currentLanguage === 'en' ? (item.nameEn || item.name) : (item.nameEs || item.name);
                const status = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'denied' ? 'Denied' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'denied' ? 'Rechazado' : 'Pendiente');
                const approvalDate = item.approvalStatus === 'approved' ? (getItemApprovalDate(item.id) || '-') : '-';
                const notes = (item.notes || item.notesEn || item.notesEs || '-').substring(0, 50); // Limit notes length for print
                const total = parseFloat(item.totalPrice || 0);
                grandTotal += total;

                printHTML += `
                    <tr>
                        <td>${itemName}</td>
                        <td>${categoryName}</td>
                        <td style="text-align: right;">${item.quantity || 1}</td>
                        <td style="text-align: right;">$${(item.unitPrice || 0).toLocaleString('es-MX')} MXN</td>
                        <td style="text-align: right;">$${total.toLocaleString('es-MX')} MXN</td>
                        <td>${status}</td>
                        ${isPartial ? '' : `<td>${approvalDate}</td>`}
                        <td>${notes}</td>
                    </tr>
                `;
            });

            printHTML += `
                            <tr class="total-row">
                                <td colspan="${isPartial ? '4' : '5'}" style="text-align: right; font-weight: 600;">${currentLanguage === 'en' ? 'TOTAL:' : 'TOTAL:'}</td>
                                <td style="text-align: right; font-weight: 600;">$${grandTotal.toLocaleString('es-MX')} MXN</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="footer">
                        ${currentLanguage === 'en' ? 'Generated on' : 'Generado el'} ${new Date().toLocaleString()}<br>
                        Budget Manager - Mexico Operations
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            };
        }

        async function exportSavedBudget(budgetId) {
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget) {
                alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                return;
            }
            
            // Show modal to choose export format
            const modalHTML = `
                <div id="exportFormatModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; color: #2c3e50; margin-bottom: 20px;" data-en="Export Budget" data-es="Exportar Presupuesto">Export Budget</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;" data-en="Choose export format:" data-es="Elige el formato de exportaciÃ³n:">Choose export format:</p>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button class="btn btn-danger" onclick="exportSavedBudgetAsPDF(${budgetId}); closeExportFormatModal();" style="width: 100%; padding: 15px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="font-size: 20px;">ðŸ“„</span>
                                <span data-en="Export as PDF" data-es="Exportar como PDF">Export as PDF</span>
                            </button>
                            <button class="btn btn-success" onclick="exportSavedBudgetAsExcel(${budgetId}); closeExportFormatModal();" style="width: 100%; padding: 15px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="font-size: 20px;">ðŸ“Š</span>
                                <span data-en="Export as Excel" data-es="Exportar como Excel">Export as Excel</span>
                            </button>
                            <button class="btn btn-secondary" onclick="closeExportFormatModal();" style="width: 100%; padding: 12px; font-size: 14px;" data-en="Cancel" data-es="Cancelar">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('exportFormatModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            updateLanguage();
        }
        
        function closeExportFormatModal() {
            const modal = document.getElementById('exportFormatModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function exportSavedBudgetAsPDF(budgetId) {
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget) {
                alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.text(currentLanguage === 'en' ? 'Budget Report' : 'Reporte de Presupuesto', 14, 20);
            doc.setFontSize(12);
            doc.text(budget.weekLabel || 'Saved Budget', 14, 30);
            
            if (budget.savedDate) {
                const savedDate = new Date(budget.savedDate);
                doc.text(savedDate.toLocaleDateString(), 14, 37);
            }
            
            // Prepare table data from saved budget items
            const tableData = (budget.items || []).map(item => {
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const supplierName = typeof item.supplier === 'string' ? item.supplier : (item.supplier?.name || '');
                const priorityName = currentLanguage === 'en' ? 
                    (item.priority === 'high' ? 'High' : item.priority === 'medium' ? 'Medium' : 'Low') :
                    (item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Media' : 'Baja');
                const approvalStatus = currentLanguage === 'en' ?
                    (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'rejected' ? 'Rejected' : 'Pending') :
                    (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'rejected' ? 'Rechazado' : 'Pendiente');
                
                // Display name: prefer current language, but fall back to other language if current is empty
                const displayNameForPDF = currentLanguage === 'en' 
                    ? (item.nameEn || item.nameEs || item.name || '') 
                    : (item.nameEs || item.nameEn || item.name || '');
                
                // Get notes: prefer current language, but fall back to other language if current is empty
                const displayNotes = currentLanguage === 'en' 
                    ? (item.notesEn || item.notesEs || item.notes || '') 
                    : (item.notesEs || item.notesEn || item.notes || '');
                
                // Truncate very long notes to prevent table overflow (keep first 100 chars)
                const notesForPDF = displayNotes && displayNotes.length > 100 
                    ? displayNotes.substring(0, 100) + '...' 
                    : (displayNotes || '');
                
                return [
                    displayNameForPDF,
                    categoryName,
                    supplierName,
                    `$${(item.unitPrice || 0).toLocaleString('es-MX')}`,
                    item.quantity || 1,
                    `$${(item.totalPrice || 0).toLocaleString('es-MX')}`,
                    priorityName,
                    approvalStatus,
                    notesForPDF
                ];
            });
            
            // Add table
            doc.autoTable({
                head: [[
                    currentLanguage === 'en' ? 'Item' : 'ArtÃ­culo',
                    currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                    currentLanguage === 'en' ? 'Supplier' : 'Proveedor',
                    currentLanguage === 'en' ? 'Unit Price' : 'Precio Unitario',
                    currentLanguage === 'en' ? 'Qty' : 'Cant',
                    currentLanguage === 'en' ? 'Total' : 'Total',
                    currentLanguage === 'en' ? 'Priority' : 'Prioridad',
                    currentLanguage === 'en' ? 'Status' : 'Estado',
                    currentLanguage === 'en' ? 'Notes' : 'Notas'
                ]],
                body: tableData,
                startY: 50,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: { 
                    fillColor: [102, 126, 234],
                    fontSize: 8
                },
                columnStyles: {
                    8: { // Notes column (0-indexed, so 8 is the 9th column)
                        fontSize: 6,
                        cellWidth: 'wrap'
                    }
                }
            });
            
            // Add summary
            const total = budget.total || (budget.items || []).reduce((sum, item) => sum + (item.totalPrice || 0), 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(currentLanguage === 'en' ? `Total Budget: $${total.toLocaleString('es-MX')} MXN` : 
                `Presupuesto Total: $${total.toLocaleString('es-MX')} MXN`, 14, finalY);
            doc.text(currentLanguage === 'en' ? `Total Items: ${(budget.items || []).length}` : 
                `Total de ArtÃ­culos: ${(budget.items || []).length}`, 14, finalY + 7);
            
            // Save PDF
            const fileName = `budget-${(budget.weekLabel || 'saved-budget').replace(/\s+/g, '-')}.pdf`;
            doc.save(fileName);
            
            // Log activity
            logActivity('export', `${currentLanguage === 'en' ? 'Exported saved budget as PDF' : 'Presupuesto guardado exportado como PDF'}: ${budget.weekLabel}`, null);
        }
        
        function exportSavedBudgetAsExcel(budgetId) {
            const savedBudgets = getAllSavedBudgetsSync();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget) {
                alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                return;
            }
            
            // Temporarily set items to saved budget items for export
            const originalItems = items;
            items = budget.items || [];
            
            // Export using existing Excel export function
            exportToExcel();
            
            // Restore original items
            items = originalItems;
            
            // Log activity
            logActivity('export', `${currentLanguage === 'en' ? 'Exported saved budget as Excel' : 'Presupuesto guardado exportado como Excel'}: ${budget.weekLabel}`, null);
        }

        async function deleteSavedBudget(budgetId) {
            const savedBudgets = await getAllSavedBudgets();
            const budget = savedBudgets.find(b => b.id === budgetId);
            
            if (!budget) {
                alert(currentLanguage === 'en' ? 'Budget not found' : 'Presupuesto no encontrado');
                return;
            }
            
            // Confirm deletion
            const confirmMessage = currentLanguage === 'en' 
                ? `Are you sure you want to delete the budget "${budget.weekLabel}"? This action cannot be undone.`
                : `Â¿EstÃ¡s seguro de que quieres eliminar el presupuesto "${budget.weekLabel}"? Esta acciÃ³n no se puede deshacer.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Delete from Supabase if using it
            if (useSupabase && currentUser) {
                try {
                    // Delete budget items first (foreign key constraint)
                    await supabase
                        .from('saved_budget_items')
                        .delete()
                        .eq('saved_budget_id', budgetId);
                    
                    // Delete the budget
                    const { error } = await supabase
                        .from('saved_budgets')
                        .delete()
                        .eq('id', budgetId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                } catch (error) {
                    console.error('Error deleting budget from Supabase:', error);
                    alert(currentLanguage === 'en' 
                        ? 'Error deleting budget from database: ' + error.message 
                        : 'Error al eliminar presupuesto de la base de datos: ' + error.message);
                    return;
                }
            }
            
            // Remove the budget from localStorage
            const updatedBudgets = savedBudgets.filter(b => b.id !== budgetId);
            localStorage.setItem('savedBudgets', JSON.stringify(updatedBudgets));
            
            // Log activity
            logActivity('delete', `${currentLanguage === 'en' ? 'Deleted saved budget' : 'Presupuesto guardado eliminado'}: ${budget.weekLabel}`, null);
            
            // Show success message
            showApprovalStatus('success', currentLanguage === 'en' 
                ? `Budget "${budget.weekLabel}" deleted successfully.` 
                : `Presupuesto "${budget.weekLabel}" eliminado exitosamente.`);
            
            // Reload the report to reflect the deletion
            await loadReport();
        }

        function generateSummaryReport(dateRange, itemFilter = 'all') {
            let filteredItems = items;
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredItems = items.filter(item => {
                    const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                    return itemKey === itemFilter;
                });
            }
            
            const currentBudget = filteredItems.reduce((sum, item) => sum + item.totalPrice, 0);
            const itemCount = filteredItems.length;
            const categoryCount = new Set(filteredItems.map(item => item.category)).size;
            const supplierCount = new Set(filteredItems.map(item => typeof item.supplier === 'string' ? item.supplier : item.supplier.name)).size;
            
            return `
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 data-en="Current Budget Summary" data-es="Resumen del Presupuesto Actual">Current Budget Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">$${currentBudget.toLocaleString('es-MX')}</div>
                            <div data-en="Total Budget" data-es="Presupuesto Total">Total Budget</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;">${itemCount}</div>
                            <div data-en="Total Items" data-es="Total de ArtÃ­culos">Total Items</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">${categoryCount}</div>
                            <div data-en="Categories" data-es="CategorÃ­as">Categories</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f39c12;">${supplierCount}</div>
                            <div data-en="Suppliers" data-es="Proveedores">Suppliers</div>
                        </div>
                    </div>
                    ${filteredItems.length > 0 ? `
                        <h4 style="margin-top: 30px; margin-bottom: 15px; color: #2c3e50;" data-en="Items" data-es="ArtÃ­culos">Items</h4>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="budget-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;" data-en="Item" data-es="ArtÃ­culo">Item</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;" data-en="Category" data-es="CategorÃ­a">Category</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Quantity" data-es="Cantidad">Quantity</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Unit Price" data-es="Precio Unitario">Unit Price</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;" data-en="Total" data-es="Total">Total</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Status" data-es="Estado">Status</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Date Approved" data-es="Fecha Aprobado">Date Approved</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;" data-en="Days Between Orders" data-es="DÃ­as Entre Ã“rdenes">Days Between Orders</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;" data-en="Notes" data-es="Notas">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredItems.map(item => {
                                        const categoryName = categories[item.category] ? 
                                            (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                                            item.category;
                                        const itemName = currentLanguage === 'en' ? (item.nameEn || item.name) : (item.nameEs || item.name);
                                        const status = currentLanguage === 'en' ?
                                            (item.approvalStatus === 'approved' ? 'Approved' : item.approvalStatus === 'denied' ? 'Denied' : 'Pending') :
                                            (item.approvalStatus === 'approved' ? 'Aprobado' : item.approvalStatus === 'denied' ? 'Rechazado' : 'Pendiente');
                                        const approvalDate = item.approvalStatus === 'approved' ? (getItemApprovalDate(item.id) || '-') : '-';
                                        const notes = item.notes || item.notesEn || item.notesEs || '-';
                                        const statusColor = item.approvalStatus === 'approved' ? '#27ae60' : item.approvalStatus === 'denied' ? '#e74c3c' : '#f39c12';
                                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                                        const daysBetween = getDaysBetweenBudgetOrders(itemKey, item.nameEn || item.name, item.category || 'uncategorized');
                                        let daysInfo = '-';
                                        if (daysBetween) {
                                            if (daysBetween.firstOrder) {
                                                daysInfo = `<span style="color: #95a5a6; font-weight: 600;" title="${currentLanguage === 'en' ? `First order on ${daysBetween.firstOrderDate.toLocaleDateString()}` : `Primera orden el ${daysBetween.firstOrderDate.toLocaleDateString()}`}">
                                                    ${currentLanguage === 'en' ? 'First order' : 'Primera orden'}
                                                </span>`;
                                            } else {
                                                daysInfo = `<span style="color: #3498db; font-weight: 600;" title="${currentLanguage === 'en' ? `Last ordered ${daysBetween.days} days ago (${daysBetween.totalOrders} total orders)` : `Ãšltima orden hace ${daysBetween.days} dÃ­as (${daysBetween.totalOrders} Ã³rdenes totales)`}">
                                                    ${daysBetween.days} ${currentLanguage === 'en' ? 'days' : 'dÃ­as'}
                                                </span>`;
                                            }
                                        }
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #dee2e6;">
                                                <td style="padding: 10px;">${itemName}</td>
                                                <td style="padding: 10px;">${categoryName}</td>
                                                <td style="padding: 10px; text-align: center;">${item.quantity || 1}</td>
                                                <td style="padding: 10px; text-align: right;">$${(item.unitPrice || 0).toLocaleString('es-MX')} MXN</td>
                                                <td style="padding: 10px; text-align: right; font-weight: 600;">$${(item.totalPrice || 0).toLocaleString('es-MX')} MXN</td>
                                                <td style="padding: 10px; text-align: center;">
                                                    <span style="color: ${statusColor}; font-weight: 600;">${status}</span>
                                                </td>
                                                <td style="padding: 10px; text-align: center;">${approvalDate}</td>
                                                <td style="padding: 10px; text-align: center;">${daysInfo}</td>
                                                <td style="padding: 10px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${notes !== '-' ? notes : ''}">${notes}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function generateCategoryReport(dateRange, itemFilter = 'all') {
            const savedBudgets = await getSavedBudgetsByDateRange(dateRange);
            const categoryTotals = {};
            let grandTotal = 0;
            
            // Aggregate from saved budgets (including partial budgets)
            savedBudgets.forEach(budget => {
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        // Filter by item if specified
                        if (itemFilter && itemFilter !== 'all') {
                            const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                            if (itemKey !== itemFilter) {
                                return; // Skip this item if it doesn't match the filter
                            }
                        }
                        
                        if (!categoryTotals[item.category]) {
                            categoryTotals[item.category] = 0;
                        }
                        categoryTotals[item.category] += item.totalPrice;
                        grandTotal += item.totalPrice;
                    });
                }
            });
            
            // If no saved budgets, use current items
            if (savedBudgets.length === 0) {
                let filteredItems = items;
                
                // Filter by item if specified
                if (itemFilter && itemFilter !== 'all') {
                    filteredItems = items.filter(item => {
                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        return itemKey === itemFilter;
                    });
                }
                
                filteredItems.forEach(item => {
                    if (!categoryTotals[item.category]) {
                        categoryTotals[item.category] = 0;
                    }
                    categoryTotals[item.category] += item.totalPrice;
                    grandTotal += item.totalPrice;
                });
            }
            
            let reportHTML = '<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><h3 data-en="Spending by Category" data-es="Gastos por CategorÃ­a">Spending by Category</h3>';
            
            const totalBudget = grandTotal;
            Object.keys(categoryTotals).forEach(category => {
                const categoryName = categories[category] ? (currentLanguage === 'en' ? categories[category].nameEn : categories[category].nameEs) : category;
                const total = categoryTotals[category];
                const percentage = totalBudget > 0 ? ((total / totalBudget) * 100).toFixed(1) : 0;
                
                reportHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${categoryName}</strong>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${percentage}% of total budget</div>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">$${total.toLocaleString('es-MX')} MXN</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += '</div>';
            return reportHTML;
        }

        async function generateSupplierReport(dateRange, itemFilter = 'all') {
            const savedBudgets = await getSavedBudgetsByDateRange(dateRange);
            const supplierTotals = {};
            let grandTotal = 0;
            
            // Aggregate from saved budgets (including partial budgets)
            savedBudgets.forEach(budget => {
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        // Filter by item if specified
                        if (itemFilter && itemFilter !== 'all') {
                            const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                            if (itemKey !== itemFilter) {
                                return; // Skip this item if it doesn't match the filter
                            }
                        }
                        
                        const supplierName = typeof item.supplier === 'string' ? item.supplier : (item.supplier?.name || 'Unknown');
                        if (!supplierTotals[supplierName]) {
                            supplierTotals[supplierName] = 0;
                        }
                        supplierTotals[supplierName] += item.totalPrice;
                        grandTotal += item.totalPrice;
                    });
                }
            });
            
            // If no saved budgets, use current items
            if (savedBudgets.length === 0) {
                let filteredItems = items;
                
                // Filter by item if specified
                if (itemFilter && itemFilter !== 'all') {
                    filteredItems = items.filter(item => {
                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        return itemKey === itemFilter;
                    });
                }
                
                filteredItems.forEach(item => {
                    const supplierName = typeof item.supplier === 'string' ? item.supplier : (item.supplier?.name || 'Unknown');
                    if (!supplierTotals[supplierName]) {
                        supplierTotals[supplierName] = 0;
                    }
                    supplierTotals[supplierName] += item.totalPrice;
                    grandTotal += item.totalPrice;
                });
            }
            
            let reportHTML = '<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><h3 data-en="Spending by Supplier" data-es="Gastos por Proveedor">Spending by Supplier</h3>';
            
            const totalBudget = grandTotal;
            Object.keys(supplierTotals).sort((a, b) => supplierTotals[b] - supplierTotals[a]).forEach(supplier => {
                const total = supplierTotals[supplier];
                const percentage = totalBudget > 0 ? ((total / totalBudget) * 100).toFixed(1) : 0;
                
                reportHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${supplier}</strong>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${percentage}% of total budget</div>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">$${total.toLocaleString('es-MX')} MXN</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += '</div>';
            return reportHTML;
        }

        async function generatePriorityReport(dateRange, itemFilter = 'all') {
            const savedBudgets = await getSavedBudgetsByDateRange(dateRange);
            const priorityTotals = { high: 0, medium: 0, low: 0 };
            const priorityCounts = { high: 0, medium: 0, low: 0 };
            let grandTotal = 0;
            
            // Aggregate from saved budgets (including partial budgets)
            savedBudgets.forEach(budget => {
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        // Filter by item if specified
                        if (itemFilter && itemFilter !== 'all') {
                            const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                            if (itemKey !== itemFilter) {
                                return; // Skip this item if it doesn't match the filter
                            }
                        }
                        
                        const priority = item.priority || 'medium';
                        priorityTotals[priority] += item.totalPrice;
                        priorityCounts[priority]++;
                        grandTotal += item.totalPrice;
                    });
                }
            });
            
            // If no saved budgets, use current items
            if (savedBudgets.length === 0) {
                let filteredItems = items;
                
                // Filter by item if specified
                if (itemFilter && itemFilter !== 'all') {
                    filteredItems = items.filter(item => {
                        const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                        return itemKey === itemFilter;
                    });
                }
                
                filteredItems.forEach(item => {
                    const priority = item.priority || 'medium';
                    priorityTotals[priority] += item.totalPrice;
                    priorityCounts[priority]++;
                    grandTotal += item.totalPrice;
                });
            }
            
            let reportHTML = '<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><h3 data-en="Spending by Priority" data-es="Gastos por Prioridad">Spending by Priority</h3>';
            
            const totalBudget = grandTotal;
            ['high', 'medium', 'low'].forEach(priority => {
                const total = priorityTotals[priority];
                const count = priorityCounts[priority];
                const percentage = totalBudget > 0 ? ((total / totalBudget) * 100).toFixed(1) : 0;
                const priorityName = currentLanguage === 'en' ? 
                    (priority === 'high' ? 'High' : priority === 'medium' ? 'Medium' : 'Low') :
                    (priority === 'high' ? 'Alta' : priority === 'medium' ? 'Media' : 'Baja');
                
                const color = priority === 'high' ? '#e74c3c' : priority === 'medium' ? '#f39c12' : '#27ae60';
                
                reportHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${priorityName} Priority</strong>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${count} items â€¢ ${percentage}% of total budget</div>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">$${total.toLocaleString('es-MX')} MXN</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += '</div>';
            return reportHTML;
        }

        function generateHistoricalReport(dateRange, itemFilter = 'all') {
            // For now, show current budget as historical data
            // In a real app, you'd store historical budget data
            return `
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 data-en="Historical Trends" data-es="Tendencias HistÃ³ricas">Historical Trends</h3>
                    <p data-en="Historical data tracking will be available as you create more budgets over time." data-es="El seguimiento de datos histÃ³ricos estarÃ¡ disponible a medida que crees mÃ¡s presupuestos con el tiempo.">Historical data tracking will be available as you create more budgets over time.</p>
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ“Š</div>
                        <p data-en="Create and save multiple budgets to see trends and patterns over time." data-es="Crea y guarda mÃºltiples presupuestos para ver tendencias y patrones a lo largo del tiempo.">Create and save multiple budgets to see trends and patterns over time.</p>
                    </div>
                </div>
            `;
        }

        async function generateItemAnalysisReport(dateRange, itemFilter = 'all') {
            let filteredItems = items;
            
            // Filter by item if specified
            if (itemFilter && itemFilter !== 'all') {
                filteredItems = items.filter(item => {
                    const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                    return itemKey === itemFilter;
                });
            }
            
            // Collect all items including from saved budgets (including partial budgets)
            const savedBudgets = await getSavedBudgetsByDateRange(dateRange);
            const allItems = [...filteredItems];
            
            savedBudgets.forEach(budget => {
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        // Filter by item if specified
                        if (itemFilter === 'all') {
                            allItems.push(item);
                        } else {
                            const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                            if (itemKey === itemFilter) {
                                allItems.push(item);
                            }
                        }
                    });
                }
            });
            
            const itemAnalysis = {};
            allItems.forEach(item => {
                const itemKey = `${item.nameEn || item.name}_${item.category || 'uncategorized'}`;
                const itemName = currentLanguage === 'en' ? (item.nameEn || item.name) : (item.nameEs || item.name);
                
                if (!itemAnalysis[itemKey]) {
                    itemAnalysis[itemKey] = {
                        itemName: itemName,
                        nameEn: item.nameEn || item.name,
                        nameEs: item.nameEs || item.name,
                        totalSpent: 0,
                        quantity: 0,
                        unitPrice: item.unitPrice,
                        category: item.category,
                        supplier: typeof item.supplier === 'string' ? item.supplier : (item.supplier?.name || ''),
                        approvalDates: [],
                        notes: []
                    };
                }
                itemAnalysis[itemKey].totalSpent += item.totalPrice;
                itemAnalysis[itemKey].quantity += item.quantity;
                
                // Get approval date if item is approved
                if (item.approvalStatus === 'approved') {
                    const approvalDate = getItemApprovalDate(item.id);
                    if (approvalDate && !itemAnalysis[itemKey].approvalDates.includes(approvalDate)) {
                        itemAnalysis[itemKey].approvalDates.push(approvalDate);
                    }
                }
                
                // Collect notes
                const notes = item.notes || item.notesEn || item.notesEs;
                if (notes && notes.trim() !== '' && notes !== '(none)' && !itemAnalysis[itemKey].notes.includes(notes)) {
                    itemAnalysis[itemKey].notes.push(notes);
                }
            });
            
            if (Object.keys(itemAnalysis).length === 0) {
                return `<div class="alert alert-info" style="padding: 20px; text-align: center;">
                    <p data-en="No items found" data-es="No se encontraron artÃ­culos">No items found</p>
                </div>`;
            }
            
            let reportHTML = '<div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><h3 data-en="Item Analysis" data-es="AnÃ¡lisis de ArtÃ­culos">Item Analysis</h3>';
            
            Object.keys(itemAnalysis).sort((a, b) => itemAnalysis[b].totalSpent - itemAnalysis[a].totalSpent).forEach(itemKey => {
                const analysis = itemAnalysis[itemKey];
                const categoryName = categories[analysis.category] ? (currentLanguage === 'en' ? categories[analysis.category].nameEn : categories[analysis.category].nameEs) : analysis.category;
                
                reportHTML += `
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>${analysis.itemName}</strong>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${categoryName}${analysis.supplier ? ' â€¢ ' + analysis.supplier : ''}</div>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">$${analysis.totalSpent.toLocaleString('es-MX')} MXN</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem; margin-bottom: 10px;">
                            <div><strong data-en="Quantity:" data-es="Cantidad:">Quantity:</strong> ${analysis.quantity}</div>
                            <div><strong data-en="Unit Price:" data-es="Precio Unitario:">Unit Price:</strong> $${analysis.unitPrice.toLocaleString('es-MX')} MXN</div>
                            ${analysis.approvalDates.length > 0 ? `<div><strong data-en="Date Approved:" data-es="Fecha Aprobado:">Date Approved:</strong> ${analysis.approvalDates.join(', ')}</div>` : ''}
                        </div>
                        ${analysis.notes.length > 0 ? `<div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px; border-left: 3px solid #3498db;">
                            <strong data-en="Notes:" data-es="Notas:">Notes:</strong>
                            <div style="margin-top: 5px; font-size: 0.9rem; color: #555;">
                                ${analysis.notes.map(note => `<div style="margin: 5px 0;">â€¢ ${note}</div>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            });
            
            reportHTML += '</div>';
            return reportHTML;
        }

        // Budget Approval Functions

        function showApprovalStatus(type, message) {
            const statusDiv = document.getElementById('approvalStatus');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Persistent Duties/Taxes Alert System
        function checkForDutiesAlerts() {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const acceptedAlerts = JSON.parse(localStorage.getItem('acceptedDutiesAlerts')) || {};
            
            let dutiesShipments = [];
            
            // Find all shipments with duties due that haven't been accepted
            for (const request of history) {
                if (request.trackingShipments && request.trackingShipments.length > 0) {
                    for (const shipment of request.trackingShipments) {
                        if (shipment.upsHasDutiesDue) {
                            const alertKey = `${request.id}_${shipment.trackingNumber}`;
                            if (!acceptedAlerts[alertKey]) {
                                dutiesShipments.push({
                                    requestId: request.id,
                                    requestDate: request.date || request.sentDate,
                                    trackingNumber: shipment.trackingNumber,
                                    dutiesAmount: shipment.upsDutiesAmount || '',
                                    status: shipment.upsStatus || '',
                                    alertKey: alertKey
                                });
                            }
                        }
                    }
                }
            }
            
            if (dutiesShipments.length > 0) {
                showDutiesAlert(dutiesShipments);
            } else {
                hideDutiesAlert();
            }
        }

        function showDutiesAlert(shipments) {
            const banner = document.getElementById('dutiesAlertBanner');
            const details = document.getElementById('dutiesAlertDetails');
            
            if (!banner || !details) return;
            
            // Build alert message
            const count = shipments.length;
            const message = currentLanguage === 'en' ?
                `${count} shipment${count > 1 ? 's' : ''} require${count > 1 ? '' : 's'} payment of duties/taxes. Click 'Accept & View' to see details and proceed with payment.` :
                `${count} envÃ­o${count > 1 ? 's' : ''} requiere${count > 1 ? 'n' : ''} pago de impuestos/aranceles. Haz clic en 'Aceptar y Ver' para ver los detalles y proceder con el pago.`;
            
            details.textContent = message;
            
            // Store shipments for navigation
            banner.dataset.shipments = JSON.stringify(shipments);
            
            // Show banner
            banner.style.display = 'block';
            document.body.classList.add('has-duties-alert');
            
            // Update language on banner elements
            updateLanguage();
        }

        function hideDutiesAlert() {
            const banner = document.getElementById('dutiesAlertBanner');
            if (banner) {
                banner.style.display = 'none';
                document.body.classList.remove('has-duties-alert');
            }
        }

        function acceptDutiesAlert() {
            const banner = document.getElementById('dutiesAlertBanner');
            if (!banner || !banner.dataset.shipments) return;
            
            const shipments = JSON.parse(banner.dataset.shipments);
            const acceptedAlerts = JSON.parse(localStorage.getItem('acceptedDutiesAlerts')) || {};
            
            // Mark all shipments as accepted
            shipments.forEach(shipment => {
                acceptedAlerts[shipment.alertKey] = {
                    acceptedAt: new Date().toISOString(),
                    requestId: shipment.requestId,
                    trackingNumber: shipment.trackingNumber
                };
            });
            
            localStorage.setItem('acceptedDutiesAlerts', JSON.stringify(acceptedAlerts));
            
            // Hide banner
            hideDutiesAlert();
            
            // Navigate to Canada tab and filter to show duties
            switchTab('canada');
            
            // Set filter to duties
            setTimeout(() => {
                const filterSelect = document.getElementById('canadaHistoryFilter');
                if (filterSelect) {
                    filterSelect.value = 'duties';
                    loadCanadaHistory();
                }
                
                // Scroll to first shipment with duties
                setTimeout(() => {
                    const firstShipment = shipments[0];
                    if (firstShipment) {
                        const requestElement = document.querySelector(`[data-request-id="${firstShipment.requestId}"]`);
                        if (requestElement) {
                            requestElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Highlight the element briefly
                            requestElement.style.transition = 'background-color 0.3s';
                            requestElement.style.backgroundColor = '#fff3cd';
                            setTimeout(() => {
                                requestElement.style.backgroundColor = '';
                            }, 3000);
                        }
                    }
                }, 500);
            }, 100);
        }

        function dismissDutiesAlert() {
            const banner = document.getElementById('dutiesAlertBanner');
            if (!banner || !banner.dataset.shipments) return;
            
            const shipments = JSON.parse(banner.dataset.shipments);
            const acceptedAlerts = JSON.parse(localStorage.getItem('acceptedDutiesAlerts')) || {};
            
            // Mark all shipments as dismissed (accepted but not viewed)
            shipments.forEach(shipment => {
                acceptedAlerts[shipment.alertKey] = {
                    dismissedAt: new Date().toISOString(),
                    requestId: shipment.requestId,
                    trackingNumber: shipment.trackingNumber,
                    dismissed: true
                };
            });
            
            localStorage.setItem('acceptedDutiesAlerts', JSON.stringify(acceptedAlerts));
            
            // Hide banner
            hideDutiesAlert();
        }

        // Request Review Function - Sends email to mike@oolab.com
        function requestReview() {
            if (items.length === 0) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'No items in budget to review. Please add items first.' : 
                    'No hay artÃ­culos en el presupuesto para revisar. Por favor agrega artÃ­culos primero.');
                return;
            }
            
            // Calculate budget summary
            const total = items.reduce((sum, item) => sum + item.totalPrice, 0);
            const approvedCount = items.filter(item => item.approvalStatus === 'approved').length;
            const pendingCount = items.filter(item => !item.approvalStatus || item.approvalStatus === 'pending').length;
            const today = new Date();
            const weekLabel = getWeekLabel(today);
            
            // Get current page URL (budget link)
            const budgetLink = window.location.href;
            
            // Create email content
            const emailSubject = `Budget Review Request - ${weekLabel}`;
            const emailMessage = `
Hello Mike,

A budget review has been requested for the week of ${weekLabel}.

Budget Summary:
- Total Items: ${items.length}
- Approved Items: ${approvedCount}
- Pending Items: ${pendingCount}
- Total Budget: $${total.toLocaleString('es-MX')} MXN

Please review the budget by clicking the link below:
${budgetLink}

Thank you,
Budget Manager System
            `.trim();
            
            // Try EmailJS first (if configured), otherwise fall back to mailto
            // To use EmailJS: Sign up at https://www.emailjs.com/, create a service and template
            // Then uncomment and configure the EmailJS code below
            
            // EmailJS Configuration (uncomment and configure after setting up EmailJS account)
            /*
            emailjs.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS public key
            
            const templateParams = {
                to_email: 'mike@oolab.com',
                subject: emailSubject,
                message: emailMessage,
                budget_link: budgetLink,
                week_label: weekLabel,
                total_items: items.length,
                total_budget: `$${total.toLocaleString('es-MX')} MXN`
            };
            
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
                .then(function(response) {
                    showApprovalStatus('success', currentLanguage === 'en' ? 
                        'Review request email sent successfully to mike@oolab.com!' : 
                        'Â¡Correo de solicitud de revisiÃ³n enviado exitosamente a mike@oolab.com!');
                    logActivity('email', 'Review request sent to mike@oolab.com', null);
                }, function(error) {
                    console.error('EmailJS Error:', error);
                    // Fall back to mailto
                    sendReviewMailto(emailSubject, emailMessage);
                });
            */
            
            // For now, use mailto (opens email client)
            // This works immediately without setup
            sendReviewMailto(emailSubject, emailMessage);
        }
        
        function sendReviewMailto(subject, message) {
            const mailtoLink = `mailto:mike@oolab.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
            window.open(mailtoLink);
            
            showApprovalStatus('info', currentLanguage === 'en' ? 
                'Email client opened. For automatic email delivery, please configure EmailJS (see code comments).' : 
                'Cliente de correo abierto. Para envÃ­o automÃ¡tico de correo, por favor configura EmailJS (ver comentarios en el cÃ³digo).');
            
            logActivity('review_request', 'Review requested - email opened for mike@oolab.com', null);
        }
        
        // Email Functions
        function sendApprovalEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            const subject = document.getElementById('emailSubject').value || 
                (currentLanguage === 'en' ? 'Budget Approval Notification' : 'NotificaciÃ³n de AprobaciÃ³n de Presupuesto');
            const message = document.getElementById('emailMessage').value || 
                (currentLanguage === 'en' ? 'The budget has been approved and is ready for review.' : 'El presupuesto ha sido aprobado y estÃ¡ listo para revisiÃ³n.');
            
            if (!recipientEmail) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please enter recipient email address first' : 
                    'Por favor ingresa la direcciÃ³n de correo del destinatario primero');
                return;
            }
            
            // Create email content
            const total = items.reduce((sum, item) => sum + item.totalPrice, 0);
            const emailBody = `
${message}

${currentLanguage === 'en' ? 'Budget Summary:' : 'Resumen del Presupuesto:'}
${currentLanguage === 'en' ? 'Total Items:' : 'Total de ArtÃ­culos:'} ${items.length}
${currentLanguage === 'en' ? 'Total Budget:' : 'Presupuesto Total:'} $${total.toLocaleString('es-MX')} MXN

${currentLanguage === 'en' ? 'Approved Items:' : 'ArtÃ­culos Aprobados:'}
${items.map(item => `- ${currentLanguage === 'en' ? item.nameEn : item.nameEs}: $${item.totalPrice.toLocaleString('es-MX')} MXN`).join('\n')}

${currentLanguage === 'en' ? 'Date:' : 'Fecha:'} ${new Date().toLocaleDateString()}
            `.trim();
            
            // Create mailto link
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Open email client
            window.open(mailtoLink);
            
            showApprovalStatus('success', currentLanguage === 'en' ? 
                'Email client opened with approval notification' : 
                'Cliente de correo abierto con notificaciÃ³n de aprobaciÃ³n');
        }
        
        function testEmail() {
            const recipientEmail = document.getElementById('recipientEmail').value;
            if (!recipientEmail) {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Please enter recipient email address first' : 
                    'Por favor ingresa la direcciÃ³n de correo del destinatario primero');
                return;
            }
            
            const subject = document.getElementById('emailSubject').value || 
                (currentLanguage === 'en' ? 'Test Email - Budget Manager' : 'Correo de Prueba - Gestor de Presupuesto');
            const message = document.getElementById('emailMessage').value || 
                (currentLanguage === 'en' ? 'This is a test email from the Budget Manager application.' : 'Este es un correo de prueba de la aplicaciÃ³n Gestor de Presupuesto.');
            
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
            window.open(mailtoLink);
            
            showApprovalStatus('info', currentLanguage === 'en' ? 
                'Test email opened in email client' : 
                'Correo de prueba abierto en el cliente de correo');
        }

        // Helper Functions for Week Management
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday as week start
            d.setDate(diff);
            d.setHours(0, 0, 0, 0); // Reset to start of day
            return d;
        }

        function getWeekLabel(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = d.toLocaleString('default', { month: 'short' });
            const day = d.getDate();
            const weekNumber = getWeekNumber(d);
            return `Week of ${month} ${day}, ${year} (Week ${weekNumber})`;
        }
        
        function getWeekOfYear(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); // Get to nearest Thursday
            const week1 = new Date(d.getFullYear(), 0, 4); // January 4th
            return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }
        
        // Helper function to format date with week number
        function formatDateWithWeek(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const weekNumber = getWeekNumber(date);
            const dateStr = date.toLocaleDateString();
            return `${dateStr} (Week ${weekNumber})`;
        }
        
        // Get the last ordered date for an item by looking up saved budget snapshots
        function getLastOrderedDate(item) {
            try {
                const savedBudgets = JSON.parse(localStorage.getItem('savedBudgets')) || [];
                
                // Sort by savedDate descending (most recent first)
                const sortedBudgets = savedBudgets.sort((a, b) => 
                    new Date(b.savedDate) - new Date(a.savedDate)
                );
                
                // Find the most recent budget that contains this item
                for (const budget of sortedBudgets) {
                    if (budget.items && Array.isArray(budget.items)) {
                        const matchingItem = budget.items.find(savedItem => 
                            savedItem.nameEn === item.nameEn &&
                            savedItem.nameEs === item.nameEs &&
                            savedItem.category === item.category &&
                            savedItem.unitPrice === item.unitPrice
                        );
                        
                        if (matchingItem) {
                            // Found the item in a saved budget - return the saved date
                            return new Date(budget.savedDate).toLocaleDateString();
                        }
                    }
                }
                
                // If not found in saved budgets, fall back to dateAdded
                return item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : 'N/A';
            } catch (error) {
                console.error('Error getting last ordered date:', error);
                // Fall back to dateAdded
                return item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : 'N/A';
            }
        }

        // Search and Filter Functions
        function filterCategoryItems() {
            const searchFilter = document.getElementById('itemSearchFilter');
            const category = document.getElementById('categorySelect').value;
            
            if (!searchFilter || !category) return;
            
            const searchTerm = searchFilter.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all items if search is empty (will filter recurring items in loadCategoryItems)
                loadCategoryItems();
                return;
            }
            
            // Get items from database and filter out recurring weekly items first
            let itemsToSearch = itemDatabase[category] || [];
            const categoryIsRecurring = categories[category] && categories[category].recurringWeekly;
            
            if (categoryIsRecurring) {
                // If entire category is recurring, don't show any items
                itemsToSearch = [];
            } else {
                // Filter out individual items that are marked as recurring weekly
                itemsToSearch = itemsToSearch.filter(item => !item.recurringWeekly);
            }
            
            // Then filter items based on search term
            const filteredItems = itemsToSearch.filter(item => {
                const itemName = (currentLanguage === 'en' ? item.nameEn : item.nameEs).toLowerCase();
                const itemDescription = (currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs).toLowerCase();
                const supplierName = (typeof item.supplier === 'string' ? item.supplier : item.supplier.name).toLowerCase();
                const itemNameAlt = (currentLanguage === 'en' ? item.nameEs : item.nameEn).toLowerCase();
                const itemDescriptionAlt = (currentLanguage === 'en' ? item.descriptionEs : item.descriptionEn).toLowerCase();
                
                return itemName.includes(searchTerm) || 
                       itemDescription.includes(searchTerm) || 
                       supplierName.includes(searchTerm) ||
                       itemNameAlt.includes(searchTerm) ||
                       itemDescriptionAlt.includes(searchTerm);
            });
            
            renderCategoryItems(filteredItems, category);
        }

        // Auto-Add Due Items and Recurring Weekly Items
        // Options: checkNextWeek = true to check for next week, skipRecurring = true to skip recurring items
        function checkAndAddDueItems(checkNextWeek = false, skipRecurring = false) {
            // Reload categories and itemDatabase to ensure we have the latest data
            categories = JSON.parse(localStorage.getItem('customCategories')) || {};
            itemDatabase = JSON.parse(localStorage.getItem('categoryItems')) || {};
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentWeekStart = getWeekStart(today);
            const targetWeekStart = checkNextWeek ? new Date(currentWeekStart) : currentWeekStart;
            if (checkNextWeek) {
                targetWeekStart.setDate(targetWeekStart.getDate() + 7);
            }
            
            // Only add recurring items on Monday (start of the week)
            const isMonday = today.getDay() === 1; // 1 = Monday
            const isCurrentWeekMonday = currentWeekStart.getTime() === today.getTime();
            
            let itemsAdded = false;
            const addedItemsList = []; // Track what items were added
            
            // Check each category for due dates (recurring is now handled at item level)
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                
                // Handle due date categories (skip if skipRecurring is true - we only want pushed items when clearing)
                if (category.hasDueDate && category.dueDate && !skipRecurring) {
                    const dueDate = new Date(category.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    
                    // Calculate one week before due date
                    const oneWeekBefore = new Date(dueDate);
                    oneWeekBefore.setDate(oneWeekBefore.getDate() - 7);
                    const weekBeforeStart = getWeekStart(oneWeekBefore);
                    
                    // Only add on Monday of the week before due date
                    if (isMonday && isCurrentWeekMonday && weekBeforeStart.getTime() === currentWeekStart.getTime()) {
                        // Check if items from this category already exist in current budget
                        const existingItemsInBudget = items.filter(item => item.category === categoryKey);
                        
                        // Get all items in this category
                        const categoryItems = itemDatabase[categoryKey] || [];
                        
                        // Add items that aren't already in the budget
                        categoryItems.forEach(item => {
                            // Check if this exact item is already in budget (by comparing key properties)
                            const alreadyExists = existingItemsInBudget.some(existingItem => 
                                existingItem.nameEn === item.nameEn &&
                                existingItem.nameEs === item.nameEs &&
                                existingItem.unitPrice === item.unitPrice &&
                                existingItem.dueDateAdded !== true // Only auto-add once per due date period
                            );
                            
                            if (!alreadyExists) {
                                const newItem = {
                                    id: Date.now() + Math.random(), // Unique ID
                                    nameEn: item.nameEn,
                                    nameEs: item.nameEs,
                                    descriptionEn: item.descriptionEn || '',
                                    descriptionEs: item.descriptionEs || '',
                                    category: categoryKey,
                                    unitPrice: item.unitPrice || 0,
                                    quantity: item.quantity || 1,
                                    totalPrice: (item.unitPrice || 0) * (item.quantity || 1),
                                    priority: item.priority || 'high',
                                    invoicePhoto: null,
                                    supplier: item.supplier,
                                    dueDateAdded: true,
                                    dueDate: category.dueDate,
                                    dateAdded: currentWeekStart.toISOString() // Set to Monday of the week
                                };
                                
                                // Apply automatic credit if item was in alerts
                                applyAutomaticCreditIfInAlerts(newItem);
                                
                                items.push(newItem);
                                itemsAdded = true;
                                addedItemsList.push({ name: item.nameEn, reason: 'Due Date Category' });
                            }
                        });
                    }
                }
            });
            
            // Check for items with individual recurring weekly or due dates in category database
            let recurringItemsFound = 0;
            console.log('Checking itemDatabase for recurring items. Total categories:', Object.keys(itemDatabase).length);
            Object.keys(itemDatabase).forEach(categoryKey => {
                const categoryItems = itemDatabase[categoryKey] || [];
                
                categoryItems.forEach(item => {
                    // Check if item is recurring weekly (skip if skipRecurring is true)
                    // Add recurring weekly items - check if they're already in the current week
                    if (item.recurringWeekly && !skipRecurring) {
                        recurringItemsFound++;
                        console.log('Found recurring weekly item:', item.nameEn, 'in category:', categoryKey);
                        // Check if this item already exists in current budget for target week
                        // Use flexible matching: check by weeklyAddedWeek OR by dateAdded being in the target week
                        const existingItemsInBudget = items.filter(existingItem => {
                            // Must match category, name, and price
                            if (existingItem.category !== categoryKey || 
                                existingItem.nameEn !== item.nameEn ||
                                existingItem.nameEs !== item.nameEs ||
                                existingItem.unitPrice !== item.unitPrice) {
                                return false;
                            }
                            
                            // Check if weeklyAddedWeek matches (if it exists)
                            if (existingItem.weeklyAddedWeek) {
                                const existingWeek = new Date(existingItem.weeklyAddedWeek);
                                const existingWeekStart = getWeekStart(existingWeek);
                                return existingWeekStart.getTime() === targetWeekStart.getTime();
                            }
                            
                            // Fallback: check if dateAdded is within the target week
                            if (existingItem.dateAdded) {
                                const itemDate = new Date(existingItem.dateAdded);
                                const itemWeekStart = getWeekStart(itemDate);
                                return itemWeekStart.getTime() === targetWeekStart.getTime();
                            }
                            
                            // If no date info but matches name/price/category, assume it's already there (prevent duplicates)
                            return true;
                        });
                        
                        if (existingItemsInBudget.length === 0) {
                            const newItem = {
                                id: Date.now() + Math.random(),
                                nameEn: item.nameEn,
                                nameEs: item.nameEs,
                                descriptionEn: item.descriptionEn || '',
                                descriptionEs: item.descriptionEs || '',
                                category: categoryKey,
                                unitPrice: item.unitPrice || 0,
                                quantity: item.quantity || 1,
                                totalPrice: (item.unitPrice || 0) * (item.quantity || 1),
                                priority: item.priority || 'high',
                                invoicePhoto: null,
                                supplier: item.supplier,
                                weeklyAddedWeek: targetWeekStart.toISOString(),
                                dateAdded: currentWeekStart.toISOString() // Set to Monday of the week
                            };
                            
                            // Apply automatic credit if item was in alerts
                            applyAutomaticCreditIfInAlerts(newItem);
                            
                            items.push(newItem);
                            itemsAdded = true;
                            addedItemsList.push({ name: item.nameEn, reason: 'Recurring Weekly Item' });
                            console.log('Added recurring weekly item:', item.nameEn, 'to budget');
                        } else {
                            console.log('Recurring weekly item already exists:', item.nameEn);
                        }
                    }
                    
                    // Check if item is recurring monthly (skip if skipRecurring is true)
                    // Only add on Monday of the week that contains the monthly day
                    if (item.recurringMonthly && item.monthlyDay && !skipRecurring) {
                        const targetDay = item.monthlyDay;
                        
                        // Calculate the date for this month's target day
                        const targetDate = new Date(today.getFullYear(), today.getMonth(), targetDay);
                        const targetDateWeekStart = getWeekStart(targetDate);
                        
                        // Only add on Monday if we're in the week that contains the monthly day
                        let shouldAdd = false;
                        if (checkNextWeek) {
                            // For next week, check if the monthly day falls within that week
                            const nextWeekStartDate = new Date(targetWeekStart);
                            const nextWeekEndDate = new Date(targetWeekStart);
                            nextWeekEndDate.setDate(nextWeekEndDate.getDate() + 6);
                            shouldAdd = targetDate >= nextWeekStartDate && targetDate <= nextWeekEndDate;
                        } else {
                            // For current week, check if the monthly day falls within this week
                            const weekEndDate = new Date(currentWeekStart);
                            weekEndDate.setDate(weekEndDate.getDate() + 6);
                            shouldAdd = targetDate >= currentWeekStart && targetDate <= weekEndDate;
                        }
                        
                        // Only add on Monday of the week that contains the monthly day
                        if (shouldAdd && isMonday && isCurrentWeekMonday && targetDateWeekStart.getTime() === currentWeekStart.getTime()) {
                            // Check if this item already exists in current budget for this month
                            const currentMonth = today.getMonth();
                            const currentYear = today.getFullYear();
                            const existingItemsInBudget = items.filter(existingItem => 
                                existingItem.category === categoryKey && 
                                existingItem.nameEn === item.nameEn &&
                                existingItem.nameEs === item.nameEs &&
                                existingItem.unitPrice === item.unitPrice &&
                                existingItem.monthlyAddedMonth === currentMonth &&
                                existingItem.monthlyAddedYear === currentYear
                            );
                            
                            if (existingItemsInBudget.length === 0) {
                                const newItem = {
                                    id: Date.now() + Math.random(),
                                    nameEn: item.nameEn,
                                    nameEs: item.nameEs,
                                    descriptionEn: item.descriptionEn || '',
                                    descriptionEs: item.descriptionEs || '',
                                    category: categoryKey,
                                    unitPrice: item.unitPrice || 0,
                                    quantity: item.quantity || 1,
                                    totalPrice: (item.unitPrice || 0) * (item.quantity || 1),
                                    priority: item.priority || 'high',
                                    invoicePhoto: null,
                                    supplier: item.supplier,
                                    monthlyAddedMonth: currentMonth,
                                    monthlyAddedYear: currentYear,
                                    dateAdded: currentWeekStart.toISOString() // Set to Monday of the week
                                };
                                
                                // Apply automatic credit if item was in alerts
                                applyAutomaticCreditIfInAlerts(newItem);
                                
                                items.push(newItem);
                                itemsAdded = true;
                                addedItemsList.push({ name: item.nameEn, reason: `Recurring Monthly (Day ${targetDay})` });
                            }
                        }
                    }
                    
                    // Check if item has its own due date (skip if skipRecurring is true - we only want pushed items when clearing)
                    // Only add on Monday of the week before due date
                    if (item.hasDueDate && item.dueDate && !skipRecurring) {
                        const dueDate = new Date(item.dueDate);
                        dueDate.setHours(0, 0, 0, 0);
                        
                        // Calculate one week before due date
                        const oneWeekBefore = new Date(dueDate);
                        oneWeekBefore.setDate(oneWeekBefore.getDate() - 7);
                        const weekBeforeStart = getWeekStart(oneWeekBefore);
                        
                        // Only add on Monday of the week before due date
                        if (isMonday && isCurrentWeekMonday && weekBeforeStart.getTime() === currentWeekStart.getTime()) {
                            // Check if this item already exists in budget
                            const alreadyExists = items.some(existingItem => 
                                existingItem.nameEn === item.nameEn &&
                                existingItem.nameEs === item.nameEs &&
                                existingItem.category === categoryKey &&
                                existingItem.unitPrice === item.unitPrice &&
                                existingItem.itemDueDateAdded !== true // Only auto-add once per due date period
                            );
                            
                            if (!alreadyExists) {
                                const newItem = {
                                    id: Date.now() + Math.random(),
                                    nameEn: item.nameEn,
                                    nameEs: item.nameEs,
                                    descriptionEn: item.descriptionEn || '',
                                    descriptionEs: item.descriptionEs || '',
                                    category: categoryKey,
                                    unitPrice: item.unitPrice || 0,
                                    quantity: item.quantity || 1,
                                    totalPrice: (item.unitPrice || 0) * (item.quantity || 1),
                                    priority: item.priority || 'high',
                                    invoicePhoto: null,
                                    supplier: item.supplier,
                                    itemDueDateAdded: true,
                                    itemDueDate: item.dueDate,
                                    dateAdded: currentWeekStart.toISOString() // Set to Monday of the week
                                };
                                
                                items.push(newItem);
                                itemsAdded = true;
                                addedItemsList.push({ name: item.nameEn, reason: 'Item Due Date' });
                            }
                        }
                    }
                });
            });
            
            // Check for items pushed to next week
            const pushedItems = JSON.parse(localStorage.getItem('pushedToNextWeek')) || [];
            const activePushedItems = [];
            
            // Process pushed items and add them if we're in the target week (or checking next week)
            pushedItems.forEach(pushedItem => {
                const pushedWeekStart = new Date(pushedItem.pushedWeekStart);
                pushedWeekStart.setHours(0, 0, 0, 0);
                
                // Check if we're in the week this item was pushed for (or checking next week)
                const weekMatches = pushedWeekStart.getTime() === targetWeekStart.getTime();
                
                if (weekMatches) {
                    // Check if item already exists
                    const alreadyExists = items.some(item => 
                        item.nameEn === pushedItem.nameEn &&
                        item.nameEs === pushedItem.nameEs &&
                        item.category === pushedItem.category &&
                        item.unitPrice === pushedItem.unitPrice &&
                        item.pushedFromWeek === pushedItem.pushedWeekStart
                    );
                    
                    if (!alreadyExists) {
                        const newItem = {
                            ...pushedItem,
                            id: Date.now() + Math.random(),
                            approvalStatus: 'pending',
                            pushedFromWeek: pushedItem.pushedWeekStart,
                            weeklyAddedWeek: targetWeekStart.toISOString(),
                            dateAdded: today.toISOString()
                        };
                        delete newItem.pushedWeekStart; // Remove temporary property
                        items.push(newItem);
                        itemsAdded = true;
                        addedItemsList.push({ name: pushedItem.nameEn, reason: 'Pushed to Next Week' });
                    }
                }
                
                // Keep pushed items that are for future weeks (not past weeks)
                const pushedWeek = new Date(pushedItem.pushedWeekStart);
                pushedWeek.setHours(0, 0, 0, 0);
                if (pushedWeek >= currentWeekStart) {
                    activePushedItems.push(pushedItem);
                }
            });
            
            // Clean up old pushed items (keep only future ones)
            if (activePushedItems.length !== pushedItems.length) {
                localStorage.setItem('pushedToNextWeek', JSON.stringify(activePushedItems));
            }
            
            // Save and refresh if items were added
            if (itemsAdded) {
                saveItems();
                renderBudgetItems();
                updateTotal();
                updateApprovalSummary();
                updateMonitorDashboard();
            }
            
            // Return information about what was added
            // Log summary
            if (recurringItemsFound > 0) {
                console.log(`Found ${recurringItemsFound} recurring weekly items in database`);
            }
            if (addedItemsList.length > 0) {
                console.log(`Added ${addedItemsList.length} items:`, addedItemsList);
            } else if (recurringItemsFound > 0) {
                console.log('No recurring items were added (they may already be in the budget)');
            }
            
            return {
                itemsAdded: itemsAdded,
                count: addedItemsList.length,
                details: addedItemsList
            };
        }

        function pushItemToNextWeek(id) {
            console.log('=== PUSH TO NEXT WEEK CALLED ===', id, typeof id);
            
            // Find item using EXACT same method as removeItem
            const item = items.find(i => i.id === id);
            console.log('Found item:', item ? item.nameEn : 'NOT FOUND');
            
            if (!item) {
                console.error('Item not found!');
                showApprovalStatus('error', currentLanguage === 'en' ? 
                    'Item not found' : 
                    'ArtÃ­culo no encontrado');
                return;
            }
            
            // Calculate next week
            const today = new Date();
            const currentWeekStart = getWeekStart(today);
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            
            // Get pushed items
            const pushedItems = JSON.parse(localStorage.getItem('pushedToNextWeek')) || [];
            
            // Create copy for next week
            const itemCopy = {
                nameEn: item.nameEn,
                nameEs: item.nameEs,
                descriptionEn: item.descriptionEn || '',
                descriptionEs: item.descriptionEs || '',
                category: item.category,
                unitPrice: item.unitPrice,
                quantity: item.quantity,
                totalPrice: item.totalPrice,
                priority: item.priority,
                supplier: item.supplier,
                pushedWeekStart: nextWeekStart.toISOString()
            };
            
            // Save to pushed list FIRST (before removing)
            pushedItems.push(itemCopy);
            localStorage.setItem('pushedToNextWeek', JSON.stringify(pushedItems));
            console.log('Saved to pushedToNextWeek');
            
            // NOW remove using EXACT same code as removeItem
            items = items.filter(item => item.id !== id);
            console.log('Filtered items. New count:', items.length);
            
            // Save items (same as removeItem)
            saveItems();
            console.log('Saved items to localStorage');
            
            // Log activity
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            logActivity('push', `${currentLanguage === 'en' ? 'Pushed item to next week' : 'ArtÃ­culo empujado a la prÃ³xima semana'}: ${itemName}`, item.id);
            logChange('push', item.id, itemName, 'current week', 'next week', 'week');
            
            // Refresh (same as removeItem)
            renderBudgetItems();
            updateTotal();
            updateApprovalSummary();
            updateMonitorDashboard();
            
            console.log('=== PUSH COMPLETE ===');
            showApprovalStatus('success', currentLanguage === 'en' ? 
                `"${itemName}" has been moved to next week.` : 
                `"${itemName}" ha sido movido a la prÃ³xima semana.`);
        }

        // Monitoring Functions
        async function logActivity(type, description, itemId = null) {
            const activity = {
                id: Date.now(),
                type: type,
                description: description,
                itemId: itemId,
                timestamp: new Date().toISOString(),
                language: currentLanguage
            };
            activityLog.unshift(activity);
            if (activityLog.length > 500) activityLog = activityLog.slice(0, 500); // Keep last 500 entries
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            
            // If using Supabase and user is logged in, save to database
            if (useSupabase && currentUser) {
                try {
                    // Convert itemId to number (BIGINT) or null
                    let itemIdNum = null;
                    if (itemId !== null && itemId !== undefined) {
                        const parsed = typeof itemId === 'string' ? parseFloat(itemId) : itemId;
                        itemIdNum = !isNaN(parsed) && isFinite(parsed) ? Math.floor(parsed) : null;
                    }
                    
                    const { error } = await supabase.from('activity_log').insert([{
                        user_id: currentUser.id,
                        type: type,
                        description: description,
                        item_id: itemIdNum
                    }]);
                    
                    if (error) {
                        console.error('Error logging activity to Supabase:', error);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                    }
                } catch (error) {
                    console.error('Error logging activity to Supabase (catch):', error);
                }
            }
            
            if (document.getElementById('activityLog')) {
                refreshActivityLog();
            }
        }

        async function logChange(type, itemId, itemName, oldValue = null, newValue = null, field = null) {
            const change = {
                id: Date.now(),
                type: type,
                itemId: itemId,
                itemName: itemName,
                oldValue: oldValue,
                newValue: newValue,
                field: field,
                timestamp: new Date().toISOString()
            };
            changeHistory.unshift(change);
            if (changeHistory.length > 1000) changeHistory = changeHistory.slice(0, 1000); // Keep last 1000 entries
            localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
            
            // If using Supabase and user is logged in, save to database
            if (useSupabase && currentUser) {
                try {
                    // Convert itemId to number (BIGINT) or null
                    let itemIdNum = null;
                    if (itemId !== null && itemId !== undefined) {
                        const parsed = typeof itemId === 'string' ? parseFloat(itemId) : itemId;
                        itemIdNum = !isNaN(parsed) && isFinite(parsed) ? Math.floor(parsed) : null;
                    }
                    
                    // Convert oldValue and newValue to JSONB format (wrap in JSON)
                    const oldValueJsonb = oldValue !== null && oldValue !== undefined ? oldValue : null;
                    const newValueJsonb = newValue !== null && newValue !== undefined ? newValue : null;
                    
                    const { error } = await supabase.from('change_history').insert([{
                        user_id: currentUser.id,
                        type: type,
                        item_id: itemIdNum,
                        item_name: itemName,
                        old_value: oldValueJsonb, // Supabase will automatically convert to JSONB
                        new_value: newValueJsonb, // Supabase will automatically convert to JSONB
                        field: field
                    }]);
                    
                    if (error) {
                        console.error('Error logging change to Supabase:', error);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                        console.error('Attempted values:', { itemIdNum, itemName, oldValueJsonb, newValueJsonb, field });
                    }
                } catch (error) {
                    console.error('Error logging change to Supabase (catch):', error);
                }
            }
            
            if (document.getElementById('changeHistory')) {
                loadChangeHistory();
            }
        }

        function refreshActivityLog() {
            const logContainer = document.getElementById('activityLog');
            if (!logContainer) return;
            
            logContainer.innerHTML = '';
            
            if (activityLog.length === 0) {
                logContainer.innerHTML = `<p style="text-align: center; color: #7f8c8d; padding: 20px;" data-en="No activity recorded yet" data-es="AÃºn no hay actividad registrada">No activity recorded yet</p>`;
                updateLanguage();
                return;
            }
            
            activityLog.slice(0, 100).forEach(activity => {
                const entry = document.createElement('div');
                entry.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-left: 4px solid #3498db; border-radius: 4px; font-size: 0.9rem;';
                
                const time = new Date(activity.timestamp).toLocaleString();
                const typeColors = {
                    'add': '#27ae60',
                    'update': '#3498db',
                    'delete': '#e74c3c',
                    'approve': '#2ecc71',
                    'deny': '#e67e22',
                    'export': '#9b59b6',
                    'clear': '#95a5a6'
                };
                entry.style.borderLeftColor = typeColors[activity.type] || '#3498db';
                
                entry.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: ${typeColors[activity.type] || '#3498db'};">${activity.type.toUpperCase()}</strong>
                            <span style="margin-left: 10px; color: #2c3e50;">${activity.description}</span>
                        </div>
                        <span style="color: #7f8c8d; font-size: 0.85rem;">${time}</span>
                    </div>
                `;
                logContainer.appendChild(entry);
            });
        }

        function clearActivityLog() {
            if (confirm(currentLanguage === 'en' ? 'Are you sure you want to clear the activity log?' : 'Â¿EstÃ¡s seguro de que quieres limpiar el registro de actividad?')) {
                activityLog = [];
                localStorage.setItem('activityLog', JSON.stringify(activityLog));
                refreshActivityLog();
                logActivity('clear', currentLanguage === 'en' ? 'Activity log cleared' : 'Registro de actividad limpiado');
            }
        }

        function exportActivityLog() {
            const data = {
                activityLog: activityLog,
                exportDate: new Date().toISOString(),
                totalEntries: activityLog.length
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity-log-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logActivity('export', currentLanguage === 'en' ? 'Activity log exported' : 'Registro de actividad exportado');
        }

        function loadChangeHistory() {
            const historyContainer = document.getElementById('changeHistory');
            if (!historyContainer) return;
            
            const itemFilter = document.getElementById('historyItemFilter')?.value || '';
            const typeFilter = document.getElementById('historyTypeFilter')?.value || '';
            
            let filteredHistory = changeHistory;
            
            if (itemFilter) {
                filteredHistory = filteredHistory.filter(change => change.itemId == itemFilter);
            }
            
            if (typeFilter) {
                filteredHistory = filteredHistory.filter(change => change.type === typeFilter);
            }
            
            historyContainer.innerHTML = '';
            
            if (filteredHistory.length === 0) {
                historyContainer.innerHTML = `<p style="text-align: center; color: #7f8c8d; padding: 20px;" data-en="No changes recorded" data-es="No hay cambios registrados">No changes recorded</p>`;
                updateLanguage();
                return;
            }
            
            filteredHistory.slice(0, 100).forEach(change => {
                const entry = document.createElement('div');
                entry.style.cssText = 'padding: 12px; margin-bottom: 10px; background: white; border-left: 4px solid #3498db; border-radius: 4px; font-size: 0.9rem;';
                
                const time = new Date(change.timestamp).toLocaleString();
                const typeColors = {
                    'added': '#27ae60',
                    'updated': '#3498db',
                    'deleted': '#e74c3c',
                    'approved': '#2ecc71',
                    'denied': '#e67e22'
                };
                entry.style.borderLeftColor = typeColors[change.type] || '#3498db';
                
                let changeDetails = '';
                if (change.field && change.oldValue !== null && change.newValue !== null) {
                    changeDetails = `<div style="margin-top: 5px; color: #7f8c8d; font-size: 0.85rem;">
                        ${change.field}: ${change.oldValue} â†’ ${change.newValue}
                    </div>`;
                }
                
                entry.innerHTML = `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: ${typeColors[change.type] || '#3498db'};">${change.type.toUpperCase()}</strong>
                                <span style="margin-left: 10px; color: #2c3e50;">${change.itemName}</span>
                            </div>
                            <span style="color: #7f8c8d; font-size: 0.85rem;">${time}</span>
                        </div>
                        ${changeDetails}
                    </div>
                `;
                historyContainer.appendChild(entry);
            });
            
            // Populate item filter
            const itemFilterSelect = document.getElementById('historyItemFilter');
            if (itemFilterSelect && itemFilterSelect.children.length === 1) {
                const uniqueItems = [...new Set(changeHistory.map(c => c.itemId))];
                uniqueItems.forEach(itemId => {
                    const change = changeHistory.find(c => c.itemId == itemId);
                    if (change) {
                        const option = document.createElement('option');
                        option.value = itemId;
                        option.textContent = change.itemName;
                        itemFilterSelect.appendChild(option);
                    }
                });
            }
        }

        function updateMonitorDashboard() {
            const total = items.filter(item => item.approvalStatus === 'approved' || !item.approvalStatus || item.approvalStatus === 'pending')
                .reduce((sum, item) => sum + item.totalPrice, 0);
            
            const today = new Date().toDateString();
            const itemsToday = items.filter(item => {
                const itemDate = item.dateAdded ? new Date(item.dateAdded).toDateString() : null;
                return itemDate === today;
            }).length;
            
            const changesToday = changeHistory.filter(change => {
                const changeDate = new Date(change.timestamp).toDateString();
                return changeDate === today;
            }).length;
            
            const pendingApproval = items.filter(item => !item.approvalStatus || item.approvalStatus === 'pending').length;
            
            const budgetLimit = parseFloat(localStorage.getItem('budgetLimit')) || 0;
            const percentage = budgetLimit > 0 ? ((total / budgetLimit) * 100).toFixed(1) : 0;
            
            if (document.getElementById('monitorCurrentBudget')) {
                document.getElementById('monitorCurrentBudget').textContent = `$${total.toLocaleString('es-MX')} MXN`;
            }
            if (document.getElementById('monitorBudgetPercentage')) {
                document.getElementById('monitorBudgetPercentage').textContent = `${percentage}%`;
            }
            if (document.getElementById('monitorItemsToday')) {
                document.getElementById('monitorItemsToday').textContent = itemsToday;
            }
            if (document.getElementById('monitorChangesToday')) {
                document.getElementById('monitorChangesToday').textContent = changesToday;
            }
            if (document.getElementById('monitorPendingApproval')) {
                document.getElementById('monitorPendingApproval').textContent = pendingApproval;
            }
            
            // Check budget threshold
            checkBudgetThreshold(total, budgetLimit);
        }

        function checkBudgetThreshold(currentTotal, budgetLimit) {
            if (!budgetLimit || budgetLimit <= 0) return;
            
            const alertThreshold = parseFloat(localStorage.getItem('alertThreshold')) || 80;
            const percentage = (currentTotal / budgetLimit) * 100;
            const alertStatus = document.getElementById('budgetAlertStatus');
            
            if (!alertStatus) return;
            
            if (percentage >= 100) {
                alertStatus.innerHTML = `<div class="alert alert-danger">
                    <strong data-en="Budget Exceeded!" data-es="Â¡Presupuesto Excedido!">Budget Exceeded!</strong>
                    <span data-en="Current budget has exceeded the limit by " data-es="El presupuesto actual ha excedido el lÃ­mite en ">Current budget has exceeded the limit by </span>
                    $${(currentTotal - budgetLimit).toLocaleString('es-MX')} MXN
                </div>`;
                updateLanguage();
                showBrowserNotification(
                    currentLanguage === 'en' ? 'Budget Exceeded!' : 'Â¡Presupuesto Excedido!',
                    currentLanguage === 'en' ? `Budget has exceeded the limit by $${(currentTotal - budgetLimit).toLocaleString('es-MX')} MXN` : `El presupuesto ha excedido el lÃ­mite en $${(currentTotal - budgetLimit).toLocaleString('es-MX')} MXN`
                );
            } else if (percentage >= alertThreshold) {
                alertStatus.innerHTML = `<div class="alert alert-warning">
                    <strong data-en="Budget Alert!" data-es="Â¡Alerta de Presupuesto!">Budget Alert!</strong>
                    <span data-en="Budget has reached " data-es="El presupuesto ha alcanzado ">Budget has reached </span>
                    ${percentage.toFixed(1)}% ${currentLanguage === 'en' ? 'of the limit' : 'del lÃ­mite'}
                </div>`;
                updateLanguage();
                if (percentage >= alertThreshold && percentage < alertThreshold + 1) { // Only alert once when crossing threshold
                    showBrowserNotification(
                        currentLanguage === 'en' ? 'Budget Alert!' : 'Â¡Alerta de Presupuesto!',
                        currentLanguage === 'en' ? `Budget has reached ${percentage.toFixed(1)}% of the limit` : `El presupuesto ha alcanzado ${percentage.toFixed(1)}% del lÃ­mite`
                    );
                }
            } else {
                alertStatus.innerHTML = `<div class="alert alert-success">
                    <strong data-en="Budget Status: OK" data-es="Estado del Presupuesto: OK">Budget Status: OK</strong>
                    <span data-en="Current budget is " data-es="El presupuesto actual es ">Current budget is </span>
                    ${percentage.toFixed(1)}% ${currentLanguage === 'en' ? 'of the limit' : 'del lÃ­mite'}
                </div>`;
                updateLanguage();
            }
        }

        function saveBudgetSettings() {
            const budgetLimit = document.getElementById('budgetLimit').value;
            const alertThreshold = document.getElementById('alertThreshold').value;
            
            if (budgetLimit) localStorage.setItem('budgetLimit', budgetLimit);
            if (alertThreshold) localStorage.setItem('alertThreshold', alertThreshold);
            
            updateMonitorDashboard();
            logActivity('update', currentLanguage === 'en' ? 'Budget settings updated' : 'ConfiguraciÃ³n de presupuesto actualizada');
        }

        function saveNotificationSettings() {
            const enableNotifications = document.getElementById('enableNotifications').checked;
            const alertOnThreshold = document.getElementById('alertOnThreshold').checked;
            const alertOnChanges = document.getElementById('alertOnChanges').checked;
            
            localStorage.setItem('enableNotifications', enableNotifications);
            localStorage.setItem('alertOnThreshold', alertOnThreshold);
            localStorage.setItem('alertOnChanges', alertOnChanges);
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showApprovalStatus('success', currentLanguage === 'en' ? 
                            'Notification permission granted!' : 
                            'Â¡Permiso de notificaciÃ³n concedido!');
                        saveNotificationSettings();
                    } else {
                        showApprovalStatus('warning', currentLanguage === 'en' ? 
                            'Notification permission denied' : 
                            'Permiso de notificaciÃ³n denegado');
                    }
                });
            } else {
                showApprovalStatus('warning', currentLanguage === 'en' ? 
                    'Browser does not support notifications' : 
                    'El navegador no admite notificaciones');
            }
        }

        function showBrowserNotification(title, body) {
            const enableNotifications = localStorage.getItem('enableNotifications') === 'true';
            if (!enableNotifications || !('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'ðŸ“Š',
                    badge: 'ðŸ“Š'
                });
            }
        }

        function loadMonitorSettings() {
            const budgetLimit = localStorage.getItem('budgetLimit');
            const alertThreshold = localStorage.getItem('alertThreshold');
            const enableNotifications = localStorage.getItem('enableNotifications') === 'true';
            const alertOnThreshold = localStorage.getItem('alertOnThreshold') === 'true';
            const alertOnChanges = localStorage.getItem('alertOnChanges') === 'true';
            
            if (budgetLimit && document.getElementById('budgetLimit')) {
                document.getElementById('budgetLimit').value = budgetLimit;
            }
            if (alertThreshold && document.getElementById('alertThreshold')) {
                document.getElementById('alertThreshold').value = alertThreshold;
            }
            if (document.getElementById('enableNotifications')) {
                document.getElementById('enableNotifications').checked = enableNotifications;
            }
            if (document.getElementById('alertOnThreshold')) {
                document.getElementById('alertOnThreshold').checked = alertOnThreshold;
            }
            if (document.getElementById('alertOnChanges')) {
                document.getElementById('alertOnChanges').checked = alertOnChanges;
            }
        }

        // Initialize the app
        // itemForm submission is handled by onsubmit attribute in HTML
        document.getElementById('editItemForm').addEventListener('submit', saveEditedItem);
        
        // Initialize categories first
        loadCategoriesList();
        populateCategoryDropdowns();
        updateUnitPriceField(); // Initialize unit price field based on current category
        
        // Make sure price field required attribute is set correctly on page load
        const unitPriceInput = document.getElementById('unitPrice');
        if (unitPriceInput) {
            // Check if Canada checkbox is checked on page load
            const canadaCheckbox = document.getElementById('itemForCanada');
            if (canadaCheckbox && canadaCheckbox.checked) {
                unitPriceInput.removeAttribute('required');
                unitPriceInput.required = false;
            }
        }
        populateMonthlyDayDropdown(); // Populate day of month dropdown
        
        updateLanguage();
        // Function to remove item from alerts tracking when receipt is added
        function removeItemFromAlertsTracking(item) {
            if (item.invoicePhoto || (item.receiptAmount && item.receiptAmount > 0)) {
                const itemsInAlerts = JSON.parse(localStorage.getItem('itemsInAlerts')) || [];
                const updatedAlerts = itemsInAlerts.filter(alert => 
                    !(alert.nameEn === item.nameEn && 
                      alert.nameEs === item.nameEs && 
                      alert.category === item.category)
                );
                if (updatedAlerts.length !== itemsInAlerts.length) {
                    localStorage.setItem('itemsInAlerts', JSON.stringify(updatedAlerts));
                    console.log('Item removed from alerts tracking:', item.nameEn);
                }
            }
        }
        
        // Function to check if item was in alerts and apply automatic credit
        function applyAutomaticCreditIfInAlerts(item) {
            const itemsInAlerts = JSON.parse(localStorage.getItem('itemsInAlerts')) || [];
            
            // Find matching item in alerts
            const alertItem = itemsInAlerts.find(alert => 
                alert.nameEn === item.nameEn && 
                alert.nameEs === item.nameEs && 
                alert.category === item.category
            );
            
            if (alertItem && alertItem.budgetedAmount > 0) {
                // Apply credit: subtract the previous budgeted amount
                const originalTotal = item.totalPrice || 0;
                const creditAmount = alertItem.budgetedAmount;
                const newTotal = Math.max(0, originalTotal - creditAmount); // Don't allow negative
                
                // Update the total price
                item.totalPrice = newTotal;
                
                // Calculate new unit price based on quantity
                if (item.quantity && item.quantity > 0) {
                    item.unitPrice = newTotal / item.quantity;
                }
                
                // Add credit note
                const creditNoteEn = `Automatic credit applied: -$${creditAmount.toFixed(2)} MXN (Item was missing receipt in previous budget)`;
                const creditNoteEs = `CrÃ©dito automÃ¡tico aplicado: -$${creditAmount.toFixed(2)} MXN (El artÃ­culo no tenÃ­a recibo en el presupuesto anterior)`;
                
                // Add or update notes
                if (!item.notes || item.notes === '(none)') {
                    item.notes = currentLanguage === 'en' ? creditNoteEn : creditNoteEs;
                } else {
                    item.notes = item.notes + '\n' + (currentLanguage === 'en' ? creditNoteEn : creditNoteEs);
                }
                
                // Also update notesEn and notesEs
                if (!item.notesEn || item.notesEn === '(none)') {
                    item.notesEn = creditNoteEn;
                } else {
                    item.notesEn = item.notesEn + '\n' + creditNoteEn;
                }
                
                if (!item.notesEs || item.notesEs === '(none)') {
                    item.notesEs = creditNoteEs;
                } else {
                    item.notesEs = item.notesEs + '\n' + creditNoteEs;
                }
                
                // Remove from alerts tracking (credit has been applied)
                const updatedAlerts = itemsInAlerts.filter(alert => 
                    !(alert.nameEn === item.nameEn && 
                      alert.nameEs === item.nameEs && 
                      alert.category === item.category)
                );
                localStorage.setItem('itemsInAlerts', JSON.stringify(updatedAlerts));
                
                console.log('Automatic credit applied:', {
                    item: item.nameEn,
                    originalTotal: originalTotal,
                    creditAmount: creditAmount,
                    newTotal: newTotal
                });
                
                return true; // Credit was applied
            }
            
            return false; // No credit applied
        }
        
        // Function to load items missing receipts
        function loadMissingReceipts() {
            const missingReceiptsList = document.getElementById('missingReceiptsList');
            if (!missingReceiptsList) return;
            
            // Get all items from current budget that don't have photos or receipt amounts
            // and have been in the budget for more than 7 days
            const today = new Date();
            const itemsWithoutReceipts = items.filter(item => {
                // Skip if item has photo or receipt amount
                if (item.invoicePhoto || (item.receiptAmount && item.receiptAmount > 0)) return false;
                
                if (!item.dateAdded) return false; // No date added, skip
                
                const dateAdded = new Date(item.dateAdded);
                const daysSinceAdded = Math.floor((today - dateAdded) / (1000 * 60 * 60 * 24));
                
                // Only show items that have been in budget for more than 7 days
                return daysSinceAdded > 7;
            });
            
            if (itemsWithoutReceipts.length === 0) {
                // Check if there are items without receipts but less than 7 days old
                const itemsWithoutReceiptsRecent = items.filter(item => 
                    !item.invoicePhoto && 
                    (!item.receiptAmount || item.receiptAmount <= 0) && 
                    item.dateAdded
                );
                if (itemsWithoutReceiptsRecent.length > 0) {
                    missingReceiptsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #3498db; background: #ebf5fb; border-radius: 8px;">
                            <strong>${currentLanguage === 'en' ? 'No items require receipts yet (7-day grace period)' : 'AÃºn no hay artÃ­culos que requieran recibos (perÃ­odo de gracia de 7 dÃ­as)'}</strong>
                            <div style="margin-top: 10px; font-size: 0.9rem;">
                                ${currentLanguage === 'en' ? 'Items will appear here after 7 days without a receipt.' : 'Los artÃ­culos aparecerÃ¡n aquÃ­ despuÃ©s de 7 dÃ­as sin recibo.'}
                            </div>
                        </div>
                    `;
                } else {
                    missingReceiptsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #27ae60; background: #d5f4e6; border-radius: 8px;">
                            <strong>${currentLanguage === 'en' ? 'All items have receipts!' : 'Â¡Todos los artÃ­culos tienen recibos!'}</strong>
                        </div>
                    `;
                }
                return;
            }
            
            // Track items in alerts for automatic credit application
            const itemsInAlerts = [];
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            itemsWithoutReceipts.forEach(item => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const dateAdded = item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : 'N/A';
                const categoryName = categories[item.category] ? (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : item.category;
                const budgetedAmount = item.totalPrice || 0;
                
                // Calculate days since added
                const today = new Date();
                const addedDate = new Date(item.dateAdded);
                const daysSinceAdded = Math.floor((today - addedDate) / (1000 * 60 * 60 * 24));
                
                // Track this item for automatic credit
                itemsInAlerts.push({
                    nameEn: item.nameEn,
                    nameEs: item.nameEs,
                    category: item.category,
                    budgetedAmount: budgetedAmount,
                    dateTracked: new Date().toISOString()
                });
                
                html += `
                    <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #856404;">${itemName}</strong>
                            <div style="color: #856404; font-size: 0.9rem; margin-top: 5px;">
                                ${currentLanguage === 'en' ? 'Category' : 'CategorÃ­a'}: ${categoryName} | 
                                ${currentLanguage === 'en' ? 'Added to Budget' : 'Agregado al Presupuesto'}: ${dateAdded} | 
                                ${currentLanguage === 'en' ? 'Days Since Added' : 'DÃ­as desde Agregado'}: ${daysSinceAdded} | 
                                ${currentLanguage === 'en' ? 'Budgeted Amount' : 'Monto Presupuestado'}: $${budgetedAmount.toFixed(2)} MXN
                            </div>
                        </div>
                        <button class="btn btn-sm" onclick="editBudgetItemForReceipt(${items.indexOf(item)})" style="background: #ffc107; color: #856404; border: none;">
                            ${currentLanguage === 'en' ? 'Add Receipt' : 'Agregar Recibo'}
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            missingReceiptsList.innerHTML = html;
            
            // Save items in alerts to localStorage for automatic credit application
            if (itemsInAlerts.length > 0) {
                const existingAlerts = JSON.parse(localStorage.getItem('itemsInAlerts')) || [];
                // Merge with existing, avoiding duplicates
                itemsInAlerts.forEach(newAlert => {
                    const exists = existingAlerts.find(existing => 
                        existing.nameEn === newAlert.nameEn && 
                        existing.nameEs === newAlert.nameEs && 
                        existing.category === newAlert.category
                    );
                    if (!exists) {
                        existingAlerts.push(newAlert);
                    } else {
                        // Update the budgeted amount if it's different
                        exists.budgetedAmount = newAlert.budgetedAmount;
                        exists.dateTracked = newAlert.dateTracked;
                    }
                });
                localStorage.setItem('itemsInAlerts', JSON.stringify(existingAlerts));
            }
        }
        
        // Function to load weekly budgets vs actual spending
        async         function loadWeeklyBudgetsVsActual() {
            const container = document.getElementById('weeklyBudgetsVsActual');
            if (!container) return;
            
            const savedBudgets = getAllSavedBudgetsSync();
            
            if (savedBudgets.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        ${currentLanguage === 'en' ? 'No saved budgets yet. Save budgets to see weekly comparisons.' : 'AÃºn no hay presupuestos guardados. Guarda presupuestos para ver comparaciones semanales.'}
                    </div>
                `;
                return;
            }
            
            // Group budgets by week (combine regular and partial payments for the same week)
            const budgetsByWeek = {};
            
            savedBudgets.forEach(budget => {
                const savedDate = new Date(budget.savedDate);
                const weekStart = budget.weekStart ? new Date(budget.weekStart) : savedDate;
                const weekKey = `${weekStart.getFullYear()}-W${getWeekNumber(weekStart)}`;
                
                if (!budgetsByWeek[weekKey]) {
                    budgetsByWeek[weekKey] = {
                        weekStart: weekStart,
                        weekNumber: getWeekNumber(weekStart),
                        year: weekStart.getFullYear(),
                        budgets: [],
                        totalBudgeted: 0,
                        totalActual: 0,
                        allItems: []
                    };
                }
                
                // Add items from this budget
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        budgetsByWeek[weekKey].totalBudgeted += item.totalPrice || 0;
                        budgetsByWeek[weekKey].totalActual += item.receiptAmount || 0;
                        budgetsByWeek[weekKey].allItems.push({
                            ...item,
                            budgetLabel: budget.weekLabel,
                            isPartial: budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment')
                        });
                    });
                }
                
                budgetsByWeek[weekKey].budgets.push(budget);
            });
            
            // Convert to array and sort by date (newest first)
            const weekEntries = Object.values(budgetsByWeek).sort((a, b) => 
                new Date(b.weekStart) - new Date(a.weekStart)
            );
            
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            weekEntries.forEach(weekData => {
                const weekLabel = weekData.budgets[0]?.weekLabel || `Week ${weekData.weekNumber}, ${weekData.year}`;
                const hasPartial = weekData.budgets.some(b => b.isPartialPayment || b.weekLabel?.includes('Partial Payment'));
                const latestDate = weekData.budgets.sort((a, b) => new Date(b.savedDate) - new Date(a.savedDate))[0].savedDate;
                const dateStr = new Date(latestDate).toLocaleDateString();
                
                // Get items with receipts (actual amounts)
                const itemsWithReceipts = weekData.allItems.filter(item => 
                    item.receiptAmount && item.receiptAmount > 0
                );
                
                html += `
                    <div style="border: 1px solid #e1e8ed; border-left: 4px solid #3498db; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <h4 style="margin: 0; color: #2c3e50;">${weekLabel.replace(' (Partial Payment)', '')}</h4>
                                    ${hasPartial ? '<span style="background: #3498db; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">' + (currentLanguage === 'en' ? 'INCLUDES PARTIAL PAYMENT' : 'INCLUYE PAGO PARCIAL') + '</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 5px;">
                                    ${currentLanguage === 'en' ? 'Week' : 'Semana'} ${weekData.weekNumber}, ${weekData.year} â€¢ ${dateStr}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e1e8ed;">
                                <div style="font-size: 0.75rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Total Budgeted" data-es="Total Presupuestado">Total Budgeted</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">$${weekData.totalBudgeted.toFixed(2)} MXN</div>
                                <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 3px;">
                                    ${weekData.budgets.length} ${currentLanguage === 'en' ? 'budget(s)' : 'presupuesto(s)'}
                                </div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e1e8ed;">
                                <div style="font-size: 0.75rem; color: #7f8c8d; margin-bottom: 5px;" data-en="Total Actual (Receipts)" data-es="Total Real (Recibos)">Total Actual (Receipts)</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">$${weekData.totalActual.toFixed(2)} MXN</div>
                                <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 3px;">
                                    ${itemsWithReceipts.length} ${currentLanguage === 'en' ? 'item(s) with receipts' : 'artÃ­culo(s) con recibos'}
                                </div>
                            </div>
                        </div>
                        
                        ${itemsWithReceipts.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h5 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 0.95rem;" data-en="Items with Receipts (Actual Amounts)" data-es="ArtÃ­culos con Recibos (Montos Reales)">Items with Receipts (Actual Amounts)</h5>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        ` : ''}
                        ${itemsWithReceipts.map(item => {
                            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                            const budgeted = item.totalPrice || 0;
                            const actual = item.receiptAmount || 0;
                            const difference = actual - budgeted;
                            const diffColor = difference >= 0 ? '#27ae60' : '#e74c3c';
                            const diffIcon = difference >= 0 ? '+' : '';
                            const hasFile = item.invoicePhoto ? 'ðŸ“Ž' : '';
                            
                            return `
                                <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid ${diffColor}; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #2c3e50;">${itemName} ${hasFile}</div>
                                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 3px;">
                                            ${currentLanguage === 'en' ? 'Budgeted' : 'Presupuestado'}: $${budgeted.toFixed(2)} MXN
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: ${diffColor}; font-size: 1.1rem;">
                                            ${diffIcon}$${difference.toFixed(2)} MXN
                                        </div>
                                        <div style="font-size: 0.75rem; color: #7f8c8d;">
                                            ${currentLanguage === 'en' ? 'Actual' : 'Real'}: $${actual.toFixed(2)} MXN
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${itemsWithReceipts.length > 0 ? `
                                </div>
                            </div>
                        ` : `
                            <div style="padding: 15px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px; font-size: 0.9rem;">
                                ${currentLanguage === 'en' ? 'No receipts added yet for this week' : 'AÃºn no se han agregado recibos para esta semana'}
                            </div>
                        `}
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            ${weekData.budgets.map(budget => `
                                <button class="btn btn-sm btn-primary" onclick="viewSavedBudget(${budget.id})" style="padding: 4px 12px; font-size: 0.85rem;" 
                                        data-en="View ${budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment') ? 'Partial Payment' : 'Budget'}" 
                                        data-es="Ver ${budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment') ? 'Pago Parcial' : 'Presupuesto'}">
                                    ${budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment') ? 
                                        (currentLanguage === 'en' ? 'View Partial Payment' : 'Ver Pago Parcial') : 
                                        (currentLanguage === 'en' ? 'View Budget' : 'Ver Presupuesto')}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            updateLanguage();
        }
        
        // Helper function to get week number of the year
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        // Function to calculate budget vs actual spending
        function calculateBudgetVsActual() {
            // Calculate totals from current budget
            let totalBudgeted = 0;
            let totalActual = 0;
            const itemComparisons = [];
            
            items.forEach(item => {
                const budgeted = item.totalPrice || 0;
                const actual = item.receiptAmount || 0;
                
                totalBudgeted += budgeted;
                totalActual += actual;
                
                if (item.invoicePhoto || item.receiptAmount) {
                    const difference = actual - budgeted;
                    itemComparisons.push({
                        item: item,
                        budgeted: budgeted,
                        actual: actual,
                        difference: difference
                    });
                }
            });
            
            // Add totals from all saved budgets (including partial payments)
            const savedBudgets = getAllSavedBudgetsSync();
            savedBudgets.forEach(budget => {
                if (budget.items && budget.items.length > 0) {
                    budget.items.forEach(item => {
                        totalBudgeted += item.totalPrice || 0;
                        totalActual += item.receiptAmount || 0;
                        
                        // Add to comparisons if has receipt
                        if (item.invoicePhoto || item.receiptAmount) {
                            const budgeted = item.totalPrice || 0;
                            const actual = item.receiptAmount || 0;
                            const difference = actual - budgeted;
                            itemComparisons.push({
                                item: {
                                    ...item,
                                    weekLabel: budget.weekLabel,
                                    isPartial: budget.isPartialPayment || budget.weekLabel?.includes('Partial Payment')
                                },
                                budgeted: budgeted,
                                actual: actual,
                                difference: difference
                            });
                        }
                    });
                }
            });
            
            // Update totals display
            const totalBudgetedEl = document.getElementById('totalBudgeted');
            const totalActualEl = document.getElementById('totalActual');
            const runningBalanceEl = document.getElementById('runningBalance');
            const balanceStatusEl = document.getElementById('balanceStatus');
            const balanceCard = document.getElementById('balanceCard');
            
            if (totalBudgetedEl) totalBudgetedEl.textContent = `$${totalBudgeted.toFixed(2)} MXN`;
            if (totalActualEl) totalActualEl.textContent = `$${totalActual.toFixed(2)} MXN`;
            
            const runningBalance = totalActual - totalBudgeted;
            if (runningBalanceEl) runningBalanceEl.textContent = `$${Math.abs(runningBalance).toFixed(2)} MXN`;
            
            // Update balance status and color
            if (runningBalance >= 0) {
                // Surplus (green)
                if (balanceStatusEl) balanceStatusEl.textContent = currentLanguage === 'en' ? 'Surplus' : 'Excedente';
                if (balanceCard) balanceCard.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
            } else {
                // Negative (red)
                if (balanceStatusEl) balanceStatusEl.textContent = currentLanguage === 'en' ? 'Over Budget' : 'Sobre Presupuesto';
                if (balanceCard) balanceCard.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            }
            
            // Display item-by-item comparison
            const itemComparisonList = document.getElementById('itemComparisonList');
            if (!itemComparisonList) return;
            
            if (itemComparisons.length === 0) {
                itemComparisonList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        ${currentLanguage === 'en' ? 'No items with receipts yet.' : 'AÃºn no hay artÃ­culos con recibos.'}
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            itemComparisons.forEach((comp, index) => {
                const itemName = currentLanguage === 'en' ? comp.item.nameEn : comp.item.nameEs;
                const diffColor = comp.difference >= 0 ? '#27ae60' : '#e74c3c';
                const diffIcon = comp.difference >= 0 ? '+' : '';
                const hasFile = comp.item.invoicePhoto ? 'ðŸ“Ž' : '';
                const weekLabel = comp.item.weekLabel ? ` (${comp.item.weekLabel.replace(' (Partial Payment)', '')})` : '';
                const isPartial = comp.item.isPartial ? ' [PARTIAL]' : '';
                const hasAdjustment = comp.item.adjustmentApplied || false;
                
                html += `
                    <div style="padding: 15px; background: white; border: 1px solid #e1e8ed; border-left: 3px solid ${diffColor}; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1;">
                                <strong style="color: #2c3e50;">${itemName} ${hasFile}</strong>
                                ${weekLabel ? `<div style="font-size: 0.75rem; color: #7f8c8d; margin-top: 3px;">${weekLabel}${isPartial}</div>` : ''}
                                ${hasAdjustment ? `<div style="font-size: 0.75rem; color: #27ae60; margin-top: 3px; font-weight: 600;">âœ“ ${currentLanguage === 'en' ? 'Adjustment applied to next budget' : 'Ajuste aplicado al siguiente presupuesto'}</div>` : ''}
                            </div>
                            <span style="color: ${diffColor}; font-weight: bold; font-size: 1.1rem;">
                                ${diffIcon}$${Math.abs(comp.difference).toFixed(2)} MXN
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px;">
                            <div>
                                <strong>${currentLanguage === 'en' ? 'Budgeted' : 'Presupuestado'}:</strong><br>
                                $${comp.budgeted.toFixed(2)} MXN
                            </div>
                            <div>
                                <strong>${currentLanguage === 'en' ? 'Actual' : 'Real'}:</strong><br>
                                $${comp.actual.toFixed(2)} MXN
                            </div>
                            <div>
                                <strong>${currentLanguage === 'en' ? 'Difference' : 'Diferencia'}:</strong><br>
                                <span style="color: ${diffColor}; font-weight: bold;">
                                    ${comp.difference >= 0 ? '+' : ''}$${comp.difference.toFixed(2)} MXN
                                </span>
                            </div>
                        </div>
                        ${!hasAdjustment && Math.abs(comp.difference) > 0.01 ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e1e8ed; display: flex; gap: 8px; flex-wrap: wrap;">
                                ${comp.difference > 0 ? `
                                    <button class="btn btn-sm" onclick="applySurplusCreditToCurrentBudget(${comp.difference}, '${(comp.item.nameEn || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${(comp.item.nameEs || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${(comp.item.weekLabel || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" 
                                            style="background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;"
                                            data-en="Apply credit to current budget" 
                                            data-es="Aplicar crÃ©dito al presupuesto actual">
                                        ðŸ’° ${currentLanguage === 'en' ? 'Apply Credit to Current Budget' : 'Aplicar CrÃ©dito al Presupuesto Actual'}
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm" onclick="applyDifferenceToNextBudget(${comp.difference}, '${(comp.item.category || '').replace(/'/g, "\\'")}', '${(comp.item.nameEn || '').replace(/'/g, "\\'")}', '${(comp.item.nameEs || '').replace(/'/g, "\\'")}', ${comp.item.quantity || 1})" 
                                        style="background: ${comp.difference >= 0 ? '#3498db' : '#e74c3c'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;"
                                        data-en="${comp.difference >= 0 ? 'Adjust price for next budget' : 'Subtract'} ${Math.abs(comp.difference).toFixed(2)} MXN to next budget" 
                                        data-es="${comp.difference >= 0 ? 'Ajustar precio para el siguiente presupuesto' : 'Restar'} ${Math.abs(comp.difference).toFixed(2)} MXN al siguiente presupuesto">
                                    ${comp.difference >= 0 ? 'ðŸ“' : 'âž–'} ${currentLanguage === 'en' ? (comp.difference >= 0 ? 'Adjust Price for Next Budget' : 'Subtract') : (comp.difference >= 0 ? 'Ajustar Precio para el Siguiente Presupuesto' : 'Restar')} ${comp.difference < 0 ? Math.abs(comp.difference).toFixed(2) + ' MXN ' + (currentLanguage === 'en' ? 'to next budget' : 'al siguiente presupuesto') : ''}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            itemComparisonList.innerHTML = html;
        }
        
        // Function to apply difference to next budget
        function applyDifferenceToNextBudget(difference, category, nameEn, nameEs, quantity) {
            // Find the item in the category database
            const categoryItems = itemDatabase[category] || [];
            const itemIndex = categoryItems.findIndex(item => 
                item.nameEn === nameEn && item.nameEs === nameEs
            );
            
            if (itemIndex === -1) {
                alert(currentLanguage === 'en' 
                    ? 'Item not found in category database. Please add it to a category first.' 
                    : 'ArtÃ­culo no encontrado en la base de datos de categorÃ­as. Por favor agrÃ©galo a una categorÃ­a primero.');
                return;
            }
            
            const item = categoryItems[itemIndex];
            const currentUnitPrice = item.unitPrice || 0;
            const budgetQuantity = quantity || 1;
            
            // Calculate adjustment per unit (divide difference by the quantity used in the budget)
            const adjustmentPerUnit = difference / budgetQuantity;
            const newUnitPrice = currentUnitPrice + adjustmentPerUnit;
            
            // Confirm the action
            const action = difference >= 0 ? 
                (currentLanguage === 'en' ? 'add' : 'agregar') : 
                (currentLanguage === 'en' ? 'subtract' : 'restar');
            const confirmMsg = currentLanguage === 'en' 
                ? `Apply ${Math.abs(difference).toFixed(2)} MXN ${action} to "${nameEn}"?\n\nCurrent unit price: $${currentUnitPrice.toFixed(2)} MXN\nNew unit price: $${newUnitPrice.toFixed(2)} MXN\n\nThis will adjust the price for the next time this item is added to a budget.`
                : `Â¿Aplicar ${Math.abs(difference).toFixed(2)} MXN ${action} a "${nameEs}"?\n\nPrecio unitario actual: $${currentUnitPrice.toFixed(2)} MXN\nNuevo precio unitario: $${newUnitPrice.toFixed(2)} MXN\n\nEsto ajustarÃ¡ el precio para la prÃ³xima vez que este artÃ­culo se agregue a un presupuesto.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Update the item's unit price
            item.unitPrice = Math.max(0, newUnitPrice); // Ensure price doesn't go negative
            
            // Store adjustment info
            if (!item.adjustments) {
                item.adjustments = [];
            }
            item.adjustments.push({
                date: new Date().toISOString(),
                difference: difference,
                oldPrice: currentUnitPrice,
                newPrice: item.unitPrice,
                reason: currentLanguage === 'en' ? 'Applied from budget vs actual difference' : 'Aplicado de diferencia presupuesto vs real'
            });
            
            // Save the updated item database
            saveCategoryItems();
            
            // Mark the comparison item as having adjustment applied
            // We need to find and update the item in saved budgets and current items
            const savedBudgets = getAllSavedBudgetsSync();
            savedBudgets.forEach(budget => {
                if (budget.items) {
                    budget.items.forEach(budgetItem => {
                        if (budgetItem.nameEn === nameEn && budgetItem.nameEs === nameEs && 
                            budgetItem.category === category && budgetItem.receiptAmount) {
                            budgetItem.adjustmentApplied = true;
                        }
                    });
                }
            });
            localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
            
            // Also check current items
            items.forEach(item => {
                if (item.nameEn === nameEn && item.nameEs === nameEs && 
                    item.category === category && item.receiptAmount) {
                    item.adjustmentApplied = true;
                }
            });
            saveItems();
            
            // Refresh the display
            calculateBudgetVsActual();
            
            // Show success message
            showApprovalStatus('success', currentLanguage === 'en' 
                ? `Price adjusted! Next time "${nameEn}" is added, it will use the new price of $${item.unitPrice.toFixed(2)} MXN per unit.`
                : `Â¡Precio ajustado! La prÃ³xima vez que se agregue "${nameEs}", usarÃ¡ el nuevo precio de $${item.unitPrice.toFixed(2)} MXN por unidad.`);
        }
        
        // Function to apply surplus credit to current budget
        function applySurplusCreditToCurrentBudget(surplusAmount, sourceItemNameEn, sourceItemNameEs, weekLabel) {
            // Create modal for selecting item and amount
            const modal = document.createElement('div');
            modal.id = 'surplusCreditModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            // Clean weekLabel for display
            const cleanWeekLabel = weekLabel ? weekLabel.replace(' (Partial Payment)', '').replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
            const weekInfo = cleanWeekLabel ? ` (${cleanWeekLabel})` : '';
            const sourceItemName = currentLanguage === 'en' ? sourceItemNameEn : sourceItemNameEs;
            const safeSourceItemName = sourceItemName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 10px; padding: 25px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin-top: 0; color: #2c3e50;" data-en="Apply Surplus Credit to Current Budget" data-es="Aplicar CrÃ©dito de Excedente al Presupuesto Actual">Apply Surplus Credit to Current Budget</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">
                        <span data-en="Apply credit from overpayment on &quot;${safeSourceItemName}&quot;${weekInfo} to an item in your current budget." data-es="Aplicar crÃ©dito del sobrepago en &quot;${safeSourceItemName}&quot;${weekInfo} a un artÃ­culo en su presupuesto actual.">
                            Apply credit from overpayment on "${safeSourceItemName}"${weekInfo} to an item in your current budget.
                        </span>
                    </p>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #27ae60;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;" data-en="Available Surplus" data-es="Excedente Disponible">Available Surplus:</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #27ae60;">$${surplusAmount.toFixed(2)} MXN</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;" data-en="Select Item to Apply Credit To" data-es="Seleccionar ArtÃ­culo para Aplicar CrÃ©dito">Select Item to Apply Credit To:</label>
                        <select id="surplusCreditItemSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                            <option value="" data-en="-- Select an item --" data-es="-- Seleccionar un artÃ­culo --">-- Select an item --</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;" data-en="Credit Amount (MXN)" data-es="Monto del CrÃ©dito (MXN)">Credit Amount (MXN):</label>
                        <input type="number" id="surplusCreditAmount" value="${surplusAmount.toFixed(2)}" step="0.01" min="0.01" max="${surplusAmount.toFixed(2)}" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;"
                               onchange="updateSurplusCreditPreview()">
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;" data-en="Maximum: $${surplusAmount.toFixed(2)} MXN" data-es="MÃ¡ximo: $${surplusAmount.toFixed(2)} MXN">Maximum: $${surplusAmount.toFixed(2)} MXN</small>
                    </div>
                    
                    <div id="surplusCreditPreview" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                        <div style="font-size: 0.9rem; color: #7f8c8d;" data-en="Preview:" data-es="Vista previa:">Preview:</div>
                        <div id="surplusCreditPreviewText" style="margin-top: 5px; font-weight: 600; color: #2c3e50;"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeSurplusCreditModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;" data-en="Cancel" data-es="Cancelar">Cancel</button>
                        <button onclick="confirmSurplusCredit('${sourceItemNameEn.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${sourceItemNameEs.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${cleanWeekLabel}', ${surplusAmount})" 
                                style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 600;" 
                                data-en="Apply Credit" data-es="Aplicar CrÃ©dito">Apply Credit</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateLanguage();
            
            // Populate item select with current budget items
            const itemSelect = document.getElementById('surplusCreditItemSelect');
            items.forEach((item, index) => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const currentTotal = item.totalPrice || 0;
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${itemName} - Current: $${currentTotal.toFixed(2)} MXN`;
                itemSelect.appendChild(option);
            });
            
            // Update preview when selection changes
            itemSelect.addEventListener('change', updateSurplusCreditPreview);
            document.getElementById('surplusCreditAmount').addEventListener('input', updateSurplusCreditPreview);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSurplusCreditModal();
                }
            });
        }
        
        function updateSurplusCreditPreview() {
            const itemSelect = document.getElementById('surplusCreditItemSelect');
            const amountInput = document.getElementById('surplusCreditAmount');
            const preview = document.getElementById('surplusCreditPreview');
            const previewText = document.getElementById('surplusCreditPreviewText');
            
            if (!itemSelect || !amountInput || !preview || !previewText) return;
            
            const selectedIndex = itemSelect.value;
            const creditAmount = parseFloat(amountInput.value) || 0;
            
            if (selectedIndex && creditAmount > 0) {
                const item = items[parseInt(selectedIndex)];
                if (item) {
                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                    const currentTotal = item.totalPrice || 0;
                    const newTotal = Math.max(0, currentTotal - creditAmount);
                    
                    preview.style.display = 'block';
                    previewText.innerHTML = currentLanguage === 'en'
                        ? `"${itemName}" will be reduced from $${currentTotal.toFixed(2)} MXN to $${newTotal.toFixed(2)} MXN`
                        : `"${itemName}" se reducirÃ¡ de $${currentTotal.toFixed(2)} MXN a $${newTotal.toFixed(2)} MXN`;
                }
            } else {
                preview.style.display = 'none';
            }
        }
        
        function closeSurplusCreditModal() {
            const modal = document.getElementById('surplusCreditModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function confirmSurplusCredit(sourceItemNameEn, sourceItemNameEs, weekLabel, maxSurplus) {
            const itemSelect = document.getElementById('surplusCreditItemSelect');
            const amountInput = document.getElementById('surplusCreditAmount');
            
            if (!itemSelect || !itemSelect.value) {
                alert(currentLanguage === 'en' 
                    ? 'Please select an item to apply the credit to.' 
                    : 'Por favor seleccione un artÃ­culo para aplicar el crÃ©dito.');
                return;
            }
            
            const creditAmount = parseFloat(amountInput.value) || 0;
            if (creditAmount <= 0 || creditAmount > maxSurplus) {
                alert(currentLanguage === 'en' 
                    ? `Please enter a valid credit amount between $0.01 and $${maxSurplus.toFixed(2)} MXN.` 
                    : `Por favor ingrese un monto de crÃ©dito vÃ¡lido entre $0.01 y $${maxSurplus.toFixed(2)} MXN.`);
                return;
            }
            
            const selectedIndex = parseInt(itemSelect.value);
            const item = items[selectedIndex];
            
            if (!item) {
                alert(currentLanguage === 'en' 
                    ? 'Selected item not found.' 
                    : 'ArtÃ­culo seleccionado no encontrado.');
                return;
            }
            
            const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
            const currentTotal = item.totalPrice || 0;
            const newTotal = Math.max(0, currentTotal - creditAmount);
            
            // Confirm action
            const weekInfo = weekLabel ? ` from ${weekLabel.replace(' (Partial Payment)', '')}` : '';
            const confirmMsg = currentLanguage === 'en'
                ? `Apply $${creditAmount.toFixed(2)} MXN credit to "${itemName}"?\n\nCurrent total: $${currentTotal.toFixed(2)} MXN\nNew total: $${newTotal.toFixed(2)} MXN\n\nThis credit is from overpayment on "${currentLanguage === 'en' ? sourceItemNameEn : sourceItemNameEs}"${weekInfo}.`
                : `Â¿Aplicar crÃ©dito de $${creditAmount.toFixed(2)} MXN a "${itemName}"?\n\nTotal actual: $${currentTotal.toFixed(2)} MXN\nNuevo total: $${newTotal.toFixed(2)} MXN\n\nEste crÃ©dito es del sobrepago en "${currentLanguage === 'en' ? sourceItemNameEn : sourceItemNameEs}"${weekInfo}.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Apply credit
            const oldTotal = item.totalPrice || 0;
            item.totalPrice = newTotal;
            
            // Recalculate unit price if quantity exists
            if (item.quantity && item.quantity > 0) {
                item.unitPrice = newTotal / item.quantity;
            }
            
            // Add note about overpayment
            const weekNote = weekLabel ? ` (${weekLabel.replace(' (Partial Payment)', '')})` : '';
            const creditNoteEn = `Overpayment credit applied: -$${creditAmount.toFixed(2)} MXN from overpayment on "${sourceItemNameEn}"${weekNote}`;
            const creditNoteEs = `CrÃ©dito de sobrepago aplicado: -$${creditAmount.toFixed(2)} MXN del sobrepago en "${sourceItemNameEs}"${weekNote}`;
            
            // Add or update notes
            if (!item.notes || item.notes === '(none)') {
                item.notes = currentLanguage === 'en' ? creditNoteEn : creditNoteEs;
            } else {
                item.notes = item.notes + '\n' + (currentLanguage === 'en' ? creditNoteEn : creditNoteEs);
            }
            
            // Also update notesEn and notesEs
            if (!item.notesEn || item.notesEn === '(none)') {
                item.notesEn = creditNoteEn;
            } else {
                item.notesEn = item.notesEn + '\n' + creditNoteEn;
            }
            
            if (!item.notesEs || item.notesEs === '(none)') {
                item.notesEs = creditNoteEs;
            } else {
                item.notesEs = item.notesEs + '\n' + creditNoteEs;
            }
            
            // Save items
            await saveItems();
            
            // Refresh displays
            renderBudgetItems();
            updateTotal();
            calculateBudgetVsActual();
            
            // Close modal
            closeSurplusCreditModal();
            
            // Show success message
            showApprovalStatus('success', currentLanguage === 'en' 
                ? `Credit of $${creditAmount.toFixed(2)} MXN applied to "${itemName}". New total: $${newTotal.toFixed(2)} MXN.`
                : `CrÃ©dito de $${creditAmount.toFixed(2)} MXN aplicado a "${itemName}". Nuevo total: $${newTotal.toFixed(2)} MXN.`);
        }

        // Canada Request Functions
        let canadaSelectedItems = JSON.parse(localStorage.getItem('canadaSelectedItems')) || {};
        // Request counter - starts at 0 and increments for each new request
        // Initialize counter: if not set, check existing history and start from max ID + 1, or 0 if no history
        let savedCounter = localStorage.getItem('canadaRequestCounter');
        let canadaRequestCounter;
        if (savedCounter !== null) {
            canadaRequestCounter = parseInt(savedCounter);
        } else {
            // First time - check existing history to avoid conflicts
            const existingHistory = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            if (existingHistory.length > 0) {
                // Find max ID from existing requests (could be Date.now() values)
                const maxId = Math.max(...existingHistory.map(req => typeof req.id === 'number' ? req.id : 0));
                // Start counter at 0 for new requests (existing ones can coexist)
                canadaRequestCounter = 0;
            } else {
                canadaRequestCounter = 0;
            }
            localStorage.setItem('canadaRequestCounter', canadaRequestCounter.toString());
        }
        
        function loadCanadaItems() {
            const canadaItemsList = document.getElementById('canadaItemsList');
            if (!canadaItemsList) return;
            
            // Get all items from Canada category OR items marked forCanada
            const canadaItems = [];
            
            // Use global itemDatabase (synced with Supabase) and categories
            // Also check localStorage as fallback
            const savedCategories = categories || JSON.parse(localStorage.getItem('customCategories')) || {};
            const savedItemDatabase = itemDatabase || JSON.parse(localStorage.getItem('categoryItems')) || {};
            
            // Find Canada category (case-insensitive search)
            let canadaCategoryKey = null;
            Object.keys(savedCategories).forEach(key => {
                const catNameEn = savedCategories[key].nameEn || '';
                const catNameEs = savedCategories[key].nameEs || '';
                if (catNameEn.toLowerCase() === 'canada' || catNameEs.toLowerCase() === 'canadÃ¡' || key.toLowerCase() === 'canada') {
                    canadaCategoryKey = key;
                }
            });
            
            // Get items from Canada category
            if (canadaCategoryKey && savedItemDatabase[canadaCategoryKey] && Array.isArray(savedItemDatabase[canadaCategoryKey])) {
                savedItemDatabase[canadaCategoryKey].forEach(item => {
                    canadaItems.push({...item, source: 'category', category: canadaCategoryKey});
                });
            }
            
            // Also get items marked forCanada from other categories
            Object.keys(savedItemDatabase).forEach(category => {
                if (category === canadaCategoryKey) return; // Skip Canada category (already added)
                if (Array.isArray(savedItemDatabase[category])) {
                    savedItemDatabase[category].forEach(item => {
                        if (item.forCanada) {
                            const exists = canadaItems.find(ci => 
                                ci.nameEn === item.nameEn && 
                                ci.nameEs === item.nameEs && 
                                ci.category === category
                            );
                            if (!exists) {
                                canadaItems.push({...item, source: 'category', category: category});
                            }
                        }
                    });
                }
            });
            
            if (canadaItems.length === 0) {
                canadaItemsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        <strong>${currentLanguage === 'en' ? 'No items available for Canada requests yet.' : 'AÃºn no hay artÃ­culos disponibles para solicitudes de CanadÃ¡.'}</strong>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            ${currentLanguage === 'en' ? 'Mark items as "Available for Canada Requests" when adding them.' : 'Marca los artÃ­culos como "Disponible para Solicitudes de CanadÃ¡" al agregarlos.'}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            canadaItems.forEach(item => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const itemDescription = currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs;
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const itemId = item.id || `canada_${item.nameEn}_${item.category}`;
                const selected = canadaSelectedItems[itemId] || {selected: false, quantity: 1, unit: 'sheet'};
                
                html += `
                    <div style="padding: 15px; background: white; border: 2px solid ${selected.selected ? '#3498db' : '#e1e8ed'}; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="canada_${itemId}" 
                                       ${selected.selected ? 'checked' : ''} 
                                       onchange="toggleCanadaItem('${itemId}')"
                                       style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <strong style="color: #2c3e50; font-size: 1.1rem;">${itemName}</strong>
                                    ${itemDescription ? `<div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 3px;">${itemDescription}</div>` : ''}
                                    <div style="color: #95a5a6; font-size: 0.85rem; margin-top: 5px;">
                                        ${currentLanguage === 'en' ? 'Category' : 'CategorÃ­a'}: ${categoryName}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 0.9rem; color: #7f8c8d;">${currentLanguage === 'en' ? 'Qty:' : 'Cant:'}</span>
                                <input type="number" id="canada_qty_${itemId}" 
                                       value="${selected.quantity}" 
                                       min="1" 
                                       style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                       onchange="updateCanadaQuantity('${itemId}', this.value)"
                                       ${!selected.selected ? 'disabled' : ''}>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <select id="canada_unit_${itemId}" 
                                        style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                        onchange="updateCanadaUnit('${itemId}', this.value)"
                                        ${!selected.selected ? 'disabled' : ''}>
                                    <option value="roll" ${(selected.unit || 'sheet') === 'roll' ? 'selected' : ''}>${currentLanguage === 'en' ? 'Roll' : 'Rollo'}</option>
                                    <option value="sheet" ${(selected.unit || 'sheet') === 'sheet' ? 'selected' : ''}>${currentLanguage === 'en' ? 'Sheet' : 'Hoja'}</option>
                                </select>
                            </label>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            canadaItemsList.innerHTML = html;
        }
        
        function toggleCanadaItem(itemId) {
            const checkbox = document.getElementById(`canada_${itemId}`);
            const quantityInput = document.getElementById(`canada_qty_${itemId}`);
            
            if (!canadaSelectedItems[itemId]) {
                canadaSelectedItems[itemId] = {selected: false, quantity: 1, unit: 'sheet'};
            }
            
            canadaSelectedItems[itemId].selected = checkbox.checked;
            quantityInput.disabled = !checkbox.checked;
            const unitSelect = document.getElementById(`canada_unit_${itemId}`);
            if (unitSelect) {
                unitSelect.disabled = !checkbox.checked;
            }
            
            if (!checkbox.checked) {
                canadaSelectedItems[itemId].quantity = 1;
                canadaSelectedItems[itemId].unit = 'sheet';
                quantityInput.value = 1;
                if (unitSelect) {
                    unitSelect.value = 'sheet';
                }
            }
            
            localStorage.setItem('canadaSelectedItems', JSON.stringify(canadaSelectedItems));
            updateCanadaRequestSummary();
        }
        
        function updateCanadaQuantity(itemId, quantity) {
            if (!canadaSelectedItems[itemId]) {
                canadaSelectedItems[itemId] = {selected: true, quantity: 1, unit: 'sheet'};
            }
            canadaSelectedItems[itemId].quantity = parseInt(quantity) || 1;
            localStorage.setItem('canadaSelectedItems', JSON.stringify(canadaSelectedItems));
            updateCanadaRequestSummary();
        }
        
        function updateCanadaUnit(itemId, unit) {
            if (!canadaSelectedItems[itemId]) {
                canadaSelectedItems[itemId] = {selected: true, quantity: 1, unit: 'sheet'};
            }
            canadaSelectedItems[itemId].unit = unit || 'sheet';
            localStorage.setItem('canadaSelectedItems', JSON.stringify(canadaSelectedItems));
            updateCanadaRequestSummary();
        }
        
        function updateCanadaRequestSummary() {
            const summaryDiv = document.getElementById('canadaRequestSummary');
            if (!summaryDiv) return;
            
            const selected = Object.keys(canadaSelectedItems).filter(id => canadaSelectedItems[id].selected);
            
            if (selected.length === 0) {
                summaryDiv.innerHTML = `
                    <p style="color: #7f8c8d; text-align: center;" data-en="No items selected yet" data-es="AÃºn no se han seleccionado artÃ­culos">No items selected yet</p>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            selected.forEach(itemId => {
                const selection = canadaSelectedItems[itemId];
                // Find the item
                let item = items.find(i => (i.id || `canada_${i.nameEn}_${i.category}`) == itemId);
                if (!item) {
                    // Search in category database
                    Object.keys(itemDatabase).forEach(category => {
                        const found = itemDatabase[category].find(i => (i.id || `canada_${i.nameEn}_${category}`) == itemId);
                        if (found) item = {...found, category: category};
                    });
                }
                
                if (item) {
                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                    const unit = selection.unit || 'sheet';
                    const unitLabels = {
                        'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                        'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                    };
                    const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                    html += `
                        <div style="padding: 10px; background: white; border-left: 4px solid #3498db; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>${itemName}</strong></span>
                            <span style="color: #7f8c8d;">${currentLanguage === 'en' ? 'Quantity' : 'Cantidad'}: ${selection.quantity} ${unitLabel}</span>
                        </div>
                    `;
                }
            });
            html += '</div>';
            summaryDiv.innerHTML = html;
        }
        
        function clearCanadaSelection() {
            if (confirm(currentLanguage === 'en' ? 'Clear all selected items?' : 'Â¿Limpiar todos los artÃ­culos seleccionados?')) {
                Object.keys(canadaSelectedItems).forEach(id => {
                    canadaSelectedItems[id].selected = false;
                });
                localStorage.setItem('canadaSelectedItems', JSON.stringify(canadaSelectedItems));
                loadCanadaItems();
                updateCanadaRequestSummary();
            }
        }
        
        async function generateCanadaRequest() {
            // Ensure canadaSelectedItems is loaded from localStorage
            canadaSelectedItems = JSON.parse(localStorage.getItem('canadaSelectedItems') || '{}');
            
            const selected = Object.keys(canadaSelectedItems).filter(id => canadaSelectedItems[id].selected);
            
            if (selected.length === 0) {
                alert(currentLanguage === 'en' ? 'Please select at least one item' : 'Por favor selecciona al menos un artÃ­culo');
                return;
            }
            
            console.log('Generating Canada request with', selected.length, 'selected items');
            
            const requestItems = [];
            selected.forEach(itemId => {
                const selection = canadaSelectedItems[itemId];
                let item = items.find(i => (i.id || `canada_${i.nameEn}_${i.category}`) == itemId);
                if (!item) {
                    Object.keys(itemDatabase).forEach(category => {
                        const found = itemDatabase[category].find(i => (i.id || `canada_${i.nameEn}_${category}`) == itemId);
                        if (found) item = {...found, category: category};
                    });
                }
                
                if (item) {
                    requestItems.push({
                        nameEn: item.nameEn,
                        nameEs: item.nameEs,
                        descriptionEn: item.descriptionEn || '',
                        descriptionEs: item.descriptionEs || '',
                        category: item.category,
                        quantity: selection.quantity,
                        unit: selection.unit || 'sheet'
                    });
                }
            });
            
            const request = {
                id: canadaRequestCounter,
                date: new Date().toISOString(),
                items: requestItems,
                status: 'pending'
            };
            
            // Increment counter for next request
            canadaRequestCounter++;
            localStorage.setItem('canadaRequestCounter', canadaRequestCounter.toString());
            
            // Save to history (localStorage)
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            history.unshift(request);
            localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
            
            // Save to Supabase if logged in
            if (useSupabase && currentUser) {
                try {
                    console.log('Saving new request to Supabase...');
                    await saveCanadaRequestToSupabase(request);
                    console.log('Request saved to Supabase with ID:', request.id);
                    // Update localStorage with the new database ID
                    const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
                    const requestIndex = history.findIndex(req => req.id === (canadaRequestCounter - 1));
                    if (requestIndex !== -1) {
                        history[requestIndex].id = request.id; // Update with database ID
                        localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
                        console.log('Updated request ID in localStorage:', request.id);
                    } else {
                        console.warn('Could not find request in history to update ID');
                    }
                } catch (err) {
                    console.error('Error saving Canada request to Supabase:', err);
                    // Continue even if Supabase save fails - request is still in localStorage
                }
            }
            
            // Clear selection
            Object.keys(canadaSelectedItems).forEach(id => {
                canadaSelectedItems[id].selected = false;
            });
            localStorage.setItem('canadaSelectedItems', JSON.stringify(canadaSelectedItems));
            
            loadCanadaItems();
            updateCanadaRequestSummary();
            await loadCanadaHistory();
            
            // Generate PDF and send email
            generateCanadaRequestPDF(request).then(() => {
                alert(currentLanguage === 'en' ? 
                    `Request generated successfully! ${requestItems.length} item(s) added to history. Email sent with PDF.` : 
                    `Â¡Solicitud generada exitosamente! ${requestItems.length} artÃ­culo(s) agregado(s) al historial. Correo enviado con PDF.`);
            }).catch(error => {
                console.error('Error sending email:', error);
                const errorMsg = error.message || error.toString();
                alert(currentLanguage === 'en' ? 
                    `Request generated successfully! ${requestItems.length} item(s) added to history.\n\nEmail Error: ${errorMsg}\n\nPlease check EmailJS configuration.` : 
                    `Â¡Solicitud generada exitosamente! ${requestItems.length} artÃ­culo(s) agregado(s) al historial.\n\nError de Correo: ${errorMsg}\n\nPor favor verifica la configuraciÃ³n de EmailJS.`);
            });
        }
        
        function generateCanadaRequestPDF(request) {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Title
                    doc.setFontSize(18);
                    doc.text(currentLanguage === 'en' ? 'Canada Material Request' : 'Solicitud de Materiales de CanadÃ¡', 14, 20);
                    doc.setFontSize(12);
                    doc.text(currentLanguage === 'en' ? `Request Date: ${new Date(request.date).toLocaleDateString()}` : `Fecha de Solicitud: ${new Date(request.date).toLocaleDateString()}`, 14, 30);
                    doc.text(currentLanguage === 'en' ? `Request ID: #${request.id}` : `ID de Solicitud: #${request.id}`, 14, 37);
                    
                    // Prepare table data
                    const tableData = request.items.map((item, index) => {
                        const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                        const itemDescription = currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs;
                        const categoryName = categories[item.category] ? 
                            (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                            item.category;
                        
                        const unit = item.unit || 'sheet';
                        const unitLabels = {
                            'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                            'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                        };
                        const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                        return [
                            index + 1,
                            itemName,
                            itemDescription || '',
                            categoryName,
                            `${item.quantity} ${unitLabel}`
                        ];
                    });
                    
                    // Add table
                    doc.autoTable({
                        startY: 45,
                        head: [[
                            currentLanguage === 'en' ? '#' : '#',
                            currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo',
                            currentLanguage === 'en' ? 'Description' : 'DescripciÃ³n',
                            currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                            currentLanguage === 'en' ? 'Quantity' : 'Cantidad'
                        ]],
                        body: tableData,
                        theme: 'striped',
                        headStyles: { fillColor: [102, 126, 234] },
                        styles: { fontSize: 9 },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 50 },
                            3: { cellWidth: 40 },
                            4: { cellWidth: 25 }
                        }
                    });
                    
                    // Get PDF as base64 using jsPDF's built-in method (more reliable for email attachments)
                    const pdfDataUri = doc.output('datauristring');
                    // Extract base64 part (remove "data:application/pdf;base64," prefix)
                    const pdfBase64 = pdfDataUri.split(',')[1];
                    
                    const pdfFileName = `Canada_Request_${request.id}_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Log PDF generation for debugging
                    console.log('PDF generated for Canada request:', {
                        requestId: request.id,
                        pdfSize: pdfBase64.length,
                        pdfFileName: pdfFileName,
                        itemCount: request.items.length
                    });
                    
                    // Send email
                    sendCanadaRequestEmail(request, pdfBase64, pdfFileName).then(resolve).catch(reject);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    reject(error);
                }
            });
        }
        
        async function sendCanadaRequestEmail(request, pdfBase64, pdfFileName) {
            const canadaEmailjsServiceId = localStorage.getItem('canadaEmailjsServiceId') || localStorage.getItem('emailjsServiceId');
            const canadaEmailjsTemplateId = localStorage.getItem('canadaEmailjsTemplateId');
            const emailjsPublicKey = localStorage.getItem('emailjsPublicKey');
            let recipientEmails = localStorage.getItem('canadaRecipientEmails') || 'shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com';
            
            // Normalize email separators (handle both commas and semicolons)
            recipientEmails = recipientEmails.replace(/;/g, ',');
            
            // Parse email list and clean up
            const emailList = recipientEmails.split(',').map(email => email.trim()).filter(email => email.length > 0);
            
            if (emailList.length === 0) {
                throw new Error('No recipient emails configured. Please add emails in the Canada Email Configuration section.');
            }
            
            if (!canadaEmailjsTemplateId) {
                throw new Error('EmailJS Template ID not configured for Canada requests. Please configure it in the Canada tab.');
            }
            
            if (!emailjsPublicKey) {
                throw new Error('EmailJS Public Key not configured. Please configure it in the main EmailJS settings.');
            }
            
            if (!canadaEmailjsServiceId && !localStorage.getItem('emailjsServiceId')) {
                throw new Error('EmailJS Service ID not configured. Please configure it in the main EmailJS settings or Canada settings.');
            }
            
            // Initialize EmailJS
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS library not loaded');
            }
            
            emailjs.init(emailjsPublicKey);
            
            const requestDate = new Date(request.date).toLocaleDateString();
            const itemCount = request.items.length;
            const totalQuantity = request.items.reduce((sum, item) => sum + item.quantity, 0);
            
            const subject = currentLanguage === 'en' ? `Canada Material Request #${request.id}` : `Solicitud de Materiales de CanadÃ¡ #${request.id}`;
            const message = currentLanguage === 'en' ? 
                `Please find the Canada material request attached.\n\nRequest Details:\n- Request ID: #${request.id}\n- Date: ${requestDate}\n- Items: ${itemCount}\n- Total Quantity: ${totalQuantity}\n\nThe PDF file is attached to this email.\n\nThank you,\nBudget Manager System` :
                `Por favor encuentra la solicitud de materiales de CanadÃ¡ adjunta.\n\nDetalles de la Solicitud:\n- ID de Solicitud: #${request.id}\n- Fecha: ${requestDate}\n- ArtÃ­culos: ${itemCount}\n- Cantidad Total: ${totalQuantity}\n\nEl archivo PDF estÃ¡ adjunto a este correo.\n\nGracias,\nSistema de GestiÃ³n de Presupuesto`;
            
            // Send email to each recipient (EmailJS may not support multiple recipients in one call)
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (const email of emailList) {
                try {
                    // EmailJS expects base64 string without data URI prefix for attachments
                    // Make sure the base64 string is clean (no data:application/pdf;base64, prefix)
                    const cleanBase64 = pdfBase64.startsWith('data:') ? pdfBase64.split(',')[1] : pdfBase64;
                    
                    const emailParams = {
                        email: email,  // Use 'email' to match EmailJS template variable {{email}}
                        to_email: email,  // Also include 'to_email' in case template uses it
                        subject: subject,
                        message: message,
                        pdf_attachment: cleanBase64,  // Clean base64 without data URI prefix
                        pdf_filename: pdfFileName
                    };
                    
                    // Log attachment data size for debugging
                    console.log(`Sending Canada request email to ${email} with PDF attachment:`, {
                        pdf_size: cleanBase64.length,
                        pdf_filename: pdfFileName,
                        pdf_base64_preview: cleanBase64.substring(0, 50) + '...',
                        has_data_uri_prefix: pdfBase64.startsWith('data:')
                    });
                    
                    await emailjs.send(canadaEmailjsServiceId, canadaEmailjsTemplateId, emailParams);
                    successCount++;
                    console.log(`Canada request email sent successfully to ${email}`);
                } catch (error) {
                    errorCount++;
                    console.error(`Error sending email to ${email}:`, error);
                    const errorMsg = error.text || error.message || error.toString();
                    errors.push(`${email}: ${errorMsg}`);
                }
            }
            
            if (errorCount > 0) {
                throw new Error(`Failed to send to ${errorCount} recipient(s). ${successCount} sent successfully. Errors: ${errors.join('; ')}`);
            }
            
            if (successCount === 0) {
                throw new Error('Failed to send email to any recipients');
            }
        }
        
        function toggleCanadaEmailConfig() {
            const details = document.getElementById('canadaEmailConfigDetails');
            const toggle = document.getElementById('canadaEmailConfigToggle');
            
            if (details.style.display === 'none' || !details.style.display) {
                details.style.display = 'block';
                toggle.textContent = currentLanguage === 'en' ? 'Hide Configuration' : 'Ocultar ConfiguraciÃ³n';
            } else {
                details.style.display = 'none';
                toggle.textContent = currentLanguage === 'en' ? 'Show Configuration' : 'Mostrar ConfiguraciÃ³n';
            }
        }
        
        function saveCanadaEmailJSSettings() {
            const serviceId = document.getElementById('canadaEmailjsServiceId').value.trim();
            const templateId = document.getElementById('canadaEmailjsTemplateId').value.trim();
            const recipientEmails = document.getElementById('canadaRecipientEmails').value.trim();
            
            if (serviceId) {
                localStorage.setItem('canadaEmailjsServiceId', serviceId);
            } else {
                localStorage.removeItem('canadaEmailjsServiceId');
            }
            
            if (templateId) {
                localStorage.setItem('canadaEmailjsTemplateId', templateId);
            } else {
                localStorage.removeItem('canadaEmailjsTemplateId');
            }
            
            if (recipientEmails) {
                localStorage.setItem('canadaRecipientEmails', recipientEmails);
            } else {
                localStorage.setItem('canadaRecipientEmails', 'shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com');
            }
        }
        
        function loadCanadaEmailJSSettings() {
            const serviceId = localStorage.getItem('canadaEmailjsServiceId');
            const templateId = localStorage.getItem('canadaEmailjsTemplateId');
            const recipientEmails = localStorage.getItem('canadaRecipientEmails') || 'shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com';
            
            if (document.getElementById('canadaEmailjsServiceId')) {
                document.getElementById('canadaEmailjsServiceId').value = serviceId || '';
            }
            if (document.getElementById('canadaEmailjsTemplateId')) {
                document.getElementById('canadaEmailjsTemplateId').value = templateId || '';
            }
            if (document.getElementById('canadaRecipientEmails')) {
                document.getElementById('canadaRecipientEmails').value = recipientEmails;
            }
        }
        
        async function testCanadaEmailJS() {
            const canadaEmailjsServiceId = localStorage.getItem('canadaEmailjsServiceId') || localStorage.getItem('emailjsServiceId');
            const canadaEmailjsTemplateId = localStorage.getItem('canadaEmailjsTemplateId');
            const emailjsPublicKey = localStorage.getItem('emailjsPublicKey');
            const recipientEmails = localStorage.getItem('canadaRecipientEmails') || 'shipping@oolab.com, natasha@oolab.com, mike@oolab.com, kathryn@oolab.com';
            
            if (!canadaEmailjsTemplateId || !emailjsPublicKey) {
                alert(currentLanguage === 'en' ? 
                    'Please configure EmailJS Template ID and Public Key first' : 
                    'Por favor configura el ID de Plantilla de EmailJS y la Clave PÃºblica primero');
                return;
            }
            
            try {
                // Create a test request
                const testRequest = {
                    id: 'TEST',
                    date: new Date().toISOString(),
                    items: [
                        {
                            nameEn: 'Test Item',
                            nameEs: 'ArtÃ­culo de Prueba',
                            descriptionEn: 'This is a test request',
                            descriptionEs: 'Esta es una solicitud de prueba',
                            category: 'Test',
                            quantity: 1
                        }
                    ],
                    status: 'pending'
                };
                
                // Generate test PDF and send
                await generateCanadaRequestPDF(testRequest);
                alert(currentLanguage === 'en' ? 
                    'Test email sent successfully!' : 
                    'Â¡Correo de prueba enviado exitosamente!');
            } catch (error) {
                console.error('Test email error:', error);
                alert(currentLanguage === 'en' ? 
                    `Error sending test email: ${error.message}` : 
                    `Error al enviar correo de prueba: ${error.message}`);
            }
        }
        
        function exportCanadaRequest() {
            const selected = Object.keys(canadaSelectedItems).filter(id => canadaSelectedItems[id].selected);
            
            if (selected.length === 0) {
                alert(currentLanguage === 'en' ? 'Please select at least one item to export' : 'Por favor selecciona al menos un artÃ­culo para exportar');
                return;
            }
            
            const requestItems = [];
            selected.forEach(itemId => {
                const selection = canadaSelectedItems[itemId];
                let item = items.find(i => (i.id || `canada_${i.nameEn}_${i.category}`) == itemId);
                if (!item) {
                    Object.keys(itemDatabase).forEach(category => {
                        const found = itemDatabase[category].find(i => (i.id || `canada_${i.nameEn}_${category}`) == itemId);
                        if (found) item = {...found, category: category};
                    });
                }
                
                if (item) {
                    const unit = selection.unit || 'sheet';
                    const unitLabels = {
                        'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                        'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                    };
                    const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                    requestItems.push({
                        name: currentLanguage === 'en' ? item.nameEn : item.nameEs,
                        description: currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs,
                        category: categories[item.category] ? 
                            (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                            item.category,
                        quantity: selection.quantity,
                        unit: unitLabel
                    });
                }
            });
            
            // Create Excel export
            const wb = XLSX.utils.book_new();
            const wsData = [
                [currentLanguage === 'en' ? 'Canada Material Request' : 'Solicitud de Materiales de CanadÃ¡'],
                [currentLanguage === 'en' ? `Generated: ${new Date().toLocaleDateString()}` : `Generado: ${new Date().toLocaleDateString()}`],
                [],
                [currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo', 
                 currentLanguage === 'en' ? 'Description' : 'DescripciÃ³n',
                 currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                 currentLanguage === 'en' ? 'Quantity' : 'Cantidad',
                 currentLanguage === 'en' ? 'Unit' : 'Unidad']
            ];
            
            requestItems.forEach(item => {
                wsData.push([item.name, item.description, item.category, item.quantity, item.unit || '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, currentLanguage === 'en' ? 'Canada Request' : 'Solicitud CanadÃ¡');
            XLSX.writeFile(wb, `Canada_Request_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        function loadBackordersSummary() {
            const summaryDiv = document.getElementById('backordersSummary');
            if (!summaryDiv) return;
            
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const allBackorders = [];
            
            // Collect all backorders from all requests
            history.forEach(request => {
                if (request.backorders && request.backorders.length > 0) {
                    request.backorders.forEach(bo => {
                        allBackorders.push({
                            ...bo,
                            requestId: request.id,
                            requestDate: request.date,
                            requestStatus: request.status
                        });
                    });
                }
            });
            
            if (allBackorders.length === 0) {
                summaryDiv.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        <strong>${currentLanguage === 'en' ? 'No backorders found.' : 'No se encontraron pedidos pendientes.'}</strong>
                    </div>
                `;
                return;
            }
            
            // Group backorders by item name
            const groupedBackorders = {};
            allBackorders.forEach(bo => {
                const key = `${bo.nameEn}_${bo.category}`;
                if (!groupedBackorders[key]) {
                    groupedBackorders[key] = {
                        nameEn: bo.nameEn,
                        nameEs: bo.nameEs,
                        category: bo.category,
                        unit: bo.unit,
                        totalBackorderQty: 0,
                        requests: []
                    };
                }
                groupedBackorders[key].totalBackorderQty += bo.backorderQty;
                groupedBackorders[key].requests.push({
                    requestId: bo.requestId,
                    requestDate: bo.requestDate,
                    requestStatus: bo.requestStatus,
                    backorderQty: bo.backorderQty,
                    requestedQty: bo.requestedQty,
                    sentQty: bo.sentQty,
                    reason: bo.reason
                });
            });
            
            const unitLabels = {
                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
            };
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            Object.values(groupedBackorders).forEach((group, groupIndex) => {
                const itemName = currentLanguage === 'en' ? group.nameEn : group.nameEs;
                const unitLabel = unitLabels[group.unit] || unitLabels['sheet'];
                const groupKey = `${group.nameEn}_${group.category}`;
                
                // Check if this entire group is dismissed
                const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders')) || {};
                const isGroupDismissed = dismissedBackorders[groupKey] === true;
                
                if (isGroupDismissed) return; // Skip dismissed backorders
                
                html += `
                    <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #d68910; font-size: 1rem;">${itemName}</strong>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #d68910; font-weight: 700; font-size: 1.1rem;">${currentLanguage === 'en' ? 'Total Backorder' : 'Total Pendiente'}: ${group.totalBackorderQty} ${unitLabel}</span>
                                <button class="btn btn-sm" onclick="dismissBackorder('${groupKey}')" 
                                        style="background: #95a5a6; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;"
                                        title="${currentLanguage === 'en' ? 'Dismiss this backorder' : 'Descartar este pedido pendiente'}">
                                    ${currentLanguage === 'en' ? 'Dismiss' : 'Descartar'}
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #856404;">
                            ${group.requests.map(req => {
                                const date = new Date(req.requestDate).toLocaleDateString();
                                const statusText = req.requestStatus === 'sent' ? 
                                    (currentLanguage === 'en' ? 'Sent' : 'Enviada') :
                                    (req.requestStatus === 'received' ? 
                                    (currentLanguage === 'en' ? 'Received' : 'Recibida') :
                                    (currentLanguage === 'en' ? 'Pending' : 'Pendiente'));
                                const reasonText = req.reason === 'not_assigned' ? 
                                    (currentLanguage === 'en' ? 'Not assigned to shipment' : 'No asignado a envÃ­o') :
                                    (currentLanguage === 'en' ? 'Partial shipment' : 'EnvÃ­o parcial');
                                return `â€¢ Request #${req.requestId} (${date}) - ${req.backorderQty} ${unitLabel} - ${statusText} - ${reasonText}`;
                            }).join('<br>')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            summaryDiv.innerHTML = html;
        }
        
        function dismissBackorder(groupKey) {
            if (confirm(currentLanguage === 'en' 
                ? 'Dismiss this backorder? It will be hidden from all views.' 
                : 'Â¿Descartar este pedido pendiente? Se ocultarÃ¡ de todas las vistas.')) {
                const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders')) || {};
                dismissedBackorders[groupKey] = true;
                localStorage.setItem('dismissedBackorders', JSON.stringify(dismissedBackorders));
                loadBackordersSummary();
                loadCanadaHistory(); // Also refresh the request history to hide dismissed backorders
            }
        }
        
        async function loadCanadaHistory() {
            const historyDiv = document.getElementById('canadaRequestHistory');
            if (!historyDiv) return;
            
            // Also load backorders summary
            loadBackordersSummary();
            
            let history = [];
            
            // If using Supabase, load from database
            if (useSupabase && currentUser) {
                try {
                    // Load Canada requests
                    const { data: requests, error: requestsError } = await supabase
                        .from('canada_requests')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('date', { ascending: false });
                    
                    if (requestsError) throw requestsError;
                    
                    console.log('Loaded requests from Supabase:', requests?.length || 0);
                    
                    if (requests && requests.length > 0) {
                        // Get existing localStorage data to preserve sentItems (not stored in Supabase)
                        const localHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                        
                        // Load items and tracking for each request
                        history = await Promise.all(
                            requests.map(async (req) => {
                                // Load request items
                                const { data: items } = await supabase
                                    .from('canada_request_items')
                                    .select('*')
                                    .eq('request_id', req.id);
                                
                                // Load tracking shipments
                                const { data: tracking, error: trackingError } = await supabase
                                    .from('canada_tracking_shipments')
                                    .select('*')
                                    .eq('request_id', req.id);
                                
                                if (trackingError) {
                                    console.error(`Error loading tracking for request ${req.id}:`, trackingError);
                                } else {
                                    console.log(`Loaded ${tracking?.length || 0} tracking shipments for request ${req.id}:`, tracking);
                                }
                                
                                // Load backorders
                                const { data: backorders } = await supabase
                                    .from('canada_backorders')
                                    .select('*')
                                    .eq('request_id', req.id);
                                
                                // Find matching request in localStorage to preserve sentItems and trackingShipments
                                const localRequest = localHistory.find(lr => lr.id == req.id);
                                
                                // Get tracking shipments from Supabase
                                const supabaseTracking = (tracking || []).map(t => {
                                        // Get item IDs from shipment_items column (JSONB)
                                        let itemIds = t.shipment_items || [];
                                        if (typeof itemIds === 'string') {
                                            try {
                                                itemIds = JSON.parse(itemIds);
                                            } catch (e) {
                                                console.error('Error parsing shipment_items:', e);
                                                itemIds = [];
                                            }
                                        }
                                        // Ensure all IDs are strings for consistency
                                        itemIds = itemIds.map(id => String(id));
                                        
                                        return {
                                            trackingNumber: t.tracking_number || '',
                                            itemIds: itemIds,
                                            upsStatus: t.ups_status || null,
                                            upsLastUpdate: t.ups_last_update || null,
                                            upsHasDutiesDue: t.ups_has_duties_due || false,
                                            upsHasDelay: t.ups_has_delay || false,
                                            upsExceptionDescription: t.ups_exception_description || null,
                                            upsPickedUp: t.ups_picked_up || false,
                                            upsInTransit: t.ups_in_transit || false,
                                            upsDutiesPaid: t.ups_duties_paid || false,
                                            upsDutiesAmount: t.ups_duties_amount || '',
                                            upsStatusCode: t.ups_status_code || null,
                                            upsLastLocation: t.ups_last_location || null,
                                            upsLastDate: t.ups_last_date || null,
                                            upsLastChecked: t.ups_last_checked || null
                                        };
                                    });
                                
                                // Merge Supabase and localStorage tracking data
                                // Prefer the most recent status (compare upsLastChecked timestamps)
                                // This ensures we show the latest status even if Supabase save is delayed
                                let finalTrackingShipments = supabaseTracking;
                                
                                if (localRequest?.trackingShipments && localRequest.trackingShipments.length > 0) {
                                    // Merge: for each tracking number, use the most recent status
                                    const mergedShipments = new Map();
                                    
                                    // Add Supabase shipments first
                                    supabaseTracking.forEach(shipment => {
                                        mergedShipments.set(shipment.trackingNumber, shipment);
                                    });
                                    
                                    // Merge with localStorage, preferring newer status
                                    localRequest.trackingShipments.forEach(localShipment => {
                                        if (!localShipment.trackingNumber) return;
                                        
                                        const existing = mergedShipments.get(localShipment.trackingNumber);
                                        if (!existing) {
                                            // No Supabase entry, use localStorage
                                            mergedShipments.set(localShipment.trackingNumber, localShipment);
                                        } else {
                                            // Compare timestamps - use the newer one
                                            const localTime = localShipment.upsLastChecked ? new Date(localShipment.upsLastChecked).getTime() : 0;
                                            const supabaseTime = existing.upsLastChecked ? new Date(existing.upsLastChecked).getTime() : 0;
                                            
                                            if (localTime > supabaseTime && localShipment.upsStatus && !localShipment.upsStatus.includes('Error')) {
                                                // localStorage has newer status and it's not an error, use it
                                                mergedShipments.set(localShipment.trackingNumber, localShipment);
                                            }
                                        }
                                    });
                                    
                                    finalTrackingShipments = Array.from(mergedShipments.values());
                                } else if (supabaseTracking.length === 0 && localRequest?.trackingShipments) {
                                    // No Supabase data, use localStorage
                                    finalTrackingShipments = localRequest.trackingShipments;
                                }
                                
                                return {
                                    id: req.id,
                                    date: req.date,
                                    status: req.status,
                                    sentDate: req.sent_date,
                                    receivedDate: req.received_date,
                                    items: (items || []).map(item => ({
                                        id: item.id,
                                        nameEn: item.name_en,
                                        nameEs: item.name_es,
                                        category: item.category,
                                        quantity: item.quantity,
                                        unitPrice: parseFloat(item.unit_price || 0),
                                        totalPrice: parseFloat(item.total_price || 0),
                                        notes: item.notes
                                    })),
                                    // Preserve sentItems from localStorage (not stored in Supabase)
                                    sentItems: localRequest?.sentItems || [],
                                    trackingShipments: finalTrackingShipments,
                                    trackingNumbers: finalTrackingShipments.map(t => t.trackingNumber),
                                    trackingNumber: finalTrackingShipments.length > 0 ? finalTrackingShipments[0].trackingNumber : '',
                                    backorders: (backorders || []).map(bo => ({
                                        id: bo.id,
                                        nameEn: bo.name_en,
                                        nameEs: bo.name_es,
                                        category: bo.category,
                                        backorderQty: bo.backorder_qty,
                                        notes: bo.notes
                                    }))
                                };
                            })
                        );
                        
                        // Update localStorage to keep in sync
                        localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
                        console.log('Updated localStorage with Supabase data:', history.length, 'requests');
                    } else {
                        // If Supabase is empty, check localStorage and migrate
                        const localHistory = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                        console.log('No requests in Supabase, checking localStorage:', localHistory.length, 'requests');
                        if (localHistory.length > 0) {
                            console.log('Migrating Canada requests from localStorage to Supabase...');
                            await migrateCanadaRequests(localHistory);
                            // Reload after migration
                            return loadCanadaHistory();
                        }
                        history = localHistory;
                    }
                } catch (error) {
                    console.error('Error loading Canada history from Supabase:', error);
                    // Fallback to localStorage
                    history = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                }
            } else {
                // Not using Supabase - load from localStorage
                history = JSON.parse(localStorage.getItem('canadaRequestHistory') || '[]');
                console.log('loadCanadaHistory: Loaded from localStorage (no Supabase):', history.length, 'requests');
            }
            const filterSelect = document.getElementById('canadaHistoryFilter');
            const filter = filterSelect?.value || 'all';
            
            // Set default to 'all' if not already set
            if (filterSelect && !filterSelect.value) {
                filterSelect.value = 'all';
            }
            
            console.log('Total history loaded:', history.length, 'requests');
            
            let filteredHistory = history;
            if (filter === 'all') {
                // Show ALL requests - no filtering
                filteredHistory = [...history];
                
                // Sort by date descending (newest first)
                filteredHistory.sort((a, b) => {
                    const dateA = new Date(a.date || a.created_at || 0);
                    const dateB = new Date(b.date || b.created_at || 0);
                    return dateB - dateA;
                });
                
                console.log('Filtered history (all):', filteredHistory.length, 'requests');
            } else if (filter === 'pending' || filter === 'sent' || filter === 'received') {
                // Filter by request status
                filteredHistory = history.filter(req => req.status === filter);
            } else if (filter === 'duties') {
                // Filter requests with duties/taxes due
                filteredHistory = history.filter(req => {
                    if (!req.trackingShipments || req.trackingShipments.length === 0) return false;
                    return req.trackingShipments.some(shipment => shipment.upsHasDutiesDue === true);
                });
            } else if (filter === 'delays') {
                // Filter requests with delays/exceptions
                filteredHistory = history.filter(req => {
                    if (!req.trackingShipments || req.trackingShipments.length === 0) return false;
                    return req.trackingShipments.some(shipment => shipment.upsHasDelay === true);
                });
            } else if (filter === 'in_transit') {
                // Filter requests that are in transit (sent but not delivered)
                filteredHistory = history.filter(req => {
                    if (req.status !== 'sent') return false;
                    if (!req.trackingShipments || req.trackingShipments.length === 0) return true;
                    // Check if any shipment is in transit (has status but not delivered)
                    return req.trackingShipments.some(shipment => {
                        const status = (shipment.upsStatus || '').toLowerCase();
                        return status && !status.includes('delivered') && !shipment.upsHasDelay;
                    });
                });
            } else if (filter === 'delivered') {
                // Filter requests with delivered packages
                filteredHistory = history.filter(req => {
                    if (!req.trackingShipments || req.trackingShipments.length === 0) return false;
                    return req.trackingShipments.some(shipment => {
                        const status = (shipment.upsStatus || '').toLowerCase();
                        return status.includes('delivered');
                    });
                });
            } else if (filter === 'backorders') {
                // Filter requests with backorders
                filteredHistory = history.filter(req => {
                    return req.backorders && req.backorders.length > 0;
                });
            }
            
            if (filteredHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        ${currentLanguage === 'en' ? 'No requests found.' : 'No se encontraron solicitudes.'}
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            filteredHistory.forEach(request => {
                const date = new Date(request.date).toLocaleDateString();
                
                // Determine status based on UPS tracking data if available
                let displayStatus = request.status;
                let statusText = '';
                let statusColor = '#f39c12'; // default pending color
                
                if (request.status === 'received') {
                    statusText = currentLanguage === 'en' ? 'Received' : 'Recibido';
                    statusColor = '#27ae60';
                } else if (request.trackingShipments && request.trackingShipments.length > 0) {
                    // Check UPS status from shipments - check both flags and status descriptions
                    const hasPickedUp = request.trackingShipments.some(s => {
                        if (!s.upsStatus) return false;
                        const status = s.upsStatus.toLowerCase();
                        return s.upsPickedUp || 
                               status.includes('origin scan') ||
                               status.includes('picked up') ||
                               status.includes('pickup scan') ||
                               status.includes('we have your package') ||
                               status.includes('package received');
                    });
                    const hasInTransit = request.trackingShipments.some(s => {
                        if (!s.upsStatus) return false;
                        const status = s.upsStatus.toLowerCase();
                        return s.upsInTransit || 
                               status.includes('in transit') ||
                               status.includes('on the way') ||
                               status.includes('shipped') ||
                               status.includes('departed') ||
                               status.includes('arrived') ||
                               (status.includes('transit') && !status.includes('delivered'));
                    });
                    const hasDelivered = request.trackingShipments.some(s => {
                        const status = (s.upsStatus || '').toLowerCase();
                        return status.includes('delivered');
                    });
                    
                    if (hasDelivered) {
                        statusText = currentLanguage === 'en' ? 'Received' : 'Recibido';
                        statusColor = '#27ae60';
                    } else if (hasPickedUp) {
                        statusText = currentLanguage === 'en' ? 'Picked Up' : 'Recogido';
                        statusColor = '#3498db';
                    } else if (hasInTransit) {
                        statusText = currentLanguage === 'en' ? 'In Transit' : 'En TrÃ¡nsito';
                        statusColor = '#3498db';
                    } else if (request.status === 'sent') {
                        statusText = currentLanguage === 'en' ? 'Sent' : 'Enviada';
                        statusColor = '#3498db';
                    } else {
                        statusText = currentLanguage === 'en' ? 'Pending' : 'Pendiente';
                        statusColor = '#f39c12';
                    }
                } else if (request.status === 'sent') {
                    statusText = currentLanguage === 'en' ? 'Sent' : 'Enviada';
                    statusColor = '#3498db';
                } else {
                    statusText = currentLanguage === 'en' ? 'Pending' : 'Pendiente';
                    statusColor = '#f39c12';
                }
                
                // Debug: Log tracking shipments
                console.log(`Request #${request.id} tracking data:`, {
                    hasTrackingShipments: !!(request.trackingShipments && request.trackingShipments.length > 0),
                    trackingShipmentsCount: request.trackingShipments?.length || 0,
                    trackingShipments: request.trackingShipments,
                    hasTrackingNumbers: !!(request.trackingNumbers && request.trackingNumbers.length > 0),
                    trackingNumber: request.trackingNumber
                });
                
                html += `
                    <div data-request-id="${request.id}" style="padding: 15px; background: white; border: 1px solid #e1e8ed; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #2c3e50;">${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong>
                                <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 3px;">${date}</div>
                                ${(request.trackingShipments && request.trackingShipments.length > 0) || (request.trackingNumbers && request.trackingNumbers.length > 0) || request.trackingNumber ? `
                                    <div style="color: #3498db; font-size: 0.85rem; margin-top: 3px;">
                                        <div style="font-weight: 600; margin-bottom: 5px;">
                                            ${currentLanguage === 'en' ? 'Tracking Shipments' : 'EnvÃ­os con Seguimiento'}:
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${request.trackingShipments && request.trackingShipments.length > 0 ? 
                                                request.trackingShipments.map((shipment, idx) => {
                                                    const shipmentItems = request.items.filter((item, itemIdx) => {
                                                        const itemId = item.id !== undefined && item.id !== null 
                                                            ? String(item.id) 
                                                            : `item_${item.nameEn}_${item.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                                        // Convert shipment itemIds to strings for comparison
                                                        const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                                                        return shipmentItemIds.includes(String(itemId));
                                                    });
                                                    
                                                    // Get UPS status if available
                                                    const upsStatus = shipment.upsStatus || '';
                                                    const upsHasDelay = shipment.upsHasDelay || false;
                                                    const upsHasDutiesDue = shipment.upsHasDutiesDue || false;
                                                    const upsDutiesPaid = shipment.upsDutiesPaid || false;
                                                    const upsDutiesAmount = shipment.upsDutiesAmount || '';
                                                    const upsLastLocation = shipment.upsLastLocation || '';
                                                    const upsLastDate = shipment.upsLastDate || '';
                                                    const upsPickedUp = shipment.upsPickedUp || false;
                                                    const upsInTransit = shipment.upsInTransit || false;
                                                    
                                                    // Determine border color and background based on priority: duties > delay > delivered > in transit/picked up > normal
                                                    let borderColor = '#2196F3'; // default blue
                                                    let bgColor = '#e3f2fd'; // default light blue
                                                    
                                                    if (upsHasDutiesDue) {
                                                        borderColor = '#f39c12'; // orange for duties
                                                        bgColor = '#fff3cd'; // light yellow/orange
                                                    } else if (upsHasDelay) {
                                                        borderColor = '#e74c3c'; // red for delays
                                                        bgColor = '#ffebee'; // light red
                                                    } else if (upsStatus.toLowerCase().includes('delivered')) {
                                                        borderColor = '#27ae60'; // green for delivered
                                                        bgColor = '#e8f5e9'; // light green
                                                    } else if (upsPickedUp || upsInTransit) {
                                                        borderColor = '#3498db'; // blue for in transit/picked up
                                                        bgColor = '#e3f2fd'; // light blue
                                                    }
                                                    
                                                    return `
                                                        <div style="padding: 8px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; flex-wrap: wrap;">
                                                                <div style="font-size: 0.85rem; font-weight: 600;">
                                                                    ${currentLanguage === 'en' ? 'Tracking' : 'Seguimiento'} #${idx + 1}:
                                                                </div>
                                                                <a href="https://www.ups.com/track?tracknum=${shipment.trackingNumber}" 
                                                                   target="_blank" 
                                                                   rel="noopener noreferrer"
                                                                   style="font-family: monospace; font-size: 0.85rem; font-weight: 600; color: #3498db; text-decoration: underline; cursor: pointer;"
                                                                   title="${currentLanguage === 'en' ? 'Click to track on UPS website' : 'Haz clic para rastrear en el sitio web de UPS'}">
                                                                    ${shipment.trackingNumber}
                                                                </a>
                                                                ${upsHasDutiesDue ? ' ðŸ’°' : ''}${upsDutiesPaid ? ' âœ…' : ''}${upsHasDelay ? ' âš ï¸' : ''}${upsPickedUp ? ' ðŸ“¦' : ''}${upsInTransit && !upsPickedUp ? ' ðŸšš' : ''}
                                                            </div>
                                                            ${upsHasDutiesDue ? `
                                                                <div style="font-size: 0.8rem; color: #fff; font-weight: 700; margin-top: 5px; margin-bottom: 5px; padding: 6px 10px; background: #f39c12; border-radius: 4px; text-align: center; box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);">
                                                                    ðŸ’° ${currentLanguage === 'en' ? 'DUTIES/TAXES DUE - PAYMENT REQUIRED' : 'IMPUESTOS/ARANCELES PENDIENTES - PAGO REQUERIDO'}
                                                                </div>
                                                            ` : ''}
                                                            ${upsDutiesPaid ? `
                                                                <div style="font-size: 0.8rem; color: #fff; font-weight: 700; margin-top: 5px; margin-bottom: 5px; padding: 6px 10px; background: #27ae60; border-radius: 4px; text-align: center; box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);">
                                                                    âœ… ${currentLanguage === 'en' ? 'IMPORT FEES PAID' : 'TARIFAS DE IMPORTACIÃ“N PAGADAS'}
                                                                </div>
                                                            ` : ''}
                                                            <div style="font-size: 0.85rem; color: ${upsHasDutiesDue ? '#d68910' : (upsHasDelay ? '#c0392b' : (upsStatus ? '#2c3e50' : '#7f8c8d'))}; font-weight: ${(upsHasDutiesDue || upsHasDelay || upsStatus) ? '600' : '500'}; margin-top: 8px; margin-bottom: 5px; padding: 6px 8px; background: ${upsStatus ? '#f8f9fa' : '#fff3cd'}; border-radius: 4px; border-left: 3px solid ${upsHasDutiesDue ? '#f39c12' : (upsHasDelay ? '#e74c3c' : (upsStatus ? '#3498db' : '#f39c12'))};">
                                                                <div style="font-weight: 600; margin-bottom: 3px;">
                                                                    ${currentLanguage === 'en' ? 'Status' : 'Estado'}: 
                                                                    <strong style="color: ${upsHasDutiesDue ? '#d68910' : (upsHasDelay ? '#c0392b' : (upsStatus ? '#2c3e50' : '#7f8c8d'))};">
                                                                        ${upsStatus || (currentLanguage === 'en' ? 'Checking...' : 'Verificando...')}
                                                                    </strong>
                                                                </div>
                                                                ${upsPickedUp ? `<div style="font-size: 0.75rem; color: #3498db; margin-top: 3px;">ðŸ“¦ ${currentLanguage === 'en' ? 'PICKED UP' : 'RECOGIDO'}</div>` : ''}
                                                                ${upsInTransit && !upsPickedUp ? `<div style="font-size: 0.75rem; color: #3498db; margin-top: 3px;">ðŸšš ${currentLanguage === 'en' ? 'IN TRANSIT' : 'EN TRÃNSITO'}</div>` : ''}
                                                                ${upsHasDelay ? `<div style="font-size: 0.75rem; color: #e74c3c; margin-top: 3px;">âš ï¸ ${currentLanguage === 'en' ? 'DELAY/EXCEPTION' : 'RETRASO/EXCEPCIÃ“N'}</div>` : ''}
                                                            </div>
                                                            ${upsHasDutiesDue && upsDutiesAmount ? `
                                                                <div style="font-size: 0.75rem; color: #d68910; font-weight: 600; margin-top: 3px; padding: 4px; background: #fff3cd; border-radius: 3px;">
                                                                    ${currentLanguage === 'en' ? 'Amount Due' : 'Monto Pendiente'}: ${upsDutiesAmount}
                                                                </div>
                                                            ` : ''}
                                                            ${upsLastLocation ? `
                                                                <div style="font-size: 0.75rem; color: #555; margin-top: 3px;">
                                                                    ${currentLanguage === 'en' ? 'Last Location' : 'Ãšltima UbicaciÃ³n'}: ${upsLastLocation}
                                                                    ${upsLastDate ? (() => {
                                                                        try {
                                                                            const date = new Date(upsLastDate);
                                                                            if (!isNaN(date.getTime())) {
                                                                                return ` (${date.toLocaleDateString()})`;
                                                                            }
                                                                        } catch (e) {
                                                                            // Invalid date, skip
                                                                        }
                                                                        return '';
                                                                    })() : ''}
                                                                </div>
                                                            ` : ''}
                                                            ${shipmentItems.length > 0 ? `
                                                                <div style="font-size: 0.75rem; color: #555; margin-top: 3px;">
                                                                    ${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'}: ${shipmentItems.map(item => {
                                                                        const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                                                        return itemName;
                                                                    }).join(', ')}
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    `;
                                                }).join('') :
                                                (request.trackingNumbers && request.trackingNumbers.length > 0 
                                                    ? request.trackingNumbers.map(tn => `
                                                        <div style="padding: 3px 8px; background: #e3f2fd; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">
                                                            <a href="https://www.ups.com/track?tracknum=${tn}" 
                                                               target="_blank" 
                                                               rel="noopener noreferrer"
                                                               style="color: #3498db; text-decoration: underline; cursor: pointer;"
                                                               title="${currentLanguage === 'en' ? 'Click to track on UPS website' : 'Haz clic para rastrear en el sitio web de UPS'}">
                                                                ${tn}
                                                            </a>
                                                        </div>
                                                    `).join('')
                                                    : request.trackingNumber ? `
                                                        <div style="padding: 3px 8px; background: #e3f2fd; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">
                                                            <a href="https://www.ups.com/track?tracknum=${request.trackingNumber}" 
                                                               target="_blank" 
                                                               rel="noopener noreferrer"
                                                               style="color: #3498db; text-decoration: underline; cursor: pointer;"
                                                               title="${currentLanguage === 'en' ? 'Click to track on UPS website' : 'Haz clic para rastrear en el sitio web de UPS'}">
                                                                ${request.trackingNumber}
                                                            </a>
                                                        </div>
                                                    ` : '')
                                            }
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <span style="padding: 5px 12px; background: ${statusColor}; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                                    ${statusText}
                                </span>
                                ${request.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markCanadaRequestSent(${request.id})" 
                                            style="background: #27ae60; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                                        ${currentLanguage === 'en' ? 'Mark as Sent' : 'Marcar como Enviada'}
                                    </button>
                                ` : request.status === 'sent' ? `
                                    <button class="btn btn-sm" onclick="editCanadaRequestTracking(${request.id})" 
                                            style="background: #3498db; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;"
                                            title="${currentLanguage === 'en' ? 'Edit items, quantities, and tracking numbers' : 'Editar artÃ­culos, cantidades y nÃºmeros de seguimiento'}">
                                        ${currentLanguage === 'en' ? 'Edit Items & Tracking' : 'Editar ArtÃ­culos y Seguimiento'}
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm" onclick="deleteCanadaRequest(${request.id})" 
                                        style="background: #e74c3c; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;"
                                        title="${currentLanguage === 'en' ? 'Delete this request (removes from all reports)' : 'Eliminar esta solicitud (elimina de todos los reportes)'}">
                                    ${currentLanguage === 'en' ? 'Delete' : 'Eliminar'}
                                </button>
                            </div>
                        </div>
                        ${(() => {
                            // Only show items section if there are no tracking shipments
                            if (request.trackingShipments && request.trackingShipments.length > 0) {
                                return '';
                            }
                            
                            const unitLabels = {
                                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                            };
                            
                            const itemsHtml = request.items.map((item, itemIdx) => {
                                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                const unit = item.unit || 'sheet';
                                const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                                
                                // Check if there's a sent item or backorder
                                const itemId = item.id !== undefined && item.id !== null 
                                    ? String(item.id) 
                                    : `item_${item.nameEn}_${item.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                
                                // Find which tracking shipment this item belongs to
                                let trackingInfo = '';
                                if (request.trackingShipments && request.trackingShipments.length > 0) {
                                    request.trackingShipments.forEach((shipment, shipmentIdx) => {
                                        const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                                        if (shipmentItemIds.includes(String(itemId))) {
                                            const trackingLink = `<a href="https://www.ups.com/track?tracknum=${shipment.trackingNumber}" 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                style="color: #3498db; text-decoration: underline; font-size: 0.8rem; margin-left: 5px;"
                                                title="${currentLanguage === 'en' ? 'Click to track on UPS website' : 'Haz clic para rastrear en el sitio web de UPS'}">
                                                ðŸ“¦ ${currentLanguage === 'en' ? 'Tracking' : 'Seguimiento'} #${shipmentIdx + 1}: ${shipment.trackingNumber}
                                            </a>`;
                                            trackingInfo = trackingLink;
                                        }
                                    });
                                }
                                
                                const sentItem = request.sentItems && request.sentItems.find(si => {
                                    const siId = si.id !== undefined && si.id !== null 
                                        ? String(si.id) 
                                        : `item_${si.nameEn}_${si.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                    return String(siId) === String(itemId);
                                });
                                const backorder = request.backorders && request.backorders.find(bo => {
                                    const boId = bo.id !== undefined && bo.id !== null 
                                        ? String(bo.id) 
                                        : `item_${bo.nameEn}_${bo.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                    return String(boId) === String(itemId);
                                });
                                
                                let itemDisplay = `<div style="padding: 5px; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">`;
                                itemDisplay += `â€¢ ${itemName} `;
                                
                                // Add tracking info if this item is in a tracking shipment
                                if (trackingInfo) {
                                    itemDisplay += `<br>${trackingInfo}`;
                                }
                                
                                if (sentItem && request.status === 'sent') {
                                    const sentUnitLabel = unitLabels[sentItem.unit] || unitLabels['sheet'];
                                    itemDisplay += `<span style="color: #2c3e50;">(${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${item.quantity} ${unitLabel}, ${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${sentItem.quantity} ${sentUnitLabel})</span>`;
                                    if (backorder) {
                                        // Check if this backorder is dismissed
                                        const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders')) || {};
                                        const boGroupKey = `${backorder.nameEn}_${backorder.category}`;
                                        const isDismissed = dismissedBackorders[boGroupKey] === true;
                                        
                                        if (!isDismissed) {
                                            itemDisplay += ` <span style="color: #e74c3c; font-weight: 600;">âš ï¸ ${currentLanguage === 'en' ? 'Backorder' : 'Pedido Pendiente'}: ${backorder.backorderQty} ${unitLabel}</span>`;
                                        }
                                    }
                                } else {
                                    itemDisplay += `<span style="color: #2c3e50;">(${currentLanguage === 'en' ? 'Qty' : 'Cant'}: ${item.quantity} ${unitLabel})</span>`;
                                }
                                
                                itemDisplay += `</div>`;
                                return itemDisplay;
                            }).join('');
                            
                            // Filter out dismissed backorders
                            const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedBackorders')) || {};
                            const visibleBackorders = request.backorders ? request.backorders.filter(bo => {
                                const boGroupKey = `${bo.nameEn}_${bo.category}`;
                                return dismissedBackorders[boGroupKey] !== true;
                            }) : [];
                            
                            const backordersHtml = visibleBackorders.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <div style="font-weight: 600; color: #d68910; font-size: 0.9rem;">
                                            âš ï¸ ${currentLanguage === 'en' ? 'Backorders' : 'Pedidos Pendientes'}:
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 5px;">
                                        ${visibleBackorders.map(bo => {
                                            const boName = currentLanguage === 'en' ? bo.nameEn : bo.nameEs;
                                            const boUnitLabel = unitLabels[bo.unit] || unitLabels['sheet'];
                                            const boGroupKey = `${bo.nameEn}_${bo.category}`;
                                            return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 3px;">
                                                <div style="font-size: 0.85rem; color: #d68910;">
                                                    â€¢ ${boName}: ${bo.backorderQty} ${boUnitLabel} (${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${bo.requestedQty}, ${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${bo.sentQty})
                                                </div>
                                                <button class="btn btn-sm" onclick="dismissBackorder('${boGroupKey}')" 
                                                        style="background: #95a5a6; color: white; border: none; padding: 3px 10px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap;"
                                                        title="${currentLanguage === 'en' ? 'Dismiss this backorder' : 'Descartar este pedido pendiente'}">
                                                    ${currentLanguage === 'en' ? 'Dismiss' : 'Descartar'}
                                                </button>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : '';
                            
                            return `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 5px;">
                                ${currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos'} (${request.items.length}):
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                ${itemsHtml}
                            </div>
                            ${backordersHtml}
                        </div>
                            `;
                        })()}
                    </div>
                `;
            });
            html += '</div>';
            historyDiv.innerHTML = html;
        }
        
        async function deleteCanadaRequest(requestId) {
            if (!confirm(currentLanguage === 'en' 
                ? `Are you sure you want to delete Request #${requestId}? This action cannot be undone.` 
                : `Â¿EstÃ¡s seguro de que deseas eliminar la Solicitud #${requestId}? Esta acciÃ³n no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Delete from Supabase if logged in
                if (useSupabase && currentUser) {
                    // Delete related data first (cascade should handle this, but being explicit)
                    // Delete tracking shipments
                    const { data: shipments } = await supabase
                        .from('canada_tracking_shipments')
                        .select('id')
                        .eq('request_id', requestId);
                    
                    if (shipments && shipments.length > 0) {
                        await supabase
                            .from('canada_tracking_shipments')
                            .delete()
                            .eq('request_id', requestId);
                    }
                    
                    // Delete request items
                    await supabase
                        .from('canada_request_items')
                        .delete()
                        .eq('request_id', requestId);
                    
                    // Delete backorders
                    await supabase
                        .from('canada_backorders')
                        .delete()
                        .eq('request_id', requestId);
                    
                    // Delete the request itself
                    const { error } = await supabase
                        .from('canada_requests')
                        .delete()
                        .eq('id', requestId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                }
                
                // Delete from localStorage
                const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
                const filteredHistory = history.filter(req => req.id != requestId);
                localStorage.setItem('canadaRequestHistory', JSON.stringify(filteredHistory));
                
                // Reload history
                await loadCanadaHistory();
                
                // Reload reports to exclude deleted request
                const reportsTab = document.getElementById('reportsTab');
                const canadaReportsSection = document.getElementById('canadaReportsSection');
                if (reportsTab && reportsTab.classList.contains('active') && canadaReportsSection && canadaReportsSection.style.display !== 'none') {
                    loadCanadaReport();
                }
                
                // Show confirmation message
                showApprovalStatus('success', currentLanguage === 'en' 
                    ? `Request #${requestId} has been deleted.` 
                    : `La Solicitud #${requestId} ha sido eliminada.`);
            } catch (error) {
                console.error('Error deleting Canada request:', error);
                showApprovalStatus('error', currentLanguage === 'en' 
                    ? `Error deleting request: ${error.message}` 
                    : `Error al eliminar solicitud: ${error.message}`);
            }
        }
        
        // Store current request being processed
        let currentTrackingRequestId = null;
        let trackingShipments = []; // Array of {trackingNumber: '', itemIds: []}

        function markCanadaRequestSent(requestId) {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == requestId);
            if (request) {
                currentTrackingRequestId = requestId;
                
                // Initialize tracking shipments from existing data or empty
                if (request.trackingShipments && request.trackingShipments.length > 0) {
                    trackingShipments = JSON.parse(JSON.stringify(request.trackingShipments));
                } else if (request.trackingNumbers && request.trackingNumbers.length > 0) {
                    // Convert old format to new format
                    trackingShipments = request.trackingNumbers.map(tn => ({
                        trackingNumber: tn,
                        itemIds: request.items.map((item, idx) => item.id || `item_${item.nameEn}_${item.category}_${idx}`.replace(/[^a-zA-Z0-9_]/g, '_'))
                    }));
                } else {
                    trackingShipments = [];
                }
                
                // Open modal
                openTrackingModal(request);
            }
        }

        function editCanadaRequestTracking(requestId) {
            // Same functionality as markCanadaRequestSent, but for already sent requests
            markCanadaRequestSent(requestId);
        }

        function openTrackingModal(request) {
            const modal = document.getElementById('trackingModal');
            const content = document.getElementById('trackingModalContent');
            const modalTitle = document.getElementById('trackingModalTitle');
            
            // Always get fresh data from localStorage to ensure we have latest sentItems
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const freshRequest = history.find(r => r.id == currentTrackingRequestId) || request;
            
            // Use fresh request data (this ensures sentItems are up to date)
            request = freshRequest;
            
            // Update modal title based on request status
            const isAlreadySent = request.status === 'sent';
            if (modalTitle) {
                modalTitle.textContent = isAlreadySent 
                    ? (currentLanguage === 'en' ? 'Edit Items & Tracking' : 'Editar ArtÃ­culos y Seguimiento')
                    : (currentLanguage === 'en' ? 'Mark Request as Sent' : 'Marcar Solicitud como Enviada');
            }
            
            // Calculate which items are assigned to shipments
            const assignedItemIds = new Set();
            trackingShipments.forEach(shipment => {
                if (shipment.itemIds) {
                    shipment.itemIds.forEach(id => assignedItemIds.add(String(id))); // Ensure all IDs are strings for comparison
                }
            });
            
            // Build HTML for all items with checkboxes
            let itemsHtml = '<div style="margin-bottom: 20px;">';
            itemsHtml += `<h3 style="margin-bottom: 15px;">${currentLanguage === 'en' ? 'Request Items' : 'ArtÃ­culos de la Solicitud'}</h3>`;
            itemsHtml += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">';
            
            request.items.forEach((item, index) => {
                // Generate consistent ID - use database ID if available, otherwise generate from properties
                // For Supabase items, item.id is the database ID (number), so we need to use it as-is
                // For localStorage items, we generate a string ID
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const requestedQty = item.quantity || 1;
                const requestedUnit = item.unit || 'sheet';
                const isAssigned = assignedItemIds.has(String(itemId));
                
                // Skip items that are already assigned to a shipment (they'll show in the shipment section only)
                if (isAssigned) {
                    return; // Don't render this item in the main list - it's already in a shipment
                }
                
                // Get sent quantity if already saved, otherwise default to requested
                // Use fresh data from localStorage to ensure we have latest sentItems
                const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
                const freshRequest = history.find(r => r.id == currentTrackingRequestId) || request;
                const sentItem = freshRequest.sentItems && freshRequest.sentItems.find(si => {
                    return String(si.id) === String(itemId);
                });
                const sentQty = sentItem ? sentItem.quantity : requestedQty;
                const sentUnit = sentItem ? sentItem.unit : (requestedUnit || 'sheet');
                
                const unitLabels = {
                    'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                    'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                };
                const requestedUnitLabel = unitLabels[requestedUnit] || unitLabels['sheet'];
                
                const borderColor = '#e1e8ed';
                const bgColor = 'white';
                
                itemsHtml += `
                    <div style="padding: 10px; margin-bottom: 8px; background: ${bgColor}; border-radius: 4px; border: 2px solid ${borderColor};">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="item_${itemId}" value="${itemId}" 
                                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;"
                                   onchange="toggleItemEditFields('${itemId}')">
                            <label for="item_${itemId}" style="cursor: pointer; flex: 1;">
                                <strong>${itemName}</strong> 
                                <span style="color: #7f8c8d; font-size: 0.9rem;">(${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${requestedQty} ${requestedUnitLabel})</span>
                            </label>
                        </div>
                        <div id="editFields_${itemId}" style="display: none; padding-left: 28px; padding-top: 8px; border-top: 1px solid #e1e8ed;">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <span style="font-size: 0.85rem; color: #7f8c8d;">${currentLanguage === 'en' ? 'Sent Qty:' : 'Cant. Enviada:'}</span>
                                    <input type="number" id="sentQty_${itemId}" 
                                           value="${sentQty}" 
                                           min="0" 
                                           style="width: 70px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                           onchange="updateSentQuantity('${itemId}')">
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <select id="sentUnit_${itemId}" 
                                            style="width: 90px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                                            onchange="updateSentQuantity('${itemId}')">
                                        <option value="roll" ${(sentUnit || 'sheet') === 'roll' ? 'selected' : ''}>${unitLabels['roll']}</option>
                                        <option value="sheet" ${(sentUnit || 'sheet') === 'sheet' ? 'selected' : ''}>${unitLabels['sheet']}</option>
                                    </select>
                                </label>
                            </div>
                            <div id="backorderInfo_${itemId}" style="margin-top: 5px; font-size: 0.8rem; color: #e74c3c; font-weight: 600;"></div>
                        </div>
                    </div>
                `;
            });
            itemsHtml += '</div>';
            
            // Show remaining items count (will be updated dynamically)
            itemsHtml += `<div data-remaining-items style="margin-top: 10px;"></div>`;
            itemsHtml += '</div>';
            
            // Build HTML for tracking shipments
            let shipmentsHtml = '<div style="margin-bottom: 20px;">';
            shipmentsHtml += `<h3 style="margin-bottom: 15px;">${currentLanguage === 'en' ? 'Tracking Numbers & Items' : 'NÃºmeros de Seguimiento y ArtÃ­culos'}</h3>`;
            shipmentsHtml += '<div id="trackingShipmentsList" style="margin-bottom: 15px;">';
            
            if (trackingShipments.length === 0) {
                shipmentsHtml += `<p style="color: #7f8c8d; font-style: italic;">${currentLanguage === 'en' ? 'No tracking numbers added yet. Click "Add Tracking Number" to start.' : 'AÃºn no se han agregado nÃºmeros de seguimiento. Haz clic en "Agregar NÃºmero de Seguimiento" para comenzar.'}</p>`;
            } else {
                trackingShipments.forEach((shipment, index) => {
                    shipmentsHtml += buildTrackingShipmentHtml(shipment, index, request);
                });
            }
            
            shipmentsHtml += '</div>';
            shipmentsHtml += `<button class="btn btn-primary" onclick="addTrackingShipment()" style="margin-bottom: 15px;">
                ${currentLanguage === 'en' ? '+ Add Tracking Number' : '+ Agregar NÃºmero de Seguimiento'}
            </button>`;
            shipmentsHtml += '</div>';
            
            // Build complete content
            content.innerHTML = itemsHtml + shipmentsHtml + `
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <button class="btn" onclick="closeTrackingModal()" style="background: #95a5a6; color: white;">
                        ${currentLanguage === 'en' ? 'Cancel' : 'Cancelar'}
                    </button>
                    <button class="btn btn-success" onclick="saveTrackingShipments()">
                        ${currentLanguage === 'en' ? 'Mark as Sent' : 'Marcar como Enviada'}
                    </button>
                </div>
            `;
            
            // Restore checkbox states and initialize sent items
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            trackingShipments.forEach((shipment, shipmentIndex) => {
                shipment.itemIds.forEach(itemId => {
                    const checkbox = document.getElementById(`item_${itemId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        toggleItemEditFields(itemId);
                    }
                });
            });
            
            // Initialize all sent quantities
            request.items.forEach((item, index) => {
                const itemId = item.id || `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                updateSentQuantity(itemId);
            });
            
            // Update remaining items count
            updateRemainingItemsCount();
            
            modal.style.display = 'block';
        }
        
        function toggleItemEditFields(itemId) {
            const checkbox = document.getElementById(`item_${itemId}`);
            const editFields = document.getElementById(`editFields_${itemId}`);
            if (checkbox && editFields) {
                editFields.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    updateSentQuantity(itemId);
                }
            }
        }
        
        function updateSentQuantity(itemId) {
            // Get fresh data from localStorage
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (!request) {
                console.error('Request not found for ID:', currentTrackingRequestId);
                return;
            }
            
            const item = request.items.find((it, idx) => {
                // Match ID consistently - convert both to strings for comparison
                const itId = it.id !== undefined && it.id !== null 
                    ? String(it.id) 
                    : `item_${it.nameEn}_${it.category}_${idx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                return String(itId) === String(itemId);
            });
            
            if (!item) {
                console.error('Item not found for ID:', itemId);
                return;
            }
            
            const sentQtyInput = document.getElementById(`sentQty_${itemId}`);
            const sentUnitSelect = document.getElementById(`sentUnit_${itemId}`);
            const backorderInfo = document.getElementById(`backorderInfo_${itemId}`);
            
            if (!sentQtyInput || !sentUnitSelect) {
                console.error('Form elements not found for item:', itemId);
                return;
            }
            
            const requestedQty = item.quantity || 1;
            const requestedUnit = item.unit || 'sheet';
            const sentQty = parseInt(sentQtyInput.value) || 0;
            const sentUnit = sentUnitSelect.value || 'sheet';
            
            // Initialize sentItems array if needed
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            // Find or create sent item - use consistent ID matching
            let sentItem = request.sentItems.find(si => {
                // Match by ID directly
                return si.id === itemId;
            });
            
            if (!sentItem) {
                sentItem = {
                    id: itemId,
                    nameEn: item.nameEn,
                    nameEs: item.nameEs,
                    category: item.category,
                    quantity: sentQty,
                    unit: sentUnit
                };
                request.sentItems.push(sentItem);
            } else {
                sentItem.quantity = sentQty;
                sentItem.unit = sentUnit;
            }
            
            // Save to localStorage IMMEDIATELY
            localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
            
            // Force update the select element to ensure it shows the correct value
            // Use setTimeout to ensure DOM is ready
            setTimeout(() => {
                const updatedSelect = document.getElementById(`sentUnit_${itemId}`);
                if (updatedSelect && updatedSelect.value !== sentUnit) {
                    updatedSelect.value = sentUnit;
                    // Trigger change event to ensure any listeners are notified
                    updatedSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }, 0);
            
            console.log('Updated sentItem:', { itemId, quantity: sentQty, unit: sentUnit, savedToLocalStorage: true });
            
            // Calculate backorder (only if units match)
            if (backorderInfo) {
                if (requestedUnit === sentUnit) {
                    const backorderQty = requestedQty - sentQty;
                    if (backorderQty > 0) {
                        const unitLabels = {
                            'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                            'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                        };
                        const unitLabel = unitLabels[sentUnit] || unitLabels['sheet'];
                        backorderInfo.innerHTML = `âš ï¸ ${currentLanguage === 'en' ? 'Backorder' : 'Pedido Pendiente'}: ${backorderQty} ${unitLabel}`;
                        backorderInfo.style.display = 'block';
                    } else {
                        backorderInfo.style.display = 'none';
                    }
                } else {
                    backorderInfo.innerHTML = `âš ï¸ ${currentLanguage === 'en' ? 'Note: Units differ from requested' : 'Nota: Las unidades difieren de lo solicitado'}`;
                    backorderInfo.style.display = 'block';
                }
            }
            
            // Update tracking shipment displays to reflect unit changes
            updateTrackingShipmentDisplays();
        }
        
        function updateTrackingShipmentDisplays() {
            // Update all tracking shipment item displays to show current sent quantities/units
            // Get fresh data from localStorage to ensure we have the latest sentItems
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (!request) return;
            
            // Ensure sentItems exists
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            // Update each tracking shipment section
            trackingShipments.forEach((shipment, shipmentIndex) => {
                if (!shipment.itemIds) return;
                
                shipment.itemIds.forEach(itemId => {
                    const sentItem = request.sentItems.find(si => si.id === itemId);
                    if (!sentItem) return;
                    
                    // Find the label for this item in this shipment
                    const label = document.querySelector(`label[for="shipment_${shipmentIndex}_item_${itemId}"]`);
                    if (label) {
                        // Find the original item to get requested quantity
                        const originalItem = request.items.find((it, idx) => {
                            const itId = it.id || `item_${it.nameEn}_${it.category}_${idx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                            return itId === itemId;
                        });
                        
                        if (originalItem) {
                            const unitLabels = {
                                'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                                'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                            };
                            const itemName = currentLanguage === 'en' ? originalItem.nameEn : originalItem.nameEs;
                            const requestedUnit = originalItem.unit || 'sheet';
                            const requestedUnitLabel = unitLabels[requestedUnit] || unitLabels['sheet'];
                            const sentUnitLabel = unitLabels[sentItem.unit] || unitLabels['sheet'];
                            
                            const qtyDisplay = `${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${sentItem.quantity} ${sentUnitLabel} (${currentLanguage === 'en' ? 'Req' : 'Sol'}: ${originalItem.quantity} ${requestedUnitLabel})`;
                            label.innerHTML = `${itemName} (${qtyDisplay})`;
                        }
                    }
                });
            });
        }

        function buildTrackingShipmentHtml(shipment, index, request) {
            // Get fresh request data from localStorage to ensure we have latest sentItems
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const freshRequest = history.find(r => r.id == currentTrackingRequestId) || request;
            
            // Use fresh request data if available, otherwise use passed request
            const currentRequest = freshRequest || request;
            
            // Get all assigned item IDs from other shipments
            const otherShipmentItemIds = new Set();
            trackingShipments.forEach((s, idx) => {
                if (idx !== index && s.itemIds) {
                    s.itemIds.forEach(id => otherShipmentItemIds.add(id));
                }
            });
            
            const selectedItems = currentRequest.items.filter((item, itemIdx) => {
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                return shipmentItemIds.includes(String(itemId));
            });
            
            return `
                <div id="shipment_${index}" style="padding: 15px; margin-bottom: 10px; background: white; border: 2px solid #3498db; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #2c3e50;">${currentLanguage === 'en' ? 'Tracking Number' : 'NÃºmero de Seguimiento'} #${index + 1}</strong>
                        <button class="btn btn-sm" onclick="removeTrackingShipment(${index})" 
                                style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem;">
                            ${currentLanguage === 'en' ? 'Remove' : 'Eliminar'}
                        </button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            ${currentLanguage === 'en' ? 'Tracking Number:' : 'NÃºmero de Seguimiento:'}
                        </label>
                        <input type="text" id="tracking_${index}" value="${shipment.trackingNumber || ''}" 
                               placeholder="${currentLanguage === 'en' ? 'Enter tracking number' : 'Ingresa el nÃºmero de seguimiento'}"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                               onchange="updateTrackingNumber(${index}, this.value)">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            ${currentLanguage === 'en' ? 'Select Items for this Shipment:' : 'Selecciona ArtÃ­culos para este EnvÃ­o:'}
                        </label>
                        <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                            ${request.items.length === 0 ? `
                                <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 10px;">
                                    ${currentLanguage === 'en' ? 'No items available' : 'No hay artÃ­culos disponibles'}
                                </p>
                            ` : currentRequest.items.map((item, itemIndex) => {
                                // Generate consistent ID (same as in openTrackingModal)
                                const itemId = item.id !== undefined && item.id !== null 
                                    ? String(item.id) 
                                    : `item_${item.nameEn}_${item.category}_${itemIndex}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                                const isChecked = shipmentItemIds.includes(String(itemId));
                                const isInOtherShipment = Array.from(otherShipmentItemIds).some(id => String(id) === String(itemId));
                                // Get sentItem from currentRequest (which has fresh data from localStorage)
                                const sentItem = currentRequest.sentItems && currentRequest.sentItems.find(si => {
                                    return si.id === itemId;
                                });
                                const unitLabels = {
                                    'roll': currentLanguage === 'en' ? 'Roll' : 'Rollo',
                                    'sheet': currentLanguage === 'en' ? 'Sheet' : 'Hoja'
                                };
                                const unit = item.unit || 'sheet';
                                const unitLabel = unitLabels[unit] || unitLabels['sheet'];
                                let qtyDisplay = `${currentLanguage === 'en' ? 'Qty' : 'Cant'}: ${item.quantity} ${unitLabel}`;
                                if (sentItem) {
                                    const sentUnitLabel = unitLabels[sentItem.unit] || unitLabels['sheet'];
                                    qtyDisplay = `${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${sentItem.quantity} ${sentUnitLabel} (${currentLanguage === 'en' ? 'Req' : 'Sol'}: ${item.quantity} ${unitLabel})`;
                                }
                                return `
                                    <div style="padding: 5px; margin-bottom: 3px; ${isInOtherShipment ? 'opacity: 0.5;' : ''}">
                                        <input type="checkbox" id="shipment_${index}_item_${itemId}" 
                                               value="${itemId}" ${isChecked ? 'checked' : ''} ${isInOtherShipment ? 'disabled' : ''}
                                               onchange="updateShipmentItems(${index}, '${itemId}', this.checked)"
                                               style="margin-right: 8px; cursor: ${isInOtherShipment ? 'not-allowed' : 'pointer'};">
                                        <label for="shipment_${index}_item_${itemId}" style="cursor: ${isInOtherShipment ? 'default' : 'pointer'};">
                                            ${itemName} (${qtyDisplay})
                                            ${isInOtherShipment ? `<span style="color: #27ae60; font-size: 0.8rem; margin-left: 5px;">âœ“ ${currentLanguage === 'en' ? 'In another shipment' : 'En otro envÃ­o'}</span>` : ''}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${request.items.length > 0 && request.items.every((item, itemIndex) => {
                            const itemId = item.id || `item_${item.nameEn}_${item.category}_${itemIndex}`.replace(/[^a-zA-Z0-9_]/g, '_');
                            return otherShipmentItemIds.has(itemId);
                        }) ? `
                            <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px; font-size: 0.85rem; color: #d68910;">
                                <strong>${currentLanguage === 'en' ? 'Note:' : 'Nota:'}</strong> ${currentLanguage === 'en' ? 'All items are already assigned to other shipments. Remove items from other shipments first to assign them here.' : 'Todos los artÃ­culos ya estÃ¡n asignados a otros envÃ­os. Elimina artÃ­culos de otros envÃ­os primero para asignarlos aquÃ­.'}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function addTrackingShipment() {
            // Save current sentItems before rebuilding modal
            saveCurrentSentItems();
            
            trackingShipments.push({
                trackingNumber: '',
                itemIds: []
            });
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (request) {
                openTrackingModal(request);
            }
        }
        
        function saveCurrentSentItems() {
            // Save all current sent quantity/unit values from the form before modal rebuild
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (!request) return;
            
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            // Update sentItems from current form values
            request.items.forEach((item, index) => {
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const sentQtyInput = document.getElementById(`sentQty_${itemId}`);
                const sentUnitSelect = document.getElementById(`sentUnit_${itemId}`);
                
                if (sentQtyInput && sentUnitSelect) {
                    const sentQty = parseInt(sentQtyInput.value) || 0;
                    const sentUnit = sentUnitSelect.value || 'sheet';
                    
                    let sentItem = request.sentItems.find(si => {
                        const siId = si.id !== undefined && si.id !== null 
                            ? String(si.id) 
                            : `item_${si.nameEn}_${si.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                        return String(siId) === String(itemId);
                    });
                    if (sentItem) {
                        sentItem.quantity = sentQty;
                        sentItem.unit = sentUnit;
                    } else {
                        sentItem = {
                            id: itemId,
                            nameEn: item.nameEn,
                            nameEs: item.nameEs,
                            category: item.category,
                            quantity: sentQty,
                            unit: sentUnit
                        };
                        request.sentItems.push(sentItem);
                    }
                }
            });
            
            // Save to localStorage immediately to preserve changes
            localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
            
            localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
        }

        function removeTrackingShipment(index) {
            // Save current sentItems before rebuilding modal
            saveCurrentSentItems();
            
            trackingShipments.splice(index, 1);
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (request) {
                openTrackingModal(request);
            }
        }

        function updateTrackingNumber(index, value) {
            if (trackingShipments[index]) {
                trackingShipments[index].trackingNumber = value.trim();
            }
        }

        function updateShipmentItems(shipmentIndex, itemId, isChecked) {
            if (trackingShipments[shipmentIndex]) {
                if (!trackingShipments[shipmentIndex].itemIds) {
                    trackingShipments[shipmentIndex].itemIds = [];
                }
                if (isChecked) {
                    if (!trackingShipments[shipmentIndex].itemIds.includes(itemId)) {
                        trackingShipments[shipmentIndex].itemIds.push(itemId);
                    }
                } else {
                    trackingShipments[shipmentIndex].itemIds = trackingShipments[shipmentIndex].itemIds.filter(id => id !== itemId);
                }
                
                // Also update the main checkbox if it exists
                const mainCheckbox = document.getElementById(`item_${itemId}`);
                if (mainCheckbox) {
                    mainCheckbox.checked = isChecked;
                    toggleItemEditFields(itemId);
                }
                
                // Update remaining items count without full refresh
                updateRemainingItemsCount();
            }
        }
        
        function updateRemainingItemsCount() {
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            if (!request) return;
            
            const assignedItemIds = new Set();
            trackingShipments.forEach(shipment => {
                if (shipment.itemIds) {
                    shipment.itemIds.forEach(id => assignedItemIds.add(id));
                }
            });
            
            const remainingCount = request.items.length - assignedItemIds.size;
            const remainingDiv = document.querySelector('[data-remaining-items]');
            if (remainingCount > 0) {
                const itemsHtml = `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;">
                    <strong style="color: #d68910;">âš ï¸ ${currentLanguage === 'en' ? 'Remaining Items' : 'ArtÃ­culos Restantes'}: ${remainingCount} ${currentLanguage === 'en' ? 'item(s) not yet assigned to a shipment' : 'artÃ­culo(s) aÃºn no asignado(s) a un envÃ­o'}</strong>
                </div>`;
                if (remainingDiv) {
                    remainingDiv.innerHTML = itemsHtml;
                }
            } else if (assignedItemIds.size > 0) {
                const itemsHtml = `<div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 4px;">
                    <strong style="color: #27ae60;">âœ“ ${currentLanguage === 'en' ? 'All items assigned to shipments' : 'Todos los artÃ­culos asignados a envÃ­os'}</strong>
                </div>`;
                if (remainingDiv) {
                    remainingDiv.innerHTML = itemsHtml;
                }
            } else if (remainingDiv) {
                remainingDiv.innerHTML = '';
            }
        }

        async function saveTrackingShipments() {
            // CRITICAL: Read tracking numbers from input fields BEFORE validation
            // This ensures we capture what the user actually typed
            trackingShipments.forEach((shipment, index) => {
                const trackingInput = document.getElementById(`tracking_${index}`);
                if (trackingInput) {
                    shipment.trackingNumber = trackingInput.value.trim();
                }
            });
            
            // Validate that all shipments have tracking numbers
            const emptyTracking = trackingShipments.some(s => !s.trackingNumber || s.trackingNumber.trim() === '');
            if (emptyTracking) {
                alert(currentLanguage === 'en' 
                    ? 'Please enter tracking numbers for all shipments.' 
                    : 'Por favor ingresa nÃºmeros de seguimiento para todos los envÃ­os.');
                return;
            }
            
            // CRITICAL: Save current sentItems from form BEFORE doing anything else
            // This captures any unit/quantity changes the user made
            saveCurrentSentItems();
            
            // Note: We allow partial shipments - unassigned items will be tracked as backorders
            const history = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
            const request = history.find(r => r.id == currentTrackingRequestId);
            
            // Save to request
            if (request) {
                // Make a deep copy of trackingShipments to ensure we save the current state
                const trackingShipmentsToSave = trackingShipments.map(shipment => ({
                    trackingNumber: shipment.trackingNumber || '',
                    itemIds: (shipment.itemIds || []).map(id => String(id)), // Ensure all IDs are strings
                    upsStatus: shipment.upsStatus || null,
                    upsLastUpdate: shipment.upsLastUpdate || null,
                    upsHasDutiesDue: shipment.upsHasDutiesDue || false,
                    upsHasDelay: shipment.upsHasDelay || false,
                    upsExceptionDescription: shipment.upsExceptionDescription || null,
                    upsPickedUp: shipment.upsPickedUp || false,
                    upsInTransit: shipment.upsInTransit || false,
                    upsDutiesPaid: shipment.upsDutiesPaid || false,
                    upsDutiesAmount: shipment.upsDutiesAmount || '',
                    upsStatusCode: shipment.upsStatusCode || null,
                    upsLastLocation: shipment.upsLastLocation || null,
                    upsLastDate: shipment.upsLastDate || null,
                    upsLastChecked: shipment.upsLastChecked || null
                }));
                
                request.status = 'sent';
                request.trackingShipments = trackingShipmentsToSave;
                // Also keep old format for backward compatibility
                request.trackingNumbers = trackingShipmentsToSave.map(s => s.trackingNumber);
                request.trackingNumber = trackingShipmentsToSave.length > 0 ? trackingShipmentsToSave[0].trackingNumber : '';
                if (!request.sentDate) {
                    request.sentDate = new Date().toISOString();
                }
                
                console.log('Saving tracking shipments:', {
                    requestId: request.id,
                    trackingShipmentsCount: trackingShipmentsToSave.length,
                    trackingShipments: trackingShipmentsToSave
                });
                
                // Subscribe to UPS Track Alert API for real-time updates
                const trackingNumbers = trackingShipmentsToSave.map(s => s.trackingNumber).filter(tn => tn && tn.trim());
                if (trackingNumbers.length > 0) {
                    console.log('Subscribing tracking numbers to Track Alert:', trackingNumbers);
                    subscribeToTrackAlert(trackingNumbers).then(result => {
                        if (result.success) {
                            console.log('âœ“ Track Alert subscription successful:', result.message);
                        } else {
                            console.warn('âš  Track Alert subscription failed:', result.error || result.message);
                        }
                    }).catch(error => {
                        console.error('Error subscribing to Track Alert:', error);
                    });
                }
                
                // Calculate backorders - only for items NOT assigned to any shipment OR where sent qty < requested qty
                const allAssignedItemIds = new Set();
                trackingShipments.forEach(shipment => {
                    if (shipment.itemIds) {
                        shipment.itemIds.forEach(id => allAssignedItemIds.add(id));
                    }
                });
                
                request.backorders = [];
                request.items.forEach((item, index) => {
                    const itemId = item.id !== undefined && item.id !== null 
                        ? String(item.id) 
                        : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                    const isAssigned = allAssignedItemIds.has(String(itemId));
                    const sentItem = request.sentItems && request.sentItems.find(si => {
                        const siId = si.id !== undefined && si.id !== null 
                            ? String(si.id) 
                            : `item_${si.nameEn}_${si.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                        return String(siId) === String(itemId);
                    });
                    
                    const requestedQty = item.quantity || 1;
                    const requestedUnit = item.unit || 'sheet';
                    
                    // If item is not assigned to any shipment, it's a backorder
                    if (!isAssigned) {
                        request.backorders.push({
                            id: itemId,
                            nameEn: item.nameEn,
                            nameEs: item.nameEs,
                            category: item.category,
                            requestedQty: requestedQty,
                            sentQty: 0,
                            backorderQty: requestedQty,
                            unit: requestedUnit,
                            reason: 'not_assigned'
                        });
                    } else if (sentItem) {
                        // If assigned but sent qty < requested qty, it's a partial backorder
                        const sentQty = sentItem.quantity || 0;
                        const sentUnit = sentItem.unit || 'sheet';
                        
                        // Only calculate backorder if units match
                        if (requestedUnit === sentUnit && requestedQty > sentQty) {
                            request.backorders.push({
                                id: itemId,
                                nameEn: item.nameEn,
                                nameEs: item.nameEs,
                                category: item.category,
                                requestedQty: requestedQty,
                                sentQty: sentQty,
                                backorderQty: requestedQty - sentQty,
                                unit: requestedUnit,
                                reason: 'partial'
                            });
                        }
                    }
                });
                
                // Save to localStorage first (this ensures immediate UI update)
                localStorage.setItem('canadaRequestHistory', JSON.stringify(history));
                
                // Immediately check UPS status for all new tracking numbers
                console.log('Checking UPS status for newly added tracking numbers...');
                for (const shipment of trackingShipmentsToSave) {
                    if (shipment.trackingNumber && shipment.trackingNumber.trim()) {
                        try {
                            const result = await checkUPSTracking(shipment.trackingNumber.trim());
                            
                            // Update shipment with UPS status
                            shipment.upsStatus = result.status;
                            shipment.upsStatusCode = result.statusCode;
                            shipment.upsHasDelay = result.hasDelay;
                            shipment.upsHasDutiesDue = result.hasDutiesDue || false;
                            shipment.upsDutiesPaid = result.dutiesPaid || false;
                            shipment.upsDutiesAmount = result.dutiesAmount || '';
                            shipment.upsLastLocation = result.lastLocation;
                            shipment.upsLastDate = result.lastDate;
                            shipment.upsLastChecked = new Date().toISOString();
                            shipment.upsPickedUp = result.pickedUp || false;
                            shipment.upsInTransit = result.inTransit || false;
                            
                            console.log(`âœ… UPS status for ${shipment.trackingNumber}:`, result.status);
                            
                            // Update the request in history
                            const updatedHistory = JSON.parse(localStorage.getItem('canadaRequestHistory')) || [];
                            const updatedRequest = updatedHistory.find(r => r.id == currentTrackingRequestId);
                            if (updatedRequest && updatedRequest.trackingShipments) {
                                const updatedShipment = updatedRequest.trackingShipments.find(s => s.trackingNumber === shipment.trackingNumber);
                                if (updatedShipment) {
                                    Object.assign(updatedShipment, shipment);
                                }
                                localStorage.setItem('canadaRequestHistory', JSON.stringify(updatedHistory));
                            }
                            
                            // Small delay to avoid rate limiting
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (error) {
                            console.error(`Error checking UPS status for ${shipment.trackingNumber}:`, error);
                            shipment.upsStatus = 'Error checking status';
                            shipment.upsLastChecked = new Date().toISOString();
                        }
                    }
                }
                
                // Close modal immediately so user sees the change
                closeTrackingModal();
                
                // Reload history to show updated status immediately
                await loadCanadaHistory();
                
                // Save to Supabase in background (don't block UI)
                if (useSupabase && currentUser && request.id) {
                    try {
                        // Update request status and sent_date
                        const { error: updateError } = await supabase
                            .from('canada_requests')
                            .update({
                                status: 'sent',
                                sent_date: request.sentDate
                            })
                            .eq('id', request.id)
                            .eq('user_id', currentUser.id);
                        
                        if (updateError) throw updateError;
                        
                        // Delete existing tracking shipments for this request
                        await supabase
                            .from('canada_tracking_shipments')
                            .delete()
                            .eq('request_id', request.id);
                        
                        // Insert new tracking shipments (use trackingShipmentsToSave which has the correct data)
                        // Only save columns that exist in the table schema
                        if (trackingShipmentsToSave.length > 0) {
                            const trackingData = trackingShipmentsToSave.map(shipment => ({
                                request_id: request.id,
                                tracking_number: shipment.trackingNumber || '',
                                shipment_items: shipment.itemIds || [], // Store as JSONB array
                                ups_status: shipment.upsStatus || null,
                                ups_has_duties_due: shipment.upsHasDutiesDue || false,
                                ups_has_delay: shipment.upsHasDelay || false,
                                ups_picked_up: shipment.upsPickedUp || false,
                                ups_in_transit: shipment.upsInTransit || false,
                                ups_duties_paid: shipment.upsDutiesPaid || false,
                                ups_duties_amount: shipment.upsDutiesAmount || ''
                            }));
                            
                            const { error: trackingError } = await supabase
                                .from('canada_tracking_shipments')
                                .insert(trackingData);
                            
                            if (trackingError) {
                                console.error('Error saving tracking shipments to Supabase:', trackingError);
                                throw trackingError;
                            }
                            
                            console.log('Successfully saved tracking shipments to Supabase:', trackingData);
                        }
                        
                        // Delete existing backorders for this request
                        await supabase
                            .from('canada_backorders')
                            .delete()
                            .eq('request_id', request.id);
                        
                        // Insert new backorders
                        if (request.backorders && request.backorders.length > 0) {
                            const backorderData = request.backorders.map(bo => ({
                                request_id: request.id,
                                item_id: bo.id,
                                name_en: bo.nameEn,
                                name_es: bo.nameEs,
                                category: bo.category,
                                requested_qty: bo.requestedQty,
                                sent_qty: bo.sentQty,
                                backorder_qty: bo.backorderQty,
                                unit: bo.unit,
                                reason: bo.reason
                            }));
                            
                            const { error: backorderError } = await supabase
                                .from('canada_backorders')
                                .insert(backorderData);
                            
                            if (backorderError) throw backorderError;
                        }
                        
                        console.log('Tracking shipments saved to Supabase for request:', request.id);
                        
                        // Reload history again after Supabase save to ensure sync
                        await loadCanadaHistory();
                    } catch (error) {
                        console.error('Error saving tracking shipments to Supabase:', error);
                        // Don't show alert - changes are already saved locally and visible
                    }
                }
            }
        }

        function closeTrackingModal() {
            document.getElementById('trackingModal').style.display = 'none';
            // Clear both Can/Mex and Mex/Can tracking states
            currentTrackingRequestId = null;
            trackingShipments = [];
            currentMexcanTrackingRequestId = null;
            mexcanTrackingShipments = [];
        }

        // Mex/Can Request Functions (Mexico requesting from Canada)
        let mexcanSelectedItems = JSON.parse(localStorage.getItem('mexcanSelectedItems')) || {};
        let mexcanRequestCounter = parseInt(localStorage.getItem('mexcanRequestCounter') || '0');
        
        function loadMexcanItems() {
            const mexcanItemsList = document.getElementById('mexcanItemsList');
            if (!mexcanItemsList) return;
            
            // Get all items marked forMexico
            const mexcanItems = [];
            
            // Use global itemDatabase (synced with Supabase) and categories
            // Also check localStorage as fallback
            const savedCategories = categories || JSON.parse(localStorage.getItem('customCategories')) || {};
            const savedItemDatabase = itemDatabase || JSON.parse(localStorage.getItem('categoryItems')) || {};
            
            console.log('ðŸ”µ loadMexcanItems - savedCategories keys:', Object.keys(savedCategories));
            console.log('ðŸ”µ loadMexcanItems - savedItemDatabase keys:', Object.keys(savedItemDatabase));
            
            // Find Mexico category (case-insensitive search)
            let mexicoCategoryKey = null;
            Object.keys(savedCategories).forEach(key => {
                const catNameEn = savedCategories[key].nameEn || '';
                const catNameEs = savedCategories[key].nameEs || '';
                if (catNameEn.toLowerCase() === 'mexico' || catNameEs.toLowerCase() === 'mÃ©xico' || key.toLowerCase() === 'mexico') {
                    mexicoCategoryKey = key;
                    console.log('âœ… Found Mexico category:', key, 'with name:', catNameEn || catNameEs);
                }
            });
            
            // Get items from Mexico category
            if (mexicoCategoryKey && savedItemDatabase[mexicoCategoryKey] && Array.isArray(savedItemDatabase[mexicoCategoryKey])) {
                console.log('âœ… Found', savedItemDatabase[mexicoCategoryKey].length, 'items in Mexico category');
                savedItemDatabase[mexicoCategoryKey].forEach(item => {
                    mexcanItems.push({...item, source: 'category', category: mexicoCategoryKey});
                });
            } else {
                console.log('âš ï¸ Mexico category not found or has no items. Category key:', mexicoCategoryKey, 'Items:', savedItemDatabase[mexicoCategoryKey]);
            }
            
            // Also get items marked forMexico from other categories
            let forMexicoCount = 0;
            Object.keys(savedItemDatabase).forEach(category => {
                if (category === mexicoCategoryKey) return; // Skip Mexico category (already added)
                if (Array.isArray(savedItemDatabase[category])) {
                    savedItemDatabase[category].forEach(item => {
                        if (item.forMexico) {
                            forMexicoCount++;
                            const exists = mexcanItems.find(mi => 
                                mi.nameEn === item.nameEn && 
                                mi.nameEs === item.nameEs && 
                                mi.category === category
                            );
                            if (!exists) {
                                mexcanItems.push({...item, source: 'category', category: category});
                            }
                        }
                    });
                }
            });
            
            console.log('ðŸ”µ loadMexcanItems - Total items found:', mexcanItems.length, '(from Mexico category +', forMexicoCount, 'marked forMexico)');
            
            if (mexcanItems.length === 0) {
                mexcanItemsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        <strong>${currentLanguage === 'en' ? 'No items available for Mexico requests yet.' : 'AÃºn no hay artÃ­culos disponibles para solicitudes de MÃ©xico.'}</strong>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            ${currentLanguage === 'en' ? 'Mark items as "Available for Mexico Requests" when adding them.' : 'Marca los artÃ­culos como "Disponible para Solicitudes de MÃ©xico" al agregarlos.'}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            mexcanItems.forEach(item => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const itemDescription = currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs;
                const categoryName = categories[item.category] ? 
                    (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                    item.category;
                const itemId = item.id || `mexcan_${item.nameEn}_${item.category}`;
                const selected = mexcanSelectedItems[itemId] || {selected: false, quantity: 1, unit: 'pieces', note: ''};
                
                html += `
                    <div style="padding: 15px; background: white; border: 2px solid ${selected.selected ? '#3498db' : '#e1e8ed'}; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="mexcan_${itemId}" 
                                           ${selected.selected ? 'checked' : ''} 
                                           onchange="toggleMexcanItem('${itemId}')"
                                           style="width: 20px; height: 20px; cursor: pointer;">
                                    <div>
                                        <strong style="color: #2c3e50; font-size: 1.1rem;">${itemName}</strong>
                                        ${itemDescription ? `<div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 3px;">${itemDescription}</div>` : ''}
                                        <div style="color: #95a5a6; font-size: 0.85rem; margin-top: 5px;">
                                            ${currentLanguage === 'en' ? 'Category' : 'CategorÃ­a'}: ${categoryName}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <span style="font-size: 0.9rem; color: #7f8c8d;">${currentLanguage === 'en' ? 'Qty:' : 'Cant:'}</span>
                                    <input type="number" id="mexcan_qty_${itemId}" 
                                           value="${selected.quantity}" 
                                           min="1" 
                                           style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                           onchange="updateMexcanQuantity('${itemId}', this.value)"
                                           ${!selected.selected ? 'disabled' : ''}>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <select id="mexcan_unit_${itemId}" 
                                            style="width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                            onchange="updateMexcanUnit('${itemId}', this.value)"
                                            ${!selected.selected ? 'disabled' : ''}>
                                        <option value="pieces" ${(selected.unit || 'pieces') === 'pieces' ? 'selected' : ''}>${currentLanguage === 'en' ? 'Pieces' : 'Piezas'}</option>
                                        <option value="pairs" ${(selected.unit || 'pieces') === 'pairs' ? 'selected' : ''}>${currentLanguage === 'en' ? 'Pairs' : 'Pares'}</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        ${selected.selected ? `
                        <div style="margin-top: 12px; width: 100%;">
                            <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 4px;" data-en="Note (optional)" data-es="Nota (opcional)">Note (optional):</label>
                            <input type="text" 
                                   id="mexcan_note_${itemId}" 
                                   placeholder="${currentLanguage === 'en' ? 'Add a note for this item...' : 'Agregar una nota para este artÃ­culo...'}"
                                   value="${(selected.note || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
                                   onchange="updateMexcanNote('${itemId}', this.value)"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                   maxlength="200">
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            mexcanItemsList.innerHTML = html;
        }
        
        function toggleMexcanItem(itemId) {
            const checkbox = document.getElementById(`mexcan_${itemId}`);
            const quantityInput = document.getElementById(`mexcan_qty_${itemId}`);
            
            if (!mexcanSelectedItems[itemId]) {
                mexcanSelectedItems[itemId] = {selected: false, quantity: 1, unit: 'pieces'};
            }
            
            mexcanSelectedItems[itemId].selected = checkbox.checked;
            quantityInput.disabled = !checkbox.checked;
            const unitSelect = document.getElementById(`mexcan_unit_${itemId}`);
            if (unitSelect) {
                unitSelect.disabled = !checkbox.checked;
            }
            
            if (!checkbox.checked) {
                mexcanSelectedItems[itemId].quantity = 1;
                mexcanSelectedItems[itemId].unit = 'pieces';
                quantityInput.value = 1;
                if (unitSelect) {
                    unitSelect.value = 'pieces';
                }
            }
            
            // Reload items to show/hide note field properly
            loadMexcanItems();
            localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
            updateMexcanRequestSummary();
        }
        
        function updateMexcanQuantity(itemId, quantity) {
            if (!mexcanSelectedItems[itemId]) {
                mexcanSelectedItems[itemId] = {selected: true, quantity: 1, unit: 'pieces'};
            }
            mexcanSelectedItems[itemId].quantity = parseInt(quantity) || 1;
            localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
            updateMexcanRequestSummary();
        }
        
        function updateMexcanUnit(itemId, unit) {
            if (!mexcanSelectedItems[itemId]) {
                mexcanSelectedItems[itemId] = {selected: true, quantity: 1, unit: 'pieces'};
            }
            mexcanSelectedItems[itemId].unit = unit || 'pieces';
            localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
            updateMexcanRequestSummary();
        }
        
        function updateMexcanNote(itemId, note) {
            if (!mexcanSelectedItems[itemId]) {
                mexcanSelectedItems[itemId] = {selected: true, quantity: 1, unit: 'pieces', note: ''};
            }
            mexcanSelectedItems[itemId].note = note || '';
            localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
        }
        
        function updateMexcanRequestSummary() {
            const summaryDiv = document.getElementById('mexcanRequestSummary');
            if (!summaryDiv) return;
            
            const selected = Object.keys(mexcanSelectedItems).filter(id => mexcanSelectedItems[id].selected);
            
            if (selected.length === 0) {
                summaryDiv.innerHTML = `
                    <p style="color: #7f8c8d; text-align: center;" data-en="No items selected yet" data-es="AÃºn no se han seleccionado artÃ­culos">No items selected yet</p>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            selected.forEach(itemId => {
                const selection = mexcanSelectedItems[itemId];
                // Find the item
                let item = items.find(i => (i.id || `mexcan_${i.nameEn}_${i.category}`) == itemId);
                if (!item) {
                    // Search in category database
                    Object.keys(itemDatabase).forEach(category => {
                        const found = itemDatabase[category].find(i => (i.id || `mexcan_${i.nameEn}_${category}`) == itemId);
                        if (found) item = {...found, category: category};
                    });
                }
                
                if (item) {
                    const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                    const unit = selection.unit || 'pieces';
                    const unitLabels = {
                        'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas'
                    };
                    const unitLabel = unitLabels[unit] || unitLabels['pieces'];
                    html += `
                        <div style="padding: 10px; background: white; border-left: 4px solid #3498db; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>${itemName}</strong></span>
                            <span style="color: #7f8c8d;">${currentLanguage === 'en' ? 'Quantity' : 'Cantidad'}: ${selection.quantity} ${unitLabel}</span>
                        </div>
                    `;
                }
            });
            html += '</div>';
            summaryDiv.innerHTML = html;
        }
        
        function clearMexcanSelection() {
            if (confirm(currentLanguage === 'en' ? 'Clear all selected items?' : 'Â¿Limpiar todos los artÃ­culos seleccionados?')) {
                Object.keys(mexcanSelectedItems).forEach(id => {
                    mexcanSelectedItems[id].selected = false;
                });
                localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
                loadMexcanItems();
                updateMexcanRequestSummary();
            }
        }
        
        function toggleMexcanEmailConfig() {
            const details = document.getElementById('mexcanEmailConfigDetails');
            const toggle = document.getElementById('mexcanEmailConfigToggle');
            
            if (details.style.display === 'none' || !details.style.display) {
                details.style.display = 'block';
                toggle.textContent = currentLanguage === 'en' ? 'Hide Configuration' : 'Ocultar ConfiguraciÃ³n';
            } else {
                details.style.display = 'none';
                toggle.textContent = currentLanguage === 'en' ? 'Show Configuration' : 'Mostrar ConfiguraciÃ³n';
            }
        }
        
        function saveMexcanEmailJSSettings() {
            const serviceId = document.getElementById('mexcanEmailjsServiceId').value.trim();
            const templateId = document.getElementById('mexcanEmailjsTemplateId').value.trim();
            const recipientEmails = document.getElementById('mexcanRecipientEmails').value.trim();
            
            if (serviceId) {
                localStorage.setItem('mexcanEmailjsServiceId', serviceId);
            } else {
                localStorage.removeItem('mexcanEmailjsServiceId');
            }
            
            if (templateId) {
                localStorage.setItem('mexcanEmailjsTemplateId', templateId);
            } else {
                localStorage.removeItem('mexcanEmailjsTemplateId');
            }
            
            if (recipientEmails) {
                localStorage.setItem('mexcanRecipientEmails', recipientEmails);
            }
        }
        
        function loadMexcanEmailJSSettings() {
            const serviceId = localStorage.getItem('mexcanEmailjsServiceId');
            const templateId = localStorage.getItem('mexcanEmailjsTemplateId');
            const recipientEmails = localStorage.getItem('mexcanRecipientEmails') || '';
            
            if (document.getElementById('mexcanEmailjsServiceId')) {
                document.getElementById('mexcanEmailjsServiceId').value = serviceId || '';
            }
            if (document.getElementById('mexcanEmailjsTemplateId')) {
                document.getElementById('mexcanEmailjsTemplateId').value = templateId || '';
            }
            if (document.getElementById('mexcanRecipientEmails')) {
                document.getElementById('mexcanRecipientEmails').value = recipientEmails;
            }
        }
        
        async function testMexcanEmailJS() {
            const mexcanEmailjsServiceId = localStorage.getItem('mexcanEmailjsServiceId') || localStorage.getItem('emailjsServiceId');
            const mexcanEmailjsTemplateId = localStorage.getItem('mexcanEmailjsTemplateId');
            const emailjsPublicKey = localStorage.getItem('emailjsPublicKey');
            const recipientEmails = localStorage.getItem('mexcanRecipientEmails') || '';
            
            if (!mexcanEmailjsTemplateId || !emailjsPublicKey) {
                alert(currentLanguage === 'en' ? 
                    'Please configure EmailJS Template ID and Public Key first' : 
                    'Por favor configura el ID de Plantilla de EmailJS y la Clave PÃºblica primero');
                return;
            }
            
            try {
                // Create a test request
                const testRequest = {
                    id: 'TEST',
                    date: new Date().toISOString(),
                    items: [
                        {
                            nameEn: 'Test Item',
                            nameEs: 'ArtÃ­culo de Prueba',
                            descriptionEn: 'This is a test request',
                            descriptionEs: 'Esta es una solicitud de prueba',
                            category: 'Test',
                            quantity: 1
                        }
                    ],
                    status: 'pending'
                };
                
                // Generate test PDF and send
                await generateMexcanRequestPDF(testRequest);
                alert(currentLanguage === 'en' ? 
                    'Test email sent successfully!' : 
                    'Â¡Correo de prueba enviado exitosamente!');
            } catch (error) {
                console.error('Test email error:', error);
                alert(currentLanguage === 'en' ? 
                    `Error sending test email: ${error.message}` : 
                    `Error al enviar correo de prueba: ${error.message}`);
            }
        }
        
        async function generateMexcanRequest() {
            const selected = Object.keys(mexcanSelectedItems).filter(id => mexcanSelectedItems[id].selected);
            
            if (selected.length === 0) {
                alert(currentLanguage === 'en' ? 'Please select at least one item' : 'Por favor selecciona al menos un artÃ­culo');
                return;
            }
            
            const requestItems = [];
            selected.forEach(itemId => {
                const selection = mexcanSelectedItems[itemId];
                let item = items.find(i => (i.id || `mexcan_${i.nameEn}_${i.category}`) == itemId);
                if (!item) {
                    Object.keys(itemDatabase).forEach(category => {
                        const found = itemDatabase[category].find(i => (i.id || `mexcan_${i.nameEn}_${category}`) == itemId);
                        if (found) item = {...found, category: category};
                    });
                }
                
                if (item) {
                    requestItems.push({
                        nameEn: item.nameEn,
                        nameEs: item.nameEs,
                        descriptionEn: item.descriptionEn || '',
                        descriptionEs: item.descriptionEs || '',
                        category: item.category,
                        quantity: selection.quantity,
                        unit: selection.unit || 'pieces',
                        note: selection.note || ''
                    });
                }
            });
            
            const request = {
                id: mexcanRequestCounter,
                date: new Date().toISOString(),
                items: requestItems,
                status: 'pending',
                direction: 'mexcan' // Mark as Mex/Can request
            };
            
            // Increment counter for next request
            mexcanRequestCounter++;
            localStorage.setItem('mexcanRequestCounter', mexcanRequestCounter.toString());
            
            // Save to history (localStorage) - using separate key for now
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            history.unshift(request);
            localStorage.setItem('mexcanRequestHistory', JSON.stringify(history));
            
            // TODO: Save to Supabase if logged in (will need separate tables or direction flag)
            // For now, just save to localStorage
            
            // Clear selection
            Object.keys(mexcanSelectedItems).forEach(id => {
                mexcanSelectedItems[id].selected = false;
            });
            localStorage.setItem('mexcanSelectedItems', JSON.stringify(mexcanSelectedItems));
            
            loadMexcanItems();
            updateMexcanRequestSummary();
            await loadMexcanHistory();
            
            // Generate PDF and send email
            generateMexcanRequestPDF(request).then(() => {
                alert(currentLanguage === 'en' ? 
                    `Request generated successfully! ${requestItems.length} item(s) added to history. Email sent with PDF.` : 
                    `Â¡Solicitud generada exitosamente! ${requestItems.length} artÃ­culo(s) agregado(s) al historial. Correo enviado con PDF.`);
            }).catch(error => {
                console.error('Error sending email:', error);
                const errorMsg = error.message || error.toString();
                alert(currentLanguage === 'en' ? 
                    `Request generated successfully! ${requestItems.length} item(s) added to history.\n\nEmail Error: ${errorMsg}\n\nPlease check EmailJS configuration.` : 
                    `Â¡Solicitud generada exitosamente! ${requestItems.length} artÃ­culo(s) agregado(s) al historial.\n\nError de Correo: ${errorMsg}\n\nPor favor verifica la configuraciÃ³n de EmailJS.`);
            });
        }
        
        function generateMexcanRequestPDF(request) {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Title
                    doc.setFontSize(18);
                    doc.text(currentLanguage === 'en' ? 'Mex/Can Material Request' : 'Solicitud de Materiales Mex/Can', 14, 20);
                    doc.setFontSize(12);
                    doc.text(currentLanguage === 'en' ? `Request Date: ${new Date(request.date).toLocaleDateString()}` : `Fecha de Solicitud: ${new Date(request.date).toLocaleDateString()}`, 14, 30);
                    doc.text(currentLanguage === 'en' ? `Request ID: #${request.id}` : `ID de Solicitud: #${request.id}`, 14, 37);
                    
                    // Prepare table data
                    const tableData = request.items.map((item, index) => {
                        const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                        const itemDescription = currentLanguage === 'en' ? item.descriptionEn : item.descriptionEs;
                        const categoryName = categories[item.category] ? 
                            (currentLanguage === 'en' ? categories[item.category].nameEn : categories[item.category].nameEs) : 
                            item.category;
                        
                        const unit = item.unit || 'pieces';
                        const unitLabels = {
                            'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas',
                            'pairs': currentLanguage === 'en' ? 'Pairs' : 'Pares'
                        };
                        const unitLabel = unitLabels[unit] || unitLabels['pieces'];
                        // Include note in item name if present
                        const displayName = item.note ? `${itemName} (${item.note})` : itemName;
                        return [
                            index + 1,
                            displayName,
                            itemDescription || '',
                            categoryName,
                            `${item.quantity} ${unitLabel}`
                        ];
                    });
                    
                    // Add table
                    doc.autoTable({
                        startY: 45,
                        head: [[
                            currentLanguage === 'en' ? '#' : '#',
                            currentLanguage === 'en' ? 'Item Name' : 'Nombre del ArtÃ­culo',
                            currentLanguage === 'en' ? 'Description' : 'DescripciÃ³n',
                            currentLanguage === 'en' ? 'Category' : 'CategorÃ­a',
                            currentLanguage === 'en' ? 'Quantity' : 'Cantidad'
                        ]],
                        body: tableData,
                        theme: 'striped',
                        headStyles: { fillColor: [102, 126, 234] },
                        styles: { fontSize: 9 },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 50 },
                            3: { cellWidth: 40 },
                            4: { cellWidth: 25 }
                        }
                    });
                    
                    // Get PDF as base64 using jsPDF's built-in method (more reliable for email attachments)
                    const pdfDataUri = doc.output('datauristring');
                    // Extract base64 part (remove "data:application/pdf;base64," prefix)
                    let pdfBase64 = pdfDataUri.split(',')[1];
                    
                    // Ensure base64 is clean (remove any whitespace/newlines that might cause issues)
                    pdfBase64 = pdfBase64.replace(/\s/g, '');
                    
                    // Validate base64
                    if (!pdfBase64 || pdfBase64.length === 0) {
                        throw new Error('Failed to generate PDF base64 data');
                    }
                    
                    const pdfFileName = `Mexcan_Request_${request.id}_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Log PDF generation for debugging
                    console.log('PDF generated for Mex/Can request:', {
                        requestId: request.id,
                        pdfSize: pdfBase64.length,
                        pdfFileName: pdfFileName,
                        itemCount: request.items.length,
                        base64Preview: pdfBase64.substring(0, 50) + '...'
                    });
                    
                    // Send email
                    sendMexcanRequestEmail(request, pdfBase64, pdfFileName).then(resolve).catch(reject);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    reject(error);
                }
            });
        }
        
        async function sendMexcanRequestEmail(request, pdfBase64, pdfFileName) {
            const mexcanEmailjsServiceId = localStorage.getItem('mexcanEmailjsServiceId') || localStorage.getItem('emailjsServiceId');
            const mexcanEmailjsTemplateId = localStorage.getItem('mexcanEmailjsTemplateId');
            const emailjsPublicKey = localStorage.getItem('emailjsPublicKey');
            let recipientEmails = localStorage.getItem('mexcanRecipientEmails') || '';
            
            // Normalize email separators
            recipientEmails = recipientEmails.replace(/;/g, ',');
            const emailList = recipientEmails.split(',').map(email => email.trim()).filter(email => email.length > 0);
            
            if (emailList.length === 0) {
                throw new Error('No recipient emails configured. Please add emails in the Mex/Can Email Configuration section.');
            }
            
            if (!mexcanEmailjsTemplateId) {
                throw new Error('EmailJS Template ID not configured for Mex/Can requests. Please configure it in the Mex/Can tab.');
            }
            
            if (!emailjsPublicKey) {
                throw new Error('EmailJS Public Key not configured. Please configure it in the main EmailJS settings.');
            }
            
            if (!mexcanEmailjsServiceId && !localStorage.getItem('emailjsServiceId')) {
                throw new Error('EmailJS Service ID not configured. Please configure it in the main EmailJS settings or Mex/Can settings.');
            }
            
            // Initialize EmailJS
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS library not loaded');
            }
            
            emailjs.init(emailjsPublicKey);
            
            const requestDate = new Date(request.date).toLocaleDateString();
            const itemCount = request.items.length;
            const totalQuantity = request.items.reduce((sum, item) => sum + item.quantity, 0);
            
            // Build item list for email body
            let itemsList = '';
            request.items.forEach((item, index) => {
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const unit = item.unit || 'pieces';
                const unitLabels = {
                    'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas',
                    'pairs': currentLanguage === 'en' ? 'Pairs' : 'Pares'
                };
                const unitLabel = unitLabels[unit] || unitLabels['pieces'];
                const noteText = item.note ? ` (${item.note})` : '';
                itemsList += `${index + 1}. ${itemName}${noteText} - ${item.quantity} ${unitLabel}\n`;
            });
            
            const subject = currentLanguage === 'en' ? `Mex/Can Material Request #${request.id}` : `Solicitud de Materiales Mex/Can #${request.id}`;
            const message = currentLanguage === 'en' ? 
                `Please find the Mex/Can material request attached.\n\nRequest Details:\n- Request ID: #${request.id}\n- Date: ${requestDate}\n- Total Items: ${itemCount}\n- Total Quantity: ${totalQuantity}\n\nItems Requested:\n${itemsList}\nThe PDF file is attached to this email.\n\nThank you,\nBudget Manager System` :
                `Por favor encuentra la solicitud de materiales Mex/Can adjunta.\n\nDetalles de la Solicitud:\n- ID de Solicitud: #${request.id}\n- Fecha: ${requestDate}\n- Total de ArtÃ­culos: ${itemCount}\n- Cantidad Total: ${totalQuantity}\n\nArtÃ­culos Solicitados:\n${itemsList}\nEl archivo PDF estÃ¡ adjunto a este correo.\n\nGracias,\nSistema de GestiÃ³n de Presupuesto`;
            
            // Send email to each recipient
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (const email of emailList) {
                try {
                    // EmailJS expects base64 string without data URI prefix for attachments
                    // Make sure the base64 string is clean (no data:application/pdf;base64, prefix)
                    let cleanBase64 = pdfBase64.startsWith('data:') ? pdfBase64.split(',')[1] : pdfBase64;
                    
                    // Remove any whitespace/newlines that might cause encoding issues
                    cleanBase64 = cleanBase64.replace(/\s/g, '');
                    
                    // Validate base64 before sending
                    if (!cleanBase64 || cleanBase64.length === 0) {
                        throw new Error('Invalid PDF base64 data');
                    }
                    
                    const emailParams = {
                        email: email,  // Use 'email' to match EmailJS template variable {{email}}
                        to_email: email,  // Also include 'to_email' in case template uses it
                        subject: subject,
                        message: message,
                        pdf_attachment: cleanBase64,  // Clean base64 without data URI prefix
                        pdf_filename: pdfFileName
                    };
                    
                    // Log attachment data size for debugging
                    console.log(`Sending Mex/Can request email to ${email} with PDF attachment:`, {
                        pdf_size: cleanBase64.length,
                        pdf_filename: pdfFileName,
                        pdf_base64_preview: cleanBase64.substring(0, 50) + '...',
                        has_data_uri_prefix: pdfBase64.startsWith('data:')
                    });
                    
                    await emailjs.send(mexcanEmailjsServiceId, mexcanEmailjsTemplateId, emailParams);
                    successCount++;
                    console.log(`Mex/Can request email sent successfully to ${email}`);
                } catch (error) {
                    errorCount++;
                    console.error(`Error sending email to ${email}:`, error);
                    const errorMsg = error.text || error.message || error.toString();
                    errors.push(`${email}: ${errorMsg}`);
                }
            }
            
            if (errorCount > 0) {
                throw new Error(`Failed to send to ${errorCount} recipient(s). ${successCount} sent successfully. Errors: ${errors.join('; ')}`);
            }
            
            if (successCount === 0) {
                throw new Error('Failed to send email to any recipients');
            }
        }
        
        function exportMexcanRequest() {
            const selected = Object.keys(mexcanSelectedItems).filter(id => mexcanSelectedItems[id].selected);
            
            if (selected.length === 0) {
                alert(currentLanguage === 'en' ? 'Please select at least one item to export' : 'Por favor selecciona al menos un artÃ­culo para exportar');
                return;
            }
            
            // Similar to exportCanadaRequest - create Excel export
            // Implementation similar to Canada export
            alert(currentLanguage === 'en' ? 'Export functionality coming soon' : 'Funcionalidad de exportaciÃ³n prÃ³ximamente');
        }
        
        async function loadMexcanHistory() {
            const historyDiv = document.getElementById('mexcanRequestHistory');
            if (!historyDiv) return;
            
            // Load from localStorage (for now - can add Supabase later)
            let history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            
            const filterSelect = document.getElementById('mexcanHistoryFilter');
            const filter = filterSelect?.value || 'all';
            
            if (filterSelect && !filterSelect.value) {
                filterSelect.value = 'all';
            }
            
            let filteredHistory = history;
            if (filter === 'all') {
                filteredHistory = [...history];
                filteredHistory.sort((a, b) => {
                    const dateA = new Date(a.date || a.created_at || 0);
                    const dateB = new Date(b.date || b.created_at || 0);
                    return dateB - dateA;
                });
            } else if (filter === 'pending' || filter === 'sent' || filter === 'received') {
                filteredHistory = history.filter(req => req.status === filter);
            } else if (filter === 'backorders') {
                filteredHistory = history.filter(req => req.backorders && req.backorders.length > 0);
            }
            
            if (filteredHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #7f8c8d; background: #ecf0f1; border-radius: 8px;">
                        ${currentLanguage === 'en' ? 'No requests found.' : 'No se encontraron solicitudes.'}
                    </div>
                `;
                return;
            }
            
            // Render history similar to Canada history
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            filteredHistory.forEach(request => {
                const date = new Date(request.date).toLocaleDateString();
                const statusColor = request.status === 'received' ? '#27ae60' : (request.status === 'sent' ? '#3498db' : '#f39c12');
                const statusText = request.status === 'received' ? 
                    (currentLanguage === 'en' ? 'Received' : 'Recibido') :
                    (request.status === 'sent' ? 
                    (currentLanguage === 'en' ? 'Sent' : 'Enviada') : 
                    (currentLanguage === 'en' ? 'Pending' : 'Pendiente'));
                
                html += `
                    <div style="padding: 15px; background: white; border-left: 4px solid ${statusColor}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 1.1rem;">${currentLanguage === 'en' ? 'Request' : 'Solicitud'} #${request.id}</strong>
                                <div style="color: #7f8c8d; font-size: 0.9rem; margin-top: 3px;">${date}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <span style="padding: 5px 12px; background: ${statusColor}; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                                    ${statusText}
                                </span>
                                ${request.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markMexcanRequestSent(${request.id})" 
                                            style="background: #27ae60; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
                                        ${currentLanguage === 'en' ? 'Mark as Sent' : 'Marcar como Enviada'}
                                    </button>
                                ` : request.status === 'sent' ? `
                                    <button class="btn btn-sm" onclick="editMexcanRequestTracking(${request.id})" 
                                            style="background: #3498db; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;"
                                            title="${currentLanguage === 'en' ? 'Edit items, quantities, and tracking numbers' : 'Editar artÃ­culos, cantidades y nÃºmeros de seguimiento'}">
                                        ${currentLanguage === 'en' ? 'Edit Items & Tracking' : 'Editar ArtÃ­culos y Seguimiento'}
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm" onclick="deleteMexcanRequest(${request.id})" 
                                        style="background: #e74c3c; color: white; border: none; padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;"
                                        title="${currentLanguage === 'en' ? 'Delete this request' : 'Eliminar esta solicitud'}">
                                    ${currentLanguage === 'en' ? 'Delete' : 'Eliminar'}
                                </button>
                            </div>
                        </div>
                        ${(() => {
                            const unitLabels = {
                                'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas',
                                'pairs': currentLanguage === 'en' ? 'Pairs' : 'Pares'
                            };
                            
                            const itemsHtml = request.items.map((item, itemIdx) => {
                                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                const unit = item.unit || 'pieces';
                                const unitLabel = unitLabels[unit] || unitLabels['pieces'];
                                // Include note if present
                                const displayName = item.note ? `${itemName} <span style="color: #7f8c8d; font-style: italic;">(${item.note})</span>` : itemName;
                                
                                // Check if there's a sent item or backorder
                                const itemId = item.id !== undefined && item.id !== null 
                                    ? String(item.id) 
                                    : `item_${item.nameEn}_${item.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                
                                // Find which tracking shipment this item belongs to
                                let trackingInfo = '';
                                if (request.trackingShipments && request.trackingShipments.length > 0) {
                                    request.trackingShipments.forEach((shipment, shipmentIdx) => {
                                        const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                                        if (shipmentItemIds.includes(String(itemId))) {
                                            const trackingText = (currentLanguage === 'en' ? 'Tracking' : 'Seguimiento') + ' #' + (shipmentIdx + 1) + ': ' + shipment.trackingNumber;
                                            const titleText = currentLanguage === 'en' ? 'Click to track on UPS website' : 'Haz clic para rastrear en el sitio web de UPS';
                                            const trackingLink = '<a href="https://www.ups.com/track?tracknum=' + shipment.trackingNumber + '" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: underline; font-size: 0.8rem; margin-left: 5px;" title="' + titleText + '">ðŸ“¦ ' + trackingText + '</a>';
                                            trackingInfo = trackingLink;
                                        }
                                    });
                                }
                                
                                const sentItem = request.sentItems && request.sentItems.find(si => {
                                    const siId = si.id !== undefined && si.id !== null 
                                        ? String(si.id) 
                                        : `item_${si.nameEn}_${si.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                    return String(siId) === String(itemId);
                                });
                                const backorder = request.backorders && request.backorders.find(bo => {
                                    const boId = bo.id !== undefined && bo.id !== null 
                                        ? String(bo.id) 
                                        : `item_${bo.nameEn}_${bo.category}_${itemIdx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                    return String(boId) === String(itemId);
                                });
                                
                                let itemDisplay = '<div style="padding: 5px; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">';
                                itemDisplay += 'â€¢ ' + displayName + ' ';
                                
                                // Add tracking info if this item is in a tracking shipment
                                if (trackingInfo) {
                                    itemDisplay += '<br>' + trackingInfo;
                                }
                                
                                if (sentItem && request.status === 'sent') {
                                    const sentUnitLabel = unitLabels[sentItem.unit] || unitLabels['pieces'];
                                    const requestedText = currentLanguage === 'en' ? 'Requested' : 'Solicitado';
                                    const sentText = currentLanguage === 'en' ? 'Sent' : 'Enviado';
                                    itemDisplay += '<span style="color: #2c3e50;">(' + requestedText + ': ' + item.quantity + ' ' + unitLabel + ', ' + sentText + ': ' + sentItem.quantity + ' ' + sentUnitLabel + ')</span>';
                                    if (backorder) {
                                        const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedMexcanBackorders')) || {};
                                        const boGroupKey = backorder.nameEn + '_' + backorder.category;
                                        const isDismissed = dismissedBackorders[boGroupKey] === true;
                                        
                                        if (!isDismissed) {
                                            const backorderText = currentLanguage === 'en' ? 'Backorder' : 'Pedido Pendiente';
                                            itemDisplay += ' <span style="color: #e74c3c; font-weight: 600;">âš ï¸ ' + backorderText + ': ' + backorder.backorderQty + ' ' + unitLabel + '</span>';
                                        }
                                    }
                                } else {
                                    const qtyText = currentLanguage === 'en' ? 'Qty' : 'Cant';
                                    itemDisplay += '<span style="color: #2c3e50;">(' + qtyText + ': ' + item.quantity + ' ' + unitLabel + ')</span>';
                                }
                                
                                itemDisplay += '</div>';
                                return itemDisplay;
                            }).join('');
                            
                            // Filter out dismissed backorders
                            const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedMexcanBackorders')) || {};
                            const visibleBackorders = request.backorders ? request.backorders.filter(bo => {
                                const boGroupKey = bo.nameEn + '_' + bo.category;
                                return dismissedBackorders[boGroupKey] !== true;
                            }) : [];
                            
                            let backordersHtml = '';
                            if (visibleBackorders.length > 0) {
                                const backordersList = visibleBackorders.map(bo => {
                                    const boName = currentLanguage === 'en' ? bo.nameEn : bo.nameEs;
                                    const boUnitLabel = unitLabels[bo.unit] || unitLabels['pieces'];
                                    const boGroupKey = bo.nameEn + '_' + bo.category;
                                    const dismissText = currentLanguage === 'en' ? 'Dismiss' : 'Descartar';
                                    return '<div style="padding: 5px; background: white; border-radius: 4px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;"><span>' + boName + ': ' + bo.backorderQty + ' ' + boUnitLabel + '</span><button onclick="dismissMexcanBackorder(\'' + boGroupKey + '\')" style="background: #95a5a6; color: white; border: none; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; cursor: pointer;">' + dismissText + '</button></div>';
                                }).join('');
                                const backordersTitle = currentLanguage === 'en' ? 'Backorders' : 'Pedidos Pendientes';
                                backordersHtml = '<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;"><div style="font-weight: 600; color: #d68910; font-size: 0.9rem;">âš ï¸ ' + backordersTitle + ':</div></div><div style="display: flex; flex-direction: column; gap: 5px;">' + backordersList + '</div></div>';
                            }
                            
                            // Show tracking shipments if they exist
                            let trackingShipmentsHtml = '';
                            if (request.trackingShipments && request.trackingShipments.length > 0) {
                                const shipmentsList = request.trackingShipments.map((shipment, idx) => {
                                    const trackingLink = shipment.trackingNumber 
                                        ? '<a href="https://www.ups.com/track?tracknum=' + shipment.trackingNumber + '" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: underline; font-weight: 600;">' + shipment.trackingNumber + '</a>'
                                        : '<span style="color: #7f8c8d;">No tracking number</span>';
                                    
                                    const statusBadge = shipment.upsStatus 
                                        ? '<span style="padding: 3px 8px; background: #3498db; color: white; border-radius: 3px; font-size: 0.75rem; margin-left: 8px;">' + shipment.upsStatus + '</span>'
                                        : '';
                                    
                                    const locationInfo = shipment.upsLastLocation 
                                        ? '<div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 3px;">ðŸ“ ' + shipment.upsLastLocation + '</div>'
                                        : '';
                                    
                                    return '<div style="padding: 8px; background: #e8f4f8; border-left: 3px solid #3498db; border-radius: 4px;"><div style="display: flex; align-items: center; flex-wrap: wrap; gap: 5px;"><strong>#' + (idx + 1) + ':</strong> ' + trackingLink + ' ' + statusBadge + '</div>' + locationInfo + '</div>';
                                }).join('');
                                
                                trackingShipmentsHtml = '<div style="margin-top: 10px;"><div style="color: #2c3e50; font-weight: 600; margin-bottom: 5px;">ðŸ“¦ ' + (currentLanguage === 'en' ? 'Tracking Shipments' : 'EnvÃ­os con Seguimiento') + ' (' + request.trackingShipments.length + '):</div><div style="display: flex; flex-direction: column; gap: 8px;">' + shipmentsList + '</div></div>';
                            }
                            
                            const itemsTitle = currentLanguage === 'en' ? 'Items' : 'ArtÃ­culos';
                            return '<div style="margin-top: 10px;"><div style="color: #2c3e50; font-weight: 600; margin-bottom: 5px;">' + itemsTitle + ' (' + request.items.length + '):</div><div style="display: flex; flex-direction: column; gap: 5px;">' + itemsHtml + '</div>' + trackingShipmentsHtml + backordersHtml + '</div>';
                        })()}
                    </div>
                `;
            });
            html += '</div>';
            historyDiv.innerHTML = html;
        }
        
        async function deleteMexcanRequest(requestId) {
            if (!confirm(currentLanguage === 'en' 
                ? `Are you sure you want to delete Request #${requestId}? This action cannot be undone.` 
                : `Â¿EstÃ¡s seguro de que deseas eliminar la Solicitud #${requestId}? Esta acciÃ³n no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Delete from localStorage
                const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
                const filteredHistory = history.filter(req => req.id != requestId);
                localStorage.setItem('mexcanRequestHistory', JSON.stringify(filteredHistory));
                
                // Reload history
                await loadMexcanHistory();
                
                // Show confirmation message
                showApprovalStatus('success', currentLanguage === 'en' 
                    ? `Request #${requestId} has been deleted.` 
                    : `La Solicitud #${requestId} ha sido eliminada.`);
            } catch (error) {
                console.error('Error deleting Mex/Can request:', error);
                showApprovalStatus('error', currentLanguage === 'en' 
                    ? `Error deleting request: ${error.message}` 
                    : `Error al eliminar solicitud: ${error.message}`);
            }
        }
        
        function dismissMexcanBackorder(groupKey) {
            const dismissedBackorders = JSON.parse(localStorage.getItem('dismissedMexcanBackorders')) || {};
            dismissedBackorders[groupKey] = true;
            localStorage.setItem('dismissedMexcanBackorders', JSON.stringify(dismissedBackorders));
            loadMexcanHistory();
        }
        
        function migrateMexcanRequestsFromLocalStorage() {
            // TODO: Implement Supabase migration for Mex/Can requests
            alert(currentLanguage === 'en' ? 'Migration functionality coming soon' : 'Funcionalidad de migraciÃ³n prÃ³ximamente');
        }

        // Mex/Can Tracking Functions
        let currentMexcanTrackingRequestId = null;
        let mexcanTrackingShipments = []; // Array of {trackingNumber: '', itemIds: []}

        function markMexcanRequestSent(requestId) {
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == requestId);
            if (request) {
                currentMexcanTrackingRequestId = requestId;
                
                // Initialize tracking shipments from existing data or empty
                if (request.trackingShipments && request.trackingShipments.length > 0) {
                    mexcanTrackingShipments = JSON.parse(JSON.stringify(request.trackingShipments));
                } else {
                    mexcanTrackingShipments = [];
                }
                
                openMexcanTrackingModal(request);
            }
        }

        function editMexcanRequestTracking(requestId) {
            markMexcanRequestSent(requestId); // Same function, just different entry point
        }

        function openMexcanTrackingModal(request) {
            const modal = document.getElementById('trackingModal');
            const content = document.getElementById('trackingModalContent');
            const modalTitle = document.getElementById('trackingModalTitle');
            
            // Always get fresh data from localStorage
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const freshRequest = history.find(r => r.id == currentMexcanTrackingRequestId) || request;
            request = freshRequest;
            
            // Update modal title based on request status
            const isAlreadySent = request.status === 'sent';
            if (modalTitle) {
                modalTitle.textContent = isAlreadySent 
                    ? (currentLanguage === 'en' ? 'Edit Items & Tracking (Mex/Can)' : 'Editar ArtÃ­culos y Seguimiento (Mex/Can)')
                    : (currentLanguage === 'en' ? 'Mark Request as Sent (Mex/Can)' : 'Marcar Solicitud como Enviada (Mex/Can)');
            }
            
            // Calculate which items are assigned to shipments
            const assignedItemIds = new Set();
            mexcanTrackingShipments.forEach(shipment => {
                if (shipment.itemIds) {
                    shipment.itemIds.forEach(id => assignedItemIds.add(String(id)));
                }
            });
            
            // Build HTML for all items with checkboxes
            let itemsHtml = '<div style="margin-bottom: 20px;">';
            itemsHtml += `<h3 style="margin-bottom: 15px;">${currentLanguage === 'en' ? 'Request Items' : 'ArtÃ­culos de la Solicitud'}</h3>`;
            itemsHtml += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">';
            
            request.items.forEach((item, index) => {
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                const requestedQty = item.quantity || 1;
                const requestedUnit = item.unit || 'pieces';
                const isAssigned = assignedItemIds.has(String(itemId));
                
                if (isAssigned) {
                    return; // Don't render this item in the main list
                }
                
                // Get sent quantity if already saved
                const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
                const freshRequest = history.find(r => r.id == currentMexcanTrackingRequestId) || request;
                const sentItem = freshRequest.sentItems && freshRequest.sentItems.find(si => {
                    return String(si.id) === String(itemId);
                });
                const sentQty = sentItem ? sentItem.quantity : requestedQty;
                const sentUnit = sentItem ? sentItem.unit : (requestedUnit || 'pieces');
                
                const unitLabels = {
                    'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas'
                };
                const requestedUnitLabel = unitLabels[requestedUnit] || unitLabels['pieces'];
                
                itemsHtml += `
                    <div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 4px; border: 2px solid #e1e8ed;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="mexcan_item_${itemId}" value="${itemId}" 
                                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;"
                                   onchange="toggleMexcanItemEditFields('${itemId}')">
                            <label for="mexcan_item_${itemId}" style="cursor: pointer; flex: 1;">
                                <strong>${itemName}</strong> 
                                <span style="color: #7f8c8d; font-size: 0.9rem;">(${currentLanguage === 'en' ? 'Requested' : 'Solicitado'}: ${requestedQty} ${requestedUnitLabel})</span>
                            </label>
                        </div>
                        <div id="mexcan_editFields_${itemId}" style="display: none; padding-left: 28px; padding-top: 8px; border-top: 1px solid #e1e8ed;">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <span style="font-size: 0.85rem; color: #7f8c8d;">${currentLanguage === 'en' ? 'Sent Qty:' : 'Cant. Enviada:'}</span>
                                    <input type="number" id="mexcan_sentQty_${itemId}" 
                                           value="${sentQty}" 
                                           min="0" 
                                           style="width: 70px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                           onchange="updateMexcanSentQuantity('${itemId}')">
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <select id="mexcan_sentUnit_${itemId}" 
                                            style="width: 90px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                                            onchange="updateMexcanSentQuantity('${itemId}')">
                                        <option value="pieces" ${(sentUnit || 'pieces') === 'pieces' ? 'selected' : ''}>${unitLabels['pieces']}</option>
                                    </select>
                                </label>
                            </div>
                            <div id="mexcan_backorderInfo_${itemId}" style="margin-top: 5px; font-size: 0.8rem; color: #e74c3c; font-weight: 600;"></div>
                        </div>
                    </div>
                `;
            });
            itemsHtml += '</div>';
            itemsHtml += `<div data-mexcan-remaining-items style="margin-top: 10px;"></div>`;
            itemsHtml += '</div>';
            
            // Build HTML for tracking shipments
            let shipmentsHtml = '<div style="margin-bottom: 20px;">';
            shipmentsHtml += `<h3 style="margin-bottom: 15px;">${currentLanguage === 'en' ? 'Tracking Numbers & Items' : 'NÃºmeros de Seguimiento y ArtÃ­culos'}</h3>`;
            shipmentsHtml += '<div id="mexcanTrackingShipmentsList" style="margin-bottom: 15px;">';
            
            if (mexcanTrackingShipments.length === 0) {
                shipmentsHtml += `<p style="color: #7f8c8d; font-style: italic;">${currentLanguage === 'en' ? 'No tracking numbers added yet. Click "Add Tracking Number" to start.' : 'AÃºn no se han agregado nÃºmeros de seguimiento. Haz clic en "Agregar NÃºmero de Seguimiento" para comenzar.'}</p>`;
            } else {
                mexcanTrackingShipments.forEach((shipment, index) => {
                    shipmentsHtml += buildMexcanTrackingShipmentHtml(shipment, index, request);
                });
            }
            
            shipmentsHtml += '</div>';
            shipmentsHtml += `<button class="btn btn-primary" onclick="addMexcanTrackingShipment()" style="margin-bottom: 15px;">
                ${currentLanguage === 'en' ? '+ Add Tracking Number' : '+ Agregar NÃºmero de Seguimiento'}
            </button>`;
            shipmentsHtml += '</div>';
            
            // Build complete content
            content.innerHTML = itemsHtml + shipmentsHtml + `
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <button class="btn" onclick="closeMexcanTrackingModal()" style="background: #95a5a6; color: white;">
                        ${currentLanguage === 'en' ? 'Cancel' : 'Cancelar'}
                    </button>
                    <button class="btn btn-success" onclick="saveMexcanTrackingShipments()">
                        ${currentLanguage === 'en' ? 'Mark as Sent' : 'Marcar como Enviada'}
                    </button>
                </div>
            `;
            
            // Initialize sent items
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            mexcanTrackingShipments.forEach((shipment, shipmentIndex) => {
                shipment.itemIds.forEach(itemId => {
                    const checkbox = document.getElementById(`mexcan_item_${itemId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        toggleMexcanItemEditFields(itemId);
                    }
                });
            });
            
            // Initialize all sent quantities
            request.items.forEach((item, index) => {
                const itemId = item.id || `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                updateMexcanSentQuantity(itemId);
            });
            
            // Update remaining items count
            updateMexcanRemainingItemsCount();
            
            modal.style.display = 'block';
        }

        function toggleMexcanItemEditFields(itemId) {
            const checkbox = document.getElementById(`mexcan_item_${itemId}`);
            const editFields = document.getElementById(`mexcan_editFields_${itemId}`);
            if (checkbox && editFields) {
                editFields.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    updateMexcanSentQuantity(itemId);
                }
            }
        }

        function updateMexcanSentQuantity(itemId) {
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            if (!request) return;
            
            const item = request.items.find((it, idx) => {
                const itId = it.id !== undefined && it.id !== null 
                    ? String(it.id) 
                    : `item_${it.nameEn}_${it.category}_${idx}`.replace(/[^a-zA-Z0-9_]/g, '_');
                return String(itId) === String(itemId);
            });
            
            if (!item) return;
            
            const sentQtyInput = document.getElementById(`mexcan_sentQty_${itemId}`);
            const sentUnitSelect = document.getElementById(`mexcan_sentUnit_${itemId}`);
            const backorderInfo = document.getElementById(`mexcan_backorderInfo_${itemId}`);
            
            if (!sentQtyInput || !sentUnitSelect) return;
            
            const requestedQty = item.quantity || 1;
            const requestedUnit = item.unit || 'pieces';
            const sentQty = parseInt(sentQtyInput.value) || 0;
            const sentUnit = sentUnitSelect.value || 'pieces';
            
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            let sentItem = request.sentItems.find(si => si.id === itemId);
            if (!sentItem) {
                sentItem = {
                    id: itemId,
                    nameEn: item.nameEn,
                    nameEs: item.nameEs,
                    category: item.category,
                    quantity: sentQty,
                    unit: sentUnit
                };
                request.sentItems.push(sentItem);
            } else {
                sentItem.quantity = sentQty;
                sentItem.unit = sentUnit;
            }
            
            // Update localStorage
            const updatedHistory = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const updatedRequest = updatedHistory.find(r => r.id == currentMexcanTrackingRequestId);
            if (updatedRequest) {
                updatedRequest.sentItems = request.sentItems;
                localStorage.setItem('mexcanRequestHistory', JSON.stringify(updatedHistory));
            }
            
            // Show backorder warning if sent < requested
            if (backorderInfo && requestedUnit === sentUnit && sentQty < requestedQty) {
                const backorderQty = requestedQty - sentQty;
                backorderInfo.textContent = currentLanguage === 'en' 
                    ? `âš ï¸ Backorder: ${backorderQty} ${sentUnit === 'pieces' ? 'Pieces' : sentUnit}`
                    : `âš ï¸ Pedido Pendiente: ${backorderQty} ${sentUnit === 'pieces' ? 'Piezas' : sentUnit}`;
                backorderInfo.style.display = 'block';
            } else if (backorderInfo) {
                backorderInfo.style.display = 'none';
            }
            
            updateMexcanRemainingItemsCount();
        }

        function updateMexcanRemainingItemsCount() {
            const remainingItemsDiv = document.querySelector('[data-mexcan-remaining-items]');
            if (!remainingItemsDiv) return;
            
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            if (!request) return;
            
            const assignedItemIds = new Set();
            mexcanTrackingShipments.forEach(shipment => {
                if (shipment.itemIds) {
                    shipment.itemIds.forEach(id => assignedItemIds.add(String(id)));
                }
            });
            
            const unassignedItems = request.items.filter((item, index) => {
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                return !assignedItemIds.has(String(itemId));
            });
            
            if (unassignedItems.length > 0) {
                remainingItemsDiv.innerHTML = `<div style="padding: 8px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px; font-size: 0.85rem; color: #d68910;">
                    <strong>${currentLanguage === 'en' ? 'Note:' : 'Nota:'}</strong> ${unassignedItems.length} ${currentLanguage === 'en' ? 'item(s) not assigned to any shipment. They will be marked as backorders.' : 'artÃ­culo(s) no asignado(s) a ningÃºn envÃ­o. Se marcarÃ¡n como pedidos pendientes.'}
                </div>`;
            } else {
                remainingItemsDiv.innerHTML = '';
            }
        }

        function buildMexcanTrackingShipmentHtml(shipment, index, request) {
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const freshRequest = history.find(r => r.id == currentMexcanTrackingRequestId) || request;
            const currentRequest = freshRequest || request;
            
            const otherShipmentItemIds = new Set();
            mexcanTrackingShipments.forEach((s, idx) => {
                if (idx !== index && s.itemIds) {
                    s.itemIds.forEach(id => otherShipmentItemIds.add(id));
                }
            });
            
            const unitLabels = {
                'pieces': currentLanguage === 'en' ? 'Pieces' : 'Piezas'
            };
            
            return `
                <div id="mexcan_shipment_${index}" style="padding: 15px; margin-bottom: 10px; background: white; border: 2px solid #3498db; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #2c3e50;">${currentLanguage === 'en' ? 'Tracking Number' : 'NÃºmero de Seguimiento'} #${index + 1}</strong>
                        <button class="btn btn-sm" onclick="removeMexcanTrackingShipment(${index})" 
                                style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem;">
                            ${currentLanguage === 'en' ? 'Remove' : 'Eliminar'}
                        </button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            ${currentLanguage === 'en' ? 'Tracking Number:' : 'NÃºmero de Seguimiento:'}
                        </label>
                        <input type="text" id="mexcan_tracking_${index}" value="${shipment.trackingNumber || ''}" 
                               placeholder="${currentLanguage === 'en' ? 'Enter tracking number' : 'Ingresa el nÃºmero de seguimiento'}"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                               onchange="updateMexcanTrackingNumber(${index}, this.value)">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                            ${currentLanguage === 'en' ? 'Select Items for this Shipment:' : 'Selecciona ArtÃ­culos para este EnvÃ­o:'}
                        </label>
                        <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                            ${currentRequest.items.map((item, itemIndex) => {
                                const itemId = item.id !== undefined && item.id !== null 
                                    ? String(item.id) 
                                    : `item_${item.nameEn}_${item.category}_${itemIndex}`.replace(/[^a-zA-Z0-9_]/g, '_');
                                const itemName = currentLanguage === 'en' ? item.nameEn : item.nameEs;
                                const shipmentItemIds = (shipment.itemIds || []).map(id => String(id));
                                const isChecked = shipmentItemIds.includes(String(itemId));
                                const isInOtherShipment = Array.from(otherShipmentItemIds).some(id => String(id) === String(itemId));
                                const sentItem = currentRequest.sentItems && currentRequest.sentItems.find(si => {
                                    return si.id === itemId;
                                });
                                const unit = item.unit || 'pieces';
                                const unitLabel = unitLabels[unit] || unitLabels['pieces'];
                                let qtyDisplay = `${currentLanguage === 'en' ? 'Qty' : 'Cant'}: ${item.quantity} ${unitLabel}`;
                                if (sentItem) {
                                    const sentUnitLabel = unitLabels[sentItem.unit] || unitLabels['pieces'];
                                    qtyDisplay = `${currentLanguage === 'en' ? 'Sent' : 'Enviado'}: ${sentItem.quantity} ${sentUnitLabel} (${currentLanguage === 'en' ? 'Req' : 'Sol'}: ${item.quantity} ${unitLabel})`;
                                }
                                return `
                                    <div style="padding: 5px; margin-bottom: 3px; ${isInOtherShipment ? 'opacity: 0.5;' : ''}">
                                        <input type="checkbox" id="mexcan_shipment_${index}_item_${itemId}" 
                                               value="${itemId}" ${isChecked ? 'checked' : ''} ${isInOtherShipment ? 'disabled' : ''}
                                               onchange="updateMexcanShipmentItems(${index}, '${itemId}', this.checked)"
                                               style="margin-right: 8px; cursor: ${isInOtherShipment ? 'not-allowed' : 'pointer'};">
                                        <label for="mexcan_shipment_${index}_item_${itemId}" style="cursor: ${isInOtherShipment ? 'default' : 'pointer'};">
                                            ${itemName} (${qtyDisplay})
                                            ${isInOtherShipment ? `<span style="color: #27ae60; font-size: 0.8rem; margin-left: 5px;">âœ“ ${currentLanguage === 'en' ? 'In another shipment' : 'En otro envÃ­o'}</span>` : ''}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function addMexcanTrackingShipment() {
            mexcanTrackingShipments.push({
                trackingNumber: '',
                itemIds: []
            });
            
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            if (request) {
                openMexcanTrackingModal(request);
            }
        }

        function removeMexcanTrackingShipment(index) {
            mexcanTrackingShipments.splice(index, 1);
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            if (request) {
                openMexcanTrackingModal(request);
            }
        }

        function updateMexcanTrackingNumber(index, trackingNumber) {
            if (mexcanTrackingShipments[index]) {
                mexcanTrackingShipments[index].trackingNumber = trackingNumber.trim();
            }
        }

        function updateMexcanShipmentItems(shipmentIndex, itemId, isChecked) {
            if (!mexcanTrackingShipments[shipmentIndex]) {
                mexcanTrackingShipments[shipmentIndex] = { trackingNumber: '', itemIds: [] };
            }
            
            if (!mexcanTrackingShipments[shipmentIndex].itemIds) {
                mexcanTrackingShipments[shipmentIndex].itemIds = [];
            }
            
            if (isChecked) {
                if (!mexcanTrackingShipments[shipmentIndex].itemIds.includes(itemId)) {
                    mexcanTrackingShipments[shipmentIndex].itemIds.push(itemId);
                }
            } else {
                mexcanTrackingShipments[shipmentIndex].itemIds = mexcanTrackingShipments[shipmentIndex].itemIds.filter(id => id !== itemId);
            }
            
            updateMexcanRemainingItemsCount();
        }

        function saveCurrentMexcanSentItems() {
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            if (!request) return;
            
            if (!request.sentItems) {
                request.sentItems = [];
            }
            
            request.items.forEach((item, index) => {
                const itemId = item.id !== undefined && item.id !== null 
                    ? String(item.id) 
                    : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                const checkbox = document.getElementById(`mexcan_item_${itemId}`);
                if (checkbox && checkbox.checked) {
                    const sentQtyInput = document.getElementById(`mexcan_sentQty_${itemId}`);
                    const sentUnitSelect = document.getElementById(`mexcan_sentUnit_${itemId}`);
                    
                    if (sentQtyInput && sentUnitSelect) {
                        const sentQty = parseInt(sentQtyInput.value) || 0;
                        const sentUnit = sentUnitSelect.value || 'pieces';
                        
                        let sentItem = request.sentItems.find(si => si.id === itemId);
                        if (!sentItem) {
                            sentItem = {
                                id: itemId,
                                nameEn: item.nameEn,
                                nameEs: item.nameEs,
                                category: item.category,
                                quantity: sentQty,
                                unit: sentUnit
                            };
                            request.sentItems.push(sentItem);
                        } else {
                            sentItem.quantity = sentQty;
                            sentItem.unit = sentUnit;
                        }
                    }
                }
            });
            
            const updatedHistory = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const updatedRequest = updatedHistory.find(r => r.id == currentMexcanTrackingRequestId);
            if (updatedRequest) {
                updatedRequest.sentItems = request.sentItems;
                localStorage.setItem('mexcanRequestHistory', JSON.stringify(updatedHistory));
            }
        }

        async function saveMexcanTrackingShipments() {
            // Read tracking numbers from input fields
            mexcanTrackingShipments.forEach((shipment, index) => {
                const trackingInput = document.getElementById(`mexcan_tracking_${index}`);
                if (trackingInput) {
                    shipment.trackingNumber = trackingInput.value.trim();
                }
            });
            
            // Validate that all shipments have tracking numbers
            const emptyTracking = mexcanTrackingShipments.some(s => !s.trackingNumber || s.trackingNumber.trim() === '');
            if (emptyTracking) {
                alert(currentLanguage === 'en' 
                    ? 'Please enter tracking numbers for all shipments.' 
                    : 'Por favor ingresa nÃºmeros de seguimiento para todos los envÃ­os.');
                return;
            }
            
            // Save current sentItems from form
            saveCurrentMexcanSentItems();
            
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            const request = history.find(r => r.id == currentMexcanTrackingRequestId);
            
            if (request) {
                const trackingShipmentsToSave = mexcanTrackingShipments.map(shipment => ({
                    trackingNumber: shipment.trackingNumber || '',
                    itemIds: (shipment.itemIds || []).map(id => String(id)),
                    upsStatus: shipment.upsStatus || null,
                    upsLastUpdate: shipment.upsLastUpdate || null,
                    upsHasDutiesDue: shipment.upsHasDutiesDue || false,
                    upsHasDelay: shipment.upsHasDelay || false,
                    upsExceptionDescription: shipment.upsExceptionDescription || null,
                    upsPickedUp: shipment.upsPickedUp || false,
                    upsInTransit: shipment.upsInTransit || false,
                    upsDutiesPaid: shipment.upsDutiesPaid || false,
                    upsDutiesAmount: shipment.upsDutiesAmount || '',
                    upsStatusCode: shipment.upsStatusCode || null,
                    upsLastLocation: shipment.upsLastLocation || null,
                    upsLastDate: shipment.upsLastDate || null,
                    upsLastChecked: shipment.upsLastChecked || null
                }));
                
                request.status = 'sent';
                request.trackingShipments = trackingShipmentsToSave;
                request.trackingNumbers = trackingShipmentsToSave.map(s => s.trackingNumber);
                request.trackingNumber = trackingShipmentsToSave.length > 0 ? trackingShipmentsToSave[0].trackingNumber : '';
                if (!request.sentDate) {
                    request.sentDate = new Date().toISOString();
                }
                
                // Subscribe to UPS Track Alert API
                const trackingNumbers = trackingShipmentsToSave.map(s => s.trackingNumber).filter(tn => tn && tn.trim());
                if (trackingNumbers.length > 0) {
                    subscribeToTrackAlert(trackingNumbers).then(result => {
                        if (result.success) {
                            console.log('âœ“ Mex/Can Track Alert subscription successful:', result.message);
                        } else {
                            console.warn('âš  Mex/Can Track Alert subscription failed:', result.error || result.message);
                        }
                    }).catch(error => {
                        console.error('Error subscribing Mex/Can to Track Alert:', error);
                    });
                }
                
                // Calculate backorders
                const allAssignedItemIds = new Set();
                mexcanTrackingShipments.forEach(shipment => {
                    if (shipment.itemIds) {
                        shipment.itemIds.forEach(id => allAssignedItemIds.add(id));
                    }
                });
                
                request.backorders = [];
                request.items.forEach((item, index) => {
                    const itemId = item.id !== undefined && item.id !== null 
                        ? String(item.id) 
                        : `item_${item.nameEn}_${item.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                    const isAssigned = allAssignedItemIds.has(String(itemId));
                    const sentItem = request.sentItems && request.sentItems.find(si => {
                        const siId = si.id !== undefined && si.id !== null 
                            ? String(si.id) 
                            : `item_${si.nameEn}_${si.category}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');
                        return String(siId) === String(itemId);
                    });
                    
                    const requestedQty = item.quantity || 1;
                    const requestedUnit = item.unit || 'pieces';
                    
                    if (!isAssigned) {
                        request.backorders.push({
                            id: itemId,
                            nameEn: item.nameEn,
                            nameEs: item.nameEs,
                            category: item.category,
                            requestedQty: requestedQty,
                            sentQty: 0,
                            backorderQty: requestedQty,
                            unit: requestedUnit,
                            reason: 'not_assigned'
                        });
                    } else if (sentItem) {
                        const sentQty = sentItem.quantity || 0;
                        const sentUnit = sentItem.unit || 'pieces';
                        
                        if (requestedUnit === sentUnit && requestedQty > sentQty) {
                            request.backorders.push({
                                id: itemId,
                                nameEn: item.nameEn,
                                nameEs: item.nameEs,
                                category: item.category,
                                requestedQty: requestedQty,
                                sentQty: sentQty,
                                backorderQty: requestedQty - sentQty,
                                unit: requestedUnit,
                                reason: 'partial'
                            });
                        }
                    }
                });
                
                // Save to localStorage
                localStorage.setItem('mexcanRequestHistory', JSON.stringify(history));
                
                // Check UPS status for all new tracking numbers
                for (const shipment of trackingShipmentsToSave) {
                    if (shipment.trackingNumber && shipment.trackingNumber.trim()) {
                        try {
                            const result = await checkUPSTracking(shipment.trackingNumber.trim());
                            
                            shipment.upsStatus = result.status;
                            shipment.upsStatusCode = result.statusCode;
                            shipment.upsHasDelay = result.hasDelay;
                            shipment.upsHasDutiesDue = result.hasDutiesDue || false;
                            shipment.upsDutiesPaid = result.dutiesPaid || false;
                            shipment.upsDutiesAmount = result.dutiesAmount || '';
                            shipment.upsLastLocation = result.lastLocation;
                            shipment.upsLastDate = result.lastDate;
                            shipment.upsLastChecked = new Date().toISOString();
                            shipment.upsPickedUp = result.pickedUp || false;
                            shipment.upsInTransit = result.inTransit || false;
                            
                            // Update the request in history
                            const updatedHistory = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
                            const updatedRequest = updatedHistory.find(r => r.id == currentMexcanTrackingRequestId);
                            if (updatedRequest && updatedRequest.trackingShipments) {
                                const updatedShipment = updatedRequest.trackingShipments.find(s => s.trackingNumber === shipment.trackingNumber);
                                if (updatedShipment) {
                                    Object.assign(updatedShipment, shipment);
                                }
                                localStorage.setItem('mexcanRequestHistory', JSON.stringify(updatedHistory));
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (error) {
                            console.error(`Error checking UPS status for ${shipment.trackingNumber}:`, error);
                            shipment.upsStatus = 'Error checking status';
                            shipment.upsLastChecked = new Date().toISOString();
                        }
                    }
                }
                
                // Close modal
                closeMexcanTrackingModal();
                
                // Reload history
                await loadMexcanHistory();
            }
        }

        function closeMexcanTrackingModal() {
            document.getElementById('trackingModal').style.display = 'none';
            currentMexcanTrackingRequestId = null;
            mexcanTrackingShipments = [];
        }

        async function checkAllMexcanTrackingNumbers() {
            const history = JSON.parse(localStorage.getItem('mexcanRequestHistory')) || [];
            let updated = false;
            
            for (const request of history) {
                if (request.trackingShipments && request.trackingShipments.length > 0) {
                    for (const shipment of request.trackingShipments) {
                        if (shipment.trackingNumber && shipment.trackingNumber.trim()) {
                            try {
                                const result = await checkUPSTracking(shipment.trackingNumber.trim());
                                
                                shipment.upsStatus = result.status;
                                shipment.upsStatusCode = result.statusCode;
                                shipment.upsHasDelay = result.hasDelay;
                                shipment.upsHasDutiesDue = result.hasDutiesDue || false;
                                shipment.upsDutiesPaid = result.dutiesPaid || false;
                                shipment.upsDutiesAmount = result.dutiesAmount || '';
                                shipment.upsLastLocation = result.lastLocation;
                                shipment.upsLastDate = result.lastDate;
                                shipment.upsLastChecked = new Date().toISOString();
                                shipment.upsPickedUp = result.pickedUp || false;
                                shipment.upsInTransit = result.inTransit || false;
                                
                                updated = true;
                                await new Promise(resolve => setTimeout(resolve, 500));
                            } catch (error) {
                                console.error(`Error checking UPS status for ${shipment.trackingNumber}:`, error);
                            }
                        }
                    }
                }
            }
            
            if (updated) {
                localStorage.setItem('mexcanRequestHistory', JSON.stringify(history));
                await loadMexcanHistory();
                showApprovalStatus('success', currentLanguage === 'en' 
                    ? 'Tracking status updated for all Mex/Can requests' 
                    : 'Estado de seguimiento actualizado para todas las solicitudes Mex/Can');
            }
        }

        updateTotal();
        renderBudgetItems();
        // Initialize reports tab with budget reports as default
        switchReportType('budget');
        loadMonitorSettings();
        updateMonitorDashboard();
        refreshActivityLog();
        loadChangeHistory();
        loadEmailList(); // Load saved email list
        loadEmailJSSettings(); // Load saved EmailJS settings
        loadDeepLSettings(); // Load saved DeepL API key
        loadUPSSettings(); // Load saved UPS settings and start polling
        initializeAutoBackup(); // Initialize automatic backup if enabled
        
        // Ensure tab visibility is updated after page loads (in case user is already logged in)
        if (currentUser) {
            updateTabVisibility();
        }
        
        // Check for duties alerts on page load (after data is loaded)
        setTimeout(() => {
            checkForDutiesAlerts();
        }, 2000); // Wait 2 seconds for data to load
        loadCanadaEmailJSSettings(); // Load saved Canada EmailJS settings
        loadMexcanEmailJSSettings(); // Load saved Mex/Can EmailJS settings
        
        // Note: checkAndAddDueItems() is now called from loadUserData() after data is loaded
        // This prevents items from being cleared when Supabase data loads
        
        // Check for duties/taxes alerts on page load
        checkForDutiesAlerts();
        
        // Update monitor dashboard every 5 seconds
        setInterval(updateMonitorDashboard, 5000);
        
        // Check for duties/taxes alerts every 5 minutes
        setInterval(checkForDutiesAlerts, 5 * 60 * 1000);
        
        // Note: UPS tracking updates automatically refresh only the Canada tab when needed
        // No full page reload is necessary
    </script>
</body>
</html>

